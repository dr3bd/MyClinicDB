<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>MyClinicDB</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/localforage/1.10.0/localforage.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
  <style>
    :root {
      --primary:#145C9E;
      --accent:#1ABC9C;
      --danger:#E74C3C;
      --bg:#F7F9FC;
      --text:#1B263B;
    }
    *{box-sizing:border-box;}
    body{
      margin:0;
      font-family:'Cairo',sans-serif;
      background:var(--bg);
      color:var(--text);
    }
    header{
      display:flex;
      justify-content:space-between;
      align-items:center;
      background:var(--primary);
      color:#fff;
      padding:1.25rem 1.5rem;
    }
    main{
      display:grid;
      grid-template-columns:260px 1fr;
      min-height:calc(100vh - 96px);
    }
    nav{
      background:#fff;
      border-left:1px solid #dce6f2;
      padding:1rem;
      display:flex;
      flex-direction:column;
      gap:.5rem;
    }
    nav button{
      border-radius:12px;
      border:1px solid transparent;
      padding:.75rem 1rem;
      background:transparent;
      text-align:right;
      font-weight:600;
      color:var(--text);
      cursor:pointer;
    }
    nav button.active,nav button:hover{
      border-color:var(--primary);
      color:var(--primary);
      background:rgba(20,92,158,0.08);
    }
    section{
      padding:1.5rem;
      overflow-y:auto;
    }
    .card{
      background:#fff;
      border-radius:16px;
      padding:1.25rem;
      box-shadow:0 12px 32px rgba(0,0,0,.06);
      margin-bottom:1.5rem;
    }
    .grid{display:grid;gap:1rem;}
    .grid-2{grid-template-columns:repeat(auto-fit,minmax(220px,1fr));}
    .grid .full{grid-column:1/-1;}
    .purchase-items{display:flex;flex-direction:column;gap:.5rem;}
    .purchase-item-row{display:flex;gap:.5rem;flex-wrap:wrap;align-items:flex-end;}
    .purchase-item-row input{flex:1;min-width:120px;}
    .purchase-item-row button{height:42px;}
    #invoiceItemsWrapper{display:none;}
    label{display:block;font-weight:600;margin-bottom:.3rem;}
    input,select,textarea{
      width:100%;
      padding:.6rem .8rem;
      border-radius:12px;
      border:1px solid #dbe5ef;
      font-family:inherit;
    }
    textarea{min-height:120px;}
    table{width:100%;border-collapse:collapse;direction:rtl;}
    th,td{padding:.6rem;border-bottom:1px solid #eef2f7;text-align:right;}
    th{background:#f0f5fb;}
    .btn{
      display:inline-flex;
      align-items:center;
      gap:.4rem;
      background:var(--primary);
      color:#fff;
      border:none;
      border-radius:12px;
      padding:.6rem 1rem;
      font-weight:600;
      cursor:pointer;
    }
    .btn.secondary{background:var(--accent);}
    .btn.danger{background:var(--danger);}
    .badge{
      display:inline-flex;
      gap:.3rem;
      align-items:center;
      padding:.35rem .75rem;
      background:rgba(20,92,158,.12);
      color:var(--primary);
      border-radius:999px;
      font-size:.75rem;
    }
    .badge.danger{background:rgba(231,76,60,.15);color:var(--danger);}
    .toast{
      position:fixed;top:1.5rem;left:50%;transform:translateX(-50%);
      background:#fff;padding:1rem 1.5rem;border-radius:16px;display:none;z-index:9999;
      box-shadow:0 12px 32px rgba(0,0,0,.15);
      min-width:260px;text-align:center;
    }
    .toast.show{display:block;}
    .toast.error{border-right:6px solid var(--danger);}
    .toast.success{border-right:6px solid var(--accent);}
    #modalOverlay{
      position:fixed;inset:0;background:rgba(0,0,0,.35);backdrop-filter:blur(4px);
      display:none;align-items:center;justify-content:center;z-index:9000;
    }
    #modalOverlay.active{display:flex;}
    .modal{background:#fff;padding:1.5rem;border-radius:18px;min-width:min(420px,94vw);}
    .modal header{margin-bottom:1rem;}
    .flex{display:flex;gap:1rem;align-items:center;flex-wrap:wrap;}
    .sensitive-active{border:2px dashed var(--danger);padding:.4rem .8rem;border-radius:10px;color:var(--danger);}
    @media(max-width:960px){
      main{grid-template-columns:1fr;}
      nav{flex-direction:row;flex-wrap:wrap;border-left:none;border-top:1px solid #dce6f2;}
      nav button{flex:1 1 calc(50% - .5rem);}
    }
  </style>
</head>
<body>
  <div class="toast" id="toast"></div>
  <div id="modalOverlay"></div>
  <header>
    <h1>MyClinicDB â€” Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø­Ø§Ø³Ø¨ÙŠ</h1>
    <div class="flex" id="statusBar">
      <span id="roleBadge" class="badge">Ø§Ù„ÙˆØ¶Ø¹: Ø³ÙƒØ±ØªØ§Ø±ÙŠØ©</span>
      <span id="sensitiveBadge" class="badge danger">Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø§Ù„Ø­Ø³Ø§Ø³Ø©: ğŸ”’</span>
      <button class="btn" id="btnSensitive">ØªÙØ¹ÙŠÙ„ Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ø­Ø³Ø§Ø³</button>
      <button class="btn secondary" id="btnSwitchRole">ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</button>
    </div>
  </header>
  <main>
    <nav id="mainNav"></nav>
    <section id="view"></section>
  </main>
  <datalist id="clinicServiceList"></datalist>
  <datalist id="labPartnerList"></datalist>
  <datalist id="labServiceList"></datalist>
  <datalist id="doctorList"></datalist>
  <datalist id="inventoryItemList"></datalist>
  <script>
    const App = {
      role:'secretary',
      sensitive:false,
      passwords:{
        settings:'sha256$jZae727K08KaOmKSgOaGzww/XVqGr/PKEgIMkjrcbJI=',
        close:'sha256$SB9swFERQ8zdfi0bG5T68KcAqLSc0Tkipwta4orKqMU=',
        danger:'sha256$fCUjyYWIH7LCtM++kX6xLExLYeiYrU5xYM/KSHyjxPM='
      },
      settings:{
        clinicName:'Ø¹ÙŠØ§Ø¯Ø© Ø£Ø³Ù†Ø§Ù† Ù…ØªÙ‚Ø¯Ù…Ø©',
        clinicLogo:'',
        currency:'YER',
        overheadAllocation:'revenue',
        numberFormat:'ar'
      },
      counters:{},
      cashAccounts:[],
      view:'dashboard'
    };

    const ChartOfAccounts={
      assets:{
        cashbox:{code:'1001',name:'ØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„Ù†Ù‚Ø¯ÙŠØ©'},
        bankAccounts:{code:'1002',name:'Ø­Ø³Ø§Ø¨Ø§Øª Ø¨Ù†ÙƒÙŠØ©'},
        receivablesPatients:{code:'1101',name:'Ø°Ù…Ù… Ø§Ù„Ù…Ø±Ø¶Ù‰'},
        supplierAdvances:{code:'1102',name:'Ø³Ù„Ù Ù„Ù„Ù…ÙˆØ±Ø¯ÙŠÙ†'},
        inventory:{code:'1201',name:'Ø§Ù„Ù…Ø®Ø²ÙˆÙ†'},
        prepaidExpenses:{code:'1301',name:'Ù…ØµØ±ÙˆÙØ§Øª Ù…Ø¯ÙÙˆØ¹Ø© Ù…Ù‚Ø¯Ù…Ø§Ù‹'},
        supplierReturnPending:{code:'1401',name:'Ø±ØµÙŠØ¯ Ù…Ø±ØªØ¬Ø¹ Ù…ÙˆØ±Ø¯ Ù…Ø¹Ù„Ù‚'},
        fixedAssets:{code:'1500',name:'Ø£ØµÙˆÙ„ Ø«Ø§Ø¨ØªØ©'},
        accumulatedDepreciation:{code:'1510',name:'Ù…Ø¬Ù…Ø¹ Ø§Ù„Ø¥Ù‡Ù„Ø§Ùƒ'},
        patientDeposits:{code:'1601',name:'Ø£Ù…Ø§Ù†Ø§Øª Ø§Ù„Ù…Ø±Ø¶Ù‰'}
      },
      liabilities:{
        payablesSuppliers:{code:'2101',name:'Ø°Ù…Ù… Ø§Ù„Ù…ÙˆØ±Ø¯ÙŠÙ†'},
        accruedExpenses:{code:'2201',name:'Ù…ØµØ±ÙˆÙØ§Øª Ù…Ø³ØªØ­Ù‚Ø©'}
      },
      equity:{
        retainedEarnings:{code:'3101',name:'Ø£Ø±Ø¨Ø§Ø­ Ù…Ø­ØªØ¬Ø²Ø©'},
        incomeSummary:{code:'3201',name:'Ù…Ù„Ø®Øµ Ø§Ù„Ø¯Ø®Ù„'},
        incomeSummaryAnnual:{code:'3202',name:'Ù…Ù„Ø®Øµ Ø§Ù„Ø¯Ø®Ù„ Ø§Ù„Ø³Ù†ÙˆÙŠ'}
      },
      revenue:{
        clinicServices:{code:'4101',name:'Ø¥ÙŠØ±Ø§Ø¯Ø§Øª Ø§Ù„Ø®Ø¯Ù…Ø§Øª Ø§Ù„Ø·Ø¨ÙŠØ©'},
        labRevenue:{code:'4102',name:'Ø¥ÙŠØ±Ø§Ø¯Ø§Øª Ø£Ø¹Ù…Ø§Ù„ Ø§Ù„Ù…Ø®ØªØ¨Ø±'},
        assetDisposalGain:{code:'4201',name:'Ø£Ø±Ø¨Ø§Ø­ Ø¨ÙŠØ¹ Ø§Ù„Ø£ØµÙˆÙ„'}
      },
      expenses:{
        operating:{code:'5101',name:'Ù…ØµØ±ÙˆÙØ§Øª ØªØ´ØºÙŠÙ„ÙŠØ© ÙˆØ¥Ø¯Ø§Ø±ÙŠØ©'},
        labCost:{code:'5102',name:'ØªÙƒØ§Ù„ÙŠÙ Ø£Ø¹Ù…Ø§Ù„ Ø§Ù„Ù…Ø®ØªØ¨Ø±'},
        depreciation:{code:'5201',name:'Ù…ØµØ±ÙˆÙ Ø¥Ù‡Ù„Ø§Ùƒ'},
        doctorCommission:{code:'5202',name:'Ù…ØµØ±ÙˆÙ Ø¹Ù…ÙˆÙ„Ø§Øª Ø§Ù„Ø£Ø·Ø¨Ø§Ø¡'},
        materialsCogs:{code:'5301',name:'ØªÙƒÙ„ÙØ© Ø¨Ø¶Ø§Ø¹Ø© Ù…Ø¨Ø§Ø¹Ø©/Ù…ÙˆØ§Ø¯'},
        assetDisposalLoss:{code:'5302',name:'Ø®Ø³Ø§Ø¦Ø± Ø¨ÙŠØ¹ Ø§Ù„Ø£ØµÙˆÙ„'}
      }
    };

    const AccountMap={
      cashbox:{...ChartOfAccounts.assets.cashbox,category:'asset'},
      bankAccounts:{...ChartOfAccounts.assets.bankAccounts,category:'asset'},
      receivablesPatients:{...ChartOfAccounts.assets.receivablesPatients,category:'asset'},
      supplierAdvances:{...ChartOfAccounts.assets.supplierAdvances,category:'asset'},
      inventory:{...ChartOfAccounts.assets.inventory,category:'asset'},
      prepaidExpenses:{...ChartOfAccounts.assets.prepaidExpenses,category:'asset'},
      supplierReturnPending:{...ChartOfAccounts.assets.supplierReturnPending,category:'asset'},
      fixedAssets:{...ChartOfAccounts.assets.fixedAssets,category:'asset'},
      accumulatedDepreciation:{...ChartOfAccounts.assets.accumulatedDepreciation,category:'contra-asset'},
      patientDeposits:{...ChartOfAccounts.assets.patientDeposits,category:'liability'},
      payablesSuppliers:{...ChartOfAccounts.liabilities.payablesSuppliers,category:'liability'},
      accruedExpenses:{...ChartOfAccounts.liabilities.accruedExpenses,category:'liability'},
      retainedEarnings:{...ChartOfAccounts.equity.retainedEarnings,category:'equity'},
      incomeSummary:{...ChartOfAccounts.equity.incomeSummary,category:'equity'},
      incomeSummaryAnnual:{...ChartOfAccounts.equity.incomeSummaryAnnual,category:'equity'},
      revenueClinic:{...ChartOfAccounts.revenue.clinicServices,category:'revenue'},
      revenueLab:{...ChartOfAccounts.revenue.labRevenue,category:'revenue'},
      assetDisposalGain:{...ChartOfAccounts.revenue.assetDisposalGain,category:'revenue'},
      operatingExpense:{...ChartOfAccounts.expenses.operating,category:'expense'},
      labExpense:{...ChartOfAccounts.expenses.labCost,category:'expense'},
      depreciationExpense:{...ChartOfAccounts.expenses.depreciation,category:'expense'},
      doctorCommissionExpense:{...ChartOfAccounts.expenses.doctorCommission,category:'expense'},
      materialsCogs:{...ChartOfAccounts.expenses.materialsCogs,category:'expense'},
      assetDisposalLoss:{...ChartOfAccounts.expenses.assetDisposalLoss,category:'expense'}
    };

    const NORMAL_BALANCE={
      asset:'debit',
      expense:'debit',
      liability:'credit',
      equity:'credit',
      revenue:'credit',
      'contra-asset':'credit'
    };

    function roundAmount(val){
      return Math.round((val||0)*100)/100;
    }

    function accountLabel(info,detail){
      if(!info) return detail||'ØºÙŠØ± Ù…Ø¹Ø±Ù';
      return detail?`${info.code} - ${info.name} (${detail})`:`${info.code} - ${info.name}`;
    }

    function buildAccountEntry(key,side,amount,detail='',extra={}){
      const info=AccountMap[key];
      if(!info){
        throw new Error(`missing account map for ${key}`);
      }
      const value=roundAmount(amount);
      if(value<=0){
        throw new Error('invalid amount');
      }
      return {
        account:accountLabel(info,detail),
        code:info.code,
        name:info.name,
        category:info.category,
        detail:detail||'',
        memo:extra.memo||'',
        debit:side==='debit'?value:0,
        credit:side==='credit'?value:0
      };
    }

    function reverseEntries(entries){
      return entries.map(e=>({
        ...e,
        debit:roundAmount(e.credit||0),
        credit:roundAmount(e.debit||0)
      }));
    }

    function getCashAccount(accountId){
      if(accountId===undefined||accountId===null) return undefined;
      return (App.cashAccounts||[]).find(acc=>String(acc.id)===String(accountId));
    }

    function buildCashMovement(accountId,side,amount,context=''){
      const account=getCashAccount(accountId);
      if(!account){
        throw new Error('unknown-cash-account');
      }
      const key=account.type==='bank'?'bankAccounts':'cashbox';
      return buildAccountEntry(key,side,amount,account.name,{memo:context});
    }

    function buildEntry(type,payload={}){
      switch(type){
        case 'receipt-service':
          return [
            buildCashMovement(payload.accountId,'debit',payload.amount,'Ø³Ù†Ø¯ Ù‚Ø¨Ø¶'),
            buildAccountEntry('revenueClinic','credit',payload.amount,payload.service||'Ø®Ø¯Ù…Ø©')
          ];
        case 'receipt-settlement':
          return [
            buildCashMovement(payload.accountId,'debit',payload.amount,'ØªØ­ØµÙŠÙ„ Ø°Ù…Ø©'),
            buildAccountEntry('receivablesPatients','credit',payload.amount,payload.patient||'Ù…Ø±ÙŠØ¶')
          ];
        case 'receipt-deposit':
          return [
            buildCashMovement(payload.accountId,'debit',payload.amount,'Ø£Ù…Ø§Ù†Ø© Ù…Ø±ÙŠØ¶'),
            buildAccountEntry('patientDeposits','credit',payload.amount,payload.patient||'Ù…Ø±ÙŠØ¶')
          ];
        case 'receipt-deposit-apply':
          return [
            buildAccountEntry('patientDeposits','debit',payload.amount,payload.patient||'Ù…Ø±ÙŠØ¶'),
            buildAccountEntry('receivablesPatients','credit',payload.amount,payload.patient||'ØªØ³ÙˆÙŠØ© Ø£Ù…Ø§Ù†Ø©')
          ];
        case 'receipt-void-service':
          return reverseEntries(buildEntry('receipt-service',payload));
        case 'receipt-void-settlement':
          return reverseEntries(buildEntry('receipt-settlement',payload));
        case 'receipt-void-deposit':
          return reverseEntries(buildEntry('receipt-deposit',payload));
        case 'receipt-void-deposit-apply':
          return reverseEntries(buildEntry('receipt-deposit-apply',payload));
        case 'payment-settle':
          return [
            buildAccountEntry('payablesSuppliers','debit',payload.amount,payload.supplier||'Ù…ÙˆØ±Ø¯'),
            buildCashMovement(payload.accountId,'credit',payload.amount,'Ø³Ù†Ø¯ ØµØ±Ù')
          ];
        case 'payment-advance':
          return [
            buildAccountEntry('supplierAdvances','debit',payload.amount,payload.supplier||'Ø³Ù„ÙØ© Ù…ÙˆØ±Ø¯'),
            buildCashMovement(payload.accountId,'credit',payload.amount,'Ø³Ù†Ø¯ ØµØ±Ù')
          ];
        case 'payment-void-settle':
          return reverseEntries(buildEntry('payment-settle',payload));
        case 'payment-void-advance':
          return reverseEntries(buildEntry('payment-advance',payload));
        case 'purchase-stock':
          return [
            buildAccountEntry('inventory','debit',payload.amount,payload.supplier||'Ù…Ø´ØªØ±ÙŠØ§Øª'),
            buildAccountEntry('payablesSuppliers','credit',payload.amount,payload.supplier||'Ù…ÙˆØ±Ø¯')
          ];
        case 'purchase-expense':
          return [
            buildAccountEntry('operatingExpense','debit',payload.amount,payload.supplier||'Ù…ÙˆØ±Ø¯'),
            buildAccountEntry('payablesSuppliers','credit',payload.amount,payload.supplier||'Ù…ÙˆØ±Ø¯')
          ];
        case 'inventory-consumption':
          return [
            buildAccountEntry('materialsCogs','debit',payload.amount,payload.service||payload.item||'Ø§Ø³ØªÙ‡Ù„Ø§Ùƒ Ù…Ø§Ø¯Ø©'),
            buildAccountEntry('inventory','credit',payload.amount,payload.item||'Ù…Ø§Ø¯Ø©')
          ];
        case 'supplier-return-pending':
          return [
            buildAccountEntry('supplierReturnPending','debit',payload.amount,payload.supplier||'Ù…Ø±ØªØ¬Ø¹'),
            (payload.accountId?buildCashMovement(payload.accountId,'credit',payload.amount,'Ù…Ø±ØªØ¬Ø¹ Ù…ÙˆØ±Ø¯'):buildAccountEntry('cashbox','credit',payload.amount,'Ù…Ø±ØªØ¬Ø¹ Ù…ÙˆØ±Ø¯'))
          ];
        case 'supplier-return-settlement':
          return [
            buildAccountEntry('payablesSuppliers','debit',payload.amount,payload.supplier||'Ù…ÙˆØ±Ø¯'),
            buildAccountEntry('supplierReturnPending','credit',payload.amount,'ØªØ³ÙˆÙŠØ© Ù…Ø±ØªØ¬Ø¹')
          ];
        case 'operating-expense-accrual':
          return [
            buildAccountEntry('operatingExpense','debit',payload.amount,payload.name||'Ù…ØµØ±ÙˆÙ'),
            buildAccountEntry('accruedExpenses','credit',payload.amount,payload.costCenter||'Ù…Ø³ØªØ­Ù‚')
          ];
        case 'depreciation':
          return [
            buildAccountEntry('depreciationExpense','debit',payload.amount,payload.asset||'Ø£ØµÙ„'),
            buildAccountEntry('accumulatedDepreciation','credit',payload.amount,payload.asset||'Ø£ØµÙ„')
          ];
        case 'asset-disposal':{ 
          const entries=[
            buildAccountEntry('accumulatedDepreciation','debit',payload.accumulated,payload.asset||'Ø£ØµÙ„'),
            buildAccountEntry('fixedAssets','credit',payload.cost,payload.asset||'Ø£ØµÙ„')
          ];
          if(payload.proceeds&&payload.proceeds>0){
            entries.push(buildCashMovement(payload.accountId,'debit',payload.proceeds,'ØªØµØ±Ù Ø£ØµÙ„'));
          }
          const bookValue=roundAmount((payload.cost||0)-(payload.accumulated||0));
          const diff=roundAmount((payload.proceeds||0)-bookValue);
          if(diff>0.01){
            entries.push(buildAccountEntry('assetDisposalGain','credit',diff,payload.asset||'Ø£ØµÙ„'));
          }else if(diff<-0.01){
            entries.push(buildAccountEntry('assetDisposalLoss','debit',Math.abs(diff),payload.asset||'Ø£ØµÙ„'));
          }
          return entries;
        }
        case 'monthly-close':{
          const net=roundAmount(payload.net||0);
          if(Math.abs(net)<0.01) return [];
          if(net>0){
            return [
              buildAccountEntry('incomeSummary','debit',net,'Ø¥Ù‚ÙØ§Ù„ Ø´Ù‡Ø±ÙŠ'),
              buildAccountEntry('retainedEarnings','credit',net,'Ø£Ø±Ø¨Ø§Ø­ Ø´Ù‡Ø±ÙŠØ©')
            ];
          }
          const loss=Math.abs(net);
          return [
            buildAccountEntry('retainedEarnings','debit',loss,'Ø®Ø³Ø§Ø±Ø© Ø´Ù‡Ø±ÙŠØ©'),
            buildAccountEntry('incomeSummary','credit',loss,'Ø¥Ù‚ÙØ§Ù„ Ø´Ù‡Ø±ÙŠ')
          ];
        }
        case 'yearly-close':{
          const net=roundAmount(payload.net||0);
          if(Math.abs(net)<0.01) return [];
          if(net>0){
            return [
              buildAccountEntry('incomeSummaryAnnual','debit',net,'Ø¥Ù‚ÙØ§Ù„ Ø³Ù†ÙˆÙŠ'),
              buildAccountEntry('retainedEarnings','credit',net,'Ø£Ø±Ø¨Ø§Ø­ Ø³Ù†ÙˆÙŠØ©')
            ];
          }
          const loss=Math.abs(net);
          return [
            buildAccountEntry('retainedEarnings','debit',loss,'Ø®Ø³Ø§Ø±Ø© Ø³Ù†ÙˆÙŠØ©'),
            buildAccountEntry('incomeSummaryAnnual','credit',loss,'Ø¥Ù‚ÙØ§Ù„ Ø³Ù†ÙˆÙŠ')
          ];
        }
        default:
          throw new Error(`unsupported entry type: ${type}`);
      }
    }

    function inferCategoryFromLabel(label=''){
      if(!label) return 'other';
      if(label.includes('ØµÙ†Ø¯ÙˆÙ‚')||label.includes('Ø§Ù„Ù…Ø®Ø²ÙˆÙ†')||label.includes('Ø°Ù…Ù… Ø§Ù„Ù…Ø±Ø¶Ù‰')||label.includes('Ø±ØµÙŠØ¯ Ù…Ø±ØªØ¬Ø¹')||label.includes('Ø£ØµÙˆÙ„')) return 'asset';
      if(label.includes('Ù…ØµØ±ÙˆÙØ§Øª Ù…Ø³ØªØ­Ù‚Ø©')||label.includes('Ø°Ù…Ù… Ø§Ù„Ù…ÙˆØ±Ø¯ÙŠÙ†')) return 'liability';
      if(label.includes('Ø£Ø±Ø¨Ø§Ø­')||label.includes('Ù…Ù„Ø®Øµ Ø§Ù„Ø¯Ø®Ù„')) return 'equity';
      if(label.includes('Ø¥ÙŠØ±Ø§Ø¯Ø§Øª')) return 'revenue';
      if(label.includes('Ù…ØµØ±ÙˆÙ')||label.includes('Ø¥Ù‡Ù„Ø§Ùƒ')) return 'expense';
      if(label.includes('Ù…Ø¬Ù…Ø¹ Ø§Ù„Ø¥Ù‡Ù„Ø§Ùƒ')) return 'contra-asset';
      return 'other';
    }

    function ledgerRowNet(row){
      const category=row.category||inferCategoryFromLabel(row.account||row.name||'');
      const normal=NORMAL_BALANCE[category]||'debit';
      const debit=row.debit||0;
      const credit=row.credit||0;
      return normal==='debit'?debit-credit:credit-debit;
    }

    async function aggregateLedger(){
      const journals=await Storage.load('journals');
      const map=new Map();
      journals.forEach(j=>{
        j.entries.forEach(entry=>{
          const baseCode=entry.code||entry.account;
          const key=`${baseCode}::${entry.detail||''}`;
          if(!map.has(key)){
            const label=entry.account||entry.name||'';
            map.set(key,{
              code:entry.code||'',
              name:entry.detail?`${entry.name||label} â€” ${entry.detail}`:(entry.name||label||''),
              account:label,
              detail:entry.detail||'',
              category:entry.category||inferCategoryFromLabel(label),
              debit:0,
              credit:0
            });
          }
          const row=map.get(key);
          row.debit+=entry.debit||0;
          row.credit+=entry.credit||0;
        });
      });
      return Array.from(map.values()).sort((a,b)=>{
        const ac=a.code||a.account;
        const bc=b.code||b.account;
        return ac.localeCompare(bc);
      });
    }

    function voucherStatusLabel(status){
      switch(status){
        case 'draft': return 'Ù…Ø³ÙˆØ¯Ø©';
        case 'posted': return 'Ù…Ø±Ø­Ù„';
        case 'void': return 'Ù…Ù„ØºÙŠ';
        default: return status||'-';
      }
    }

    function voucherTypeLabel(type){
      const map={
        'receipt-service':'Ù‚Ø¨Ø¶ Ø®Ø¯Ù…Ø©',
        'receipt-settlement':'ØªØ³ÙˆÙŠØ© Ø°Ù…Ù… Ù…Ø±Ø¶Ù‰',
        'receipt-deposit':'Ø£Ù…Ø§Ù†Ø§Øª Ù…Ø±Ø¶Ù‰',
        'receipt-deposit-apply':'Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø£Ù…Ø§Ù†Ø©',
        'payment-invoice':'ØµØ±Ù Ù„Ù…ÙˆØ±Ø¯',
        'payment-advance':'Ø³Ù„ÙØ© Ù…ÙˆØ±Ø¯'
      };
      return map[type]||type||'-';
    }

    const DEFAULT_PASSWORDS={settings:'123456',close:'654321',danger:'246810'};
    const PasswordGuard={
      failed:{settings:0,close:0,danger:0},
      lockedUntil:{settings:0,close:0,danger:0}
    };
    const MAX_FAILED_ATTEMPTS=3;
    const LOCK_DURATION_MS=5*60*1000;

    const Views = {};
    const DENTAL_TEETH=[
      '18','17','16','15','14','13','12','11',
      '21','22','23','24','25','26','27','28',
      '38','37','36','35','34','33','32','31',
      '41','42','43','44','45','46','47','48'
    ];
    const DENTAL_STATUSES=['Ø³Ù„ÙŠÙ…','Ù…Ø­Ø´Ùˆ','Ù…ÙÙ‚ÙˆØ¯','ØªØ­Øª Ø§Ù„Ø¹Ù„Ø§Ø¬','Ø²Ø±Ø¹Ø©'];
    function ensureArabicFont(doc){
      if(!window.__amiriRegistered){
        doc.addFileToVFS('Amiri-Regular.ttf',ARABIC_FONT_BASE64.trim());
        doc.addFont('Amiri-Regular.ttf','Amiri','normal');
        window.__amiriRegistered=true;
      }
      doc.setFont('Amiri');
    }
    function createArabicPDF(){
      const {jsPDF}=window.jspdf;
      const doc=new jsPDF(...arguments);
      ensureArabicFont(doc);
      if(typeof doc.setLanguage==='function'){try{doc.setLanguage('ar');}catch(e){}}
      if(typeof doc.setR2L==='function'){try{doc.setR2L(true);}catch(e){}}
      doc.setFont('Amiri','normal');
      doc.setFontSize(12);
      return doc;
    }

    function pdfTextRight(doc,text,y,margin=14){
      const width=doc.internal.pageSize.getWidth();
      doc.text(text,width-margin,y,{align:'right'});
    }
    function autoTableArabic(doc,options={}){
      ensureArabicFont(doc);
      const baseStyles={font:'Amiri',halign:'right'};
      const headStyles={font:'Amiri',halign:'right'};
      options.styles={...baseStyles,...(options.styles||{})};
      options.headStyles={...headStyles,...(options.headStyles||{})};
      if(options.bodyStyles){
        options.bodyStyles={...baseStyles,...options.bodyStyles};
      }
      doc.autoTable(options);
    }
    const ARABIC_FONT_BASE64=`
AAEAAAAPAIAAAwBwR0RFRoA3oIQABS0gAAADQEdQT1OuDBunAAUwYAAA1yhHU1VCKX3XTAAGB4gA
AIyET1MvMp5/dp8AAAF4AAAAYGNtYXDwK+OqAABqhAAAESJnYXNwAAAAEAAFLRgAAAAIZ2x5ZvJz
3KQAAOSMAAQ9AWhlYWTOXCcrAAAA/AAAADZoaGVhL3wbfgAAATQAAAAkaG10eDnUxFUAAAHYAABo
qmxvY2E4yrZUAAB7sAAAaNxtYXhwGpcGhAAAAVgAAAAgbmFtZb0S9/cABSGQAAALaHBvc3T+AwAy
AAUs+AAAACBwcmVwaAaMhQAAe6gAAAAHAAEAAAABAIPplwNCXw889QADA+gAAAAAyAoxsQAAAAB8
Azv/MwAAAAgAAgAAAAAAAAABAAADwP8AAAAWAAADwP8AAAH/AAADwP8AAAAjAAAEHwABAAEAAAAA
AAACBwABAAAAAQAAAEWBaAAFAAAAPoLMwAAACwB6gPAAAEBC4MFAAAAAwACAAAAAAAAAAEAAAAA
AAMAAAAEAAQAAwAAABwAAQAAAAAAAgAAAAAAAAABAAAAAQAAAAEAAAABAAAAAQAADgABAAYAAACg
/ZL//8AAL79kv//AAD/vZL//wAAEIArAAEAAAAAAAAAAAADAACMAAAAAAAAAAAAAAAAAAAAAQAA
AAEAAAB4AAMAAQAAAAAAAAAAAAIAAQABAAAAAAACAAEAAQAAAJgCAAACAAAAAAACAAAAAgAABDoB
AAMAAQQJAAACAAAAAAAAAAMAAQQJAAEABAAAAAMAAQQJAAIABAAAAAMAAQQJAAUABAAAAAMAAQQJ
AAYABAAAAAMAAQQJAAgABAAAAAMAAQQJAAkABAAAAAMAAQQJAAsABAAAAAMAAQQJAAwABAAAAAMA
AQQJAA0ABAAAAAMAAQQJAA4ABAAAAAMAAQQJAA8ABAAAAAMAAQQJAAsAAgAAAAgAEQACAAYADQAB
ABAAQQJAAoABAAAAAMAAQQJABIAAgAAAAMAAQQJABMABAAAAAMAAQQJABQABAAAAAMAAQQJABUA
BAAAAAQABYoABAAAAAMAAQQJABYABAAAAAMAAQQJABcABAAAAAMAAQQJABgABAAAAAMAAQQJABkA
BAAAAAcAAQQJABoABAAAAAMAAQQJABsABAAAAAMAAQQJABwABAAAAAMAAQQJAB0ABAAAAAMAAQQJ
AB4ABAAAAAMAAQQJAB8ABAAAAAMAAQQJAC8ABAAAAAMAAQQJADYABAAAAAMAAQQJADcABAAAAAMA
AQQJADkABAAAAAMAAQQJADoABAAAAAMAAQQJADwABAAAAAMAAQQJAD0ABAAAAAMAAQQJAD4ABAAA
AAMAAQQJAD8ABAAAAAMAAQQJAEIABAAAAAMAAQQJAEQABAAAAAMAAQQJAEUABAAAAAMAAQQJAEcA
BAAAAAwAAQQJAEgABAAAAAMAAQQJAEkABAAAAAMAAQQJAEoABAAAAAMAAQQJAE0ABAAAAAMAAQQJ
AE4ABAAAAAMAAQQJAE8ABAAAAAMAAQQJAFIABAAAAAMAAQQJAFMABAAAAAMAAQQJAFQABAAAAAMA
AQQJAFUABAAAAAMAAQQJAFYABAAAAAMAAQQJAFcABAAAAAMAAQQJAFgABAAAAAMAAQQJAFoABAAA
AAMAAQQJAFsABAAAAAMAAQQJAFwABAAAAAMAAQQJAF0ABAAAAAMAAQQJAF4ABAAAAAMAAQQJAF8A
BAAAAA0AAQQJAGUABAAAAAMAAQQJAGgABAAAAAMAAQQJAGoABAAAAAMAAQQJAGsABAAAAAMAAQQJ
AGwABAAAAAMAAQQJAG0ABAAAAAMAAQQJAG4ABAAAAAMAAQQJAG8ABAAAAAMAAQQJAHIABAAAAAMA
AQQJAHMABAAAAAMAAQQJAHQABAAAAAMAAQQJAHUABAAAAAMAAQQJAHYABAAAAAMAAQQJAHcABAAA
AAMAAQQJAHgABAAAAAMAAQQJAHkABAAAAAMAAQQJAHsABAAAAAMAAQQJAHwABAAAAAMAAQQJAH0A
BAAAAA4AAQQJAH4ABAAAAAMAAQQJAH8ABAAAAAMAAQQJAIABBJ0sAAQAAAAAAAIABZ8sAAQAAAAAA
AQACAQAAQAAAAAAAAAABAACAQAAQAAAAAAAAAABAACAQAAQAAAAAAAAMABAACAQAAQAAAAAAAAMA
BAACAQAAQAAAAAAAAAABAACAQAAQAAAAAAAAAABAACAQAAQAAAAAAAAAABAAACAQAAQAAAAAAAAA
ABAACAQAAQAAAAAAAAAABAACAQAAQAAAAAAAAMABAACAQAAQAAAAAAAAAABAAACAQAAQAAAAAAA
AMABAACAQAAQAAAAAAAAAABAAACAQAAQAAAAAAAAAABAAACAQAAQAAAAAAAAAABAACAQAAQAAAAA
AAAMABAACAQAAQAAAAAAAAAABAAACAQAAQAAAAAAAAAABAACAQAAQAAAAAAAAAABAACAQAAQAAAA
AAAAMABAACAQAAQAAAAAAAAAABAAACAQAAQAAAAAAAAAABAACAQAAQAAAAAAAAAABAACAQAAQAAA
AAAAAMABAACAQAAQAAAAAAAAAABAACAQAAQAAAAAAAAAABAACAQAAQAAAAAAAAAABAACAQAAQAAA
AAAAAMABAACAQAAQAAAAAAAAAABAAACAQAAQAAAAAAAAAABAACAQAAQAAAAAAAAAABAAACAQAAQA
AAAAAAAMABAACAQAAQAAAAAAAAAABAAACAQAAQAAAAAAAAAABAACAQAAQAAAAAAAAAABAACAQAAQ
AAAAAAAAAABAAACAQAAQAAAAAAAAAABAACAQAAQAAAAAAAAAABAACAQAAQAAAAAAAAAABAACAQAA
QAAAAAAAAAABAACAQAAQAAAAAAAAAABAACAQAAQAAAAAAAAAABAACAQAAQAAAAAAAAAABAACAQAA
QAAAAAAAAAABAACAQAAQAAAAAAAAAABAACAQAAQAAAAAAAAAABAACAQAAQAAAAAAAAAABAACAQAA
QAAAAAAAAAABAACAQAAQAAAAAAAAAABAACAQAAQAAAAAAAAAABAACAQAAQAAAAAAAAAABAACAQAA
QAAAAAAAAAABAACAQAAQAAAAAAAAAABAACAQAAQAAAAAAAAAABAACAQAAQAAAAAAAAAABAACAQAA
QAAAAAAAAAABAACAQAAQAAAAAAAAAABAACAQAAQAAAAAAAAAABAACAQAAQAAAAAAAAAABAACAQAA
QAAAAAAAAAABAACAQAAQAAAAAAAAAABAACAQAAQAAAAAAAAAABAACAQAAQAAAAAAAAAABAACAQAA
QAAAAAAAAAABAACAQAAQAAAAAAAAAABAACAQAAQAAAAAAAAAABAACAQAAQAAAAAAAAAABAACAQAA
QAAAAAAAAAABAACAQAAQAAAAAAAAAABAACAQAAQAAAAAAAAAABAACAQAAQAAAAAAAAAABAACAQAA
QAAAAAAAAAABAACAQAAQAAAAAAAAAABAACAQAAQAAAAAAAAAABAACAQAAQAAAAAAAAAABAACAQAA
QAAAAAAAAAABAACAQAAQAAAAAAAAAABAACAQAAQAAAAAAAAAABAACAQAAQAAAAAAAAAABAACAQAA
QAAAAAAAAAABAACAQAAQAAAAAAAAAABAACAQAAQAAAAAAAAAABAACAQAAQAAAAAAAAAABAACAQAA
QAAAAAAAAAABAACAQAAQAAAAAAAAAABAACAQAAQAAAAAAAAAABAACAQAAQAAAAAAAAAABAACAQAA
QAAAAAAAAAABAACAQAAQAAAAAAAAAABAACAQAAQAAAAAAAAAABAACAQAAQAAAAAAAAAABAACAQAA
QAAAAAAAAAABAACAQAAQAAAAAAAAAABAACAQAAQAAAAAAAAAABAACAQAAQAAAAAAAAAABAACAQAA
QAAAAAAAAAABAACAQAAQAAAAAAAAAABAACAQAAQAAAAAAAAAABAACAQAAQAAAAAAAAAABAACAQAA
QAAAAAAAAAABAACAQAAQAAAAAAAAAABAACAQAAQAAAAAAAAAABAAACAQAAQAAAAAAAAAABAACAQA
AQAAAAAAAAAABAACAQAAQAAAAAAAAAABAACAQAAQAAAAAAAAAABAACAQAAQAAAAAAAAAABAACAQA
AQAAAAAAAAAABAACAQAAQAAAAAAAAAABAACAQAAQAAAAAAAAAABAACAQAAQAAAAAAAAAABAACAQA
AQAAAAAAAAAABAACAQAAQAAAAAAAAAABAACAQAAQAAAAAAAAAABAACAQAAQAAAAAAAAAABAACAQA
AQAAAAAAAAAABAACAQAAQAAAAAAAAAABAACAQAAQAAAAAAAAAABAACAQAAQAAAAAAAAAABAACAQA
AQAAAAAAAAAABAACAQAAQAAAAAAAAAABAACAQAAQAAAAAAAAAABAACAQAAQAAAAAAAAAABAACAQA
AQAAAAAAAAAABAACAQAAQAAAAAAAAAABAAACAQAAQAAAAAAAAAABAACAQAAQAAAAAAAAAABAAACA
QAAQAAAAAAAAAABAACAQAAQAAAAAAAAAABAACAQAAQAAAAAAAAAABAACAQAAQAAAAAAAAAABAACA
QAAQAAAAAAAAAABAACAQAAQAAAAAAAAAABAACAQAAQAAAAAAAAAABAAACAQAAQAAAAAAAAAABAAC
AQAAQAAAAAAAAAABAAACAQAAQAAAAAAAAAABAACAQAAQAAAAAAAAAABAACAQAAQAAAAAAAAAABAA
ACAQAAQAAAAAAAAAABAACAQAAQAAAAAAAAAABAACAQAAQAAAAAAAAAABAACAQAAQAAAAAAAAAABA
ACAQAAQAAAAAAAAAABAACAQAAQAAAAAAAAAABAACAQAAQAAAAAAAAAABAACAQAAQAAAAAAAAAABA
ACAQAAQAAAAAAAAAABAAACAQAAQAAAAAAAAAABAAACAQAAQAAAAAAAAAABAACAQAAQAAAAAAAAAA
BAACAQAAQAAAAAAAAAABAAACAQAAQAAAAAAAAAABAACAQAAQAAAAAAAAAABAAACAQAAQAAAAAAAA
AABAAACAQAAQAAAAAAAAAABAAACAQAAQAAAAAAAAAABAACAQAAQAAAAAAAAAABAAACAQAAQAAAAA
AAAAABAACAQAAQAAAAAAAAAABAAACAQAAQAAAAAAAAAABAAACAQAAQAAAAAAAAAABAACAQAAQAAA
AAAAAAABAACAQAAQAAAAAAAAAABAACAQAAQAAAAAAAAAABAACAQAAQAAAAAAAAAABAACAQAAQAAA
AAAAAAABAACAQAAQAAAAAAAAAABAACAQAAQAAAAAAAAAABAACAQAAQAAAAAAAAAABAACAQAAQAAA
AAAAAAABAACAQAAQAAAAAAAAAABAACAQAAQAAAAAAAAAABAACAQAAQAAAAAAAAAABAACAQAAQAAA
AAAAAAABAACAQAAQAAAAAAAAAABAACAQAAQAAAAAAAAAABAACAQAAQAAAAAAAAAABAACAQAAQAAA
AAAAAAABAACAQAAQAAAAAAAAAABAACAQAAQAAAAAAAAAABAACAQAAQAAAAAAAAAABAACAQAAQAAA
AAAAAAABAACAQAAQAAAAAAAAAABAACAQAAQAAAAAAAAAABAACAQAAQAAAAAAAAAABAACAQAAQAAA
AAAAAAABAACAQAAQAAAAAAAAAABAACAQAAQAAAAAAAAAABAACAQAAQAAAAAAAAAABAACAQAAQAAA
AAAAAAABAACAQAAQAAAAAAAAAABAACAQAAQAAAAAAAAAABAACAQAAQAAAAAAAAAABAACAQAAQAAA
AAAAAAABAACAQAAQAAAAAAAAAABAACAQAAQAAAAAAAAAABAACAQAAQAAAAAAAAAABAACAQAAQAAA
AAAAAAABAACAQAAQAAAAAAAAAABAACAQAAQAAAAAAAAAABAACAQAAQAAAAAAAAAABAACAQAAQAAA
AAAAAAABAACAQAAQAAAAAAAAAABAACAQAAQAAAAAAAAAABAACAQAAQAAAAAAAAAABAACAQAAQAAA
AAAAAAABAACAQAAQAAAAAAAAAABAACAQAAQAAAAAAAAAABAACAQAAQAAAAAAAAAABAACAQAAQAAA
AAAAAAABAACAQAAQAAAAAAAAAABAACAQAAQAAAAAAAAAABAACAQAAQAAAAAAAAAABAACAQAAQAAA
AAAAAAABAACAQAAQAAAAAAAAAABAACAQAAQAAAAAAAAAABAACAQAAQAAAAAAAAAABAACAQAAQAAA
AAAAAAABAACAQAAQAAAAAAAAAABAACAQAAQAAAAAAAAAABAACAQAAQAAAAAAAAAABAACAQAAQAAA
AAAAAAABAACAQAAQAAAAAAAAAABAACAQAAQAAAAAAAAAABAACAQAAQAAAAAAAAAABAACAQAAQAAA
AAAAAAABAACAQAAQAAAAAAAAAABAACAQAAQAAAAAAAAAABAACAQAAQAAAAAAAAAABAACAQAAQAAA
AAAAAAABAACAQAAQAAAAAAAAAABAACAQAAQAAAAAAAAAABAACAQAAQAAAAAAAAAABAACAQAAQAAA
AAAAAAABAACAQAAQAAAAAAAAAABAACAQAAQAAAAAAAAAABAACAQAAQAAAAAAAAAABAACAQAAQAAA
AAAAAAABAACAQAAQAAAAAAAAAABAACAQAAQAAAAAAAAAABAACAQAAQAAAAAAAAAABAACAQAAQAAA
AAAAAAABAACAQAAQAAAAAAAAAABAACAQAAQAAAAAAAAAABAACAQAAQAAAAAAAAAABAACAQAAQAAA
AAAAAAABAACAQAAQAAAAAAAAAABAACAQAAQAAAAAAAAAABAACAQAAQAAAAAAAAAABAACAQAAQAAA
AAAAAAABAACAQAAQAAAAAAAAAABAACAQAAQAAAAAAAAAABAACAQAAQAAAAAAAAAABAACAQAAQAAA
AAAAAAABAACAQAAQAAAAAAAAAABAACAQAAQAAAAAAAAAABAACAQAAQAAAAAAAAAABAACAQAAQAAA
AAAAAAABAACAQAAQAAAAAAAAAABAACAQAAQAAAAAAAAAABAACAQAAQAAAAAAAAAABAACAQAAQAAA
AAAAAAABAACAQAAQAAAAAAAAAABAACAQAAQAAAAAAAAAABAACAQAAQAAAAAAAAAABAACAQAAQAAA
AAAAAAABAACAQAAQAAAAAAAAAABAACAQAAQAAAAAAAAAABAACAQAAQAAAAAAAAAABAACAQAAQAAA
AAAAAAABAACAQAAQAAAAAAAAAABAACAQAAQAAAAAAAAAABAACAQAAQAAAAAAAAAABAACAQAAQAAA
AAAAAAABAACAQAAQAAAAAAAAAABAACAQAAQAAAAAAAAAABAACAQAAQAAAAAAAAAABAACAQAAQAAA
AAAAAAABAACAQAAQAAAAAAAAAABAACAQAAQAAAAAAAAAABAACAQAAQAAAAAAAAAABAACAQAAQAAA
AAAAAAABAACAQAAQAAAAAAAAAABAACAQAAQAAAAAAAAAABAACAQAAQAAAAAAAAAABAACAQAAQAAA
AAAAAAABAACAQAAQAAAAAAAAAABAACAQAAQAAAAAAAAAABAACAQAAQAAAAAAAAAABAACAQAAQAAA
AAAAAAABAACAQAAQAAAAAAAAAABAACAQAAQAAAAAAAAAABAACAQAAQAAAAAAAAAABAACAQAAQAAA
AAAAAAABAACAQAAQAAAAAAAAAABAACAQAAQAAAAAAAAAABAAACAQAAQAAAAAAAAAABAACAQAAQAA
AAAAAAABAACAQAAQAAAAAAAAAABAACAQAAQAAAAAAAAAABAACAQAAQAAAAAAAAAABAACAQAAQAAA
AAAAAAABAACAQAAQAAAAAAAAAABAACAQAAQAAAAAAAAAABAACAQAAQAAAAAAAAAABAAACAQAAQAA
AAAAAAAAAABAACAQAAQAAAAAAAAAABAACAQAAQAAAAAAAAAABAACAQAAQAAAAAAAAAABAACAQAAQ
AAAAAAAAAABAACAQAAQAAAAAAAAAABAACAQAAQAAAAAAAAAABAACAQAAQAAAAAAAAAABAACAQAAQ
AAAAAAAAAABAACAQAAQAAAAAAAAAABAACAQAAQAAAAAAAAAABAACAQAAQAAAAAAAAAABAACAQAAQ
AAAAAAAAAABAACAQAAQAAAAAAAAAABAACAQAAQAAAAAAAAAABAACAQAAQAAAAAAAAAABAACAQAAQ
AAAAAAAAAABAACAQAAQAAAAAAAAAABAACAQAAQAAAAAAAAAABAACAQAAQAAAAAAAAAABAACAQAAQ
AAAAAAAAAABAACAQAAQAAAAAAAAAABAACAQAAQAAAAAAAAAABAACAQAAQAAAAAAAAAABAACAQAAQ
AAAAAAAAAABAACAQAAQAAAAAAAAAABAACAQAAQAAAAAAAAAABAACAQAAQAAAAAAAAAABAACAQAAQ
AAAAAAAAAABAACAQAAQAAAAAAAAAABAACAQAAQAAAAAAAAAABAACAQAAQAAAAAAAAAABAACAQAAQ
AAAAAAAAAABAACAQAAQAAAAAAAAAABAACAQAAQAAAAAAAAAABAACAQAAQAAAAAAAAAABAACAQAAQ
AAAAAAAAAABAACAQAAQAAAAAAAAAABAACAQAAQAAAAAAAAAABAACAQAAQAAAAAAAAAABAACAQAAQ
AAAAAAAAAABAACAQAAQAAAAAAAAAABAACAQAAQAAAAAAAAAABAACAQAAQAAAAAAAAAABAACAQAAQ
AAAAAAAAAABAACAQAAQAAAAAAAAAABAACAQAAQAAAAAAAAAABAACAQAAQAAAAAAAAAABAACAQAAQ
AAAAAAAAAABAACAQAAQAAAAAAAAAABAACAQAAQAAAAAAAAAABAACAQAAQAAAAAAAAAABAACAQAAQ
AAAAAAAAAABAACAQAAQAAAAAAAAAABAACAQAAQAAAAAAAAAABAACAQAAQAAAAAAAAAABAACAQAAQ
AAAAAAAAAABAACAQAAQAAAAAAAAAABAACAQAAQAAAAAAAAAABAACAQAAQAAAAAAAAAABAACAQAAQ
AAAAAAAAAABAACAQAAQAAAAAAAAAABAACAQAAQAAAAAAAAAABAACAQAAQAAAAAAAAAABAACAQAAQ
AAAAAAAAAABAACAQAAQAAAAAAAAAABAACAQAAQAAAAAAAAAABAACAQAAQAAAAAAAAAABAACAQAAQ
AAAAAAAAAABAACAQAAQAAAAAAAAAABAACAQAAQAAAAAAAAAABAACAQAAQAAAAAAAAAABAACAQAAQ
AAAAAAAAAABAACAQAAQAAAAAAAAAABAACAQAAQAAAAAAAAAABAAACAQAAQAAAAAAAAAABAACAQAA
QAAAAAAAAAABAACAQAAQAAAAAAAAAABAACAQAAQAAAAAAAAAABAACAQAAQAAAAAAAAAABAACAQAA

    function showToast(msg,type='success'){
      const el=document.getElementById('toast');
      el.textContent=msg;
      el.className=`toast show ${type}`;
      setTimeout(()=>el.classList.remove('show'),3500);
    }

    function formatDate(date){
      if(!date) return '-';
      const d=new Date(date);
      return d.toLocaleDateString('ar-SA',{year:'numeric',month:'2-digit',day:'2-digit'});
    }
    function formatCurrency(val){
      return new Intl.NumberFormat('ar-EG',{style:'currency',currency:App.settings.currency||'YER'}).format(val||0);
    }

    async function hashText(text){
      try{
        if(!(window.crypto&&window.crypto.subtle)) throw new Error('subtle-crypto-unavailable');
        const data=new TextEncoder().encode(text);
        const digest=await crypto.subtle.digest('SHA-256',data);
        const bytes=Array.from(new Uint8Array(digest));
        const binary=String.fromCharCode(...bytes);
        return `sha256$${btoa(binary)}`;
      }catch(err){
        const encoded=unescape(encodeURIComponent(text));
        return `sha256$${btoa(encoded)}`;
      }
    }

    async function preparePasswords(existing={}){
      const updated={...existing};
      let changed=false;
      for(const key of Object.keys(DEFAULT_PASSWORDS)){
        let current=updated[key];
        if(!current){
          current=DEFAULT_PASSWORDS[key];
          changed=true;
        }
        if(!String(current).startsWith('sha256$')){
          current=await hashText(current);
          changed=true;
        }
        updated[key]=current;
      }
      return {updated,changed};
    }

    async function verifyPassword(type,value){
      if(!value) return false;
      const hashed=await hashText(value);
      return hashed===App.passwords[type];
    }

    const Storage={
      async init(){
        localforage.config({name:'MyClinicDB',storeName:'clinic_store'});
        const settings=await localforage.getItem('settings');
        if(settings){
          App.settings={...App.settings,...settings};
          if('passwords'in App.settings) delete App.settings.passwords;
        }
        const storedPasswords=await localforage.getItem('passwords');
        const {updated,changed}=await preparePasswords(storedPasswords||App.passwords);
        App.passwords=updated;
        if(changed||!storedPasswords){
          await localforage.setItem('passwords',App.passwords);
        }
        App.counters=await localforage.getItem('referenceCounters')||{};
      },
      async load(key,fallback=[]){
        return await localforage.getItem(key)||fallback;
      },
      async save(key,val){
        await localforage.setItem(key,val);
      }
    };

    function generateReference(prefix){
      const now=new Date();
      const ym=`${now.getFullYear()}${String(now.getMonth()+1).padStart(2,'0')}`;
      const key=`${prefix}-${ym}`;
      const counter=(App.counters[key]||0)+1;
      App.counters[key]=counter;
      localforage.setItem('referenceCounters',App.counters);
      return `${prefix}-${ym}-${String(counter).padStart(4,'0')}`;
    }

    function updateStatus(){
      document.getElementById('roleBadge').textContent=`Ø§Ù„ÙˆØ¶Ø¹: ${App.role==='manager'?'Ù…Ø¯ÙŠØ±':'Ø³ÙƒØ±ØªØ§Ø±ÙŠØ©'}`;
      document.getElementById('btnSensitive').disabled=App.role!=='manager';
      document.getElementById('sensitiveBadge').textContent=`Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø§Ù„Ø­Ø³Ø§Ø³Ø©: ${App.sensitive?'ğŸ”“':'ğŸ”’'}`;
      document.getElementById('sensitiveBadge').className=`badge ${App.sensitive?'':'danger'}`;
    }

    function renderNav(){
      const nav=document.getElementById('mainNav');
      nav.innerHTML='';
      const items=[
        {id:'dashboard',label:'Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…'},
        {id:'patients',label:'Ø§Ù„Ù…Ø±Ø¶Ù‰ ÙˆØ§Ù„Ø£Ù…Ø§Ù†Ø§Øª'},
        {id:'vouchers',label:'Ø§Ù„Ø³Ù†Ø¯Ø§Øª Ø§Ù„Ù…Ø§Ù„ÙŠØ©'},
        {id:'journal',label:'Ø¯ÙØªØ± Ø§Ù„ÙŠÙˆÙ…ÙŠØ©'},
        {id:'appointments',label:'Ø§Ù„Ù…ÙˆØ§Ø¹ÙŠØ¯'},
        {id:'suppliers',label:'Ø§Ù„Ù…ÙˆØ±Ø¯ÙˆÙ† ÙˆØ§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª'},
        {id:'labs',label:'Ø§Ù„Ù…Ø¹Ø§Ù…Ù„'},
        {id:'inventory',label:'Ø§Ù„Ù…Ø®Ø²ÙˆÙ†'},
        {id:'master',label:'Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©'},
        {id:'finance',label:'Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª ÙˆØ§Ù„Ø¥Ù‡Ù„Ø§Ùƒ'},
        {id:'opening',label:'Ø£Ø±ØµØ¯Ø© Ø§ÙØªØªØ§Ø­ÙŠØ©'},
        {id:'doctors',label:'Ø§Ù„Ø£Ø·Ø¨Ø§Ø¡ ÙˆØ§Ù„Ø±Ø¨Ø­ÙŠØ©'},
        {id:'prescriptions',label:'Ø§Ù„ÙˆØµÙØ§Øª Ø§Ù„Ø·Ø¨ÙŠØ©'},
        {id:'controls',label:'Ø§Ù„ØªØ³ÙˆÙŠØ§Øª ÙˆØ§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©'},
        {id:'reports',label:'Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±'},
        {id:'settings',label:'Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª'}
      ];
      items.forEach(item=>{
        if(App.role!=='manager' && item.id==='settings') return;
        const btn=document.createElement('button');
        btn.textContent=item.label;
        if(App.view===item.id) btn.classList.add('active');
        btn.onclick=()=>switchView(item.id);
        nav.appendChild(btn);
      });
    }

    function switchView(id){
      App.view=id;
      renderNav();
      const container=document.getElementById('view');
      container.innerHTML=Views[id]?Views[id]():'';
      renderCashAccountSelectors();
      const hooks={
        dashboard:()=>renderDashboardWidgets(),
        vouchers:()=>{
          updatePatientSelectors().then(()=>{renderReceiptOutstanding();});
          renderVoucherTable();
          renderPaymentOutstanding();
          renderCashAccountSelectors();
          onVoucherTypeChange();
        },
        journal:()=>renderJournalTable(),
        patients:()=>{renderPatientsTable();renderPatientReceivables();renderMedicalAlerts();renderDentalChartControls();},
        appointments:()=>renderAppointmentsTable(),
        suppliers:()=>{renderSupplierReturns();renderSupplierPayables();renderPaymentOutstanding();setupPurchaseForm();renderCashAccountSelectors();},
        labs:()=>renderLabsTable(),
        inventory:()=>{renderInventoryTable();renderInventoryConsumptionHistory();},
        master:()=>{renderEmployees();renderLabPartners();renderClinicCatalog();renderLabCatalog();refreshCatalogLists();refreshDoctorOptions();},
        finance:()=>{renderOperatingExpenses();renderFixedAssets();renderPeriodClosings();renderAssetDisposals();renderDepreciationSchedule();renderCashAccountSelectors();},
        opening:()=>{renderOpeningBalanceForm();},
        doctors:()=>renderDoctorsTable(),
        prescriptions:()=>renderPrescriptionsTable(),
        controls:()=>{
          renderCashAccountsTable();
          renderCashCountTable();
          renderBankReconciliations();
          const date=document.getElementById('cashCountDate');
          if(date&&!date.value){date.value=new Date().toISOString().slice(0,10);}
        },
        reports:()=>{},
        settings:()=>{}
      };
      if(hooks[id]) hooks[id]();
    }

    async function promptPassword(type,cb){
      const overlay=document.getElementById('modalOverlay');
      const now=Date.now();
      if(PasswordGuard.lockedUntil[type]&&now<PasswordGuard.lockedUntil[type]){
        showToast('Ù…Ø­Ø§ÙˆÙ„Ø§Øª ÙƒØ«ÙŠØ±Ø©ØŒ Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± Ù‚Ø¨Ù„ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø¬Ø¯Ø¯Ù‹Ø§','error');
        await logAudit('security-deny',`PWD-${type}`,'Ø±ÙØ¶ Ø¥Ø¯Ø®Ø§Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø¨Ø³Ø¨Ø¨ Ø§Ù„Ù‚ÙÙ„',{lockedUntil:new Date(PasswordGuard.lockedUntil[type]).toISOString()});
        return;
      }
      overlay.innerHTML=`<div class="modal">
        <header><h3>ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</h3></header>
        <p>Ø£Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± (${type==='settings'?'Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª':type==='close'?'Ø§Ù„Ø¥Ù‚ÙØ§Ù„':'Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø§Ù„Ø­Ø³Ø§Ø³Ø©'})</p>
        <input id="pwdField" type="password" style="width:100%;margin-bottom:1rem;" />
        <div class="flex" style="justify-content:flex-end;">
          <button class="btn secondary" id="cancelPwd">Ø¥Ù„ØºØ§Ø¡</button>
          <button class="btn" id="confirmPwd">ØªØ£ÙƒÙŠØ¯</button>
        </div>
      </div>`;
      overlay.classList.add('active');
      const closeModal=()=>overlay.classList.remove('active');
      document.getElementById('cancelPwd').onclick=()=>{
        closeModal();
      };
      document.getElementById('confirmPwd').onclick=async()=>{
        const value=document.getElementById('pwdField').value;
        if(await verifyPassword(type,value)){
          PasswordGuard.failed[type]=0;
          closeModal();
          await logAudit('security-pass',`PWD-${type}`,'ØªÙ… Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±');
          cb();
        }else{
          PasswordGuard.failed[type]=(PasswordGuard.failed[type]||0)+1;
          await logAudit('security-fail',`PWD-${type}`,'Ù…Ø­Ø§ÙˆÙ„Ø© ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± ÙØ§Ø´Ù„Ø©',{attempts:PasswordGuard.failed[type]});
          showToast('ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø©','error');
          if(PasswordGuard.failed[type]>=MAX_FAILED_ATTEMPTS){
            PasswordGuard.lockedUntil[type]=Date.now()+LOCK_DURATION_MS;
            PasswordGuard.failed[type]=0;
            await logAudit('security-lock',`PWD-${type}`,'ØªÙ… Ù‚ÙÙ„ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø¤Ù‚ØªÙ‹Ø§',{lockedUntil:new Date(PasswordGuard.lockedUntil[type]).toISOString()});
            showToast('ØªÙ… Ù‚ÙÙ„ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø¤Ù‚ØªÙ‹Ø§ Ø¨Ø¹Ø¯ Ù…Ø­Ø§ÙˆÙ„Ø§Øª Ù…ØªÙƒØ±Ø±Ø©','error');
            closeModal();
          }
        }
      };
      overlay.addEventListener('click',e=>{if(e.target.id==='modalOverlay')overlay.classList.remove('active');},{once:true});
    }

    function guardSensitive(cb){
      if(!App.sensitive){
        showToast('ÙØ¹Ù‘Ù„ Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ø­Ø³Ø§Ø³ Ø£ÙˆÙ„Ø§Ù‹','error');
        return;
      }
      promptPassword('danger',cb);
    }

    async function logAudit(action,reference,description,payload={}){
      const log=await Storage.load('audit');
      log.push({id:Date.now(),action,reference,description,payload,user:App.role,timestamp:new Date().toISOString()});
      await Storage.save('audit',log);
    }

    function computeLedgerTotals(journals){
      return journals.reduce((acc,j)=>{
        j.entries.forEach(e=>{
          acc.debit+=e.debit||0;
          acc.credit+=e.credit||0;
        });
        return acc;
      },{debit:0,credit:0});
    }

    async function recordJournal(entries,meta){
      const debit=entries.reduce((s,e)=>s+(e.debit||0),0);
      const credit=entries.reduce((s,e)=>s+(e.credit||0),0);
      if(Math.abs(debit-credit)>0.01){
        showToast('Ø§Ù„Ù‚ÙŠØ¯ ØºÙŠØ± Ù…ØªÙˆØ§Ø²Ù†','error');
        throw new Error('unbalanced');
      }
      const journals=await Storage.load('journals');
      let createdAt=new Date().toISOString();
      if(meta&&meta.date){
        const parsed=new Date(meta.date);
        if(!isNaN(parsed.getTime())){
          createdAt=parsed.toISOString();
        }
      }
      const doc={id:generateReference('JV'),entries,meta:{...meta},createdAt};
      const prospective=[...journals,doc];
      const totals=computeLedgerTotals(prospective);
      const imbalance=Math.abs(totals.debit-totals.credit);
      if(imbalance>0.05){
        showToast('ØªØ­Ø°ÙŠØ±: Ø¯ÙØªØ± Ø§Ù„ÙŠÙˆÙ…ÙŠØ© ØºÙŠØ± Ù…ØªØ²Ù† Ø¨Ø¹Ø¯ Ù‡Ø°Ø§ Ø§Ù„Ù‚ÙŠØ¯','error');
        await logAudit('alert','TRIAL-IMBALANCE','Ù…Ø­Ø§ÙˆÙ„Ø© Ø¥Ø¯Ø®Ø§Ù„ ØªØ³Ø¨Ø¨Øª ÙÙŠ Ø¹Ø¯Ù… Ø§ØªØ²Ø§Ù†',{meta,debit:totals.debit,credit:totals.credit});
        throw new Error('ledger-imbalance');
      }
      journals.push(doc);
      await Storage.save('journals',journals);
      await logAudit('add',doc.id,'Ø¥Ø¶Ø§ÙØ© Ù‚ÙŠØ¯ ÙŠÙˆÙ…ÙŠØ©',meta);
      return doc;
    }

    function Views_dashboard(){
      return `
      <div class="grid grid-2">
        <div class="card">
          <h2>ÙØªØ±Ø© Ø§Ù„ÙŠÙˆÙ… â€” ØµØ¨Ø§Ø­</h2>
          <div id="periodMorning"></div>
          <div class="flex" style="margin-top:1rem;">
            <button class="btn secondary" onclick="exportPeriodPDF('morning')">PDF</button>
            <button class="btn" onclick="closePeriod('morning')">Ø¥Ù‚ÙØ§Ù„ Ø§Ù„ÙØªØ±Ø©</button>
          </div>
        </div>
        <div class="card">
          <h2>ÙØªØ±Ø© Ø§Ù„ÙŠÙˆÙ… â€” Ù…Ø³Ø§Ø¡</h2>
          <div id="periodEvening"></div>
          <div class="flex" style="margin-top:1rem;">
            <button class="btn secondary" onclick="exportPeriodPDF('evening')">PDF</button>
            <button class="btn" onclick="closePeriod('evening')">Ø¥Ù‚ÙØ§Ù„ Ø§Ù„ÙØªØ±Ø©</button>
          </div>
        </div>
        <div class="card">
          <h2>Ø§Ù„Ù…ÙŠØ²Ø§Ù† Ø§Ù„Ù…ØµØºÙ‘Ø±</h2>
          <div id="miniTrial"></div>
          <div class="flex" style="margin-top:1rem;">
            <button class="btn" onclick="refreshMiniTrial()">ØªØ­Ø¯ÙŠØ«</button>
            <button class="btn secondary" onclick="miniTrialPDF()">PDF</button>
          </div>
        </div>
        <div class="card">
          <h2>Ù…ÙˆØ§Ø¹ÙŠØ¯ Ø§Ù„ØºØ¯</h2>
          <div id="appointmentsTomorrow"></div>
          <button class="btn secondary" style="margin-top:1rem;" onclick="appointmentsPDF()">PDF</button>
        </div>
        <div class="card">
          <h2>Ø§Ù„Ù…Ø®Ø²ÙˆÙ†</h2>
          <div id="inventoryAlerts"></div>
          <button class="btn secondary" style="margin-top:1rem;" onclick="inventoryAlertsPDF()">PDF</button>
        </div>
      </div>`;
    }
    Views.dashboard=Views_dashboard;

    function Views_vouchers(){
      return `
      <div class="card">
        <h2>Ø§Ù„Ø³Ù†Ø¯Ø§Øª Ø§Ù„Ù…Ø§Ù„ÙŠØ©</h2>
        <div class="grid grid-2">
          <div data-voucher-section="type"><label>Ù†ÙˆØ¹ Ø§Ù„Ø³Ù†Ø¯</label><select id="voucherType" onchange="onVoucherTypeChange()">
            <option value="receipt-service">Ù‚Ø¨Ø¶ Ø®Ø¯Ù…Ø©</option>
            <option value="receipt-settlement">ØªØ³ÙˆÙŠØ© Ø°Ù…Ù… Ù…Ø±Ø¶Ù‰</option>
            <option value="receipt-deposit">Ø£Ù…Ø§Ù†Ø§Øª Ù…Ø±Ø¶Ù‰</option>
            <option value="receipt-deposit-apply">Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø£Ù…Ø§Ù†Ø©</option>
            <option value="payment-invoice">ØµØ±Ù Ù„Ù…ÙˆØ±Ø¯</option>
            <option value="payment-advance">Ø³Ù„ÙØ© Ù…ÙˆØ±Ø¯</option>
          </select></div>
          <div data-voucher-section="receipt"><label>Ø§Ù„Ù…Ø±ÙŠØ¶</label><select id="receiptPatient"></select></div>
          <div data-voucher-section="receipt-service"><label>Ø§Ù„Ø®Ø¯Ù…Ø©</label><input id="receiptService" list="clinicServiceList" /></div>
          <div data-voucher-section="receipt-service"><label>Ø§Ù„Ø·Ø¨ÙŠØ¨</label><input id="receiptDoctor" list="doctorList" /></div>
          <div data-voucher-section="payment"><label>Ø§Ù„Ù…ÙˆØ±Ø¯/Ø§Ù„Ù…Ø¹Ù…Ù„</label><input id="paymentSupplier" oninput="debounced(()=>renderPaymentOutstanding())" /></div>
          <div data-voucher-section="amount"><label>Ø§Ù„Ù…Ø¨Ù„Øº</label><input id="voucherAmount" type="number" min="0" step="0.05" /></div>
          <div data-voucher-section="account"><label id="voucherAccountLabel">Ø­Ø³Ø§Ø¨ Ø§Ù„ØªØ­ØµÙŠÙ„</label><select id="voucherAccount"></select></div>
          <div data-voucher-section="notes"><label>Ù…Ù„Ø§Ø­Ø¸Ø§Øª</label><textarea id="voucherNotes"></textarea></div>
          <div data-voucher-section="attachment"><label>Ù…Ø±ÙÙ‚Ø§Øª</label><input type="file" id="voucherAttachment" accept="image/*,.pdf" /></div>
        </div>
        <div class="flex" style="margin-top:1rem;justify-content:flex-end;">
          <button class="btn" onclick="saveVoucher()">Ø­ÙØ¸</button>
          <button class="btn secondary" onclick="downloadVoucherPDF()">PDF</button>
        </div>
      </div>
      <div class="card" id="voucherContextCard">
        <div id="receiptOutstandingCard">
          <h3>Ø°Ù…Ù… ÙˆØ£Ù…Ø§Ù†Ø§Øª Ø§Ù„Ù…Ø±ÙŠØ¶</h3>
          <div id="receiptOutstanding"></div>
        </div>
        <div id="paymentOutstandingCard">
          <h3>Ø°Ù…Ù… Ø§Ù„Ù…ÙˆØ±Ø¯ Ø§Ù„Ù…Ø®ØªØ§Ø±</h3>
          <div id="paymentOutstanding"></div>
        </div>
      </div>
      <div class="card">
        <div class="flex" style="justify-content:space-between;align-items:center;">
          <h2>Ø¢Ø®Ø± Ø§Ù„Ø³Ù†Ø¯Ø§Øª</h2>
          <input id="voucherSearch" placeholder="Ø¨Ø­Ø« Ø¨Ø§Ù„Ù…Ø±Ø¬Ø¹" oninput="debounced(()=>renderVoucherTable())" />
        </div>
        <table>
          <thead><tr><th>Ø§Ù„Ù…Ø±Ø¬Ø¹</th><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>Ø§Ù„Ù†ÙˆØ¹</th><th>Ø§Ù„Ø·Ø±Ù</th><th>Ø§Ù„Ù…Ø¨Ù„Øº</th><th>Ø§Ù„Ø­Ø§Ù„Ø©</th><th>Ø®ÙŠØ§Ø±Ø§Øª</th></tr></thead>
          <tbody id="voucherTable"></tbody>
        </table>
      </div>`;
    }
    Views.vouchers=Views_vouchers;

    function Views_journal(){
      return `
      <div class="card">
        <div class="flex" style="justify-content:space-between;align-items:center;">
          <h2>Ø¯ÙØªØ± Ø§Ù„ÙŠÙˆÙ…ÙŠØ©</h2>
          <div class="flex">
            <input id="journalFilter" placeholder="Ø¨Ø­Ø«" oninput="debounced(()=>renderJournalTable())" />
            <button class="btn secondary" onclick="journalPDF()">PDF</button>
          </div>
        </div>
        <table>
          <thead><tr><th>Ø§Ù„Ù…Ø±Ø¬Ø¹</th><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>Ø§Ù„ÙˆØµÙ</th><th>Ø§Ù„Ù‚ÙŠÙˆØ¯</th></tr></thead>
          <tbody id="journalTable"></tbody>
        </table>
      </div>`;
    }
    Views.journal=Views_journal;

    function Views_patients(){
      return `
      <div class="card">
        <h2>Ù…Ø±ÙŠØ¶ Ø¬Ø¯ÙŠØ¯</h2>
        <div class="grid grid-2">
          <div><label>Ø§Ù„Ø§Ø³Ù…</label><input id="patientName" /></div>
          <div><label>Ø§Ù„Ù‡Ø§ØªÙ</label><input id="patientPhone" /></div>
          <div><label>Ø£Ù…Ø§Ù†Ø§Øª</label><input id="patientDeposit" type="number" min="0" step="0.05" /></div>
          <div><label>Ù…Ù„Ø§Ø­Ø¸Ø§Øª</label><textarea id="patientNotes"></textarea></div>
        </div>
        <div class="flex" style="margin-top:1rem;justify-content:flex-end;">
          <button class="btn" onclick="savePatient()">Ø­ÙØ¸</button>
        </div>
      </div>
      <div class="card">
        <div class="flex" style="justify-content:space-between;align-items:center;">
          <h2>Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø±Ø¶Ù‰</h2>
          <button class="btn secondary" onclick="patientsAgingPDF()">PDF Ø£Ø¹Ù…Ø§Ø± Ø§Ù„Ø°Ù…Ù…</button>
        </div>
        <table>
          <thead><tr><th>Ø§Ù„Ø§Ø³Ù…</th><th>Ø§Ù„Ù‡Ø§ØªÙ</th><th>Ø§Ù„Ø±ØµÙŠØ¯</th><th>Ø§Ù„Ø£Ù…Ø§Ù†Ø§Øª</th><th>ØªÙ†Ø¨ÙŠÙ‡Ø§Øª</th><th>Ø®ÙŠØ§Ø±Ø§Øª</th></tr></thead>
          <tbody id="patientTable"></tbody>
        </table>
      </div>
      <div class="card">
        <h2>Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„Ø³Ù†ÙŠ Ù„Ù„Ù…Ø±ÙŠØ¶</h2>
        <div class="grid grid-2">
          <div><label>Ø§Ù„Ù…Ø±ÙŠØ¶</label><select id="dentalPatient"></select></div>
          <div><label>Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„Ø³Ø¬Ù„</label><textarea id="dentalNotes"></textarea></div>
        </div>
        <div id="dentalChart" style="margin-top:1rem;"></div>
        <div class="flex" style="margin-top:1rem;justify-content:flex-end;">
          <button class="btn" onclick="saveDentalChart()">Ø­ÙØ¸ Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„Ø³Ù†ÙŠ</button>
        </div>
      </div>
      <div class="card">
        <h2>Ø°Ù…Ù… Ø§Ù„Ù…Ø±Ø¶Ù‰</h2>
        <div class="grid grid-2">
          <div><label>Ø§Ù„Ù…Ø±ÙŠØ¶</label><select id="receivablePatient"></select></div>
          <div><label>Ø§Ù„Ø®Ø¯Ù…Ø©</label><input id="receivableService" list="clinicServiceList" /></div>
          <div><label>Ø§Ù„Ø·Ø¨ÙŠØ¨</label><input id="receivableDoctor" list="doctorList" /></div>
          <div><label>Ø§Ù„Ù…Ø¨Ù„Øº</label><input id="receivableAmount" type="number" min="0" step="0.05" /></div>
          <div><label>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ø³ØªØ­Ù‚Ø§Ù‚</label><input id="receivableDue" type="date" /></div>
          <div><label>Ù…Ù„Ø§Ø­Ø¸Ø§Øª</label><textarea id="receivableNotes"></textarea></div>
        </div>
        <div class="flex" style="margin-top:1rem;justify-content:flex-end;">
          <button class="btn" onclick="savePatientReceivable()">ØªØ³Ø¬ÙŠÙ„ Ø°Ù…Ø©</button>
        </div>
        <table style="margin-top:1.5rem;">
          <thead><tr><th>Ø§Ù„Ù…Ø±Ø¬Ø¹</th><th>Ø§Ù„Ù…Ø±ÙŠØ¶</th><th>Ø§Ù„Ø®Ø¯Ù…Ø©</th><th>Ø§Ù„Ø·Ø¨ÙŠØ¨</th><th>Ø§Ù„Ù…Ø¨Ù„Øº</th><th>Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ</th><th>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ø³ØªØ­Ù‚Ø§Ù‚</th><th>Ø§Ù„Ø­Ø§Ù„Ø©</th></tr></thead>
          <tbody id="patientReceivableTable"></tbody>
        </table>
      </div>
      <div class="card">
        <h2>Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª Ø§Ù„Ø·Ø¨ÙŠØ©</h2>
        <div class="grid grid-2">
          <div><label>Ø§Ù„Ù…Ø±ÙŠØ¶</label><select id="alertPatient"></select></div>
          <div><label>Ù†ÙˆØ¹ Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡</label><input id="alertType" placeholder="Ø­Ø³Ø§Ø³ÙŠØ©ØŒ Ù…Ø±Ø¶ Ù…Ø²Ù…Ù†..." /></div>
          <div><label>Ø§Ù„Ø®Ø·ÙˆØ±Ø©</label><select id="alertSeverity"><option value="low">Ù…Ù†Ø®ÙØ¶</option><option value="medium">Ù…ØªÙˆØ³Ø·</option><option value="high">Ù…Ø±ØªÙØ¹</option></select></div>
          <div><label>Ù…Ù„Ø§Ø­Ø¸Ø§Øª</label><textarea id="alertNotes"></textarea></div>
        </div>
        <div class="flex" style="margin-top:1rem;justify-content:flex-end;">
          <button class="btn" onclick="saveMedicalAlert()">Ø¥Ø¶Ø§ÙØ© ØªÙ†Ø¨ÙŠÙ‡</button>
        </div>
        <div id="medicalAlertsList" style="margin-top:1rem;"></div>
      </div>`;
    }
    Views.patients=Views_patients;

    function Views_appointments(){
      return `
      <div class="card">
        <h2>Ø­Ø¬Ø² Ù…ÙˆØ¹Ø¯</h2>
        <div class="grid grid-2">
          <div><label>Ø§Ù„Ù…Ø±ÙŠØ¶</label><select id="appointmentPatient"></select></div>
          <div><label>Ø§Ù„Ø®Ø¯Ù…Ø©</label><input id="appointmentService" list="clinicServiceList" /></div>
          <div><label>Ø§Ù„Ø·Ø¨ÙŠØ¨</label><input id="appointmentDoctor" list="doctorList" /></div>
          <div><label>Ø§Ù„ØªØ§Ø±ÙŠØ®</label><input id="appointmentDate" type="datetime-local" /></div>
          <div><label>Ø§Ù„ÙØªØ±Ø©</label><select id="appointmentPeriod"><option value="morning">ØµØ¨Ø§Ø­</option><option value="evening">Ù…Ø³Ø§Ø¡</option></select></div>
          <div><label>Ø§Ù„Ø­Ø§Ù„Ø©</label><select id="appointmentStatus"><option value="scheduled">Ù…Ø¬Ø¯ÙˆÙ„</option><option value="in-progress">Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°</option><option value="completed">ØªÙ…</option><option value="cancelled">Ù…Ù„ØºÙŠ</option></select></div>
          <div><label>Ø§Ù„Ù…Ø¯ÙÙˆØ¹</label><input id="appointmentPaid" type="number" min="0" step="0.05" /></div>
          <div><label>Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ</label><input id="appointmentDue" type="number" min="0" step="0.05" /></div>
          <div class="full"><label>Ù…Ù„Ø§Ø­Ø¸Ø§Øª</label><textarea id="appointmentNotes"></textarea></div>
        </div>
        <div class="flex" style="margin-top:1rem;justify-content:flex-end;">
          <button class="btn" onclick="saveAppointment()">Ø­ÙØ¸ Ø§Ù„Ù…ÙˆØ¹Ø¯</button>
        </div>
      </div>
      <div class="card">
        <div class="flex" style="justify-content:space-between;align-items:center;">
          <h2>Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…ÙˆØ§Ø¹ÙŠØ¯</h2>
          <div class="flex">
            <select id="appointmentFilterDoctor" onchange="renderAppointmentsTable()"><option value="">ÙƒÙ„ Ø§Ù„Ø£Ø·Ø¨Ø§Ø¡</option></select>
            <select id="appointmentFilterStatus" onchange="renderAppointmentsTable()"><option value="">ÙƒÙ„ Ø§Ù„Ø­Ø§Ù„Ø§Øª</option><option value="scheduled">Ù…Ø¬Ø¯ÙˆÙ„</option><option value="in-progress">Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°</option><option value="completed">ØªÙ…</option><option value="cancelled">Ù…Ù„ØºÙŠ</option></select>
          </div>
        </div>
        <table>
          <thead><tr><th>Ø§Ù„Ù…Ø±ÙŠØ¶</th><th>Ø§Ù„Ø®Ø¯Ù…Ø©</th><th>Ø§Ù„Ø·Ø¨ÙŠØ¨</th><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>Ø§Ù„Ø­Ø§Ù„Ø©</th><th>Ø§Ù„Ù…Ø¨Ø§Ù„Øº</th><th>Ø®ÙŠØ§Ø±Ø§Øª</th></tr></thead>
          <tbody id="appointmentsTable"></tbody>
        </table>
      </div>`;
    }
    Views.appointments=Views_appointments;

    function Views_suppliers(){
      return `
      <div class="card">
        <h2>ÙØ§ØªÙˆØ±Ø© Ù…Ø´ØªØ±ÙŠØ§Øª</h2>
        <div class="grid grid-2">
          <div><label>Ø§Ù„Ù…ÙˆØ±Ø¯</label><input id="invoiceSupplier" /></div>
          <div><label>Ø¥Ù„Ù‰ Ø§Ù„Ù…Ø®Ø²ÙˆÙ†ØŸ</label><select id="invoiceToStock"><option value="yes">Ù†Ø¹Ù…</option><option value="no">Ø§Ø³ØªÙ‡Ù„Ø§Ùƒ</option></select></div>
          <div><label>Ø§Ù„Ù‚ÙŠÙ…Ø©</label><input id="invoiceAmount" type="number" min="0" step="0.05" /></div>
          <div><label>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ø³ØªØ­Ù‚Ø§Ù‚</label><input id="invoiceDueDate" type="date" /></div>
          <div class="full" id="invoiceItemsWrapper">
            <label>Ø¨Ù†ÙˆØ¯ Ø§Ù„Ù…Ø®Ø²ÙˆÙ†</label>
            <div id="invoiceItems" class="purchase-items"></div>
            <button class="btn secondary" type="button" style="margin-top:.75rem;" onclick="addPurchaseItemRow()">Ø¥Ø¶Ø§ÙØ© Ø¨Ù†Ø¯</button>
          </div>
          <div><label>Ù…Ù„Ø§Ø­Ø¸Ø§Øª</label><textarea id="invoiceNotes"></textarea></div>
        </div>
        <div class="flex" style="margin-top:1rem;justify-content:flex-end;">
          <button class="btn" onclick="savePurchaseInvoice()">Ø­ÙØ¸</button>
        </div>
      </div>
      <div class="card">
        <div class="flex" style="justify-content:space-between;align-items:center;">
          <h2>Ø°Ù…Ù… Ø§Ù„Ù…ÙˆØ±Ø¯ÙŠÙ†</h2>
          <button class="btn secondary" onclick="supplierAgingPDF()">PDF Ø£Ø¹Ù…Ø§Ø± Ø§Ù„Ø°Ù…Ù…</button>
        </div>
        <div id="supplierPayables"></div>
      </div>
      <div class="card">
        <h2>Ù…Ø±ØªØ¬Ø¹Ø§Øª Ù…Ø¤Ø¬Ù„Ø©</h2>
        <div class="grid grid-2">
          <div><label>Ø§Ù„Ù…ÙˆØ±Ø¯</label><input id="returnSupplier" /></div>
          <div><label>Ø§Ù„Ù‚ÙŠÙ…Ø©</label><input id="returnAmount" type="number" min="0" step="0.05" /></div>
          <div><label>Ø§Ù„Ø­Ø§Ù„Ø©</label><select id="returnStatus"><option value="pending">Pending</option><option value="settled">Settled</option></select></div>
          <div><label>Ù…Ù„Ø§Ø­Ø¸Ø§Øª</label><textarea id="returnNotes"></textarea></div>
        </div>
        <div class="flex" style="margin-top:1rem;justify-content:flex-end;">
          <button class="btn" onclick="saveSupplierReturn()">Ø­ÙØ¸</button>
        </div>
        <table style="margin-top:1.5rem;">
          <thead><tr><th>Ø§Ù„Ù…Ø±Ø¬Ø¹</th><th>Ø§Ù„Ù…ÙˆØ±Ø¯</th><th>Ø§Ù„Ù‚ÙŠÙ…Ø©</th><th>Ø§Ù„Ø­Ø§Ù„Ø©</th><th>Ø®ÙŠØ§Ø±Ø§Øª</th></tr></thead>
          <tbody id="returnsTable"></tbody>
        </table>
      </div>`;
    }
    Views.suppliers=Views_suppliers;

    function Views_labs(){
      return `
      <div class="card">
        <h2>Ø·Ù„Ø¨ Ù…Ø¹Ù…Ù„</h2>
        <div class="grid grid-2">
          <div><label>Ø§Ù„Ù…Ø±ÙŠØ¶</label><input id="labPatient" /></div>
          <div><label>Ø§Ù„Ø·Ø¨ÙŠØ¨</label><input id="labDoctor" list="doctorList" /></div>
          <div><label>Ø§Ù„Ù…Ø¹Ù…Ù„</label><input id="labPartner" list="labPartnerList" /></div>
          <div><label>Ø§Ù„Ø®Ø¯Ù…Ø©</label><input id="labService" list="labServiceList" /></div>
          <div><label>Ø¹Ø¯Ø¯ Ø§Ù„Ù‚Ø·Ø¹</label><input id="labUnits" type="number" min="1" value="1" /></div>
          <div><label>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥Ø±Ø³Ø§Ù„</label><input id="labSent" type="date" /></div>
          <div><label>ØªØ§Ø±ÙŠØ® Ù…ØªÙˆÙ‚Ø¹</label><input id="labExpected" type="date" /></div>
          <div><label>Ø§Ù„ØªÙƒÙ„ÙØ©</label><input id="labCost" type="number" min="0" step="0.05" /></div>
          <div><label>Ø§Ù„Ø­Ø§Ù„Ø©</label><select id="labStatus">
            <option value="requested">Ù…Ø·Ù„ÙˆØ¨</option>
            <option value="in-progress">Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°</option>
            <option value="delayed">Ù…ØªØ£Ø®Ø±</option>
            <option value="done">ØªÙ…</option>
            <option value="cancelled">Ù…Ù„ØºÙŠ</option>
            <option value="transferred">Ù…Ø­ÙˆÙ‘Ù„</option>
          </select></div>
          <div><label>Ù…Ù„Ù Ø§Ù„Ù†ØªÙŠØ¬Ø©</label><input type="file" id="labResultFile" accept="image/*,.pdf" /></div>
          <div class="full"><label>Ù…Ù„Ø§Ø­Ø¸Ø§Øª</label><textarea id="labNotes"></textarea></div>
          <div class="full"><label>Ù†ØªÙŠØ¬Ø©/ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù…Ø¹Ù…Ù„</label><textarea id="labResult"></textarea></div>
        </div>
        <div class="flex" style="margin-top:1rem;justify-content:flex-end;">
          <button class="btn" onclick="saveLabOrder()">Ø­ÙØ¸</button>
          <button class="btn secondary" onclick="labSummaryPDF()">PDF</button>
        </div>
      </div>
      <div class="card">
        <div class="flex" style="justify-content:space-between;align-items:center;">
          <h2>Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…Ø¹Ù…Ù„</h2>
          <div id="labStats" class="badge">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>
        </div>
        <table>
          <thead><tr><th>Ø§Ù„Ù…Ø±Ø¬Ø¹</th><th>Ø§Ù„Ù…Ø±ÙŠØ¶</th><th>Ø§Ù„Ø®Ø¯Ù…Ø©</th><th>Ø§Ù„Ù…Ø¹Ù…Ù„</th><th>Ø§Ù„Ø­Ø§Ù„Ø©</th><th>Ø§Ù„ØªÙƒÙ„ÙØ©</th><th>Ø§Ù„Ù†ØªÙŠØ¬Ø©</th><th>Ø®ÙŠØ§Ø±Ø§Øª</th></tr></thead>
          <tbody id="labsTable"></tbody>
        </table>
      </div>`;
    }
    Views.labs=Views_labs;

    function Views_inventory(){
      return `
      <div class="card">
        <h2>Ø¨Ø·Ø§Ù‚Ø© Ù…Ø§Ø¯Ø©</h2>
        <div class="grid grid-2">
          <div><label>Ø§Ù„Ø§Ø³Ù…</label><input id="itemName" /></div>
          <div><label>Ø§Ù„ÙƒÙ…ÙŠØ© (ØªØ­Ø¯ÙŠØ« Ø¢Ù„ÙŠ)</label><input id="itemQty" type="number" min="0" readonly /></div>
          <div><label>Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¯Ù†Ù‰</label><input id="itemMin" type="number" min="0" /></div>
          <div><label>ØªØ§Ø±ÙŠØ® Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ©</label><input id="itemExpiry" type="date" /></div>
        </div>
        <div class="flex" style="margin-top:1rem;justify-content:flex-end;">
          <button class="btn" onclick="saveInventoryItem()">Ø­ÙØ¸</button>
        </div>
      </div>
      <div class="card">
        <h2>ØªØ³Ø¬ÙŠÙ„ Ø§Ø³ØªÙ‡Ù„Ø§Ùƒ Ø§Ù„Ù…Ø®Ø²ÙˆÙ†</h2>
        <div class="grid grid-2">
          <div><label>Ø§Ù„Ù…Ø§Ø¯Ø©</label><input id="consumeItem" list="inventoryItemList" /></div>
          <div><label>Ø§Ù„ÙƒÙ…ÙŠØ©</label><input id="consumeQty" type="number" min="0" step="0.01" /></div>
          <div><label>Ø§Ù„Ø®Ø¯Ù…Ø©</label><input id="consumeService" list="clinicServiceList" /></div>
          <div><label>Ø§Ù„Ø·Ø¨ÙŠØ¨</label><input id="consumeDoctor" list="doctorList" /></div>
          <div><label>Ù…Ø±ÙƒØ² Ø§Ù„ØªÙƒÙ„ÙØ©</label><input id="consumeCenter" placeholder="Ø¹ÙŠØ§Ø¯Ø©/Ù‚Ø³Ù…" /></div>
          <div><label>Ù…Ù„Ø§Ø­Ø¸Ø§Øª</label><textarea id="consumeNotes"></textarea></div>
        </div>
        <div class="flex" style="margin-top:1rem;justify-content:flex-end;">
          <button class="btn" onclick="recordInventoryConsumption()">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø§Ø³ØªÙ‡Ù„Ø§Ùƒ</button>
        </div>
        <div id="inventoryConsumptionHistory" style="margin-top:1rem;"></div>
      </div>
      <div class="card">
        <div class="flex" style="justify-content:space-between;align-items:center;">
          <h2>Ø§Ù„Ù…ÙˆØ§Ø¯</h2>
          <button class="btn secondary" onclick="inventoryPDF()">PDF</button>
        </div>
        <table>
          <thead><tr><th>Ø§Ù„Ø§Ø³Ù…</th><th>Ø§Ù„ÙƒÙ…ÙŠØ©</th><th>Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¯Ù†Ù‰</th><th>Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ©</th><th>ØªÙ†Ø¨ÙŠÙ‡</th><th>Ø®ÙŠØ§Ø±Ø§Øª</th></tr></thead>
          <tbody id="inventoryTable"></tbody>
        </table>
      </div>`;
    }
    Views.inventory=Views_inventory;

    function Views_master(){
      return `
      <div class="card">
        <h2>Ø§Ù„Ù…ÙˆØ¸ÙÙˆÙ†</h2>
        <div class="grid grid-2">
          <div><label>Ø§Ù„Ø§Ø³Ù…</label><input id="employeeName" /></div>
          <div><label>Ø§Ù„Ù…Ø³Ù…Ù‰ Ø§Ù„ÙˆØ¸ÙŠÙÙŠ</label><input id="employeeRole" /></div>
          <div><label>Ø§Ù„Ù‡Ø§ØªÙ</label><input id="employeePhone" /></div>
          <div><label>Ø§Ù„Ø±Ø§ØªØ¨ Ø§Ù„Ø´Ù‡Ø±ÙŠ</label><input id="employeeSalary" type="number" min="0" step="0.5" /></div>
          <div><label>ØªØ§Ø±ÙŠØ® Ø¨Ø¯Ø¡ Ø§Ù„Ø¹Ù…Ù„</label><input id="employeeStart" type="date" /></div>
          <div><label>Ù…Ù„Ø§Ø­Ø¸Ø§Øª</label><textarea id="employeeNotes"></textarea></div>
        </div>
        <div class="flex" style="margin-top:1rem;justify-content:flex-end;">
          <button class="btn" onclick="saveEmployee()">Ø­ÙØ¸ Ø§Ù„Ù…ÙˆØ¸Ù</button>
        </div>
        <table style="margin-top:1.5rem;">
          <thead><tr><th>Ø§Ù„Ø§Ø³Ù…</th><th>Ø§Ù„ÙˆØ¸ÙŠÙØ©</th><th>Ø§Ù„Ù‡Ø§ØªÙ</th><th>Ø§Ù„Ø±Ø§ØªØ¨</th><th>Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ø¹Ù…Ù„</th><th>Ø®ÙŠØ§Ø±Ø§Øª</th></tr></thead>
          <tbody id="employeesTable"></tbody>
        </table>
      </div>
      <div class="card">
        <h2>Ø§Ù„Ù…Ø¹Ø§Ù…Ù„ Ø§Ù„Ù…ØªØ¹Ø§ÙˆÙ†Ø©</h2>
        <div class="grid grid-2">
          <div><label>Ø§Ø³Ù… Ø§Ù„Ù…Ø¹Ù…Ù„</label><input id="labMasterName" /></div>
          <div><label>Ø§Ù„Ù‡Ø§ØªÙ</label><input id="labMasterPhone" /></div>
          <div class="full"><label>Ù…Ù„Ø§Ø­Ø¸Ø§Øª</label><textarea id="labMasterNotes"></textarea></div>
        </div>
        <div class="flex" style="margin-top:1rem;justify-content:flex-end;">
          <button class="btn" onclick="saveLabPartner()">Ø­ÙØ¸ Ø§Ù„Ù…Ø¹Ù…Ù„</button>
        </div>
        <table style="margin-top:1.5rem;">
          <thead><tr><th>Ø§Ù„Ø§Ø³Ù…</th><th>Ø§Ù„Ù‡Ø§ØªÙ</th><th>Ù…Ù„Ø§Ø­Ø¸Ø§Øª</th><th>Ø®ÙŠØ§Ø±Ø§Øª</th></tr></thead>
          <tbody id="labPartnersTable"></tbody>
        </table>
      </div>
      <div class="card">
        <h2>ÙƒØªØ§Ù„ÙˆØ¬ Ø®Ø¯Ù…Ø§Øª Ø§Ù„Ø¹ÙŠØ§Ø¯Ø©</h2>
        <div class="grid grid-2">
          <div><label>Ø§Ù„Ù‚Ø³Ù…</label><input id="clinicServiceDepartment" /></div>
          <div><label>Ø§Ù„Ø®Ø¯Ù…Ø©</label><input id="clinicServiceName" /></div>
          <div><label>Ø§Ù„Ø³Ø¹Ø±</label><input id="clinicServicePrice" type="number" min="0" step="0.5" /></div>
          <div class="full"><label>Ù…Ù„Ø§Ø­Ø¸Ø§Øª</label><textarea id="clinicServiceNotes"></textarea></div>
        </div>
        <div class="flex" style="margin-top:1rem;justify-content:flex-end;gap:.75rem;flex-wrap:wrap;">
          <button class="btn" onclick="saveClinicService()">Ø­ÙØ¸ Ø§Ù„Ø®Ø¯Ù…Ø©</button>
          <button class="btn secondary" onclick="exportClinicCatalog()">ØªØµØ¯ÙŠØ± CSV</button>
          <label class="btn secondary" style="cursor:pointer;">
            Ø§Ø³ØªÙŠØ±Ø§Ø¯ CSV
            <input type="file" id="clinicCatalogImport" accept=".csv" style="display:none;" onchange="importClinicCatalog(event)" />
          </label>
        </div>
        <table style="margin-top:1.5rem;">
          <thead><tr><th>Ø§Ù„Ù‚Ø³Ù…</th><th>Ø§Ù„Ø®Ø¯Ù…Ø©</th><th>Ø§Ù„Ø³Ø¹Ø±</th><th>Ù…Ù„Ø§Ø­Ø¸Ø§Øª</th><th>Ø®ÙŠØ§Ø±Ø§Øª</th></tr></thead>
          <tbody id="clinicCatalogTable"></tbody>
        </table>
      </div>
      <div class="card">
        <h2>ÙƒØªØ§Ù„ÙˆØ¬ Ø®Ø¯Ù…Ø§Øª Ø§Ù„Ù…Ø¹Ù…Ù„</h2>
        <div class="grid grid-2">
          <div><label>Ø§Ù„Ø®Ø¯Ù…Ø©</label><input id="labCatalogService" /></div>
          <div><label>Ø§Ù„Ù…Ø¹Ù…Ù„</label><input id="labCatalogLab" list="labPartnerList" /></div>
          <div><label>Ø§Ù„Ø³Ø¹Ø±</label><input id="labCatalogPrice" type="number" min="0" step="0.5" /></div>
          <div class="full"><label>Ù…Ù„Ø§Ø­Ø¸Ø§Øª</label><textarea id="labCatalogNotes"></textarea></div>
        </div>
        <div class="flex" style="margin-top:1rem;justify-content:flex-end;">
          <button class="btn" onclick="saveLabCatalogService()">Ø­ÙØ¸ Ø®Ø¯Ù…Ø© Ø§Ù„Ù…Ø¹Ù…Ù„</button>
        </div>
        <table style="margin-top:1.5rem;">
          <thead><tr><th>Ø§Ù„Ø®Ø¯Ù…Ø©</th><th>Ø§Ù„Ù…Ø¹Ù…Ù„</th><th>Ø§Ù„Ø³Ø¹Ø±</th><th>Ù…Ù„Ø§Ø­Ø¸Ø§Øª</th><th>Ø®ÙŠØ§Ø±Ø§Øª</th></tr></thead>
          <tbody id="labCatalogTable"></tbody>
        </table>
      </div>`;
    }
    Views.master=Views_master;

    function Views_finance(){
      return `
      <div class="card">
        <h2>Ù…ØµØ±ÙˆÙØ§Øª ØªØ´ØºÙŠÙ„ÙŠØ© Ø¯ÙˆØ±ÙŠØ©</h2>
        <div class="grid grid-2">
          <div><label>Ø§Ø³Ù… Ø§Ù„Ù…ØµØ±ÙˆÙ</label><input id="expenseName" /></div>
          <div><label>Ø§Ù„Ù‚ÙŠÙ…Ø©</label><input id="expenseAmount" type="number" min="0" step="0.05" /></div>
          <div><label>Ø§Ù„ØªÙƒØ±Ø§Ø±</label><select id="expenseFrequency"><option value="monthly">Ø´Ù‡Ø±ÙŠ</option><option value="quarterly">Ø±Ø¨Ø¹ Ø³Ù†ÙˆÙŠ</option><option value="yearly">Ø³Ù†ÙˆÙŠ</option></select></div>
          <div><label>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ø³ØªØ­Ù‚Ø§Ù‚ Ø§Ù„Ù‚Ø§Ø¯Ù…</label><input id="expenseNextDue" type="date" /></div>
          <div><label>Ù…Ø±ÙƒØ² Ø§Ù„ØªÙƒÙ„ÙØ©</label><input id="expenseCostCenter" placeholder="Ø¹ÙŠØ§Ø¯Ø© 1ØŒ Ø§Ø³ØªÙ‚Ø¨Ø§Ù„..." /></div>
        </div>
        <div class="flex" style="margin-top:1rem;justify-content:flex-end;">
          <button class="btn" onclick="saveRecurringExpense()">Ø­ÙØ¸ Ø§Ù„Ù…ØµØ±ÙˆÙ</button>
          <button class="btn secondary" onclick="postRecurringExpenses()">ØªØ±Ø­ÙŠÙ„ Ù…ØµØ±ÙˆÙØ§Øª Ù…Ø³ØªØ­Ù‚Ø©</button>
        </div>
        <table style="margin-top:1.5rem;">
          <thead><tr><th>Ø§Ù„Ù…ØµØ±ÙˆÙ</th><th>Ø§Ù„Ù‚ÙŠÙ…Ø©</th><th>Ø§Ù„ØªÙƒØ±Ø§Ø±</th><th>Ø§Ù„Ø§Ø³ØªØ­Ù‚Ø§Ù‚ Ø§Ù„ØªØ§Ù„ÙŠ</th><th>Ù…Ø±ÙƒØ² Ø§Ù„ØªÙƒÙ„ÙØ©</th><th>Ø­Ø§Ù„Ø©</th></tr></thead>
          <tbody id="operatingExpensesTable"></tbody>
        </table>
      </div>
      <div class="card">
        <h2>Ø§Ù„Ø£ØµÙˆÙ„ Ø§Ù„Ø«Ø§Ø¨ØªØ© ÙˆØ§Ù„Ø¥Ù‡Ù„Ø§Ùƒ</h2>
        <div class="grid grid-2">
          <div><label>Ø§Ø³Ù… Ø§Ù„Ø£ØµÙ„</label><input id="assetName" /></div>
          <div><label>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø´Ø±Ø§Ø¡</label><input id="assetPurchase" type="date" /></div>
          <div><label>Ø§Ù„ØªÙƒÙ„ÙØ©</label><input id="assetCost" type="number" min="0" step="0.05" /></div>
          <div><label>Ø§Ù„Ø¹Ù…Ø± Ø§Ù„Ø¥Ù†ØªØ§Ø¬ÙŠ (Ø£Ø´Ù‡Ø±)</label><input id="assetLife" type="number" min="1" /></div>
          <div><label>Ù…Ø±ÙƒØ² Ø§Ù„ØªÙƒÙ„ÙØ©</label><input id="assetCenter" /></div>
        </div>
        <div class="flex" style="margin-top:1rem;justify-content:flex-end;">
          <button class="btn" onclick="saveFixedAsset()">Ø­ÙØ¸ Ø§Ù„Ø£ØµÙ„</button>
          <button class="btn secondary" onclick="postMonthlyDepreciation()">Ø¥Ù‡Ù„Ø§Ùƒ Ø§Ù„Ø´Ù‡Ø± Ø§Ù„Ø­Ø§Ù„ÙŠ</button>
        </div>
        <table style="margin-top:1.5rem;">
          <thead><tr><th>Ø§Ù„Ø£ØµÙ„</th><th>Ø§Ù„ØªÙƒÙ„ÙØ©</th><th>Ø§Ù„Ø¥Ù‡Ù„Ø§Ùƒ Ø§Ù„Ø´Ù‡Ø±ÙŠ</th><th>Ø§Ù„Ù…Ø¬Ù…Ø¹</th><th>Ø¢Ø®Ø± Ø´Ù‡Ø±</th><th>Ø§Ù„Ø­Ø§Ù„Ø©</th></tr></thead>
          <tbody id="fixedAssetsTable"></tbody>
        </table>
        <div id="depreciationSchedule" style="margin-top:1.5rem;"></div>
      </div>
      <div class="card">
        <h2>Ø§Ù„ØªØµØ±Ù ÙÙŠ Ø£ØµÙ„</h2>
        <div class="grid grid-2">
          <div><label>Ø§Ù„Ø£ØµÙ„</label><select id="disposalAsset"></select></div>
          <div><label>ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØµØ±Ù</label><input id="disposalDate" type="date" /></div>
          <div><label>Ù‚ÙŠÙ…Ø© Ø§Ù„Ø¨ÙŠØ¹</label><input id="disposalProceeds" type="number" min="0" step="0.05" /></div>
          <div><label>Ø­Ø³Ø§Ø¨ Ø§Ù„ØªØ­ØµÙŠÙ„</label><select id="disposalProceedsAccount"></select></div>
          <div class="full"><label>Ù…Ù„Ø§Ø­Ø¸Ø§Øª</label><textarea id="disposalNotes"></textarea></div>
        </div>
        <div class="flex" style="margin-top:1rem;justify-content:flex-end;gap:.75rem;">
          <button class="btn" onclick="disposeAsset()">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„ØªØµØ±Ù</button>
        </div>
        <table style="margin-top:1.5rem;">
          <thead><tr><th>Ø§Ù„Ù…Ø±Ø¬Ø¹</th><th>Ø§Ù„Ø£ØµÙ„</th><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>Ù‚ÙŠÙ…Ø© Ø§Ù„Ø¨ÙŠØ¹</th><th>Ù‚ÙŠÙ…Ø© Ø¯ÙØªØ±ÙŠØ©</th><th>Ø§Ù„Ù†ØªÙŠØ¬Ø©</th></tr></thead>
          <tbody id="assetDisposalsTable"></tbody>
        </table>
      </div>
      <div class="card">
        <h2>Ø¥Ù‚ÙØ§Ù„ Ø§Ù„ÙØªØ±Ø§Øª</h2>
        <div class="flex" style="gap:1rem;flex-wrap:wrap;">
          <button class="btn" onclick="closeMonth()">Ø¥Ù‚ÙØ§Ù„ Ø§Ù„Ø´Ù‡Ø±</button>
          <button class="btn" onclick="closeYear()">Ø¥Ù‚ÙØ§Ù„ Ø§Ù„Ø³Ù†Ø©</button>
        </div>
        <table style="margin-top:1.5rem;">
          <thead><tr><th>Ø§Ù„ÙØªØ±Ø©</th><th>Ø§Ù„Ù†ÙˆØ¹</th><th>Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª</th><th>Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª</th><th>ØµØ§ÙÙŠ Ø§Ù„Ø±Ø¨Ø­</th></tr></thead>
          <tbody id="periodClosingsTable"></tbody>
        </table>
      </div>`;
    }
    Views.finance=Views_finance;

    function Views_opening(){
      return `
      <div class="card">
        <div class="flex" style="justify-content:space-between;align-items:center;gap:1rem;">
          <div>
            <h2>ØªØ±Ø­ÙŠÙ„ Ø£Ø±ØµØ¯Ø© Ø§ÙØªØªØ§Ø­ÙŠØ©</h2>
            <p id="openingStatusLabel" style="margin:.25rem 0 0;font-size:.9rem;color:#4a586e;">ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø­Ø§Ù„Ø©...</p>
          </div>
          <button class="btn danger" id="btnReverseOpening" onclick="reverseOpeningBalance()">Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ØªØ±Ø­ÙŠÙ„</button>
        </div>
        <div class="grid grid-2" style="margin-top:1rem;">
          <div><label>ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØ±Ø­ÙŠÙ„</label><input type="date" id="openingDate" data-opening-input="meta" /></div>
          <div><label>Ù…Ø°ÙƒØ±Ø©</label><input id="openingMemo" data-opening-input="meta" placeholder="ÙˆØµÙ Ù…Ø®ØªØµØ± (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)" /></div>
        </div>
        <p style="margin-top:1rem;font-size:.85rem;color:#5f6f81;">Ø£Ø¯Ø®Ù„ Ø£Ø±ØµØ¯Ø© Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© Ù„Ù„ØµÙ†Ø¯ÙˆÙ‚ ÙˆØ§Ù„Ø¨Ù†Ùƒ ÙˆØ§Ù„Ù…Ø±Ø¶Ù‰ ÙˆØ§Ù„Ù…ÙˆØ±Ø¯ÙŠÙ† ÙˆØ§Ù„Ù…Ø®Ø²ÙˆÙ† Ø«Ù… Ø§Ø¶ØºØ· "ØªØ±Ø­ÙŠÙ„" Ù„Ø¥Ù†Ø´Ø§Ø¡ Ù‚ÙŠØ¯ Ø§ÙØªØªØ§Ø­ÙŠ Ù…ØªÙˆØ§Ø²Ù† ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§.</p>
      </div>
      <div class="card">
        <div class="flex" style="justify-content:space-between;align-items:center;">
          <h3>Ø§Ù„Ù†Ù‚Ø¯ÙŠØ© ÙˆØ§Ù„Ø¨Ù†ÙˆÙƒ</h3>
          <button class="btn secondary" type="button" id="openingAddCash" onclick="addOpeningCashRow()">Ø¥Ø¶Ø§ÙØ© Ø­Ø³Ø§Ø¨</button>
        </div>
        <table style="margin-top:1rem;">
          <thead><tr><th>Ø§Ù„Ø­Ø³Ø§Ø¨</th><th>Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ø§ÙØªØªØ§Ø­ÙŠ</th><th>Ø®ÙŠØ§Ø±Ø§Øª</th></tr></thead>
          <tbody id="openingCashBody"></tbody>
        </table>
      </div>
      <div class="card">
        <div class="flex" style="justify-content:space-between;align-items:center;">
          <h3>Ø°Ù…Ù… Ø§Ù„Ù…Ø±Ø¶Ù‰</h3>
          <button class="btn secondary" type="button" id="openingAddPatient" onclick="addOpeningPatientRow()">Ø¥Ø¶Ø§ÙØ© Ø°Ù…Ø©</button>
        </div>
        <table style="margin-top:1rem;">
          <thead><tr><th>Ø§Ù„Ù…Ø±ÙŠØ¶</th><th>Ø§Ù„Ù…Ø¨Ù„Øº</th><th>Ø§Ù„Ø§Ø³ØªØ­Ù‚Ø§Ù‚</th><th>Ø§Ù„ÙˆØµÙ</th><th>Ø®ÙŠØ§Ø±Ø§Øª</th></tr></thead>
          <tbody id="openingPatientBody"></tbody>
        </table>
      </div>
      <div class="card">
        <div class="flex" style="justify-content:space-between;align-items:center;">
          <h3>Ø°Ù…Ù… Ø§Ù„Ù…ÙˆØ±Ø¯ÙŠÙ†</h3>
          <button class="btn secondary" type="button" id="openingAddSupplier" onclick="addOpeningSupplierRow()">Ø¥Ø¶Ø§ÙØ© Ù…ÙˆØ±Ø¯</button>
        </div>
        <table style="margin-top:1rem;">
          <thead><tr><th>Ø§Ù„Ù…ÙˆØ±Ø¯</th><th>Ø§Ù„Ù…Ø¨Ù„Øº</th><th>Ø§Ù„Ø§Ø³ØªØ­Ù‚Ø§Ù‚</th><th>Ø§Ù„ÙˆØµÙ</th><th>Ø®ÙŠØ§Ø±Ø§Øª</th></tr></thead>
          <tbody id="openingSupplierBody"></tbody>
        </table>
      </div>
      <div class="card">
        <div class="flex" style="justify-content:space-between;align-items:center;">
          <h3>Ø§Ù„Ù…Ø®Ø²ÙˆÙ† Ø§Ù„Ø§ÙØªØªØ§Ø­ÙŠ</h3>
          <button class="btn secondary" type="button" id="openingAddInventory" onclick="addOpeningInventoryRow()">Ø¥Ø¶Ø§ÙØ© Ù…Ø§Ø¯Ø©</button>
        </div>
        <table style="margin-top:1rem;">
          <thead><tr><th>Ø§Ù„Ù…Ø§Ø¯Ø©</th><th>Ø§Ù„ÙƒÙ…ÙŠØ©</th><th>ØªÙƒÙ„ÙØ© Ø§Ù„ÙˆØ­Ø¯Ø©</th><th>Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ©</th><th>Ø®ÙŠØ§Ø±Ø§Øª</th></tr></thead>
          <tbody id="openingInventoryBody"></tbody>
        </table>
      </div>
      <div class="card">
        <div class="flex" style="justify-content:flex-end;gap:1rem;">
          <button class="btn" type="button" id="btnPostOpening" onclick="postOpeningBalance()">ØªØ±Ø­ÙŠÙ„ Ø§Ù„Ø£Ø±ØµØ¯Ø©</button>
        </div>
      </div>`;
    }
    Views.opening=Views_opening;

    function Views_doctors(){
      return `
      <div class="card">
        <h2>Ø·Ø¨ÙŠØ¨</h2>
        <div class="grid grid-2">
          <div><label>Ø§Ù„Ø§Ø³Ù…</label><input id="doctorName" /></div>
          <div><label>Ø§Ù„Ù†Ø³Ø¨Ø© (%)</label><input id="doctorShare" type="number" min="30" max="50" /></div>
        </div>
        <div class="flex" style="margin-top:1rem;justify-content:flex-end;">
          <button class="btn" onclick="saveDoctor()">Ø­ÙØ¸</button>
        </div>
      </div>
      <div class="card">
        <div class="flex" style="justify-content:space-between;align-items:center;">
          <h2>Ø±Ø¨Ø­ÙŠØ© Ø§Ù„Ø£Ø·Ø¨Ø§Ø¡</h2>
          <button class="btn secondary" onclick="doctorProfitPDF()">PDF</button>
        </div>
        <table>
          <thead><tr><th>Ø§Ù„Ø·Ø¨ÙŠØ¨</th><th>Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª</th><th>ØªÙƒÙ„ÙØ© Ø§Ù„Ù…Ø¹Ù…Ù„</th><th>Ø§Ù„Ù†Ø³Ø¨Ø©</th><th>Ù†ØµÙŠØ¨ Ø§Ù„Ø·Ø¨ÙŠØ¨</th><th>Ù…Ø³Ø§Ù‡Ù…Ø© Ø§Ù„Ø¹ÙŠØ§Ø¯Ø©</th><th>Ø®ÙŠØ§Ø±Ø§Øª</th></tr></thead>
          <tbody id="doctorTable"></tbody>
        </table>
      </div>`;
    }
    Views.doctors=Views_doctors;

    function Views_prescriptions(){
      return `
      <div class="card">
        <h2>ÙˆØµÙØ© Ø·Ø¨ÙŠØ© Ø¬Ø¯ÙŠØ¯Ø©</h2>
        <div class="grid grid-2">
          <div><label>Ø§Ù„Ù…Ø±ÙŠØ¶</label><select id="prescriptionPatient"></select></div>
          <div><label>Ø§Ù„Ø·Ø¨ÙŠØ¨</label><input id="prescriptionDoctor" list="doctorList" /></div>
          <div><label>ØªØ§Ø±ÙŠØ® Ø§Ù„ÙˆØµÙØ©</label><input id="prescriptionDate" type="date" /></div>
          <div><label>Ù…Ø¯Ø© Ø§Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… (Ø£ÙŠØ§Ù…)</label><input id="prescriptionDuration" type="number" min="1" /></div>
          <div class="full"><label>Ø§Ù„Ø£Ø¯ÙˆÙŠØ© ÙˆØ§Ù„ØªØ¹Ù„ÙŠÙ…Ø§Øª</label><textarea id="prescriptionNotes"></textarea></div>
        </div>
        <div class="flex" style="margin-top:1rem;justify-content:flex-end;">
          <button class="btn" onclick="savePrescription()">Ø­ÙØ¸ Ø§Ù„ÙˆØµÙØ©</button>
        </div>
      </div>
      <div class="card">
        <h2>Ø§Ù„ÙˆØµÙØ§Øª</h2>
        <table>
          <thead><tr><th>Ø§Ù„Ù…Ø±ÙŠØ¶</th><th>Ø§Ù„Ø·Ø¨ÙŠØ¨</th><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>Ø§Ù„Ù…Ø¯Ø©</th><th>Ø®ÙŠØ§Ø±Ø§Øª</th></tr></thead>
          <tbody id="prescriptionsTable"></tbody>
        </table>
      </div>`;
    }
    Views.prescriptions=Views_prescriptions;

    function Views_controls(){
      return `
      <div class="card">
        <h2>Ø­Ø³Ø§Ø¨Ø§Øª Ø§Ù„Ù†Ù‚Ø¯ ÙˆØ§Ù„Ø¨Ù†ÙˆÙƒ</h2>
        <div class="grid grid-2">
          <div><label>Ø§Ø³Ù… Ø§Ù„Ø­Ø³Ø§Ø¨</label><input id="cashAccountName" /></div>
          <div><label>Ø§Ù„Ù†ÙˆØ¹</label><select id="cashAccountType"><option value="cash">ØµÙ†Ø¯ÙˆÙ‚ Ù†Ù‚Ø¯ÙŠ</option><option value="bank">Ø­Ø³Ø§Ø¨ Ø¨Ù†ÙƒÙŠ</option></select></div>
          <div class="full"><label>Ù…Ù„Ø§Ø­Ø¸Ø§Øª</label><textarea id="cashAccountNotes"></textarea></div>
        </div>
        <div class="flex" style="margin-top:1rem;justify-content:flex-end;gap:.75rem;flex-wrap:wrap;">
          <button class="btn" onclick="saveCashAccount()">Ø­ÙØ¸ Ø§Ù„Ø­Ø³Ø§Ø¨</button>
          <button class="btn secondary" onclick="renderCashAccountsTable()">ØªØ­Ø¯ÙŠØ«</button>
        </div>
        <table style="margin-top:1.5rem;">
          <thead><tr><th>Ø§Ù„Ø§Ø³Ù…</th><th>Ø§Ù„Ù†ÙˆØ¹</th><th>Ù…Ù„Ø§Ø­Ø¸Ø§Øª</th><th>Ø®ÙŠØ§Ø±Ø§Øª</th></tr></thead>
          <tbody id="cashAccountsTable"></tbody>
        </table>
      </div>
      <div class="card">
        <h2>Ø¬Ø±Ø¯ ÙŠÙˆÙ…ÙŠ Ù„Ù„ØµÙ†Ø¯ÙˆÙ‚</h2>
        <div class="grid grid-2">
          <div><label>Ø§Ù„Ø­Ø³Ø§Ø¨</label><select id="cashCountAccount"></select></div>
          <div><label>Ø§Ù„ØªØ§Ø±ÙŠØ®</label><input id="cashCountDate" type="date" /></div>
          <div><label>Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„ÙØ¹Ù„ÙŠ</label><input id="cashCountActual" type="number" step="0.01" /></div>
          <div><label>Ù…Ù„Ø§Ø­Ø¸Ø§Øª</label><textarea id="cashCountNotes"></textarea></div>
        </div>
        <div class="flex" style="margin-top:1rem;justify-content:flex-end;gap:.75rem;flex-wrap:wrap;">
          <button class="btn" onclick="recordCashCount()">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¬Ø±Ø¯</button>
          <button class="btn secondary" onclick="cashCountPDF()">PDF</button>
        </div>
        <table style="margin-top:1.5rem;">
          <thead><tr><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>Ø§Ù„Ø­Ø³Ø§Ø¨</th><th>Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ø¯ÙØªØ±ÙŠ</th><th>Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„ÙØ¹Ù„ÙŠ</th><th>Ø§Ù„ÙØ±Ù‚</th><th>Ù…Ù„Ø§Ø­Ø¸Ø§Øª</th></tr></thead>
          <tbody id="cashCountTable"></tbody>
        </table>
      </div>
      <div class="card">
        <h2>ØªØ³ÙˆÙŠØ© Ø¨Ù†ÙƒÙŠØ©</h2>
        <div class="grid grid-2">
          <div><label>Ø§Ù„ØªØ§Ø±ÙŠØ®</label><input id="reconDate" type="date" /></div>
          <div><label>Ø±ØµÙŠØ¯ Ø§Ù„Ø¨Ù†Ùƒ</label><input id="reconBank" type="number" step="0.05" /></div>
          <div><label>Ø±ØµÙŠØ¯ Ø§Ù„Ø¯ÙØ§ØªØ±</label><input id="reconBooks" type="number" step="0.05" /></div>
          <div><label>ÙØ±ÙˆÙ‚ Ù…Ø³Ø¬Ù„Ø©</label><textarea id="reconNotes"></textarea></div>
        </div>
        <div class="flex" style="margin-top:1rem;justify-content:flex-end;">
          <button class="btn" onclick="saveBankReconciliation()">ØªØ³Ø¬ÙŠÙ„ ØªØ³ÙˆÙŠØ©</button>
        </div>
        <table style="margin-top:1.5rem;">
          <thead><tr><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>Ø±ØµÙŠØ¯ Ø§Ù„Ø¨Ù†Ùƒ</th><th>Ø±ØµÙŠØ¯ Ø§Ù„Ø¯ÙØ§ØªØ±</th><th>Ø§Ù„ÙØ±Ù‚</th><th>Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©</th><th>Ø®ÙŠØ§Ø±Ø§Øª</th></tr></thead>
          <tbody id="bankReconciliationTable"></tbody>
        </table>
      </div>
      <div class="card">
        <h2>Ù…Ø±Ø§Ø¬Ø¹Ø© Ø¯Ø§Ø®Ù„ÙŠØ©</h2>
        <button class="btn" onclick="runInternalReview()">ØªØ´ØºÙŠÙ„ Ù…Ø±Ø§Ø¬Ø¹Ø©</button>
        <div id="internalReviewReport" style="margin-top:1rem;"></div>
      </div>`;
    }
    Views.controls=Views_controls;

    function Views_reports(){
      return `
      <div class="card">
        <h2>Ù…Ø±ÙƒØ² Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±</h2>
        <div class="grid grid-2">
          <button class="btn" onclick="dailyReportPDF()">ØªÙ‚Ø±ÙŠØ± ÙŠÙˆÙ…ÙŠ</button>
          <button class="btn" onclick="weeklyReportPDF()">ØªÙ‚Ø±ÙŠØ± Ø£Ø³Ø¨ÙˆØ¹ÙŠ</button>
          <button class="btn" onclick="monthlyReportPDF()">ØªÙ‚Ø±ÙŠØ± Ø´Ù‡Ø±ÙŠ</button>
          <button class="btn" onclick="labSummaryPDF()">ÙƒØ´Ù Ø§Ù„Ù…Ø¹Ø§Ù…Ù„</button>
          <button class="btn" onclick="supplierAgingPDF()">ÙƒØ´Ù Ø§Ù„Ù…ÙˆØ±Ø¯ÙŠÙ†</button>
          <button class="btn" onclick="patientsAgingPDF()">Ø£Ø¹Ù…Ø§Ø± Ø§Ù„Ø°Ù…Ù…</button>
          <button class="btn" onclick="inventoryPDF()">Ø§Ù„Ù…Ø®Ø²ÙˆÙ†</button>
          <button class="btn" onclick="clinicProfitPDF()">Ø±Ø¨Ø­ÙŠØ© Ø§Ù„Ø¹ÙŠØ§Ø¯Ø©</button>
          <button class="btn" onclick="doctorProfitPDF()">Ø±Ø¨Ø­ÙŠØ© Ø§Ù„Ø£Ø·Ø¨Ø§Ø¡</button>
          <button class="btn" onclick="trialBalancePDF()">Ù…ÙŠØ²Ø§Ù† Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©</button>
          <button class="btn" onclick="incomeStatementPDF()">Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¯Ø®Ù„</button>
          <button class="btn" onclick="balanceSheetPDF()">Ø§Ù„Ù…Ø±ÙƒØ² Ø§Ù„Ù…Ø§Ù„ÙŠ</button>
          <button class="btn" onclick="journalPDF()">Ø¯ÙØªØ± Ø§Ù„ÙŠÙˆÙ…ÙŠØ©</button>
          <button class="btn" onclick="auditLogPDF()">Ø³Ø¬Ù„ Ø§Ù„ØªØ¯Ù‚ÙŠÙ‚</button>
          <button class="btn" onclick="exportDataJSON()">ØªØµØ¯ÙŠØ± JSON</button>
          <button class="btn" onclick="importDataJSON()">Ø§Ø³ØªÙŠØ±Ø§Ø¯ JSON</button>
        </div>
      </div>
      <div class="card">
        <h2>Ø¨Ø­Ø« Ù…Ø±Ø¬Ø¹ÙŠ</h2>
        <input id="referenceSearch" placeholder="Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… Ø§Ù„Ù…Ø±Ø¬Ø¹" />
        <button class="btn" style="margin-top:1rem;" onclick="searchReference()">Ø¨Ø­Ø«</button>
        <div id="referenceResult" style="margin-top:1rem;"></div>
      </div>`;
    }
    Views.reports=Views_reports;

    function Views_settings(){
      return `
      <div class="card">
        <h2>Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø¹Ø§Ù…Ø©</h2>
        <div class="grid grid-2">
          <div><label>Ø§Ø³Ù… Ø§Ù„Ø¹ÙŠØ§Ø¯Ø©</label><input id="clinicName" value="${App.settings.clinicName}" /></div>
          <div><label>Ø§Ù„Ø´Ø¹Ø§Ø± (Base64)</label><textarea id="clinicLogo">${App.settings.clinicLogo}</textarea></div>
          <div><label>Ø§Ù„Ø¹Ù…Ù„Ø©</label><input id="clinicCurrency" value="${App.settings.currency}" /></div>
          <div><label>ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª</label><select id="overheadAllocation"><option value="revenue" ${App.settings.overheadAllocation==='revenue'?'selected':''}>Ø­Ø³Ø¨ Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª</option><option value="equal" ${App.settings.overheadAllocation==='equal'?'selected':''}>Ø¨Ø§Ù„ØªØ³Ø§ÙˆÙŠ</option></select></div>
        </div>
        <div class="flex" style="margin-top:1rem;justify-content:flex-end;">
          <button class="btn" onclick="saveSettings()">Ø­ÙØ¸</button>
        </div>
      </div>
      <div class="card">
        <h2>ÙƒÙ„Ù…Ø§Øª Ø§Ù„Ù…Ø±ÙˆØ±</h2>
        <div class="grid grid-2">
          <div><label>Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</label><input id="pwdSettings" type="password" placeholder="Ø§ÙƒØªØ¨ ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ø¬Ø¯ÙŠØ¯Ø©" /></div>
          <div><label>Ø§Ù„Ø¥Ù‚ÙØ§Ù„</label><input id="pwdClose" type="password" placeholder="Ø§ÙƒØªØ¨ ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ø¬Ø¯ÙŠØ¯Ø©" /></div>
          <div><label>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø§Ù„Ø­Ø³Ø§Ø³Ø©</label><input id="pwdDanger" type="password" placeholder="Ø§ÙƒØªØ¨ ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ø¬Ø¯ÙŠØ¯Ø©" /></div>
        </div>
        <div class="flex" style="margin-top:1rem;justify-content:flex-end;">
          <button class="btn" onclick="savePasswords()">ØªØ­Ø¯ÙŠØ«</button>
        </div>
      </div>
      <div class="card">
        <h2>Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ù†Ø¸Ø§Ù…</h2>
        <button class="btn" onclick="runHealthCheck()">ØªØ´ØºÙŠÙ„</button>
        <div id="healthReport" style="margin-top:1rem;"></div>
      </div>
      <div class="card">
        <h2>Ø¯Ù„ÙŠÙ„ Ù…Ø®ØªØµØ±</h2>
        <p>
          â€¢ Ø§Ø³ØªØ®Ø¯Ù… ÙƒÙ„Ù…Ø§Øª Ø§Ù„Ù…Ø±ÙˆØ± Ù„Ø­Ù…Ø§ÙŠØ© Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ÙˆØ§Ù„Ø¥Ù‚ÙØ§Ù„ ÙˆØ§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø§Ù„Ø­Ø³Ø§Ø³Ø©.<br>
          â€¢ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø³Ù†Ø¯Ø§Øª ØªÙˆÙ„Ø¯ Ù‚ÙŠÙˆØ¯Ù‹Ø§ Ù…Ø²Ø¯ÙˆØ¬Ø© ÙˆØªØ¸Ù‡Ø± ÙÙŠ Ø¯ÙØªØ± Ø§Ù„ÙŠÙˆÙ…ÙŠØ©.<br>
          â€¢ Ø²Ø± Ø§Ù„ØªØµØ¯ÙŠØ± ÙŠÙˆÙØ± Ù†Ø³Ø®Ø© JSON Ù„Ù„Ø­ÙØ¸ Ø§Ù„Ø®Ø§Ø±Ø¬ÙŠØŒ ÙˆØ²Ø± Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯ ÙŠØ¹ÙŠØ¯Ù‡Ø§.<br>
          â€¢ Ø§Ù„Ø¥Ù‚ÙØ§Ù„ ÙŠØªØ·Ù„Ø¨ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø®Ø§ØµØ© ÙˆÙŠÙ…Ù†Ø¹ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø­ØªÙ‰ Ø¥Ø¹Ø§Ø¯Ø© ÙØªØ­Ù‡ Ø¨ÙˆØ¶Ø¹ Ø­Ø³Ø§Ø³.<br>
        </p>
      </div>`;
    }
    Views.settings=Views_settings;

    function defaultOpeningState(){
      return {id:null,status:'draft',date:'',memo:'',reference:'',postedAt:'',reverseReference:'',reversedAt:'',cash:[],patients:[],suppliers:[],inventory:[],entries:[]};
    }

    async function loadOpeningState(){
      const stored=await Storage.load('openingBalance',null);
      if(stored&&typeof stored==='object'){
        return {
          ...defaultOpeningState(),
          ...stored,
          cash:Array.isArray(stored.cash)?stored.cash:[],
          patients:Array.isArray(stored.patients)?stored.patients:[],
          suppliers:Array.isArray(stored.suppliers)?stored.suppliers:[],
          inventory:Array.isArray(stored.inventory)?stored.inventory:[],
          entries:Array.isArray(stored.entries)?stored.entries:[]
        };
      }
      return defaultOpeningState();
    }

    async function saveOpeningState(state){
      await Storage.save('openingBalance',state);
    }

    function openingStatusText(state){
      if(state.status==='posted'){
        const dateLabel=state.date?formatDate(`${state.date}T00:00:00`):formatDate(state.postedAt||'');
        const reference=state.reference||'-';
        return `ØªÙ… ØªØ±Ø­ÙŠÙ„ Ø§Ù„Ø£Ø±ØµØ¯Ø© â€” Ø§Ù„Ù…Ø±Ø¬Ø¹ ${reference} Ø¨ØªØ§Ø±ÙŠØ® ${dateLabel}`;
      }
      if(state.status==='reversed'){
        const reversed=state.reversedAt?formatDate(state.reversedAt):'-';
        return `Ø¢Ø®Ø± ØªØ±Ø­ÙŠÙ„ ØªÙ… Ø¥Ù„ØºØ§Ø¤Ù‡ ÙÙŠ ${reversed}. ÙŠÙ…ÙƒÙ†Ùƒ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø£Ø±ØµØ¯Ø© Ø«Ù… Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ±Ø­ÙŠÙ„.`;
      }
      return 'Ù„Ù… ÙŠØªÙ… ØªØ±Ø­ÙŠÙ„ Ø£Ø±ØµØ¯Ø© Ø§ÙØªØªØ§Ø­ÙŠØ© Ø¨Ø¹Ø¯.';
    }

    function setOpeningLocked(locked){
      document.querySelectorAll('[data-opening-input]').forEach(el=>{el.disabled=locked;});
      document.querySelectorAll('[data-opening-remove]').forEach(btn=>{btn.disabled=locked;});
      ['openingAddCash','openingAddPatient','openingAddSupplier','openingAddInventory','btnPostOpening'].forEach(id=>{
        const el=document.getElementById(id);
        if(el) el.disabled=locked;
      });
    }

    function openingCashOptions(selected=''){
      const options=(App.cashAccounts||[]).map(acc=>`<option value="${acc.id}" ${String(selected)===String(acc.id)?'selected':''}>${acc.name}</option>`).join('');
      return `<option value="">Ø§Ø®ØªØ± Ø§Ù„Ø­Ø³Ø§Ø¨</option>${options}`;
    }

    function addOpeningCashRow(data={}){
      const body=document.getElementById('openingCashBody');
      if(!body) return;
      const row=document.createElement('tr');
      const amountValue=data.amount!==undefined?data.amount:'';
      row.innerHTML=`
        <td><select data-opening-input="cash-account"></select></td>
        <td><input data-opening-input="cash-amount" type="number" min="0" step="0.05" value="${amountValue}" /></td>
        <td><button class="btn danger" type="button" data-opening-remove>Ø­Ø°Ù</button></td>`;
      body.appendChild(row);
      const select=row.querySelector('select');
      if(select){
        select.innerHTML=openingCashOptions(data.accountId||'');
        if(data.accountId){select.value=data.accountId;}
        else if(!select.value && App.cashAccounts&&App.cashAccounts.length===1){select.value=App.cashAccounts[0].id;}
      }
      const dueButton=row.querySelector('button');
      if(dueButton){dueButton.onclick=()=>row.remove();}
    }

    function addOpeningPatientRow(data={}){
      const body=document.getElementById('openingPatientBody');
      if(!body) return;
      const row=document.createElement('tr');
      const amountValue=data.amount!==undefined?data.amount:'';
      const defaultDate=document.getElementById('openingDate')?.value||'';
      const dueValue=data.due||defaultDate;
      row.innerHTML=`
        <td><input data-opening-input="patient-name" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø±ÙŠØ¶" value="${data.name||''}" /></td>
        <td><input data-opening-input="patient-amount" type="number" min="0" step="0.05" value="${amountValue}" /></td>
        <td><input data-opening-input="patient-due" type="date" value="${dueValue||''}" /></td>
        <td><input data-opening-input="patient-note" placeholder="ÙˆØµÙ Ø£Ùˆ Ø®Ø·Ø©" value="${data.note||''}" /></td>
        <td><button class="btn danger" type="button" data-opening-remove>Ø­Ø°Ù</button></td>`;
      body.appendChild(row);
      const btn=row.querySelector('button');
      if(btn){btn.onclick=()=>row.remove();}
    }

    function addOpeningSupplierRow(data={}){
      const body=document.getElementById('openingSupplierBody');
      if(!body) return;
      const amountValue=data.amount!==undefined?data.amount:'';
      const defaultDate=document.getElementById('openingDate')?.value||'';
      const dueValue=data.due||defaultDate;
      const row=document.createElement('tr');
      row.innerHTML=`
        <td><input data-opening-input="supplier-name" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ±Ø¯" value="${data.name||''}" /></td>
        <td><input data-opening-input="supplier-amount" type="number" min="0" step="0.05" value="${amountValue}" /></td>
        <td><input data-opening-input="supplier-due" type="date" value="${dueValue||''}" /></td>
        <td><input data-opening-input="supplier-note" placeholder="Ù…Ù„Ø§Ø­Ø¸Ø§Øª" value="${data.note||''}" /></td>
        <td><button class="btn danger" type="button" data-opening-remove>Ø­Ø°Ù</button></td>`;
      body.appendChild(row);
      const btn=row.querySelector('button');
      if(btn){btn.onclick=()=>row.remove();}
    }

    function addOpeningInventoryRow(data={}){
      const body=document.getElementById('openingInventoryBody');
      if(!body) return;
      const qtyValue=data.quantity!==undefined?data.quantity:'';
      const costValue=data.unitCost!==undefined?data.unitCost:'';
      const row=document.createElement('tr');
      row.innerHTML=`
        <td><input data-opening-input="inventory-name" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø§Ø¯Ø©" value="${data.name||''}" /></td>
        <td><input data-opening-input="inventory-qty" type="number" min="0" step="0.01" value="${qtyValue}" /></td>
        <td><input data-opening-input="inventory-cost" type="number" min="0" step="0.01" value="${costValue}" /></td>
        <td><input data-opening-input="inventory-expiry" type="date" value="${data.expiry||''}" /></td>
        <td><button class="btn danger" type="button" data-opening-remove>Ø­Ø°Ù</button></td>`;
      body.appendChild(row);
      const btn=row.querySelector('button');
      if(btn){btn.onclick=()=>row.remove();}
    }

    async function renderOpeningBalanceForm(){
      const state=await loadOpeningState();
      const status=document.getElementById('openingStatusLabel');
      if(status){status.textContent=openingStatusText(state);}
      const reverseBtn=document.getElementById('btnReverseOpening');
      if(reverseBtn){reverseBtn.disabled=state.status!=='posted';}
      const dateField=document.getElementById('openingDate');
      if(dateField){
        if(state.date){dateField.value=state.date;}
        else if(!dateField.value){dateField.value=new Date().toISOString().slice(0,10);}
      }
      const memoField=document.getElementById('openingMemo');
      if(memoField){memoField.value=state.memo||'';}
      const cashBody=document.getElementById('openingCashBody');
      if(cashBody){
        cashBody.innerHTML='';
        const rows=(state.cash&&state.cash.length)?state.cash:(App.cashAccounts||[]).map(acc=>({accountId:acc.id,amount:''}));
        if(rows.length){rows.forEach(row=>addOpeningCashRow(row));}
        else{addOpeningCashRow({});}
      }
      const patientBody=document.getElementById('openingPatientBody');
      if(patientBody){
        patientBody.innerHTML='';
        const rows=(state.patients&&state.patients.length)?state.patients:[{}];
        rows.forEach(row=>addOpeningPatientRow(row));
      }
      const supplierBody=document.getElementById('openingSupplierBody');
      if(supplierBody){
        supplierBody.innerHTML='';
        const rows=(state.suppliers&&state.suppliers.length)?state.suppliers:[{}];
        rows.forEach(row=>addOpeningSupplierRow(row));
      }
      const inventoryBody=document.getElementById('openingInventoryBody');
      if(inventoryBody){
        inventoryBody.innerHTML='';
        const rows=(state.inventory&&state.inventory.length)?state.inventory:[{}];
        rows.forEach(row=>addOpeningInventoryRow(row));
      }
      setOpeningLocked(state.status==='posted');
    }

    function collectOpeningCashRows(){
      const rows=[];
      const body=document.getElementById('openingCashBody');
      if(!body) return rows;
      body.querySelectorAll('tr').forEach(tr=>{
        const accountId=tr.querySelector('select')?.value||'';
        const amountRaw=parseFloat(tr.querySelector('input[data-opening-input="cash-amount"]')?.value||'0');
        if(!accountId && amountRaw<=0) return;
        if(!accountId) throw new Error('Ø§Ø®ØªØ± Ø­Ø³Ø§Ø¨Ù‹Ø§ Ù†Ù‚Ø¯ÙŠÙ‹Ø§ Ù„ÙƒÙ„ Ø±ØµÙŠØ¯ Ø§ÙØªØªØ§Ø­ÙŠ.');
        if(amountRaw<=0) throw new Error('Ø£Ø¯Ø®Ù„ Ù…Ø¨Ù„ØºÙ‹Ø§ Ø£ÙƒØ¨Ø± Ù…Ù† ØµÙØ± Ù„Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„Ù†Ù‚Ø¯ÙŠ Ø§Ù„Ù…Ø®ØªØ§Ø±.');
        rows.push({accountId,amount:roundAmount(amountRaw)});
      });
      return rows;
    }

    function collectOpeningPatients(defaultDate){
      const rows=[];
      const body=document.getElementById('openingPatientBody');
      if(!body) return rows;
      body.querySelectorAll('tr').forEach(tr=>{
        const name=(tr.querySelector('input[data-opening-input="patient-name"]')?.value||'').trim();
        const amountRaw=parseFloat(tr.querySelector('input[data-opening-input="patient-amount"]')?.value||'0');
        const due=tr.querySelector('input[data-opening-input="patient-due"]')?.value||defaultDate;
        const note=(tr.querySelector('input[data-opening-input="patient-note"]')?.value||'').trim();
        if(!name && amountRaw<=0) return;
        if(!name) throw new Error('Ø§Ø³Ù… Ø§Ù„Ù…Ø±ÙŠØ¶ Ù…Ø·Ù„ÙˆØ¨ Ù„Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø°Ù…Ù… Ø§Ù„Ø§ÙØªØªØ§Ø­ÙŠØ©.');
        const parts=name.split(/\s+/).filter(Boolean);
        if(parts.length<4) throw new Error(`Ø§Ø³Ù… Ø§Ù„Ù…Ø±ÙŠØ¶ "${name}" ÙŠØ¬Ø¨ Ø£Ù† ÙŠØªÙƒÙˆÙ† Ù…Ù† Ù¤ ÙƒÙ„Ù…Ø§Øª Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„.`);
        if(amountRaw<=0) throw new Error(`Ø§Ù„Ù…Ø¨Ù„Øº Ù„Ù„Ù…Ø±ÙŠØ¶ "${name}" ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ø£ÙƒØ¨Ø± Ù…Ù† ØµÙØ±.`);
        rows.push({name,amount:roundAmount(amountRaw),due,note});
      });
      return rows;
    }

    function collectOpeningSuppliers(defaultDate){
      const rows=[];
      const body=document.getElementById('openingSupplierBody');
      if(!body) return rows;
      body.querySelectorAll('tr').forEach(tr=>{
        const name=(tr.querySelector('input[data-opening-input="supplier-name"]')?.value||'').trim();
        const amountRaw=parseFloat(tr.querySelector('input[data-opening-input="supplier-amount"]')?.value||'0');
        const due=tr.querySelector('input[data-opening-input="supplier-due"]')?.value||defaultDate;
        const note=(tr.querySelector('input[data-opening-input="supplier-note"]')?.value||'').trim();
        if(!name && amountRaw<=0) return;
        if(!name) throw new Error('Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ±Ø¯ Ù…Ø·Ù„ÙˆØ¨ Ù„ÙƒÙ„ Ø°Ù…Ø© Ø§ÙØªØªØ§Ø­ÙŠØ©.');
        if(amountRaw<=0) throw new Error(`Ø§Ù„Ù…Ø¨Ù„Øº Ù„Ù„Ù…ÙˆØ±Ø¯ "${name}" ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ø£ÙƒØ¨Ø± Ù…Ù† ØµÙØ±.`);
        rows.push({name,amount:roundAmount(amountRaw),due,note});
      });
      return rows;
    }

    function collectOpeningInventory(){
      const rows=[];
      const body=document.getElementById('openingInventoryBody');
      if(!body) return rows;
      body.querySelectorAll('tr').forEach(tr=>{
        const name=(tr.querySelector('input[data-opening-input="inventory-name"]')?.value||'').trim();
        const qtyRaw=parseFloat(tr.querySelector('input[data-opening-input="inventory-qty"]')?.value||'0');
        const costRaw=parseFloat(tr.querySelector('input[data-opening-input="inventory-cost"]')?.value||'0');
        const expiry=tr.querySelector('input[data-opening-input="inventory-expiry"]')?.value||'';
        if(!name && (isNaN(qtyRaw)||qtyRaw<=0)) return;
        if(!name) throw new Error('Ø§Ø³Ù… Ø§Ù„Ù…Ø§Ø¯Ø© Ù…Ø·Ù„ÙˆØ¨ Ù„ÙƒÙ„ Ø±ØµÙŠØ¯ Ù…Ø®Ø²ÙˆÙ† Ø§ÙØªØªØ§Ø­ÙŠ.');
        if(!(qtyRaw>0)) throw new Error(`Ø§Ù„ÙƒÙ…ÙŠØ© Ù„Ù„Ù…Ø§Ø¯Ø© "${name}" ÙŠØ¬Ø¨ Ø£Ù† ØªÙƒÙˆÙ† Ø£ÙƒØ¨Ø± Ù…Ù† ØµÙØ±.`);
        if(!(costRaw>0)) throw new Error(`ØªÙƒÙ„ÙØ© Ø§Ù„ÙˆØ­Ø¯Ø© Ù„Ù„Ù…Ø§Ø¯Ø© "${name}" ÙŠØ¬Ø¨ Ø£Ù† ØªÙƒÙˆÙ† Ø£ÙƒØ¨Ø± Ù…Ù† ØµÙØ±.`);
        const quantity=roundAmount(qtyRaw);
        const unitCost=roundAmount(costRaw);
        const total=roundAmount(quantity*unitCost);
        if(total<=0) throw new Error(`Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠØ© Ù„Ù„Ù…Ø§Ø¯Ø© "${name}" ØºÙŠØ± ØµØ§Ù„Ø­Ø©.`);
        rows.push({name,quantity,unitCost,expiry,total});
      });
      return rows;
    }

    async function postOpeningBalance(){
      const state=await loadOpeningState();
      if(state.status==='posted'){showToast('ØªÙ… ØªØ±Ø­ÙŠÙ„ Ø§Ù„Ø£Ø±ØµØ¯Ø© Ø¨Ø§Ù„ÙØ¹Ù„ â€” Ø£Ù„ØºÙ Ø§Ù„ØªØ±Ø­ÙŠÙ„ Ù‚Ø¨Ù„ Ø¥Ù†Ø´Ø§Ø¡ Ø¬Ø¯ÙŠØ¯.','error');return;}
      const date=document.getElementById('openingDate')?.value||'';
      if(!date){showToast('Ø­Ø¯Ø¯ ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØ±Ø­ÙŠÙ„ Ø§Ù„Ø§ÙØªØªØ§Ø­ÙŠ','error');return;}
      const memo=(document.getElementById('openingMemo')?.value||'').trim();
      let cashRows,patientRows,supplierRows,inventoryRows;
      try{
        cashRows=collectOpeningCashRows();
        patientRows=collectOpeningPatients(date);
        supplierRows=collectOpeningSuppliers(date);
        inventoryRows=collectOpeningInventory();
      }catch(err){
        showToast(err.message||'Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø§ÙØªØªØ§Ø­ÙŠØ© ØºÙŠØ± ØµØ§Ù„Ø­Ø©','error');
        return;
      }
      if(!cashRows.length && !patientRows.length && !supplierRows.length && !inventoryRows.length){
        showToast('Ø£Ø¯Ø®Ù„ Ø±ØµÙŠØ¯Ù‹Ø§ ÙˆØ§Ø­Ø¯Ù‹Ø§ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„ Ù‚Ø¨Ù„ Ø§Ù„ØªØ±Ø­ÙŠÙ„','error');
        return;
      }
      const openingId=state.id||`ob-${Date.now()}`;
      state.id=openingId;
      const entries=[];
      let debitTotal=0;
      let creditTotal=0;
      try{
        cashRows.forEach(row=>{
          entries.push(buildCashMovement(row.accountId,'debit',row.amount,'Ø±ØµÙŠØ¯ Ø§ÙØªØªØ§Ø­ÙŠ'));
          debitTotal=roundAmount(debitTotal+row.amount);
        });
        patientRows.forEach(row=>{
          entries.push(buildAccountEntry('receivablesPatients','debit',row.amount,row.name,{memo:'Ø±ØµÙŠØ¯ Ø§ÙØªØªØ§Ø­ÙŠ'}));
          debitTotal=roundAmount(debitTotal+row.amount);
        });
        inventoryRows.forEach(row=>{
          entries.push(buildAccountEntry('inventory','debit',row.total,row.name,{memo:'Ø±ØµÙŠØ¯ Ø§ÙØªØªØ§Ø­ÙŠ'}));
          debitTotal=roundAmount(debitTotal+row.total);
        });
        supplierRows.forEach(row=>{
          entries.push(buildAccountEntry('payablesSuppliers','credit',row.amount,row.name,{memo:'Ø±ØµÙŠØ¯ Ø§ÙØªØªØ§Ø­ÙŠ'}));
          creditTotal=roundAmount(creditTotal+row.amount);
        });
      }catch(err){
        showToast(`ØªØ¹Ø°Ø± Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù‚ÙŠØ¯ Ø§Ù„Ø§ÙØªØªØ§Ø­ÙŠ: ${err.message||''}`,'error');
        return;
      }
      const net=roundAmount(debitTotal-creditTotal);
      if(Math.abs(net)>0.01){
        const adjust=Math.abs(net);
        if(net>0){
          entries.push(buildAccountEntry('retainedEarnings','credit',adjust,'Ø±ØµÙŠØ¯ Ø§ÙØªØªØ§Ø­ÙŠ'));
          creditTotal=roundAmount(creditTotal+adjust);
        }else{
          entries.push(buildAccountEntry('retainedEarnings','debit',adjust,'Ø±ØµÙŠØ¯ Ø§ÙØªØªØ§Ø­ÙŠ'));
          debitTotal=roundAmount(debitTotal+adjust);
        }
      }
      const journalDate=new Date(`${date}T00:00:00`);
      let journal;
      try{
        journal=await recordJournal(entries,{type:'opening-balance',date:journalDate.toISOString(),memo});
      }catch(err){
        showToast('ØªØ¹Ø°Ø± Ø­ÙØ¸ Ø§Ù„Ù‚ÙŠØ¯ Ø§Ù„Ø§ÙØªØªØ§Ø­ÙŠ','error');
        return;
      }
      const openDateISO=journalDate.toISOString();
      const patients=await Storage.load('patients');
      let patientChanged=false;
      patientRows.forEach(row=>{
        if(!patients.find(p=>p.name===row.name)){
          patients.push({name:row.name,phone:'',deposit:0,notes:'',createdAt:openDateISO});
          patientChanged=true;
        }
      });
      if(patientChanged){await Storage.save('patients',patients);}
      let receivables=await Storage.load('patientReceivables');
      receivables=receivables.filter(rec=>rec.openingId!==openingId);
      let receivableCounter=0;
      patientRows.forEach(row=>{
        receivables.push({
          id:`${openingId}-ar-${++receivableCounter}`,
          reference:`OB-AR-${String(receivableCounter).padStart(3,'0')}`,
          patient:row.name,
          service:row.note||'Ø±ØµÙŠØ¯ Ø§ÙØªØªØ§Ø­ÙŠ',
          doctor:'',
          amount:row.amount,
          balance:row.amount,
          due:row.due||date,
          createdAt:openDateISO,
          status:'open',
          openingId
        });
      });
      await Storage.save('patientReceivables',receivables);
      let invoices=await Storage.load('purchaseInvoices');
      invoices=invoices.filter(inv=>inv.openingId!==openingId);
      let invoiceCounter=0;
      supplierRows.forEach(row=>{
        invoices.push({
          reference:`OB-AP-${String(++invoiceCounter).padStart(3,'0')}`,
          supplier:row.name,
          amount:row.amount,
          balance:row.amount,
          createdAt:openDateISO,
          dueDate:row.due||date,
          status:'open',
          notes:row.note||'Ø±ØµÙŠØ¯ Ø§ÙØªØªØ§Ø­ÙŠ',
          openingId
        });
      });
      await Storage.save('purchaseInvoices',invoices);
      let batches=await loadInventoryBatches();
      batches=batches.filter(batch=>batch.openingId!==openingId);
      inventoryRows.forEach(row=>{
        batches.push({
          id:`${openingId}-batch-${Date.now()}-${Math.random().toString(16).slice(2)}`,
          reference:'OPENING',
          name:row.name,
          quantity:row.quantity,
          remaining:row.quantity,
          unitCost:row.unitCost,
          expiry:row.expiry||'',
          receivedAt:openDateISO,
          openingId
        });
      });
      await saveInventoryBatches(batches);
      await refreshInventoryAggregates();
      state.status='posted';
      state.reference=journal.id;
      state.postedAt=new Date().toISOString();
      state.reverseReference='';
      delete state.reversedAt;
      state.memo=memo;
      state.date=date;
      state.cash=cashRows;
      state.patients=patientRows;
      state.suppliers=supplierRows;
      state.inventory=inventoryRows.map(({name,quantity,unitCost,expiry})=>({name,quantity,unitCost,expiry}));
      state.entries=entries.map(entry=>({...entry}));
      await saveOpeningState(state);
      await logAudit('add',journal.id,'ØªØ±Ø­ÙŠÙ„ Ø£Ø±ØµØ¯Ø© Ø§ÙØªØªØ§Ø­ÙŠØ©',{date,memo,debit:debitTotal,credit:creditTotal});
      showToast('ØªÙ… ØªØ±Ø­ÙŠÙ„ Ø§Ù„Ø£Ø±ØµØ¯Ø© Ø§Ù„Ø§ÙØªØªØ§Ø­ÙŠØ©','success');
      await renderOpeningBalanceForm();
      renderJournalTable();
      renderPatientReceivables();
      renderPatientsTable();
      renderSupplierPayables();
      renderInventoryTable();
      renderReceiptOutstanding();
      renderPaymentOutstanding();
      refreshMiniTrial();
      renderDashboardWidgets();
    }

    function reverseOpeningBalance(){
      guardSensitive(async()=>{
        const state=await loadOpeningState();
        if(state.status!=='posted'){showToast('Ù„Ø§ ÙŠÙˆØ¬Ø¯ ØªØ±Ø­ÙŠÙ„ Ø§ÙØªØªØ§Ø­ÙŠ Ù…Ø«Ø¨Øª','error');return;}
        const journals=await Storage.load('journals');
        const original=journals.find(j=>j.id===state.reference);
        if(!original){showToast('ØªØ¹Ø°Ø± Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ù‚ÙŠØ¯ Ø§Ù„Ø£ØµÙ„ÙŠ','error');return;}
        let reversal;
        try{
          reversal=await recordJournal(reverseEntries(original.entries),{type:'opening-reversal',reference:state.reference});
        }catch(err){
          showToast('ØªØ¹Ø°Ø± ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù‚ÙŠØ¯ Ø§Ù„Ø¹ÙƒØ³ÙŠ','error');
          return;
        }
        const openingId=state.id;
        if(openingId){
          let receivables=await Storage.load('patientReceivables');
          const recChanged=receivables.length;
          receivables=receivables.filter(rec=>rec.openingId!==openingId);
          if(receivables.length!==recChanged){await Storage.save('patientReceivables',receivables);}
          let invoices=await Storage.load('purchaseInvoices');
          const invChanged=invoices.length;
          invoices=invoices.filter(inv=>inv.openingId!==openingId);
          if(invoices.length!==invChanged){await Storage.save('purchaseInvoices',invoices);}
          let batches=await loadInventoryBatches();
          const batchChanged=batches.length;
          batches=batches.filter(batch=>batch.openingId!==openingId);
          if(batches.length!==batchChanged){
            await saveInventoryBatches(batches);
            await refreshInventoryAggregates();
          }
        }
        state.status='reversed';
        state.reversedAt=new Date().toISOString();
        state.reverseReference=reversal.id;
        await saveOpeningState(state);
        await logAudit('reverse',state.reference||'opening','Ø¥Ù„ØºØ§Ø¡ Ø£Ø±ØµØ¯Ø© Ø§ÙØªØªØ§Ø­ÙŠØ©',{reverseReference:reversal.id});
        showToast('ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ù‚ÙŠØ¯ Ø§Ù„Ø§ÙØªØªØ§Ø­ÙŠ','success');
        await renderOpeningBalanceForm();
        renderJournalTable();
        renderPatientReceivables();
        renderPatientsTable();
        renderSupplierPayables();
        renderInventoryTable();
        renderReceiptOutstanding();
        renderPaymentOutstanding();
        refreshMiniTrial();
        renderDashboardWidgets();
      });
    }

    let debounceTimer;
    function debounced(fn){
      clearTimeout(debounceTimer);
      debounceTimer=setTimeout(fn,250);
    }

    async function fileToBase64(file){
      return new Promise((resolve,reject)=>{
        const reader=new FileReader();
        reader.onload=()=>resolve(reader.result);
        reader.onerror=reject;
        reader.readAsDataURL(file);
      });
    }

    function onVoucherTypeChange(){
      const selector=document.getElementById('voucherType');
      if(!selector) return;
      const type=selector.value||'receipt-service';
      const isReceipt=type.startsWith('receipt');
      const isService=type==='receipt-service';
      const needsAccount=type!=='receipt-deposit-apply';
      document.querySelectorAll('[data-voucher-section="receipt"]').forEach(el=>{el.style.display=isReceipt?'block':'none';});
      document.querySelectorAll('[data-voucher-section="receipt-service"]').forEach(el=>{el.style.display=isReceipt&&isService?'block':'none';});
      document.querySelectorAll('[data-voucher-section="payment"]').forEach(el=>{el.style.display=isReceipt?'none':'block';});
      const accountWrapper=document.querySelector('[data-voucher-section="account"]');
      if(accountWrapper){accountWrapper.style.display=needsAccount?'block':'none';}
      const label=document.getElementById('voucherAccountLabel');
      if(label){label.textContent=isReceipt?'Ø­Ø³Ø§Ø¨ Ø§Ù„ØªØ­ØµÙŠÙ„':'Ø­Ø³Ø§Ø¨ Ø§Ù„ØµØ±Ù';}
      const receiptCard=document.getElementById('receiptOutstandingCard');
      if(receiptCard){receiptCard.style.display=isReceipt?'block':'none';}
      const paymentCard=document.getElementById('paymentOutstandingCard');
      if(paymentCard){paymentCard.style.display=isReceipt?'none':'block';}
      if(isReceipt){
        renderReceiptOutstanding();
      }else{
        renderPaymentOutstanding();
      }
    }

    async function saveVoucher(){
      const selector=document.getElementById('voucherType');
      const type=selector?selector.value:'receipt-service';
      if(type.startsWith('receipt')){
        await saveReceipt(type.replace('receipt-',''));
      }else{
        await savePayment(type.replace('payment-',''));
      }
    }

    async function saveReceipt(operationOverride){
      const patient=document.getElementById('receiptPatient')?.value||'';
      const operation=operationOverride||(document.getElementById('voucherType')?.value||'receipt-service').replace('receipt-','');
      const service=(document.getElementById('receiptService')?.value||'').trim();
      const doctor=(document.getElementById('receiptDoctor')?.value||'').trim();
      const amountRaw=parseFloat(document.getElementById('voucherAmount')?.value||'0');
      const amount=roundAmount(amountRaw);
      const accountId=document.getElementById('voucherAccount')?.value||'';
      const notes=(document.getElementById('voucherNotes')?.value||'').trim();
      if(!patient){showToast('Ø§Ø®ØªØ± Ø§Ù„Ù…Ø±ÙŠØ¶ Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©','error');return;}
      if(isNaN(amount)||amount<=0){showToast('Ø§Ù„Ù…Ø¨Ù„Øº ØºÙŠØ± ØµØ§Ù„Ø­','error');return;}
      const patients=await Storage.load('patients');
      const patientRecord=patients.find(p=>p.name===patient);
      if(!patientRecord){showToast('Ø§Ù„Ù…Ø±ÙŠØ¶ ØºÙŠØ± Ù…Ø³Ø¬Ù„ ÙÙŠ Ø§Ù„Ù†Ø¸Ø§Ù…','error');return;}
      if(operation==='service'&&!service){showToast('Ø§Ù„Ø®Ø¯Ù…Ø© Ù…Ø·Ù„ÙˆØ¨Ø©','error');return;}
      const cashRequired=['service','settlement','deposit'].includes(operation);
      const selectedAccount=cashRequired?(accountId||defaultCashAccountId()):accountId;
      if(cashRequired&&!selectedAccount){showToast('ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø­Ø³Ø§Ø¨ Ø§Ù„ØªØ­ØµÙŠÙ„','error');return;}
      if(['settlement','deposit-apply'].includes(operation)){
        const outstanding=await patientOutstandingTotal(patient);
        if(outstanding<=0){showToast('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø°Ù…Ù… Ù…ÙØªÙˆØ­Ø© Ù„Ù‡Ø°Ø§ Ø§Ù„Ù…Ø±ÙŠØ¶','error');return;}
        if(amount-outstanding>0.05){showToast('Ø§Ù„Ù…Ø¨Ù„Øº ÙŠØªØ¬Ø§ÙˆØ² Ø§Ù„Ø°Ù…Ù… Ø§Ù„Ù…ÙØªÙˆØ­Ø©','error');return;}
      }
      if(operation==='deposit-apply'){
        const depositBalance=roundAmount(patientRecord.deposit||0);
        if(depositBalance<amount-0.01){showToast('Ø±ØµÙŠØ¯ Ø§Ù„Ø£Ù…Ø§Ù†Ø© ØºÙŠØ± ÙƒØ§Ù','error');return;}
      }
      let attachment=null;
      const file=document.getElementById('voucherAttachment')?.files?.[0];
      if(file){
        if(file.size>10*1024*1024){showToast('Ø­Ø¬Ù… Ø§Ù„Ù…Ø±ÙÙ‚ ÙŠØªØ¬Ø§ÙˆØ² Ø§Ù„Ø­Ø¯ (10MB)','error');return;}
        attachment=await fileToBase64(file);
      }
      const receipts=await Storage.load('receipts');
      const reference=generateReference('RC');
      const now=new Date().toISOString();
      const record={reference,patient,service,doctor,amount,notes,attachment,status:'posted',receiptType:operation,accountId:selectedAccount||'',createdAt:now};
      let entryType='receipt-service';
      switch(operation){
        case 'settlement': entryType='receipt-settlement'; break;
        case 'deposit': entryType='receipt-deposit'; break;
        case 'deposit-apply': entryType='receipt-deposit-apply'; break;
        default: entryType='receipt-service';
      }
      try{
        await recordJournal(buildEntry(entryType,{amount,service,patient,accountId:selectedAccount}),{type:'receipt',reference,patient,doctor,receiptType:operation});
      }catch(err){
        showToast('ØªØ¹Ø°Ø± Ø­ÙØ¸ Ø§Ù„Ø³Ù†Ø¯ Ø¨Ø³Ø¨Ø¨ Ø®Ù„Ù„ ÙÙŠ Ø§Ù„Ù‚ÙŠØ¯','error');
        throw err;
      }
      if(operation==='deposit'){
        await adjustPatientDeposit(patient,amount,reference,'deposit');
        record.depositMovement={type:'add',amount};
      }
      if(['settlement','deposit-apply'].includes(operation)){
        const allocations=await applyReceiptToReceivables(patient,amount);
        const applied=roundAmount(allocations.reduce((s,a)=>s+a.amount,0));
        if(Math.abs(applied-amount)>0.05){
          await reverseReceiptAllocations(allocations);
          const reverseMap={
            'receipt-settlement':'receipt-void-settlement',
            'receipt-deposit-apply':'receipt-void-deposit-apply',
            'receipt-service':'receipt-void-service',
            'receipt-deposit':'receipt-void-deposit'
          };
          const reverseEntry=reverseMap[entryType]||'receipt-void-service';
          await recordJournal(buildEntry(reverseEntry,{amount,service,patient,accountId:selectedAccount}),{type:'reverse',reference,receiptType:operation});
          showToast('ØªØ¹Ø°Ø± ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ù…Ø¨Ù„Øº Ø¹Ù„Ù‰ Ø§Ù„Ø°Ù…Ù… Ø§Ù„Ù…ÙØªÙˆØ­Ø©','error');
          return;
        }
        record.allocations=allocations;
      }
      if(operation==='deposit-apply'){
        await adjustPatientDeposit(patient,-amount,reference,'apply');
        record.depositMovement={type:'use',amount};
      }
      receipts.push(record);
      await Storage.save('receipts',receipts);
      await logAudit('add',reference,'Ø³Ù†Ø¯ Ù‚Ø¨Ø¶',record);
      showToast('ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø³Ù†Ø¯');
      renderVoucherTable();
      renderDoctorsTable();
      renderPatientReceivables();
      renderPatientsTable();
      renderReceiptOutstanding();
      refreshMiniTrial();
    }

    async function renderVoucherTable(){
      const receipts=await Storage.load('receipts');
      const payments=await Storage.load('payments');
      const body=document.getElementById('voucherTable');
      if(!body) return;
      const search=(document.getElementById('voucherSearch')||{value:''}).value.trim();
      let receiptsMutated=false;
      receipts.forEach(r=>{
        if(r.state&&!r.status){r.status=r.state;delete r.state;receiptsMutated=true;}
        if(r.status==='cancelled'){r.status='void';receiptsMutated=true;}
        if(r.status==='active'){r.status='posted';receiptsMutated=true;}
        if(!['draft','posted','void'].includes(r.status)){r.status='posted';receiptsMutated=true;}
        if(!r.receiptType){r.receiptType='service';receiptsMutated=true;}
      });
      if(receiptsMutated){await Storage.save('receipts',receipts);}
      let paymentsMutated=false;
      payments.forEach(p=>{
        if(p.state&&!p.status){p.status=p.state;delete p.state;paymentsMutated=true;}
        if(p.status==='cancelled'){p.status='void';paymentsMutated=true;}
        if(p.status==='paid'||p.status==='pending'){p.paymentStatus=p.status;p.status='posted';paymentsMutated=true;}
        if(!['draft','posted','void'].includes(p.status)){p.status='posted';paymentsMutated=true;}
        if(!p.paymentType){
          if(p.paymentStatus==='pending'){p.paymentType='advance';}
          else{p.paymentType='invoice';}
          paymentsMutated=true;
        }
        p.paymentStatus=p.paymentType;
      });
      if(paymentsMutated){await Storage.save('payments',payments);}
      const rows=[];
      receipts.forEach(r=>{
        const typeKey=`receipt-${r.receiptType||'service'}`;
        rows.push({
          reference:r.reference,
          createdAt:r.createdAt||'',
          type:typeKey,
          party:r.patient||'',
          amount:r.amount||0,
          status:r.status||'posted',
          source:'receipt'
        });
      });
      payments.forEach(p=>{
        const typeKey=`payment-${p.paymentType||'invoice'}`;
        rows.push({
          reference:p.reference,
          createdAt:p.createdAt||'',
          type:typeKey,
          party:p.supplier||'',
          amount:p.amount||0,
          status:p.status||'posted',
          source:'payment'
        });
      });
      const filtered=rows.filter(r=>!search||(r.reference||'').includes(search));
      filtered.sort((a,b)=>{
        const da=a.createdAt?new Date(a.createdAt).getTime():0;
        const db=b.createdAt?new Date(b.createdAt).getTime():0;
        if(db!==da) return db-da;
        return (b.reference||'').localeCompare(a.reference||'');
      });
      const limited=filtered.slice(0,200);
      body.innerHTML=limited.map(r=>{
        const statusLabel=`<span class="badge${r.status==='void'?' danger':''}">${voucherStatusLabel(r.status)}</span>`;
        const amountLabel=formatCurrency(r.amount||0);
        const typeLabel=voucherTypeLabel(r.type);
        const dateLabel=formatDate(r.createdAt);
        const actionButtons=r.source==='receipt'
          ?`<button class="btn secondary" onclick="receiptPDF('${r.reference}')">PDF</button> <button class="btn danger" onclick="cancelReceipt('${r.reference}')">Ø¥Ù„ØºØ§Ø¡</button>`
          :`<button class="btn secondary" onclick="paymentPDF('${r.reference}')">PDF</button> <button class="btn danger" onclick="cancelPayment('${r.reference}')">Ø¥Ù„ØºØ§Ø¡</button>`;
        return `
        <tr>
          <td>${r.reference}</td>
          <td>${dateLabel}</td>
          <td>${typeLabel}</td>
          <td>${r.party||'-'}</td>
          <td>${amountLabel}</td>
          <td>${statusLabel}</td>
          <td>${actionButtons}</td>
        </tr>`;
      }).join('');
    }

    async function renderReceiptsTable(){
      await renderVoucherTable();
    }

    async function cancelReceipt(reference){
      guardSensitive(async()=>{
        const list=await Storage.load('receipts');
        const item=list.find(r=>r.reference===reference);
        if(!item) return;
        if(item.status!=='posted'){showToast('Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø¥Ø¨Ø·Ø§Ù„ Ø³Ù†Ø¯ ØºÙŠØ± Ù…Ø±Ø­Ù„','error');return;}
        const receiptType=item.receiptType||'service';
        let reverseEntry='receipt-void-service';
        if(receiptType==='settlement') reverseEntry='receipt-void-settlement';
        else if(receiptType==='deposit') reverseEntry='receipt-void-deposit';
        else if(receiptType==='deposit-apply') reverseEntry='receipt-void-deposit-apply';
        const reverseAccount=['service','settlement','deposit'].includes(receiptType)?(item.accountId||defaultCashAccountId()):'';
        await recordJournal(buildEntry(reverseEntry,{amount:item.amount,service:item.service,patient:item.patient,accountId:reverseAccount}),{type:'reverse',reference,receiptType});
        item.status='void';
        await Storage.save('receipts',list);
        if(receiptType==='settlement'||receiptType==='deposit-apply'){
          await reverseReceiptAllocations(item.allocations||[],item.patient,item.amount);
        }
        if(receiptType==='deposit'){
          await adjustPatientDeposit(item.patient,-item.amount,reference,'reverse-deposit');
        }
        if(receiptType==='deposit-apply'){
          await adjustPatientDeposit(item.patient,item.amount,reference,'reverse-apply');
        }
        await logAudit('cancel',reference,'Ø¥Ù„ØºØ§Ø¡ Ø³Ù†Ø¯ Ù‚Ø¨Ø¶');
        showToast('ØªÙ… Ø§Ù„Ø¥Ù„ØºØ§Ø¡');
        renderVoucherTable();
        renderPatientReceivables();
        renderPatientsTable();
        renderReceiptOutstanding();
        refreshMiniTrial();
      });
    }

    async function savePayment(typeOverride){
      const supplier=(document.getElementById('paymentSupplier')?.value||'').trim();
      const paymentType=typeOverride||(document.getElementById('voucherType')?.value||'payment-invoice').replace('payment-','');
      const amountRaw=parseFloat(document.getElementById('voucherAmount')?.value||'0');
      const amount=roundAmount(amountRaw);
      const accountId=document.getElementById('voucherAccount')?.value||defaultCashAccountId();
      const notes=(document.getElementById('voucherNotes')?.value||'').trim();
      if(!supplier||isNaN(amount)||amount<=0){showToast('Ø¨ÙŠØ§Ù†Ø§Øª ØºÙŠØ± ØµØ§Ù„Ø­Ø©','error');return;}
      if(!accountId){showToast('ÙŠØ±Ø¬Ù‰ ØªØ­Ø¯ÙŠØ¯ Ø­Ø³Ø§Ø¨ Ø§Ù„ØµØ±Ù','error');return;}
      if(paymentType==='invoice'){
        const outstanding=await supplierOutstandingTotal(supplier);
        if(outstanding<=0){showToast('Ù„Ø§ ØªÙˆØ¬Ø¯ ÙÙˆØ§ØªÙŠØ± Ù…Ø³ØªØ­Ù‚Ø© Ù„Ù‡Ø°Ø§ Ø§Ù„Ù…ÙˆØ±Ø¯','error');return;}
        if(amount-outstanding>0.05){showToast('Ø§Ù„Ù…Ø¨Ù„Øº ÙŠØªØ¬Ø§ÙˆØ² Ø§Ù„Ø°Ù…Ù… Ø§Ù„Ù…ÙØªÙˆØ­Ø© Ù„Ù„Ù…ÙˆØ±Ø¯','error');return;}
      }
      let attachment=null;
      const file=document.getElementById('voucherAttachment')?.files?.[0];
      if(file){
        if(file.size>10*1024*1024){showToast('Ø­Ø¬Ù… Ø§Ù„Ù…Ø±ÙÙ‚ ÙŠØªØ¬Ø§ÙˆØ² Ø§Ù„Ø­Ø¯ (10MB)','error');return;}
        attachment=await fileToBase64(file);
      }
      const payments=await Storage.load('payments');
      const reference=generateReference('PMT');
      const now=new Date().toISOString();
      const record={reference,supplier,paymentType,paymentStatus:paymentType,status:'posted',amount,notes,attachment,accountId,createdAt:now};
      let entryType=paymentType==='advance'?'payment-advance':'payment-settle';
      try{
        await recordJournal(buildEntry(entryType,{amount,supplier,accountId}),{type:'payment',reference,supplier,paymentType});
      }catch(err){
        showToast('ØªØ¹Ø°Ø± Ø­ÙØ¸ Ø§Ù„Ø³Ù†Ø¯ Ø¨Ø³Ø¨Ø¨ Ø®Ù„Ù„ ÙÙŠ Ø§Ù„Ù‚ÙŠØ¯','error');
        throw err;
      }
      if(paymentType==='invoice'){
        const allocations=await applyPaymentToPayables(supplier,amount);
        const applied=roundAmount(allocations.reduce((s,a)=>s+a.amount,0));
        if(Math.abs(applied-amount)>0.05){
          await reversePaymentAllocations(allocations);
          const reverseMap={
            'payment-settle':'payment-void-settle',
            'payment-advance':'payment-void-advance'
          };
          const reverseEntry=reverseMap[entryType]||'payment-void-settle';
          await recordJournal(buildEntry(reverseEntry,{amount,supplier,accountId}),{type:'reverse-payment',reference,paymentType});
          showToast('ØªØ¹Ø°Ø± ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ø¯ÙØ¹Ø© Ø¹Ù„Ù‰ ÙÙˆØ§ØªÙŠØ± Ø§Ù„Ù…ÙˆØ±Ø¯','error');
          return;
        }
        record.allocations=allocations;
      }
      payments.push(record);
      await Storage.save('payments',payments);
      await logAudit('add',reference,'Ø³Ù†Ø¯ ØµØ±Ù',record);
      showToast('ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø³Ù†Ø¯');
      renderVoucherTable();
      renderSupplierPayables();
      renderPaymentOutstanding();
      refreshMiniTrial();
    }

    async function renderPaymentsTable(){
      await renderVoucherTable();
    }

    async function cancelPayment(reference){
      guardSensitive(async()=>{
        const list=await Storage.load('payments');
        const item=list.find(r=>r.reference===reference);
        if(!item) return;
        if(item.status!=='posted'){showToast('Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø¥Ø¨Ø·Ø§Ù„ Ø³Ù†Ø¯ ØºÙŠØ± Ù…Ø±Ø­Ù„','error');return;}
        const paymentType=item.paymentType||item.paymentStatus||'invoice';
        item.status='void';
        await Storage.save('payments',list);
        const reverseEntry=paymentType==='advance'?'payment-void-advance':'payment-void-settle';
        const reverseAccount=item.accountId||defaultCashAccountId();
        await recordJournal(buildEntry(reverseEntry,{amount:item.amount,supplier:item.supplier,accountId:reverseAccount}),{type:'reverse-payment',reference,paymentType});
        if(paymentType==='invoice'){
          await reversePaymentAllocations(item.allocations||[]);
        }
        await logAudit('cancel',reference,'Ø¥Ù„ØºØ§Ø¡ Ø³Ù†Ø¯ ØµØ±Ù');
        showToast('ØªÙ… Ø§Ù„Ø¥Ù„ØºØ§Ø¡');
        renderVoucherTable();
        renderSupplierPayables();
        renderPaymentOutstanding();
        refreshMiniTrial();
      });
    }

    async function renderJournalTable(){
      const list=await Storage.load('journals');
      const filter=(document.getElementById('journalFilter')||{value:''}).value.trim();
      const body=document.getElementById('journalTable');
      if(!body) return;
      body.innerHTML=list.filter(j=>!filter||j.id.includes(filter)||j.entries.some(e=>e.account.includes(filter))).slice(-200).reverse().map(j=>`
        <tr>
          <td>${j.id}</td>
          <td>${formatDate(j.createdAt)}</td>
          <td>${j.meta?.type||''}</td>
          <td>${j.entries.map(e=>`<div class="flex" style="justify-content:space-between;"><span>${e.account}</span><span>${e.debit?formatCurrency(e.debit):''}</span><span>${e.credit?formatCurrency(e.credit):''}</span></div>`).join('')}</td>
        </tr>`).join('');
    }

    async function savePatient(){
      const name=document.getElementById('patientName').value.trim();
      const phone=document.getElementById('patientPhone').value.trim();
      const deposit=parseFloat(document.getElementById('patientDeposit').value||'0');
      const notes=document.getElementById('patientNotes').value.trim();
      if(!name){showToast('Ø§Ø³Ù… Ø§Ù„Ù…Ø±ÙŠØ¶ Ù…Ø·Ù„ÙˆØ¨','error');return;}
      const parts=name.split(/\s+/).filter(Boolean);
      if(parts.length<4){showToast('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø«Ù„Ø§Ø«ÙŠ Ù…Ø¹ Ø§Ù„Ù„Ù‚Ø¨ (Ù¤ ÙƒÙ„Ù…Ø§Øª Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„)','error');return;}
      if(!phone){showToast('Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ','error');return;}
      const patients=await Storage.load('patients');
      const duplicatePhone=patients.find(p=>p.phone===phone && p.name!==name);
      if(duplicatePhone){showToast('Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ Ù…Ø³ØªØ®Ø¯Ù… Ù„Ù…Ø±ÙŠØ¶ Ø¢Ø®Ø±','error');return;}
      const existing=patients.find(p=>p.name===name);
      const sanitizedDeposit=isNaN(deposit)?0:deposit;
      if(existing){
        existing.phone=phone;
        existing.notes=notes;
      }else{
        patients.push({name,phone,balance:0,deposit:sanitizedDeposit,notes,createdAt:new Date().toISOString()});
      }
      await Storage.save('patients',patients);
      await logAudit('add',name,'ØªØ­Ø¯ÙŠØ« Ù…Ø±ÙŠØ¶');
      showToast('ØªÙ… Ø§Ù„Ø­ÙØ¸');
      renderPatientsTable();
      await updatePatientSelectors();
    }

    async function renderPatientsTable(){
      const patients=await Storage.load('patients');
      const receivables=await Storage.load('patientReceivables');
      receivables.forEach(normalizeReceivable);
      receivables.forEach(normalizeReceivable);
      receivables.forEach(normalizeReceivable);
      receivables.forEach(normalizeReceivable);
      const alerts=await Storage.load('medicalAlerts');
      const body=document.getElementById('patientTable');
      if(!body) return;
      body.innerHTML=patients.map(p=>{
        const outstanding=receivables.filter(r=>r.patient===p.name&&r.balance>0).reduce((s,r)=>s+r.balance,0);
        const patientAlerts=alerts.filter(a=>a.patient===p.name);
        return `<tr>
          <td>${p.name}</td>
          <td>${p.phone}</td>
          <td>${formatCurrency(outstanding)}</td>
          <td>${formatCurrency(p.deposit||0)}</td>
          <td>${patientAlerts.length?`<span class="badge danger">${patientAlerts.length} ØªÙ†Ø¨ÙŠÙ‡</span>`:'<span class="badge">Ù„Ø§ ØªÙˆØ¬Ø¯</span>'}</td>
          <td><button class="btn danger" onclick="deletePatient('${p.name}')">Ø­Ø°Ù</button></td>
        </tr>`;
      }).join('');
    }

    async function updatePatientSelectors(){
      const patients=await Storage.load('patients');
      const options=patients.map(p=>`<option value="${p.name}">${p.name}</option>`).join('');
      const withPlaceholder=`<option value="" disabled selected>Ø§Ø®ØªØ± Ø§Ù„Ù…Ø±ÙŠØ¶</option>${options}`;
      ['dentalPatient','receivablePatient','alertPatient','appointmentPatient','prescriptionPatient','receiptPatient'].forEach(id=>{
        const el=document.getElementById(id);
        if(el){
          const previous=el.value;
          if(id==='dentalPatient'){
            el.innerHTML=options;
            if(previous&&patients.some(p=>p.name===previous)){
              el.value=previous;
            }else if(patients.length){
              el.value=patients[0].name;
            }
          }else{
            el.innerHTML=withPlaceholder;
            if(previous&&patients.some(p=>p.name===previous)){
              el.value=previous;
            }
          }
        }
      });
      const receiptSelect=document.getElementById('receiptPatient');
      if(receiptSelect){
        receiptSelect.onchange=()=>renderReceiptOutstanding();
        renderReceiptOutstanding();
      }
    }

    function buildDentalChartGrid(teeth){
      return `<div class="grid" style="grid-template-columns:repeat(auto-fit,minmax(120px,1fr));">${DENTAL_TEETH.map(tooth=>{
        const status=teeth[tooth]||'Ø³Ù„ÙŠÙ…';
        return `<div><label>Ø³Ù† ${tooth}</label><select data-tooth="${tooth}" class="tooth-select">${DENTAL_STATUSES.map(s=>`<option value="${s}" ${s===status?'selected':''}>${s}</option>`).join('')}</select></div>`;
      }).join('')}</div>`;
    }

    async function loadDentalChart(){
      const select=document.getElementById('dentalPatient');
      if(!select) return;
      const patient=select.value;
      const charts=await Storage.load('dentalCharts');
      const record=charts.find(c=>c.patient===patient)||{teeth:{}};
      const notes=document.getElementById('dentalNotes');
      if(notes) notes.value=record.notes||'';
      const container=document.getElementById('dentalChart');
      if(container){
        container.innerHTML=buildDentalChartGrid(record.teeth||{});
      }
    }

    async function renderDentalChartControls(){
      await updatePatientSelectors();
      const select=document.getElementById('dentalPatient');
      if(select){
        if(!select.value&&select.options.length){select.value=select.options[0].value;}
        select.onchange=loadDentalChart;
      }
      await loadDentalChart();
    }

    async function saveDentalChart(){
      const select=document.getElementById('dentalPatient');
      if(!select||!select.value){showToast('Ø§Ø®ØªØ± Ø§Ù„Ù…Ø±ÙŠØ¶','error');return;}
      const patient=select.value;
      const notes=document.getElementById('dentalNotes')?.value||'';
      const inputs=document.querySelectorAll('#dentalChart .tooth-select');
      const teeth={};
      inputs.forEach(sel=>{teeth[sel.dataset.tooth]=sel.value;});
      const charts=await Storage.load('dentalCharts');
      const existing=charts.find(c=>c.patient===patient);
      if(existing){existing.teeth=teeth;existing.notes=notes;existing.updatedAt=new Date().toISOString();}
      else{charts.push({patient,teeth,notes,updatedAt:new Date().toISOString()});}
      await Storage.save('dentalCharts',charts);
      await logAudit('update',patient,'ØªØ­Ø¯ÙŠØ« Ø³Ø¬Ù„ Ø³Ù†ÙŠ',{teeth});
      showToast('ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„Ø³Ù†ÙŠ');
    }

    async function savePatientReceivable(){
      const patient=document.getElementById('receivablePatient')?.value;
      const service=document.getElementById('receivableService')?.value?.trim()||'';
      const doctor=document.getElementById('receivableDoctor')?.value?.trim()||'';
      const amount=parseFloat(document.getElementById('receivableAmount')?.value||'0');
      const dueRaw=document.getElementById('receivableDue')?.value;
      const notes=document.getElementById('receivableNotes')?.value||'';
      const due=dueRaw||new Date().toISOString().slice(0,10);
      if(!patient||isNaN(amount)||amount<=0){showToast('Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø°Ù…Ø© ØºÙŠØ± Ù…ÙƒØªÙ…Ù„Ø©','error');return;}
      const receivables=await Storage.load('patientReceivables');
      const reference=generateReference('AR');
      receivables.push({
        id:Date.now(),
        reference,
        patient,
        service,
        doctor,
        amount:roundAmount(amount),
        balance:roundAmount(amount),
        due,
        notes,
        source:'manual',
        status:'open',
        createdAt:new Date().toISOString()
      });
      await Storage.save('patientReceivables',receivables);
      await logAudit('add',reference,'Ø¥Ø¶Ø§ÙØ© Ø°Ù…Ø© Ù…Ø±ÙŠØ¶',{patient,amount:roundAmount(amount),due});
      showToast('ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø°Ù…Ø©');
      renderPatientReceivables();
      renderPatientsTable();
      renderReceiptOutstanding();
    }

    async function applyReceiptToReceivables(patient,amount){
      if(!patient||amount<=0) return [];
      const receivables=await Storage.load('patientReceivables');
      let remaining=roundAmount(amount);
      const allocations=[];
      for(const rec of receivables.filter(r=>r.patient===patient&&r.balance>0).sort((a,b)=>new Date(a.due||a.createdAt||0)-new Date(b.due||b.createdAt||0))){
        if(remaining<=0) break;
        const take=Math.min(rec.balance,remaining);
        if(take<=0) continue;
        rec.balance=roundAmount(rec.balance-take);
        if(rec.balance<=0.01){rec.balance=0;rec.status='settled';rec.settledAt=new Date().toISOString();}
        allocations.push({receivableId:rec.id,receivableRef:rec.reference||rec.id,amount:roundAmount(take)});
        remaining=roundAmount(remaining-take);
      }
      await Storage.save('patientReceivables',receivables);
      return allocations;
    }

    async function reverseReceiptAllocations(allocations,patient,amount){
      const receivables=await Storage.load('patientReceivables');
      if(allocations&&allocations.length){
        const map=new Map(allocations.map(a=>[a.receivableId||a.receivableRef,a]));
        receivables.forEach(rec=>{
          const key=map.get(rec.id)||map.get(rec.reference);
          if(!key) return;
          rec.balance=roundAmount((rec.balance||0)+key.amount);
          if(rec.balance>0){rec.status='open';delete rec.settledAt;}
        });
      }else if(patient&&amount>0){
        let remaining=roundAmount(amount);
        for(const rec of receivables.filter(r=>r.patient===patient).sort((a,b)=>new Date(b.due||b.createdAt||0)-new Date(a.due||a.createdAt||0))){
          if(remaining<=0) break;
          const original=rec.amount||rec.balance||0;
          const current=rec.balance||0;
          const space=roundAmount((original>current?original:current)-current);
          const add=Math.min(space||original,remaining);
          if(add<=0) continue;
          rec.balance=roundAmount(current+add);
          if(rec.balance>0){rec.status='open';delete rec.settledAt;}
          remaining=roundAmount(remaining-add);
        }
      }
      await Storage.save('patientReceivables',receivables);
    }

    function receivableStatus(rec){
      if(rec.balance<=0) return 'Ù…Ø³Ø¯Ø¯';
      const diff=(new Date(rec.due)-new Date())/(1000*60*60*24);
      if(diff<0) return 'Ù…ØªØ£Ø®Ø±';
      if(diff<=7) return 'Ù…Ø³ØªØ­Ù‚ Ù‚Ø±ÙŠØ¨Ø§Ù‹';
      return 'Ù†Ø´Ø·';
    }

    async function renderPatientReceivables(){
      const receivables=await Storage.load('patientReceivables');
      const body=document.getElementById('patientReceivableTable');
      if(!body) return;
      body.innerHTML=receivables.slice(-200).reverse().map(rec=>`
        <tr>
          <td>${rec.reference||`AR-${rec.id}`}</td>
          <td>${rec.patient}</td>
          <td>${rec.service||'-'}</td>
          <td>${rec.doctor||'-'}</td>
          <td>${formatCurrency(rec.amount||0)}</td>
          <td>${formatCurrency(rec.balance||0)}</td>
          <td>${rec.due?formatDate(rec.due):'-'}</td>
          <td>${receivableStatus(rec)}</td>
        </tr>`).join('');
    }

    async function patientOutstandingTotal(patient){
      const receivables=await Storage.load('patientReceivables');
      receivables.forEach(normalizeReceivable);
      return roundAmount(receivables.filter(r=>r.patient===patient&&r.balance>0).reduce((s,r)=>s+(r.balance||0),0));
    }

    async function renderReceiptOutstanding(){
      const container=document.getElementById('receiptOutstanding');
      if(!container) return;
      const patient=document.getElementById('receiptPatient')?.value||'';
      if(!patient){
        container.innerHTML='<span class="badge">Ø§Ø®ØªØ± Ø§Ù„Ù…Ø±ÙŠØ¶ Ù„Ø¹Ø±Ø¶ Ø§Ù„Ø°Ù…Ù… ÙˆØ§Ù„Ø£Ù…Ø§Ù†Ø§Øª</span>';
        return;
      }
      const patients=await Storage.load('patients');
      const patientRecord=patients.find(p=>p.name===patient);
      const deposit=roundAmount(patientRecord?.deposit||0);
      const receivables=await Storage.load('patientReceivables');
      const outstanding=receivables.filter(r=>r.patient===patient&&r.balance>0).sort((a,b)=>new Date(a.due||a.createdAt||0)-new Date(b.due||b.createdAt||0));
      if(!outstanding.length){
        container.innerHTML=`<div class="badge">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø°Ù…Ù… Ù…ÙØªÙˆØ­Ø© â€” Ø§Ù„Ø£Ù…Ø§Ù†Ø© Ø§Ù„Ù…ØªØ§Ø­Ø©: ${formatCurrency(deposit)}</div>`;
        return;
      }
      const rows=outstanding.map(rec=>`<tr><td>${rec.reference||`AR-${rec.id}`}</td><td>${rec.service||'-'}</td><td>${rec.doctor||'-'}</td><td>${rec.due?formatDate(rec.due):'-'}</td><td>${formatCurrency(rec.balance||0)}</td></tr>`).join('');
      const total=outstanding.reduce((s,r)=>s+(r.balance||0),0);
      container.innerHTML=`
        <div class="badge">Ø§Ù„Ø£Ù…Ø§Ù†Ø© Ø§Ù„Ù…ØªØ§Ø­Ø©: ${formatCurrency(deposit)} â€” Ø§Ù„Ø°Ù…Ù… Ø§Ù„Ù…ÙØªÙˆØ­Ø©: ${formatCurrency(total)}</div>
        <table><thead><tr><th>Ø§Ù„Ù…Ø±Ø¬Ø¹</th><th>Ø§Ù„Ø®Ø¯Ù…Ø©</th><th>Ø§Ù„Ø·Ø¨ÙŠØ¨</th><th>Ø§Ù„Ø§Ø³ØªØ­Ù‚Ø§Ù‚</th><th>Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ</th></tr></thead><tbody>${rows}</tbody></table>
      `;
    }

    async function supplierOutstandingTotal(supplier){
      if(!supplier) return 0;
      const invoices=await Storage.load('purchaseInvoices');
      invoices.forEach(normalizeInvoice);
      return roundAmount(invoices.filter(inv=>inv.supplier===supplier&&inv.balance>0).reduce((s,inv)=>s+(inv.balance||0),0));
    }

    async function renderPaymentOutstanding(){
      const container=document.getElementById('paymentOutstanding');
      if(!container) return;
      const supplier=document.getElementById('paymentSupplier')?.value?.trim();
      if(!supplier){
        container.innerHTML='<span class="badge">Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ±Ø¯ Ù„Ø¹Ø±Ø¶ Ø§Ù„Ø°Ù…Ù…</span>';
        return;
      }
      const invoices=await Storage.load('purchaseInvoices');
      invoices.forEach(normalizeInvoice);
      const outstanding=invoices.filter(inv=>inv.supplier===supplier&&inv.balance>0).sort((a,b)=>new Date(a.dueDate||a.createdAt)-new Date(b.dueDate||b.createdAt));
      if(!outstanding.length){
        container.innerHTML='<div class="badge">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø±ØµÙŠØ¯ Ù…Ø³ØªØ­Ù‚</div>';
        return;
      }
      const rows=outstanding.map(inv=>`<tr><td>${inv.reference}</td><td>${inv.dueDate?formatDate(inv.dueDate):'-'}</td><td>${formatCurrency(inv.balance||0)}</td></tr>`).join('');
      const total=outstanding.reduce((s,inv)=>s+(inv.balance||0),0);
      container.innerHTML=`
        <div class="badge">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø°Ù…Ù… Ø§Ù„Ù…ÙØªÙˆØ­Ø©: ${formatCurrency(total)}</div>
        <table><thead><tr><th>Ø§Ù„Ù…Ø±Ø¬Ø¹</th><th>Ø§Ù„Ø§Ø³ØªØ­Ù‚Ø§Ù‚</th><th>Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ</th></tr></thead><tbody>${rows}</tbody></table>
      `;
    }

    async function renderSupplierPayables(){
      const container=document.getElementById('supplierPayables');
      if(!container) return;
      const invoices=await Storage.load('purchaseInvoices');
      invoices.forEach(normalizeInvoice);
      if(!invoices.length){
        container.innerHTML='<span class="badge">Ù„Ø§ ØªÙˆØ¬Ø¯ ÙÙˆØ§ØªÙŠØ± Ù…Ø³Ø¬Ù„Ø©</span>';
        return;
      }
      const rows=invoices.sort((a,b)=>new Date(b.createdAt||b.dueDate||0)-new Date(a.createdAt||a.dueDate||0)).slice(0,200).map(inv=>{
        const status=inv.status==='settled'?'Ù…Ø³Ø¯Ø¯':inv.status==='partial'?'Ø¬Ø²Ø¦ÙŠ':'Ù…ÙØªÙˆØ­';
        return `<tr><td>${inv.reference}</td><td>${inv.supplier}</td><td>${formatCurrency(inv.amount||0)}</td><td>${formatCurrency(inv.balance||0)}</td><td>${inv.dueDate?formatDate(inv.dueDate):'-'}</td><td>${status}</td></tr>`;
      }).join('');
      container.innerHTML=`<table><thead><tr><th>Ø§Ù„Ù…Ø±Ø¬Ø¹</th><th>Ø§Ù„Ù…ÙˆØ±Ø¯</th><th>Ø§Ù„Ù‚ÙŠÙ…Ø©</th><th>Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ</th><th>Ø§Ù„Ø§Ø³ØªØ­Ù‚Ø§Ù‚</th><th>Ø§Ù„Ø­Ø§Ù„Ø©</th></tr></thead><tbody>${rows}</tbody></table>`;
    }

    function normalizeInvoice(inv){
      if(!inv) return;
      if(typeof inv.amount!=='number'){inv.amount=roundAmount(inv.amount||inv.balance||0);}
      if(typeof inv.balance!=='number'){inv.balance=roundAmount(inv.balance||inv.amount||0);}
      if(!inv.status){inv.status=inv.balance>0?'open':'settled';}
      if(!inv.dueDate){inv.dueDate=(inv.createdAt||new Date().toISOString()).slice(0,10);}
    }

    function normalizeReceivable(rec){
      if(!rec) return;
      if(typeof rec.amount!=='number'){rec.amount=roundAmount(rec.amount||rec.balance||0);}
      if(typeof rec.balance!=='number'){rec.balance=roundAmount(rec.balance||rec.amount||0);}
      if(!rec.due){rec.due=(rec.createdAt||new Date().toISOString()).slice(0,10);}
      if(!rec.status){rec.status=rec.balance>0?'open':'settled';}
    }

    async function adjustPatientDeposit(patient,delta,reference,reason){
      if(!patient||!delta) return;
      const patients=await Storage.load('patients');
      const record=patients.find(p=>p.name===patient);
      if(!record) return;
      const next=roundAmount((record.deposit||0)+delta);
      if(next<-0.01){throw new Error('Ø±ØµÙŠØ¯ Ø§Ù„Ø£Ù…Ø§Ù†Ø© Ù„Ø§ ÙŠØ³Ù…Ø­ Ø¨Ø§Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…');}
      record.deposit=next<0?0:next;
      await Storage.save('patients',patients);
      const ledger=await Storage.load('patientDepositsLedger');
      ledger.push({id:Date.now(),patient,reference,reason,amount:roundAmount(delta),balance:record.deposit,createdAt:new Date().toISOString()});
      await Storage.save('patientDepositsLedger',ledger);
    }

    async function applyPaymentToPayables(supplier,amount){
      if(!supplier||amount<=0) return [];
      const invoices=await Storage.load('purchaseInvoices');
      invoices.forEach(normalizeInvoice);
      let remaining=roundAmount(amount);
      const allocations=[];
      for(const inv of invoices.filter(i=>i.supplier===supplier&&i.balance>0).sort((a,b)=>new Date(a.dueDate||a.createdAt)-new Date(b.dueDate||b.createdAt))){
        if(remaining<=0) break;
        const take=Math.min(inv.balance,remaining);
        if(take<=0) continue;
        inv.balance=roundAmount(inv.balance-take);
        inv.status=inv.balance<=0.01?'settled':'partial';
        allocations.push({invoiceRef:inv.reference,amount:roundAmount(take)});
        remaining=roundAmount(remaining-take);
      }
      await Storage.save('purchaseInvoices',invoices);
      return allocations;
    }

    async function reversePaymentAllocations(allocations){
      if(!allocations||!allocations.length) return;
      const invoices=await Storage.load('purchaseInvoices');
      const lookup=new Map(allocations.map(a=>[a.invoiceRef,a]));
      invoices.forEach(inv=>{
        const info=lookup.get(inv.reference);
        if(!info) return;
        inv.balance=roundAmount((inv.balance||0)+info.amount);
        const original=roundAmount(inv.amount||inv.balance);
        if(inv.balance<=0.01){
          inv.balance=0;
          inv.status='settled';
        }else if(inv.balance>=original-0.01){
          inv.status='open';
        }else{
          inv.status='partial';
        }
      });
      await Storage.save('purchaseInvoices',invoices);
    }

    async function loadInventoryBatches(){
      let batches=await Storage.load('inventoryBatches');
      if(!batches.length){
        const legacyInventory=await Storage.load('inventory');
        const legacyItems=(legacyInventory||[]).map(item=>{
          const rawQty=parseFloat(item.qty||item.quantity||0);
          const qty=!isNaN(rawQty)?roundAmount(rawQty):0;
          return {...item,__legacyQty:qty};
        }).filter(item=>item.__legacyQty>0);
        if(legacyItems.length){
          const now=new Date().toISOString();
          const base=Date.now();
          let counter=0;
          batches=legacyItems.map(item=>{
            const qty=item.__legacyQty;
            return {
              id:item.id||item.batchId||`legacy-${base}-${counter++}`,
              reference:item.reference||'LEGACY',
              name:item.name,
              quantity:qty,
              remaining:qty,
              unitCost:roundAmount(parseFloat(item.unitCost||item.lastCost||item.cost||0)||0),
              expiry:item.expiry||'',
              receivedAt:item.createdAt||now,
              legacy:true
            };
          });
          await Storage.save('inventoryBatches',batches);
        }
      }
      return (batches||[]).map(batch=>({
        ...batch,
        remaining:batch.remaining===undefined?batch.quantity:batch.remaining
      }));
    }

    async function saveInventoryBatches(batches){
      await Storage.save('inventoryBatches',batches);
    }

    function sortConsumptionBatches(batches){
      return batches.slice().sort((a,b)=>{
        const ae=a.expiry?new Date(a.expiry).getTime():Infinity;
        const be=b.expiry?new Date(b.expiry).getTime():Infinity;
        if(ae!==be) return ae-be;
        return new Date(a.receivedAt||0)-new Date(b.receivedAt||0);
      });
    }

    async function refreshInventoryAggregates(){
      const batches=await loadInventoryBatches();
      let inventory=await Storage.load('inventory');
      const stats=new Map();
      batches.forEach(batch=>{
        const remaining=roundAmount(batch.remaining||0);
        if(remaining<=0) return;
        if(!stats.has(batch.name)){
          stats.set(batch.name,{qty:0,expiry:batch.expiry||''});
        }
        const info=stats.get(batch.name);
        info.qty=roundAmount(info.qty+remaining);
        if(batch.expiry){
          if(!info.expiry||new Date(batch.expiry)<new Date(info.expiry)){
            info.expiry=batch.expiry;
          }
        }
      });
      inventory=inventory.map(item=>{
        const info=stats.get(item.name);
        if(info){
          item.qty=roundAmount(info.qty);
          item.expiry=info.expiry||'';
        }else{
          item.qty=roundAmount(item.qty||0);
          item.expiry=item.expiry||'';
        }
        return item;
      });
      stats.forEach((info,name)=>{
        if(!inventory.find(i=>i.name===name)){
          inventory.push({name,qty:roundAmount(info.qty),min:0,expiry:info.expiry||'',createdAt:new Date().toISOString()});
        }
      });
      await Storage.save('inventory',inventory);
      updateInventoryItemList(inventory);
      return {inventory,batches};
    }

    function updateInventoryItemList(list){
      const datalist=document.getElementById('inventoryItemList');
      if(!datalist) return;
      datalist.innerHTML=list.map(item=>`<option value="${item.name}"></option>`).join('');
    }

    function defaultCashAccountId(){
      return (App.cashAccounts&&App.cashAccounts.length)?App.cashAccounts[0].id:'';
    }

    function addPurchaseItemRow(data={}){
      const container=document.getElementById('invoiceItems');
      if(!container) return;
      const row=document.createElement('div');
      row.className='purchase-item-row';
      row.innerHTML=`
        <input class="purchaseItemName" list="inventoryItemList" placeholder="Ø§Ù„Ù…Ø§Ø¯Ø©" value="${data.name||''}">
        <input class="purchaseItemQty" type="number" min="0" step="0.01" placeholder="Ø§Ù„ÙƒÙ…ÙŠØ©" value="${data.quantity||''}">
        <input class="purchaseItemCost" type="number" min="0" step="0.01" placeholder="Ø³Ø¹Ø± Ø§Ù„ÙˆØ­Ø¯Ø©" value="${data.unitCost||''}">
        <input class="purchaseItemExpiry" type="date" value="${data.expiry||''}">
        <button class="btn danger" type="button" onclick="removePurchaseItemRow(this)">Ø­Ø°Ù</button>`;
      container.appendChild(row);
    }

    function removePurchaseItemRow(btn){
      const row=btn.closest('.purchase-item-row');
      if(row){row.remove();}
    }

    function collectPurchaseItems(){
      const rows=[...document.querySelectorAll('#invoiceItems .purchase-item-row')];
      return rows.map(row=>{
        const name=row.querySelector('.purchaseItemName').value.trim();
        const qty=parseFloat(row.querySelector('.purchaseItemQty').value||'0');
        const cost=parseFloat(row.querySelector('.purchaseItemCost').value||'0');
        const expiry=row.querySelector('.purchaseItemExpiry').value;
        return {name,quantity:qty,unitCost:cost,expiry,total:roundAmount(qty*cost)};
      }).filter(item=>item.name&&item.quantity>0&&item.unitCost>=0);
    }

    function togglePurchaseItems(){
      const select=document.getElementById('invoiceToStock');
      const wrapper=document.getElementById('invoiceItemsWrapper');
      if(!select||!wrapper) return;
      if(select.value==='yes'){
        wrapper.style.display='block';
        if(!document.querySelector('#invoiceItems .purchase-item-row')){
          addPurchaseItemRow();
        }
      }else{
        wrapper.style.display='none';
      }
    }

    function setupPurchaseForm(){
      const select=document.getElementById('invoiceToStock');
      if(select){
        select.onchange=togglePurchaseItems;
        togglePurchaseItems();
      }
    }

    async function addInventoryBatchesFromPurchase(reference,items){
      if(!items.length) return;
      const batches=await loadInventoryBatches();
      const now=new Date().toISOString();
      items.forEach(item=>{
        batches.push({
          id:`${reference}-${item.name}-${Date.now()}-${Math.random().toString(16).slice(2)}`,
          reference,
          name:item.name,
          quantity:item.quantity,
          remaining:item.quantity,
          unitCost:item.unitCost,
          expiry:item.expiry||'',
          receivedAt:now
        });
      });
      await saveInventoryBatches(batches);
      await refreshInventoryAggregates();
    }

    async function consumeInventoryItem(name,quantity){
      if(!name||quantity<=0) throw new Error('invalid-consumption');
      const batches=await loadInventoryBatches();
      const relevant=sortConsumptionBatches(batches.filter(b=>b.name===name&&b.remaining>0));
      let needed=roundAmount(quantity);
      const usage=[];
      const totalAvailable=relevant.reduce((s,b)=>s+roundAmount(b.remaining||0),0);
      if(totalAvailable+0.0001<needed){
        throw new Error('insufficient-stock');
      }
      let cost=0;
      for(const batch of relevant){
        if(needed<=0) break;
        const take=Math.min(batch.remaining,needed);
        if(take<=0) continue;
        batch.remaining=roundAmount(batch.remaining-take);
        const line=roundAmount(take*(batch.unitCost||0));
        cost=roundAmount(cost+line);
        usage.push({batchId:batch.id,quantity:take,unitCost:batch.unitCost});
        needed=roundAmount(needed-take);
      }
      await saveInventoryBatches(batches);
      await refreshInventoryAggregates();
      return {cost:roundAmount(cost),usage};
    }

    async function ensureCashAccounts(){
      let accounts=await Storage.load('cashAccounts');
      if(!accounts.length){
        accounts=[
          {id:'cash-main',name:'Ø§Ù„ØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ',type:'cash',notes:'Ø§Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ'},
          {id:'bank-main',name:'Ø§Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¨Ù†ÙƒÙŠ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ',type:'bank',notes:''}
        ];
        await Storage.save('cashAccounts',accounts);
      }
      App.cashAccounts=accounts;
      renderCashAccountSelectors();
    }

    function renderCashAccountSelectors(){
      const selects=['voucherAccount','cashCountAccount','disposalProceedsAccount'];
      const options=(App.cashAccounts||[]).map(acc=>`<option value="${acc.id}">${acc.name}</option>`).join('');
      selects.forEach(id=>{
        const el=document.getElementById(id);
        if(!el) return;
        el.innerHTML=`<option value="">Ø§Ø®ØªØ± Ø§Ù„Ø­Ø³Ø§Ø¨</option>${options}`;
        if(!el.value && App.cashAccounts.length){
          el.value=App.cashAccounts[0].id;
        }
      });
    }

    async function renderCashAccountsTable(){
      const accounts=App.cashAccounts||await Storage.load('cashAccounts');
      App.cashAccounts=accounts;
      const body=document.getElementById('cashAccountsTable');
      if(!body) return;
      body.innerHTML=accounts.map(acc=>`<tr>
        <td>${acc.name}</td>
        <td>${acc.type==='bank'?'Ø­Ø³Ø§Ø¨ Ø¨Ù†ÙƒÙŠ':'ØµÙ†Ø¯ÙˆÙ‚ Ù†Ù‚Ø¯ÙŠ'}</td>
        <td>${acc.notes||'-'}</td>
        <td><button class="btn danger" onclick="deleteCashAccount('${acc.id}')">Ø­Ø°Ù</button></td>
      </tr>`).join('');
      renderCashAccountSelectors();
    }

    async function saveCashAccount(){
      const name=document.getElementById('cashAccountName')?.value.trim();
      const type=document.getElementById('cashAccountType')?.value||'cash';
      const notes=document.getElementById('cashAccountNotes')?.value||'';
      if(!name){showToast('Ø§Ø³Ù… Ø§Ù„Ø­Ø³Ø§Ø¨ Ù…Ø·Ù„ÙˆØ¨','error');return;}
      const accounts=await Storage.load('cashAccounts');
      let account=accounts.find(acc=>acc.name===name);
      if(account){
        account.type=type;
        account.notes=notes;
      }else{
        account={id:`acc-${Date.now()}`,name,type,notes};
        accounts.push(account);
      }
      await Storage.save('cashAccounts',accounts);
      App.cashAccounts=accounts;
      renderCashAccountsTable();
      showToast('ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø­Ø³Ø§Ø¨');
      renderCashAccountSelectors();
    }

    async function deleteCashAccount(id){
      guardSensitive(async()=>{
        let accounts=await Storage.load('cashAccounts');
        if(accounts.length<=1){showToast('Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª','error');return;}
        accounts=accounts.filter(acc=>String(acc.id)!==String(id));
        await Storage.save('cashAccounts',accounts);
        App.cashAccounts=accounts;
        renderCashAccountsTable();
        renderCashAccountSelectors();
      });
    }

    async function computeCashAccountBalance(accountId){
      const account=getCashAccount(accountId);
      if(!account) return 0;
      const code=account.type==='bank'?AccountMap.bankAccounts.code:AccountMap.cashbox.code;
      const journals=await Storage.load('journals');
      let debit=0,credit=0;
      journals.forEach(j=>{
        j.entries.forEach(entry=>{
          if((entry.code||'')===code && (entry.detail||'')===account.name){
            debit+=entry.debit||0;
            credit+=entry.credit||0;
          }
        });
      });
      return roundAmount(debit-credit);
    }

    async function recordCashCount(){
      const accountId=document.getElementById('cashCountAccount')?.value||'';
      const date=document.getElementById('cashCountDate')?.value||new Date().toISOString().slice(0,10);
      const actual=parseFloat(document.getElementById('cashCountActual')?.value||'0');
      const notes=document.getElementById('cashCountNotes')?.value||'';
      if(!accountId){showToast('Ø§Ø®ØªØ± Ø§Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø±Ø§Ø¯ Ø¬Ø±Ø¯Ù‡','error');return;}
      const book=await computeCashAccountBalance(accountId);
      const diff=roundAmount(actual-book);
      const counts=await Storage.load('cashCounts');
      const account=getCashAccount(accountId);
      const record={id:Date.now(),accountId,accountName:account?account.name:'',date,book,actual:roundAmount(actual),difference:diff,notes};
      counts.push(record);
      await Storage.save('cashCounts',counts);
      await logAudit('add',`CASH-COUNT-${record.id}`,'Ø¬Ø±Ø¯ ÙŠÙˆÙ…ÙŠ Ù„Ù„ØµÙ†Ø¯ÙˆÙ‚',record);
      showToast('ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¬Ø±Ø¯');
      renderCashCountTable();
    }

    async function renderCashCountTable(){
      const table=document.getElementById('cashCountTable');
      if(!table) return;
      const counts=await Storage.load('cashCounts');
      if(!counts.length){
        table.innerHTML='<tr><td colspan="6">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¬Ø±Ø¯Ø§Øª Ù…Ø³Ø¬Ù„Ø©</td></tr>';
        return;
      }
      table.innerHTML=counts.slice(-100).reverse().map(row=>`<tr>
        <td>${formatDate(row.date)}</td>
        <td>${row.accountName||'-'}</td>
        <td>${formatCurrency(row.book||0)}</td>
        <td>${formatCurrency(row.actual||0)}</td>
        <td>${formatCurrency(row.difference||0)}</td>
        <td>${row.notes||'-'}</td>
      </tr>`).join('');
    }

    async function cashCountPDF(){
      const doc=createArabicPDF();
      doc.setFontSize(14);
      pdfTextRight(doc,'Ø¬Ø±Ø¯ Ø§Ù„ØµÙ†Ø¯ÙˆÙ‚',20);
      const counts=await Storage.load('cashCounts');
      if(!counts.length){
        showToast('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„Ø¬Ø±Ø¯','error');
        return;
      }
      const rows=counts.slice(-100).reverse().map(row=>[
        formatDate(row.date),
        row.accountName||'-',
        formatCurrency(row.book||0),
        formatCurrency(row.actual||0),
        formatCurrency(row.difference||0),
        row.notes||'-'
      ]);
      autoTableArabic(doc,{startY:30,head:[['Ø§Ù„ØªØ§Ø±ÙŠØ®','Ø§Ù„Ø­Ø³Ø§Ø¨','Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ø¯ÙØªØ±ÙŠ','Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„ÙØ¹Ù„ÙŠ','Ø§Ù„ÙØ±Ù‚','Ù…Ù„Ø§Ø­Ø¸Ø§Øª']],body:rows});
      doc.save('cash-count.pdf');
    }

    async function saveMedicalAlert(){
      const patient=document.getElementById('alertPatient')?.value;
      const type=document.getElementById('alertType')?.value.trim();
      const severity=document.getElementById('alertSeverity')?.value;
      const notes=document.getElementById('alertNotes')?.value||'';
      if(!patient||!type){showToast('Ø£Ø¯Ø®Ù„ ØªÙØ§ØµÙŠÙ„ Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡','error');return;}
      const alerts=await Storage.load('medicalAlerts');
      alerts.push({id:Date.now(),patient,type,severity,notes,createdAt:new Date().toISOString()});
      await Storage.save('medicalAlerts',alerts);
      await logAudit('add',patient,'ØªÙ†Ø¨ÙŠÙ‡ Ø·Ø¨ÙŠ',{type,severity});
      showToast('ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡');
      renderMedicalAlerts();
      renderPatientsTable();
    }

    async function renderMedicalAlerts(){
      const container=document.getElementById('medicalAlertsList');
      if(!container) return;
      const alerts=await Storage.load('medicalAlerts');
      if(!alerts.length){container.innerHTML='<span class="badge">Ù„Ø§ ØªÙˆØ¬Ø¯ ØªÙ†Ø¨ÙŠÙ‡Ø§Øª</span>';return;}
      container.innerHTML='<ul>'+alerts.slice(-200).reverse().map(alert=>`<li>${formatDate(alert.createdAt)} â€” <strong>${alert.patient}</strong> (${alert.severity}) : ${alert.type} <button class="btn danger" style="padding:.2rem .6rem;" onclick="deleteMedicalAlert(${alert.id})">Ø­Ø°Ù</button></li>`).join('')+'</ul>';
    }

    async function deleteMedicalAlert(id){
      guardSensitive(async()=>{
        let alerts=await Storage.load('medicalAlerts');
        alerts=alerts.filter(a=>a.id!==id);
        await Storage.save('medicalAlerts',alerts);
        renderMedicalAlerts();
        renderPatientsTable();
      });
    }

    async function saveAppointment(){
      await updatePatientSelectors();
      const patient=document.getElementById('appointmentPatient')?.value;
      const service=document.getElementById('appointmentService')?.value.trim();
      const doctor=document.getElementById('appointmentDoctor')?.value.trim();
      const when=document.getElementById('appointmentDate')?.value;
      const period=document.getElementById('appointmentPeriod')?.value;
      const status=document.getElementById('appointmentStatus')?.value;
      const paid=parseFloat(document.getElementById('appointmentPaid')?.value||'0');
      const due=parseFloat(document.getElementById('appointmentDue')?.value||'0');
      const notes=document.getElementById('appointmentNotes')?.value||'';
      if(!patient||!service||!doctor||!when){showToast('Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ÙˆØ¹Ø¯ ØºÙŠØ± Ù…ÙƒØªÙ…Ù„Ø©','error');return;}
      const appointments=await Storage.load('appointments');
      const record={id:Date.now(),patient,service,doctor,date:when,period,status,paid,due,notes,createdAt:new Date().toISOString()};
      appointments.push(record);
      await Storage.save('appointments',appointments);
      if(due>0){
        const receivables=await Storage.load('patientReceivables');
        const reference=generateReference('AR');
        receivables.push({
          id:Date.now()+1,
          reference,
          patient,
          service,
          doctor,
          amount:roundAmount(due),
          balance:roundAmount(due),
          due:when.slice(0,10),
          notes:`${service} â€” Ù…ÙˆØ¹Ø¯`,
          source:'appointment',
          sourceId:record.id,
          status:'open',
          createdAt:new Date().toISOString()
        });
        await Storage.save('patientReceivables',receivables);
      }
      await logAudit('add',record.id,'Ù…ÙˆØ¹Ø¯ Ø¬Ø¯ÙŠØ¯',record);
      showToast('ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù…ÙˆØ¹Ø¯');
      renderAppointmentsTable();
      renderAppointmentsTomorrow();
      renderPatientReceivables();
      renderPatientsTable();
      renderReceiptOutstanding();
    }

    async function populateAppointmentFilters(){
      const doctorSelect=document.getElementById('appointmentFilterDoctor');
      if(doctorSelect){
        const doctors=await Storage.load('doctors');
        const current=doctorSelect.value;
        doctorSelect.innerHTML='<option value="">ÙƒÙ„ Ø§Ù„Ø£Ø·Ø¨Ø§Ø¡</option>'+doctors.map(d=>`<option value="${d.name}">${d.name}</option>`).join('');
        if(current) doctorSelect.value=current;
      }
    }

    async function renderAppointmentsTable(){
      await updatePatientSelectors();
      await populateAppointmentFilters();
      const appointments=await Storage.load('appointments');
      const doctorFilter=document.getElementById('appointmentFilterDoctor')?.value||'';
      const statusFilter=document.getElementById('appointmentFilterStatus')?.value||'';
      const body=document.getElementById('appointmentsTable');
      if(!body) return;
      body.innerHTML=appointments.slice(-500).reverse().filter(app=>{
        return (!doctorFilter||app.doctor===doctorFilter)&&(!statusFilter||app.status===statusFilter);
      }).map(app=>`<tr>
        <td>${app.patient}</td>
        <td>${app.service}</td>
        <td>${app.doctor}</td>
        <td>${new Date(app.date).toLocaleString('ar-SA')}</td>
        <td>${app.status}</td>
        <td>${formatCurrency(app.paid||0)} / ${formatCurrency(app.due||0)}</td>
        <td>
          <button class="btn" onclick="markAppointment(${app.id},'completed')">ØªÙ…</button>
          <button class="btn secondary" onclick="markAppointment(${app.id},'in-progress')">Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°</button>
          <button class="btn danger" onclick="markAppointment(${app.id},'cancelled')">Ø¥Ù„ØºØ§Ø¡</button>
        </td>
      </tr>`).join('');
    }

    async function markAppointment(id,status){
      const appointments=await Storage.load('appointments');
      const appointment=appointments.find(a=>a.id===id);
      if(!appointment) return;
      appointment.status=status;
      appointment.updatedAt=new Date().toISOString();
      await Storage.save('appointments',appointments);
      await logAudit('update',id,'ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ù…ÙˆØ¹Ø¯',{status});
      showToast('ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…ÙˆØ¹Ø¯');
      renderAppointmentsTable();
      renderAppointmentsTomorrow();
    }

    async function deletePatient(name){
      guardSensitive(async()=>{
        let patients=await Storage.load('patients');
        patients=patients.filter(p=>p.name!==name);
        await Storage.save('patients',patients);
        await logAudit('delete',name,'Ø­Ø°Ù Ù…Ø±ÙŠØ¶');
        renderPatientsTable();
        await updatePatientSelectors();
      });
    }

    async function savePurchaseInvoice(){
      const supplier=document.getElementById('invoiceSupplier').value.trim();
      const toStock=document.getElementById('invoiceToStock').value;
      const amountField=parseFloat(document.getElementById('invoiceAmount').value);
      const dueDateInput=document.getElementById('invoiceDueDate').value;
      const dueDate=dueDateInput||new Date().toISOString().slice(0,10);
      const notes=document.getElementById('invoiceNotes').value.trim();
      if(!supplier){showToast('Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ±Ø¯ Ù…Ø·Ù„ÙˆØ¨','error');return;}
      let items=[];
      let amount=roundAmount(amountField);
      if(toStock==='yes'){
        items=collectPurchaseItems();
        if(!items.length){showToast('Ø£Ø¶Ù Ø¨Ù†Ø¯Ù‹Ø§ ÙˆØ§Ø­Ø¯Ù‹Ø§ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„ Ù„Ù„Ù…Ø®Ø²ÙˆÙ†','error');return;}
        amount=roundAmount(items.reduce((sum,item)=>sum+item.total,0));
        if(amount<=0){showToast('Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¨Ù†ÙˆØ¯ ØºÙŠØ± ØµØ§Ù„Ø­','error');return;}
        document.getElementById('invoiceAmount').value=amount;
      }else{
        if(isNaN(amount)||amount<=0){showToast('Ø§Ù„Ù‚ÙŠÙ…Ø© ØºÙŠØ± ØµØ§Ù„Ø­Ø©','error');return;}
      }
      const invoices=await Storage.load('purchaseInvoices');
      const reference=generateReference('PI');
      const invoice={reference,supplier,toStock,amount,notes,dueDate,balance:amount,status:'open',createdAt:new Date().toISOString()};
      if(items.length){invoice.items=items;}
      invoices.push(invoice);
      await Storage.save('purchaseInvoices',invoices);
      const entryType=toStock==='yes'?'purchase-stock':'purchase-expense';
      await recordJournal(buildEntry(entryType,{amount,supplier}),{type:'purchase',reference,supplier,toStock});
      if(items.length){
        await addInventoryBatchesFromPurchase(reference,items);
      }
      await logAudit('add',reference,'ÙØ§ØªÙˆØ±Ø© Ù…Ø´ØªØ±ÙŠØ§Øª',invoice);
      showToast('ØªÙ… Ø­ÙØ¸ Ø§Ù„ÙØ§ØªÙˆØ±Ø©');
      document.getElementById('invoiceSupplier').value='';
      document.getElementById('invoiceNotes').value='';
      if(toStock==='yes'){
        const wrapper=document.getElementById('invoiceItems');
        if(wrapper){wrapper.innerHTML='';}
        addPurchaseItemRow();
      }
      renderSupplierReturns();
      renderSupplierPayables();
      renderPaymentOutstanding();
      renderInventoryTable();
      refreshMiniTrial();
    }

    async function saveSupplierReturn(){
      const supplier=document.getElementById('returnSupplier').value.trim();
      const amount=parseFloat(document.getElementById('returnAmount').value);
      const status=document.getElementById('returnStatus').value;
      const notes=document.getElementById('returnNotes').value.trim();
      if(!supplier||isNaN(amount)||amount<=0){showToast('Ø¨ÙŠØ§Ù†Ø§Øª ØºÙŠØ± ØµØ§Ù„Ø­Ø©','error');return;}
      const returns=await Storage.load('supplierReturns');
      const reference=generateReference('SR');
      const cashAccount=defaultCashAccountId();
      const record={reference,supplier,amount,status,notes,accountId:cashAccount,createdAt:new Date().toISOString()};
      returns.push(record);
      await Storage.save('supplierReturns',returns);
      if(status==='pending'){
        await recordJournal(buildEntry('supplier-return-pending',{amount,supplier,accountId:cashAccount}),{type:'supplier-return',reference,supplier});
      }else{
        await recordJournal(buildEntry('supplier-return-settlement',{amount,supplier}),{type:'supplier-settlement',reference,supplier});
      }
      await logAudit('add',reference,'Ù…Ø±ØªØ¬Ø¹ Ù…ÙˆØ±Ø¯',record);
      showToast('ØªÙ… Ø§Ù„Ø­ÙØ¸');
      renderSupplierReturns();
      renderSupplierPayables();
      refreshMiniTrial();
    }

    async function renderSupplierReturns(){
      const returns=await Storage.load('supplierReturns');
      const body=document.getElementById('returnsTable');
      if(!body) return;
      body.innerHTML=returns.slice(-200).reverse().map(r=>{
        const statusLabel=r.status==='pending'?'Ù‚ÙŠØ¯ Ø§Ù„ØªØ³ÙˆÙŠØ©':r.status==='settled'?'Ù…Ø³ÙˆÙ‰':r.status;
        return `
        <tr>
          <td>${r.reference}</td>
          <td>${r.supplier}</td>
          <td>${formatCurrency(r.amount)}</td>
          <td>${statusLabel}</td>
          <td><button class="btn danger" onclick="deleteSupplierReturn('${r.reference}')">Ø­Ø°Ù</button></td>
        </tr>`;
      }).join('');
    }

    async function deleteSupplierReturn(reference){
      guardSensitive(async()=>{
        let returns=await Storage.load('supplierReturns');
        returns=returns.filter(r=>r.reference!==reference);
        await Storage.save('supplierReturns',returns);
        await logAudit('delete',reference,'Ø­Ø°Ù Ù…Ø±ØªØ¬Ø¹');
        renderSupplierReturns();
        renderSupplierPayables();
      });
    }

    async function saveLabOrder(){
      const patient=document.getElementById('labPatient').value.trim();
      const doctor=document.getElementById('labDoctor').value.trim();
      const partner=document.getElementById('labPartner').value.trim();
      const service=document.getElementById('labService').value.trim();
      const units=parseInt(document.getElementById('labUnits').value||'1');
      const sent=document.getElementById('labSent').value;
      const expected=document.getElementById('labExpected').value;
      const cost=parseFloat(document.getElementById('labCost').value||'0');
      const status=document.getElementById('labStatus').value;
      const notes=document.getElementById('labNotes').value.trim();
      const result=document.getElementById('labResult').value.trim();
      let resultAttachment=null;
      const file=document.getElementById('labResultFile').files[0];
      if(file){
        if(file.size>20*1024*1024){showToast('Ø­Ø¬Ù… Ù…Ø±ÙÙ‚ Ø§Ù„Ù†ØªÙŠØ¬Ø© ÙŠØªØ¬Ø§ÙˆØ² Ø§Ù„Ø­Ø¯ (20MB)','error');return;}
        resultAttachment=await fileToBase64(file);
      }
      if(!patient||!service){showToast('Ø¨ÙŠØ§Ù†Ø§Øª ØºÙŠØ± ØµØ§Ù„Ø­Ø©','error');return;}
      const labs=await Storage.load('labs');
      const reference=generateReference('LB');
      const record={reference,patient,doctor,partner,service,units,sent,expected,cost,status,notes,result,resultAttachment,createdAt:new Date().toISOString()};
      labs.push(record);
      await Storage.save('labs',labs);
      await logAudit('add',reference,'Ø·Ù„Ø¨ Ù…Ø¹Ù…Ù„',record);
      showToast('ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø·Ù„Ø¨');
      await renderLabsTable();
      await renderDoctorsTable();
    }

    async function renderLabsTable(){
      const labs=await Storage.load('labs');
      const body=document.getElementById('labsTable');
      const stats=document.getElementById('labStats');
      const summary=labs.reduce((acc,cur)=>{acc[cur.status]=(acc[cur.status]||0)+1;return acc;},{})
      if(stats){
        stats.textContent=`Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°: ${summary['in-progress']||0} | Ù…ØªØ£Ø®Ø±: ${summary['delayed']||0} | ØªÙ…: ${summary['done']||0}`;
      }
      if(!body) return;
      body.innerHTML=labs.slice(-200).reverse().map(l=>`
        <tr>
          <td>${l.reference}</td>
          <td>${l.patient}</td>
          <td>${l.service}</td>
          <td>${l.partner||'-'}</td>
          <td>${l.status}</td>
          <td>${formatCurrency(l.cost||0)}</td>
          <td>${l.result?'<span class="badge">Ù…ØªÙˆÙØ±</span>':'-'}</td>
          <td><button class="btn secondary" onclick="labOrderPDF('${l.reference}')">PDF</button></td>
        </tr>`).join('');
    }

    function inventoryAlert(item){
      const low=item.qty<=item.min;
      let expiryAlert=false;
      if(item.expiry){
        const diff=(new Date(item.expiry)-new Date())/(1000*60*60*24*30);
        expiryAlert=diff<=6;
      }
      if(low&&expiryAlert) return 'ÙƒÙ…ÙŠØ© Ù…Ù†Ø®ÙØ¶Ø© ÙˆØµÙ„Ø§Ø­ÙŠØ© Ù‚Ø±ÙŠØ¨Ø©';
      if(low) return 'ÙƒÙ…ÙŠØ© Ù…Ù†Ø®ÙØ¶Ø©';
      if(expiryAlert) return 'Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ© Ù‚Ø±ÙŠØ¨Ø©';
      return '';
    }

    async function saveInventoryItem(){
      const name=document.getElementById('itemName').value.trim();
      const min=parseFloat(document.getElementById('itemMin').value||'0');
      const expiry=document.getElementById('itemExpiry').value;
      if(!name){showToast('Ø§Ø³Ù… Ø§Ù„Ù…Ø§Ø¯Ø© Ù…Ø·Ù„ÙˆØ¨','error');return;}
      const inventory=await Storage.load('inventory');
      let item=inventory.find(i=>i.name===name);
      const sanitizedMin=isNaN(min)?0:min;
      if(item){
        item.min=sanitizedMin;
        if(expiry) item.expiry=expiry;
      }else{
        item={name,qty:0,min:sanitizedMin,expiry:expiry||'',createdAt:new Date().toISOString()};
        inventory.push(item);
      }
      await Storage.save('inventory',inventory);
      await refreshInventoryAggregates();
      updateInventoryItemList(inventory);
      await logAudit('add',name,'ØªØ­Ø¯ÙŠØ« Ù…Ø§Ø¯Ø©',{min:sanitizedMin});
      showToast('ØªÙ… Ø§Ù„Ø­ÙØ¸');
      renderInventoryTable();
    }

    async function renderInventoryTable(){
      const {inventory}=await refreshInventoryAggregates();
      const body=document.getElementById('inventoryTable');
      if(!body) return;
      body.innerHTML=inventory.map(item=>{
        const alert=inventoryAlert(item);
        return `<tr>
          <td>${item.name}</td>
          <td>${item.qty}</td>
          <td>${item.min}</td>
          <td>${item.expiry?formatDate(item.expiry):'-'}</td>
          <td>${alert?`<span class="badge danger">${alert}</span>`:'<span class="badge">Ø¬ÙŠØ¯</span>'}</td>
          <td><button class="btn danger" onclick="deleteInventoryItem('${item.name}')">Ø­Ø°Ù</button></td>
        </tr>`;
      }).join('');
      const qtyInput=document.getElementById('itemQty');
      if(qtyInput) qtyInput.value='';
      renderInventoryAlerts(inventory);
      renderInventoryConsumptionHistory();
    }

    async function deleteInventoryItem(name){
      guardSensitive(async()=>{
        let inventory=await Storage.load('inventory');
        inventory=inventory.filter(i=>i.name!==name);
        await Storage.save('inventory',inventory);
        const batches=await loadInventoryBatches();
        const filtered=batches.filter(batch=>batch.name!==name);
        if(filtered.length!==batches.length){
          await saveInventoryBatches(filtered);
        }
        await refreshInventoryAggregates();
        await logAudit('delete',name,'Ø­Ø°Ù Ù…Ø§Ø¯Ø©');
        renderInventoryTable();
      });
    }

    async function renderInventoryAlerts(list){
      const inventory=list|| (await refreshInventoryAggregates()).inventory;
      const container=document.getElementById('inventoryAlerts');
      if(!container) return;
      const alerts=inventory.filter(i=>inventoryAlert(i));
      if(!alerts.length){container.innerHTML='<span class="badge">Ù„Ø§ ØªÙˆØ¬Ø¯ ØªÙ†Ø¨ÙŠÙ‡Ø§Øª</span>';return;}
      container.innerHTML='<ul>'+alerts.map(a=>`<li>${a.name} â€” ${inventoryAlert(a)}</li>`).join('')+'</ul>';
    }

    async function recordInventoryConsumption(){
      const item=document.getElementById('consumeItem')?.value.trim();
      const qty=parseFloat(document.getElementById('consumeQty')?.value||'0');
      const service=document.getElementById('consumeService')?.value.trim();
      const doctor=document.getElementById('consumeDoctor')?.value.trim();
      const center=document.getElementById('consumeCenter')?.value.trim();
      const notes=document.getElementById('consumeNotes')?.value.trim();
      if(!item||isNaN(qty)||qty<=0){showToast('Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø§Ø³ØªÙ‡Ù„Ø§Ùƒ ØºÙŠØ± ØµØ§Ù„Ø­Ø©','error');return;}
      try{
        const {cost,usage}=await consumeInventoryItem(item,qty);
        const reference=generateReference('IC');
        const record={reference,item,quantity:roundAmount(qty),cost,service,doctor,center,notes,usage,createdAt:new Date().toISOString()};
        const history=await Storage.load('inventoryConsumption');
        history.push(record);
        await Storage.save('inventoryConsumption',history);
        if(cost>0){
          await recordJournal(buildEntry('inventory-consumption',{amount:cost,item,service,doctor}),{type:'inventory-consumption',reference,item,service,doctor,center});
        }
        await logAudit('add',reference,'Ø§Ø³ØªÙ‡Ù„Ø§Ùƒ Ù…Ø®Ø²ÙˆÙ†',record);
        showToast('ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ø³ØªÙ‡Ù„Ø§Ùƒ Ø§Ù„Ù…Ø®Ø²ÙˆÙ†');
        document.getElementById('consumeQty').value='';
        document.getElementById('consumeNotes').value='';
        renderInventoryTable();
        renderInventoryConsumptionHistory();
        refreshMiniTrial();
      }catch(err){
        if(err.message==='insufficient-stock'){showToast('Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø© ØºÙŠØ± Ù…ØªÙˆÙØ±Ø© ÙÙŠ Ø§Ù„Ù…Ø®Ø²ÙˆÙ†','error');}
        else{showToast('ØªØ¹Ø°Ø± ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø§Ø³ØªÙ‡Ù„Ø§Ùƒ','error');console.error(err);}
      }
    }

    async function renderInventoryConsumptionHistory(){
      const container=document.getElementById('inventoryConsumptionHistory');
      if(!container) return;
      const history=await Storage.load('inventoryConsumption');
      if(!history.length){container.innerHTML='<span class="badge">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø§Ø³ØªÙ‡Ù„Ø§Ùƒ Ù…Ø³Ø¬Ù„</span>';return;}
      container.innerHTML='<table><thead><tr><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>Ø§Ù„Ù…Ø§Ø¯Ø©</th><th>Ø§Ù„ÙƒÙ…ÙŠØ©</th><th>Ø§Ù„ØªÙƒÙ„ÙØ©</th><th>Ø§Ù„Ø®Ø¯Ù…Ø©</th><th>Ø§Ù„Ø·Ø¨ÙŠØ¨</th></tr></thead><tbody>'+history.slice(-100).reverse().map(row=>`<tr><td>${formatDate(row.createdAt)}</td><td>${row.item}</td><td>${row.quantity}</td><td>${formatCurrency(row.cost)}</td><td>${row.service||'-'}</td><td>${row.doctor||'-'}</td></tr>`).join('')+'</tbody></table>';
    }

    async function saveEmployee(){
      const name=document.getElementById('employeeName')?.value.trim();
      const role=document.getElementById('employeeRole')?.value.trim();
      const phone=document.getElementById('employeePhone')?.value.trim();
      const salary=parseFloat(document.getElementById('employeeSalary')?.value||'0');
      const start=document.getElementById('employeeStart')?.value||'';
      const notes=document.getElementById('employeeNotes')?.value||'';
      if(!name){showToast('Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ¸Ù Ù…Ø·Ù„ÙˆØ¨','error');return;}
      const employees=await Storage.load('employees');
      let employee=employees.find(e=>e.name===name);
      const sanitizedSalary=isNaN(salary)?0:salary;
      if(employee){
        Object.assign(employee,{role,phone,salary:sanitizedSalary,start,notes});
      }else{
        employee={id:Date.now(),name,role,phone,salary:sanitizedSalary,start,notes};
        employees.push(employee);
      }
      await Storage.save('employees',employees);
      await logAudit('add',name,'ØªØ­Ø¯ÙŠØ« Ù…Ù„Ù Ù…ÙˆØ¸Ù',{role,salary:sanitizedSalary});
      showToast('ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù…ÙˆØ¸Ù');
      await renderEmployees();
    }

    async function renderEmployees(){
      const employees=await Storage.load('employees');
      const body=document.getElementById('employeesTable');
      if(!body) return;
      body.innerHTML=employees.map(emp=>`<tr>
        <td>${emp.name}</td>
        <td>${emp.role||'-'}</td>
        <td>${emp.phone||'-'}</td>
        <td>${formatCurrency(emp.salary||0)}</td>
        <td>${emp.start?formatDate(emp.start):'-'}</td>
        <td><button class="btn danger" onclick="deleteEmployee(${emp.id})">Ø­Ø°Ù</button></td>
      </tr>`).join('');
    }

    async function deleteEmployee(id){
      guardSensitive(async()=>{
        let employees=await Storage.load('employees');
        employees=employees.filter(emp=>emp.id!==id);
        await Storage.save('employees',employees);
        await logAudit('delete',id,'Ø­Ø°Ù Ù…ÙˆØ¸Ù');
        await renderEmployees();
      });
    }

    async function saveLabPartner(){
      const name=document.getElementById('labMasterName')?.value.trim();
      const phone=document.getElementById('labMasterPhone')?.value.trim();
      const notes=document.getElementById('labMasterNotes')?.value||'';
      if(!name){showToast('Ø§Ø³Ù… Ø§Ù„Ù…Ø¹Ù…Ù„ Ù…Ø·Ù„ÙˆØ¨','error');return;}
      const labs=await Storage.load('labPartners');
      let lab=labs.find(l=>l.name===name);
      if(lab){
        Object.assign(lab,{phone,notes});
      }else{
        lab={id:Date.now(),name,phone,notes};
        labs.push(lab);
      }
      await Storage.save('labPartners',labs);
      await logAudit('add',name,'ØªØ­Ø¯ÙŠØ« Ù…Ø¹Ù…Ù„',{phone});
      showToast('ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù…Ø¹Ù…Ù„');
      await renderLabPartners();
      await refreshCatalogLists();
    }

    async function renderLabPartners(){
      const labs=await Storage.load('labPartners');
      const body=document.getElementById('labPartnersTable');
      if(!body) return;
      body.innerHTML=labs.map(lab=>`<tr>
        <td>${lab.name}</td>
        <td>${lab.phone||'-'}</td>
        <td>${lab.notes||'-'}</td>
        <td><button class="btn danger" onclick="deleteLabPartner(${lab.id})">Ø­Ø°Ù</button></td>
      </tr>`).join('');
    }

    async function deleteLabPartner(id){
      guardSensitive(async()=>{
        let labs=await Storage.load('labPartners');
        labs=labs.filter(l=>l.id!==id);
        await Storage.save('labPartners',labs);
        await logAudit('delete',id,'Ø­Ø°Ù Ù…Ø¹Ù…Ù„');
        await renderLabPartners();
        await refreshCatalogLists();
      });
    }

    async function saveClinicService(){
      const department=document.getElementById('clinicServiceDepartment')?.value.trim();
      const name=document.getElementById('clinicServiceName')?.value.trim();
      const price=parseFloat(document.getElementById('clinicServicePrice')?.value||'0');
      const notes=document.getElementById('clinicServiceNotes')?.value||'';
      if(!name){showToast('Ø§Ø³Ù… Ø§Ù„Ø®Ø¯Ù…Ø© Ù…Ø·Ù„ÙˆØ¨','error');return;}
      const services=await Storage.load('clinicServices');
      let record=services.find(s=>s.name===name&&s.department===department);
      const normalizedPrice=isNaN(price)?0:price;
      if(record){
        Object.assign(record,{price:normalizedPrice,notes});
      }else{
        record={id:Date.now(),department,name,price:normalizedPrice,notes};
        services.push(record);
      }
      await Storage.save('clinicServices',services);
      await logAudit('add',name,'ØªØ­Ø¯ÙŠØ« Ø®Ø¯Ù…Ø© Ø¹ÙŠØ§Ø¯Ø©',{department,price:normalizedPrice});
      showToast('ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø®Ø¯Ù…Ø©');
      await renderClinicCatalog();
      await refreshCatalogLists();
    }

    async function renderClinicCatalog(){
      const services=await Storage.load('clinicServices');
      const body=document.getElementById('clinicCatalogTable');
      if(!body) return;
      body.innerHTML=services.map(service=>`<tr>
        <td>${service.department||'-'}</td>
        <td>${service.name}</td>
        <td>${formatCurrency(service.price||0)}</td>
        <td>${service.notes||'-'}</td>
        <td><button class="btn danger" onclick="deleteClinicService(${service.id})">Ø­Ø°Ù</button></td>
      </tr>`).join('');
    }

    async function deleteClinicService(id){
      guardSensitive(async()=>{
        let services=await Storage.load('clinicServices');
        services=services.filter(s=>s.id!==id);
        await Storage.save('clinicServices',services);
        await logAudit('delete',id,'Ø­Ø°Ù Ø®Ø¯Ù…Ø© Ø¹ÙŠØ§Ø¯Ø©');
        await renderClinicCatalog();
        await refreshCatalogLists();
      });
    }

    async function exportClinicCatalog(){
      const services=await Storage.load('clinicServices');
      if(!services.length){showToast('Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„ØªØµØ¯ÙŠØ±Ù‡Ø§','error');return;}
      const header='department,service,price,notes';
      const rows=services.map(s=>[
        s.department||'',
        s.name.replace(/,/g,';'),
        s.price||0,
        (s.notes||'').replace(/,/g,';')
      ].join(','));
      const csv=[header,...rows].join('\n');
      const blob=new Blob([csv],{type:'text/csv;charset=utf-8;'});
      const url=URL.createObjectURL(blob);
      const a=document.createElement('a');
      a.href=url;
      a.download='clinic-services.csv';
      a.click();
      URL.revokeObjectURL(url);
      showToast('ØªÙ… ØªØµØ¯ÙŠØ± Ø§Ù„ÙƒØªØ§Ù„ÙˆØ¬');
    }

    async function importClinicCatalog(event){
      const file=event.target.files?.[0];
      if(!file) return;
      try{
        const text=await file.text();
        const lines=text.split(/\r?\n/).filter(Boolean);
        const [,...dataLines]=lines;
        const services=await Storage.load('clinicServices');
        dataLines.forEach(line=>{
          const [department='',name='',price='0',notes='']=line.split(',');
          if(!name.trim()) return;
          const existing=services.find(s=>s.name===name.trim()&&s.department===department.trim());
          const payload={
            id:existing?existing.id:Date.now()+Math.random(),
            department:department.trim(),
            name:name.trim(),
            price:parseFloat(price)||0,
            notes:notes.replace(/;/g,',').trim()
          };
          if(existing){
            Object.assign(existing,payload);
          }else{
            services.push(payload);
          }
        });
        await Storage.save('clinicServices',services);
        await logAudit('import','clinic-services','Ø§Ø³ØªÙŠØ±Ø§Ø¯ ÙƒØªØ§Ù„ÙˆØ¬ Ø®Ø¯Ù…Ø§Øª',{count:services.length});
        showToast('ØªÙ… Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø¨Ù†Ø¬Ø§Ø­');
        await renderClinicCatalog();
        await refreshCatalogLists();
      }catch(err){
        console.error(err);
        showToast('ØªØ¹Ø°Ø± Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù…Ù„Ù','error');
      }finally{
        event.target.value='';
      }
    }

    async function saveLabCatalogService(){
      const service=document.getElementById('labCatalogService')?.value.trim();
      const lab=document.getElementById('labCatalogLab')?.value.trim();
      const price=parseFloat(document.getElementById('labCatalogPrice')?.value||'0');
      const notes=document.getElementById('labCatalogNotes')?.value||'';
      if(!service){showToast('Ø§Ø³Ù… Ø§Ù„Ø®Ø¯Ù…Ø© Ù…Ø·Ù„ÙˆØ¨','error');return;}
      const catalog=await Storage.load('labCatalog');
      let existing=catalog.find(item=>item.service===service&&item.lab===lab);
      const normalizedPrice=isNaN(price)?0:price;
      if(existing){
        Object.assign(existing,{price:normalizedPrice,notes});
      }else{
        existing={id:Date.now(),service,lab,price:normalizedPrice,notes};
        catalog.push(existing);
      }
      await Storage.save('labCatalog',catalog);
      await logAudit('add',service,'ØªØ­Ø¯ÙŠØ« Ø®Ø¯Ù…Ø© Ù…Ø¹Ù…Ù„',{lab,price:normalizedPrice});
      showToast('ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø®Ø¯Ù…Ø©');
      await renderLabCatalog();
      await refreshCatalogLists();
    }

    async function renderLabCatalog(){
      const catalog=await Storage.load('labCatalog');
      const body=document.getElementById('labCatalogTable');
      if(!body) return;
      body.innerHTML=catalog.map(item=>`<tr>
        <td>${item.service}</td>
        <td>${item.lab||'-'}</td>
        <td>${formatCurrency(item.price||0)}</td>
        <td>${item.notes||'-'}</td>
        <td><button class="btn danger" onclick="deleteLabCatalogService(${item.id})">Ø­Ø°Ù</button></td>
      </tr>`).join('');
    }

    async function deleteLabCatalogService(id){
      guardSensitive(async()=>{
        let catalog=await Storage.load('labCatalog');
        catalog=catalog.filter(item=>item.id!==id);
        await Storage.save('labCatalog',catalog);
        await logAudit('delete',id,'Ø­Ø°Ù Ø®Ø¯Ù…Ø© Ù…Ø¹Ù…Ù„');
        await renderLabCatalog();
        await refreshCatalogLists();
      });
    }

    async function refreshCatalogLists(){
      const services=await Storage.load('clinicServices');
      const clinicList=document.getElementById('clinicServiceList');
      if(clinicList){
        clinicList.innerHTML=services.map(s=>`<option value="${s.name}">${s.department?`${s.department} â€” ${s.name}`:s.name}</option>`).join('');
      }
      const labs=await Storage.load('labPartners');
      const labList=document.getElementById('labPartnerList');
      if(labList){
        labList.innerHTML=labs.map(l=>`<option value="${l.name}">${l.name}</option>`).join('');
      }
      const labServices=await Storage.load('labCatalog');
      const labServiceList=document.getElementById('labServiceList');
      if(labServiceList){
        labServiceList.innerHTML=labServices.map(item=>`<option value="${item.service}">${item.service}${item.lab?` â€” ${item.lab}`:''}</option>`).join('');
      }
    }

    async function refreshDoctorOptions(){
      const doctors=await Storage.load('doctors');
      const list=document.getElementById('doctorList');
      if(list){
        list.innerHTML=doctors.map(doc=>`<option value="${doc.name}">${doc.name}</option>`).join('');
      }
    }

    function advanceExpenseDue(item){
      if(!item.nextDue) return;
      const due=new Date(item.nextDue);
      if(item.frequency==='monthly') due.setMonth(due.getMonth()+1);
      if(item.frequency==='quarterly') due.setMonth(due.getMonth()+3);
      if(item.frequency==='yearly') due.setFullYear(due.getFullYear()+1);
      item.nextDue=due.toISOString().slice(0,10);
    }

    function expenseStatus(item){
      if(!item.nextDue) return 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
      const diff=(new Date(item.nextDue)-new Date())/(1000*60*60*24);
      if(diff<0) return 'Ù…Ø³ØªØ­Ù‚';
      if(diff<=7) return 'Ù‚Ø±ÙŠØ¨';
      return 'Ù…Ø³ØªÙ‚Ø¨Ù„ÙŠ';
    }

    async function saveRecurringExpense(){
      const name=document.getElementById('expenseName')?.value.trim();
      const amount=parseFloat(document.getElementById('expenseAmount')?.value||'0');
      const frequency=document.getElementById('expenseFrequency')?.value;
      const nextDue=document.getElementById('expenseNextDue')?.value;
      const costCenter=document.getElementById('expenseCostCenter')?.value||'';
      if(!name||isNaN(amount)||amount<=0||!nextDue){showToast('Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ØµØ±ÙˆÙ ØºÙŠØ± Ù…ÙƒØªÙ…Ù„Ø©','error');return;}
      const expenses=await Storage.load('operatingExpenses');
      const existing=expenses.find(e=>e.name===name&&e.costCenter===costCenter);
      if(existing){existing.amount=amount;existing.frequency=frequency;existing.nextDue=nextDue;existing.costCenter=costCenter;}
      else{expenses.push({id:Date.now(),name,amount,frequency,nextDue,costCenter,active:true});}
      await Storage.save('operatingExpenses',expenses);
      await logAudit('add',name,'Ù…ØµØ±ÙˆÙ ØªØ´ØºÙŠÙ„ÙŠ',{amount,frequency});
      showToast('ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù…ØµØ±ÙˆÙ');
      renderOperatingExpenses();
    }

    async function renderOperatingExpenses(){
      const expenses=await Storage.load('operatingExpenses');
      const body=document.getElementById('operatingExpensesTable');
      if(!body) return;
      body.innerHTML=expenses.map(item=>`
        <tr>
          <td>${item.name}</td>
          <td>${formatCurrency(item.amount)}</td>
          <td>${item.frequency}</td>
          <td>${item.nextDue?formatDate(item.nextDue):'-'}</td>
          <td>${item.costCenter||'-'}</td>
          <td>${expenseStatus(item)}</td>
        </tr>`).join('');
    }

    async function postRecurringExpenses(){
      const expenses=await Storage.load('operatingExpenses');
      const dueExpenses=expenses.filter(item=>item.active&&item.nextDue&&new Date(item.nextDue)<=new Date());
      if(!dueExpenses.length){showToast('Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…ØµØ±ÙˆÙØ§Øª Ù…Ø³ØªØ­Ù‚Ø© Ù„Ù„ØªØ±Ø­ÙŠÙ„','error');return;}
      for(const item of dueExpenses){
        try{
          await recordJournal(buildEntry('operating-expense-accrual',{amount:item.amount,name:item.name,costCenter:item.costCenter}),{type:'operating-expense',item:item.name,costCenter:item.costCenter});
          advanceExpenseDue(item);
        }catch(err){
          showToast(`ØªØ¹Ø°Ø± ØªØ±Ø­ÙŠÙ„ ${item.name}`,'error');
        }
      }
      await Storage.save('operatingExpenses',expenses);
      await logAudit('process','expenses','ØªØ±Ø­ÙŠÙ„ Ù…ØµØ±ÙˆÙØ§Øª',{count:dueExpenses.length});
      renderOperatingExpenses();
      refreshMiniTrial();
      showToast('ØªÙ… ØªØ±Ø­ÙŠÙ„ Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª Ø§Ù„Ù…Ø³ØªØ­Ù‚Ø©');
    }

    async function saveFixedAsset(){
      const name=document.getElementById('assetName')?.value.trim();
      const purchase=document.getElementById('assetPurchase')?.value;
      const cost=parseFloat(document.getElementById('assetCost')?.value||'0');
      const lifeMonths=parseInt(document.getElementById('assetLife')?.value||'0',10);
      const center=document.getElementById('assetCenter')?.value||'';
      if(!name||!purchase||isNaN(cost)||cost<=0||!lifeMonths){showToast('Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£ØµÙ„ ØºÙŠØ± Ù…ÙƒØªÙ…Ù„Ø©','error');return;}
      const assets=await Storage.load('fixedAssets');
      let asset=assets.find(a=>a.name===name);
      if(asset){
        asset.purchase=purchase;
        asset.cost=cost;
        asset.lifeMonths=lifeMonths;
        asset.center=center;
        asset.status=asset.status||'active';
        asset.history=asset.history||[];
        asset.id=asset.id||`asset-${Date.now()}`;
      }else{
        asset={id:`asset-${Date.now()}`,name,purchase,cost,lifeMonths,center,accumulated:0,lastDepreciation:null,status:'active',history:[],disposal:null};
        assets.push(asset);
      }
      await Storage.save('fixedAssets',assets);
      await logAudit('add',name,'ØªØ³Ø¬ÙŠÙ„ Ø£ØµÙ„ Ø«Ø§Ø¨Øª',{cost,lifeMonths});
      showToast('ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø£ØµÙ„');
      renderFixedAssets();
      renderDepreciationSchedule();
      renderAssetSelectors();
    }

    async function renderFixedAssets(){
      const assets=await Storage.load('fixedAssets');
      const body=document.getElementById('fixedAssetsTable');
      if(!body) return;
      body.innerHTML=assets.map(asset=>{
        const monthly=asset.lifeMonths?asset.cost/asset.lifeMonths:0;
        const status=asset.status==='disposed'?'Ù…ÙØªØµØ±Ù‘ÙÙ':'Ù†Ø´Ø·';
        return `<tr>
          <td>${asset.name}</td>
          <td>${formatCurrency(asset.cost)}</td>
          <td>${formatCurrency(monthly)}</td>
          <td>${formatCurrency(asset.accumulated||0)}</td>
          <td>${asset.lastDepreciation||'-'}</td>
          <td>${status}</td>
        </tr>`;
      }).join('');
      renderAssetSelectors();
      renderDepreciationSchedule();
    }

    async function renderAssetSelectors(){
      const select=document.getElementById('disposalAsset');
      if(!select) return;
      const assets=await Storage.load('fixedAssets');
      select.innerHTML='<option value="">Ø§Ø®ØªØ± Ø§Ù„Ø£ØµÙ„</option>'+assets.filter(asset=>asset.status!=='disposed').map(asset=>`<option value="${asset.id}">${asset.name}</option>`).join('');
    }

    async function renderDepreciationSchedule(){
      const container=document.getElementById('depreciationSchedule');
      if(!container) return;
      const assets=await Storage.load('fixedAssets');
      const rows=[];
      assets.forEach(asset=>{
        const history=(asset.history||[]).slice().sort((a,b)=>a.period.localeCompare(b.period));
        let running=0;
        history.forEach(entry=>{
          running=roundAmount(running+entry.amount);
          rows.push([asset.name,entry.period,formatCurrency(entry.amount),formatCurrency(running),asset.status==='disposed'?'Ù…ÙØªØµØ±Ù‘ÙÙ':'Ù†Ø´Ø·']);
        });
      });
      if(!rows.length){
        container.innerHTML='<span class="badge">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¬Ø¯ÙˆÙ„ Ø¥Ù‡Ù„Ø§Ùƒ Ù…Ø³Ø¬Ù„</span>';
        return;
      }
      container.innerHTML='<table><thead><tr><th>Ø§Ù„Ø£ØµÙ„</th><th>Ø§Ù„ÙØªØ±Ø©</th><th>Ù‚ÙŠØ¯ Ø§Ù„Ø¥Ù‡Ù„Ø§Ùƒ</th><th>Ø§Ù„Ù…Ø¬Ù…Ø¹</th><th>Ø§Ù„Ø­Ø§Ù„Ø©</th></tr></thead><tbody>'+rows.slice(-100).reverse().map(r=>`<tr><td>${r[0]}</td><td>${r[1]}</td><td>${r[2]}</td><td>${r[3]}</td><td>${r[4]}</td></tr>`).join('')+'</tbody></table>';
    }

    async function renderAssetDisposals(){
      const table=document.getElementById('assetDisposalsTable');
      if(!table) return;
      const disposals=await Storage.load('assetDisposals');
      if(!disposals.length){
        table.innerHTML='<tr><td colspan="6">Ù„Ø§ ØªÙˆØ¬Ø¯ ØªØµØ±ÙØ§Øª Ù…Ø³Ø¬Ù„Ø©</td></tr>';
        return;
      }
      table.innerHTML=disposals.slice(-100).reverse().map(row=>{
        const outcome=row.outcome||0;
        let outcomeLabel='Ø¨Ø¯ÙˆÙ† Ø£Ø«Ø±';
        if(outcome>0) outcomeLabel=`Ø±Ø¨Ø­ ${formatCurrency(outcome)}`;
        else if(outcome<0) outcomeLabel=`Ø®Ø³Ø§Ø±Ø© ${formatCurrency(Math.abs(outcome))}`;
        if(row.notes) outcomeLabel+=` â€” ${row.notes}`;
        return `<tr>
        <td>${row.reference}</td>
        <td>${row.asset}</td>
        <td>${formatDate(row.date)}</td>
        <td>${formatCurrency(row.proceeds||0)}</td>
        <td>${formatCurrency(row.bookValue||0)}</td>
        <td>${outcomeLabel}</td>
      </tr>`;
      }).join('');
    }

    async function disposeAsset(){
      const assetId=document.getElementById('disposalAsset')?.value;
      const date=document.getElementById('disposalDate')?.value||new Date().toISOString().slice(0,10);
      const proceeds=parseFloat(document.getElementById('disposalProceeds')?.value||'0');
      const accountId=document.getElementById('disposalProceedsAccount')?.value||'';
      const notes=document.getElementById('disposalNotes')?.value||'';
      if(!assetId){showToast('Ø§Ø®ØªØ± Ø§Ù„Ø£ØµÙ„ Ø§Ù„Ù…Ø±Ø§Ø¯ Ø§Ù„ØªØµØ±Ù Ø¨Ù‡','error');return;}
      const assets=await Storage.load('fixedAssets');
      const asset=assets.find(a=>String(a.id)===String(assetId));
      if(!asset){showToast('Ø§Ù„Ø£ØµÙ„ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯','error');return;}
      if(asset.status==='disposed'){showToast('ØªÙ… Ø§Ù„ØªØµØ±Ù ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„Ø£ØµÙ„ Ø³Ø§Ø¨Ù‚Ù‹Ø§','error');return;}
      const accumulated=roundAmount(asset.accumulated||0);
      const cost=roundAmount(asset.cost||0);
      const bookValue=roundAmount(cost-accumulated);
      const cashAccount=proceeds>0?(accountId||defaultCashAccountId()):'';
      if(proceeds>0&&!cashAccount){showToast('Ø­Ø¯Ø¯ Ø­Ø³Ø§Ø¨ Ø§Ù„ØªØ­ØµÙŠÙ„ Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ø¨ÙŠØ¹','error');return;}
      const reference=generateReference('AD');
      await recordJournal(buildEntry('asset-disposal',{asset:asset.name,cost,accumulated,proceeds:roundAmount(proceeds),accountId:cashAccount}),{type:'asset-disposal',reference,asset:asset.name,date});
      asset.status='disposed';
      asset.disposal={reference,date,proceeds:roundAmount(proceeds),bookValue,notes};
      await Storage.save('fixedAssets',assets);
      const disposals=await Storage.load('assetDisposals');
      const outcome=roundAmount((proceeds||0)-bookValue);
      disposals.push({reference,asset:asset.name,date,proceeds:roundAmount(proceeds),bookValue,notes,outcome});
      await Storage.save('assetDisposals',disposals);
      await logAudit('dispose',reference,'ØªØµØ±Ù Ø£ØµÙ„',{asset:asset.name,proceeds:roundAmount(proceeds),bookValue});
      showToast('ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„ØªØµØ±Ù');
      document.getElementById('disposalProceeds').value='';
      document.getElementById('disposalNotes').value='';
      const assetSelect=document.getElementById('disposalAsset');
      if(assetSelect) assetSelect.value='';
      renderFixedAssets();
      renderAssetDisposals();
      refreshMiniTrial();
    }

    async function postMonthlyDepreciation(){
      const assets=await Storage.load('fixedAssets');
      if(!assets.length){showToast('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£ØµÙˆÙ„','error');return;}
      const now=new Date();
      const period=`${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}`;
      let processed=0;
      for(const asset of assets){
        if(asset.status==='disposed') continue;
        if(asset.lastDepreciation===period) continue;
        if(new Date(asset.purchase)>now) continue;
        const monthly=asset.lifeMonths?asset.cost/asset.lifeMonths:0;
        if(monthly<=0) continue;
        const remaining=asset.cost-(asset.accumulated||0);
        if(remaining<=0) continue;
        const amount=Math.min(monthly,remaining);
        try{
          await recordJournal(buildEntry('depreciation',{amount,asset:asset.name}),{type:'depreciation',asset:asset.name,period});
          asset.accumulated=(asset.accumulated||0)+amount;
          asset.lastDepreciation=period;
          asset.history=asset.history||[];
          asset.history.push({period,amount,createdAt:now.toISOString()});
          processed++;
        }catch(err){
          showToast(`ÙØ´Ù„ Ø¥Ù‡Ù„Ø§Ùƒ Ø§Ù„Ø£ØµÙ„ ${asset.name}`,'error');
        }
      }
      await Storage.save('fixedAssets',assets);
      if(processed){
        await logAudit('process','depreciation','Ø¥Ù‡Ù„Ø§Ùƒ Ø´Ù‡Ø±ÙŠ',{count:processed,period});
        showToast('ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø¥Ù‡Ù„Ø§Ùƒ Ø§Ù„Ø´Ù‡Ø±');
        renderFixedAssets();
        refreshMiniTrial();
      }else{
        showToast('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£ØµÙˆÙ„ Ù…Ø³ØªØ­Ù‚Ø© Ù„Ù„Ø¥Ù‡Ù„Ø§Ùƒ','error');
      }
    }

    async function summarizePeriod(start,end){
      const journals=await Storage.load('journals');
      const summary={revenue:0,expenses:0};
      journals.filter(j=>{
        const time=new Date(j.createdAt);
        return time>=start&&time<=end;
      }).forEach(j=>{
        j.entries.forEach(e=>{
          const account=e.account||'';
          const debit=e.debit||0;
          const credit=e.credit||0;
          if(account.includes('Ø¥ÙŠØ±Ø§Ø¯Ø§Øª')||account.toLowerCase().includes('revenue')){
            summary.revenue+=credit-debit;
          }
          if(account.includes('Ù…ØµØ±ÙˆÙ')||account.toLowerCase().includes('expense')){
            summary.expenses+=debit-credit;
          }
        });
      });
      return summary;
    }

    async function renderPeriodClosings(){
      const closings=await Storage.load('periodClosings');
      const body=document.getElementById('periodClosingsTable');
      if(!body) return;
      body.innerHTML=closings.slice(-50).reverse().map(row=>`
        <tr>
          <td>${row.period}</td>
          <td>${row.type==='month'?'Ø´Ù‡Ø±ÙŠ':'Ø³Ù†ÙˆÙŠ'}</td>
          <td>${formatCurrency(row.revenue)}</td>
          <td>${formatCurrency(row.expenses)}</td>
          <td>${formatCurrency(row.net)}</td>
        </tr>`).join('');
    }

    async function closeMonth(){
      promptPassword('close',async()=>{
        const now=new Date();
        const start=new Date(now.getFullYear(),now.getMonth(),1);
        const end=new Date(now.getFullYear(),now.getMonth()+1,0,23,59,59);
        const period=`${start.getFullYear()}-${String(start.getMonth()+1).padStart(2,'0')}`;
        const closings=await Storage.load('periodClosings');
        if(closings.find(c=>c.period===period&&c.type==='month')){showToast('Ù‡Ø°Ø§ Ø§Ù„Ø´Ù‡Ø± Ù…ØºÙ„Ù‚ Ø¨Ø§Ù„ÙØ¹Ù„','error');return;}
        const summary=await summarizePeriod(start,end);
        const net=summary.revenue-summary.expenses;
        if(Math.abs(net)>0.01){
          const entry=buildEntry('monthly-close',{net});
          if(entry.length){
            await recordJournal(entry,{type:'monthly-close',period});
          }
        }
        closings.push({id:Date.now(),period,type:'month',revenue:summary.revenue,expenses:summary.expenses,net,createdAt:new Date().toISOString()});
        await Storage.save('periodClosings',closings);
        await logAudit('close',`month-${period}`,'Ø¥Ù‚ÙØ§Ù„ Ø´Ù‡Ø±',{net});
        showToast('ØªÙ… Ø¥Ù‚ÙØ§Ù„ Ø§Ù„Ø´Ù‡Ø±');
        renderPeriodClosings();
        refreshMiniTrial();
      });
    }

    async function closeYear(){
      promptPassword('close',async()=>{
        const now=new Date();
        const start=new Date(now.getFullYear(),0,1);
        const end=new Date(now.getFullYear(),11,31,23,59,59);
        const period=`${start.getFullYear()}`;
        const closings=await Storage.load('periodClosings');
        if(closings.find(c=>c.period===period&&c.type==='year')){showToast('Ù‡Ø°Ù‡ Ø§Ù„Ø³Ù†Ø© Ù…ØºÙ„Ù‚Ø©','error');return;}
        const summary=await summarizePeriod(start,end);
        const net=summary.revenue-summary.expenses;
        if(Math.abs(net)>0.01){
          const entry=buildEntry('yearly-close',{net});
          if(entry.length){
            await recordJournal(entry,{type:'yearly-close',period});
          }
        }
        closings.push({id:Date.now(),period,type:'year',revenue:summary.revenue,expenses:summary.expenses,net,createdAt:new Date().toISOString()});
        await Storage.save('periodClosings',closings);
        await logAudit('close',`year-${period}`,'Ø¥Ù‚ÙØ§Ù„ Ø³Ù†Ø©',{net});
        showToast('ØªÙ… Ø¥Ù‚ÙØ§Ù„ Ø§Ù„Ø³Ù†Ø©');
        renderPeriodClosings();
        refreshMiniTrial();
      });
    }

    async function saveDoctor(){
      const name=document.getElementById('doctorName').value.trim();
      const share=parseFloat(document.getElementById('doctorShare').value);
      if(!name||isNaN(share)||share<30||share>50){showToast('Ø§Ù„Ù†Ø³Ø¨Ø© Ø¨ÙŠÙ† 30-50','error');return;}
      const doctors=await Storage.load('doctors');
      const existing=doctors.find(d=>d.name===name);
      if(existing){existing.share=share;}else{doctors.push({name,share,createdAt:new Date().toISOString()});}
      await Storage.save('doctors',doctors);
      await logAudit('add',name,'ØªØ­Ø¯ÙŠØ« Ø·Ø¨ÙŠØ¨');
      showToast('ØªÙ… Ø§Ù„Ø­ÙØ¸');
      await renderDoctorsTable();
      await refreshDoctorOptions();
    }

    async function calculateOverheads(){
      const doctors=await Storage.load('doctors');
      const receipts=await Storage.load('receipts');
      const totalOverhead=await estimateTotalOverheads();
      const revenueByDoctor={};
      doctors.forEach(doc=>{
        revenueByDoctor[doc.name]=receipts.filter(r=>r.doctor===doc.name&&r.status==='posted').reduce((s,r)=>s+r.amount,0);
      });
      const totalRevenue=Object.values(revenueByDoctor).reduce((s,v)=>s+v,0);
      const allocation={};
      doctors.forEach(doc=>{
        if(App.settings.overheadAllocation==='equal'){
          allocation[doc.name]=doctors.length?totalOverhead/doctors.length:0;
        }else{
          allocation[doc.name]=totalRevenue?totalOverhead*(revenueByDoctor[doc.name]||0)/totalRevenue:0;
        }
      });
      return allocation;
    }

    async function deleteDoctor(name){
      guardSensitive(async()=>{
        let doctors=await Storage.load('doctors');
        doctors=doctors.filter(doc=>doc.name!==name);
        await Storage.save('doctors',doctors);
        await logAudit('delete',name,'Ø­Ø°Ù Ø·Ø¨ÙŠØ¨');
        await renderDoctorsTable();
        await refreshDoctorOptions();
      });
    }

    async function estimateTotalOverheads(){
      const payments=await Storage.load('payments');
      return payments.filter(p=>p.status==='posted').reduce((s,p)=>s+(p.amount||0),0)*0.2;
    }

    async function renderDoctorsTable(){
      const doctors=await Storage.load('doctors');
      const receipts=await Storage.load('receipts');
      const labs=await Storage.load('labs');
      const overheads=await calculateOverheads();
      const body=document.getElementById('doctorTable');
      if(!body) return;
      body.innerHTML=doctors.map(doc=>{
        const revenue=receipts.filter(r=>r.doctor===doc.name&&r.status==='posted').reduce((s,r)=>s+r.amount,0);
        const labCost=labs.filter(l=>l.doctor===doc.name).reduce((s,l)=>s+(l.cost||0),0);
        const net=revenue-labCost;
        const doctorShare=net*(doc.share/100);
        const clinicShare=net-doctorShare;
        const overheadShare=overheads[doc.name]||0;
        const contribution=clinicShare-overheadShare;
        const badgeClass=contribution>=0?'badge':'badge danger';
        return `<tr>
          <td>${doc.name}</td>
          <td>${formatCurrency(revenue)}</td>
          <td>${formatCurrency(labCost)}</td>
          <td>${doc.share}%</td>
          <td>${formatCurrency(doctorShare)}</td>
          <td><span class="${badgeClass}">${formatCurrency(contribution)}</span></td>
          <td><button class="btn danger" onclick="deleteDoctor('${doc.name.replace(/'/g,'&#39;')}')">Ø­Ø°Ù</button></td>
        </tr>`;
      }).join('');
      refreshDoctorOptions();
    }

    async function savePrescription(){
      await updatePatientSelectors();
      const patient=document.getElementById('prescriptionPatient')?.value;
      const doctor=document.getElementById('prescriptionDoctor')?.value.trim();
      const date=document.getElementById('prescriptionDate')?.value;
      const duration=parseInt(document.getElementById('prescriptionDuration')?.value||'0',10);
      const notes=document.getElementById('prescriptionNotes')?.value||'';
      if(!patient||!doctor||!date||!duration||duration<=0||!notes.trim()){showToast('Ø£ÙƒÙ…Ù„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙˆØµÙØ©','error');return;}
      const prescriptions=await Storage.load('prescriptions');
      const record={id:Date.now(),patient,doctor,date,duration,notes,createdAt:new Date().toISOString()};
      prescriptions.push(record);
      await Storage.save('prescriptions',prescriptions);
      await logAudit('add',record.id,'ÙˆØµÙØ© Ø·Ø¨ÙŠØ©',record);
      showToast('ØªÙ… Ø­ÙØ¸ Ø§Ù„ÙˆØµÙØ©');
      renderPrescriptionsTable();
    }

    async function renderPrescriptionsTable(){
      const prescriptions=await Storage.load('prescriptions');
      const body=document.getElementById('prescriptionsTable');
      if(!body) return;
      body.innerHTML=prescriptions.slice(-200).reverse().map(p=>`
        <tr>
          <td>${p.patient}</td>
          <td>${p.doctor}</td>
          <td>${formatDate(p.date)}</td>
          <td>${p.duration} ÙŠÙˆÙ…</td>
          <td>
            <button class="btn secondary" onclick="prescriptionPDF(${p.id})">PDF</button>
            <button class="btn danger" onclick="deletePrescription(${p.id})">Ø­Ø°Ù</button>
          </td>
        </tr>`).join('');
    }

    async function prescriptionPDF(id){
      const prescriptions=await Storage.load('prescriptions');
      const pres=prescriptions.find(p=>p.id===id);
      if(!pres) return;
      const doc=createArabicPDF();
      doc.setFontSize(14);
      pdfTextRight(doc,App.settings.clinicName,20);
      pdfTextRight(doc,'ÙˆØµÙØ© Ø·Ø¨ÙŠØ©',30);
      autoTableArabic(doc,{startY:40,head:[['Ø§Ù„Ø­Ù‚Ù„','Ø§Ù„Ù‚ÙŠÙ…Ø©']],body:[
        ['Ø§Ù„Ù…Ø±ÙŠØ¶',pres.patient],
        ['Ø§Ù„Ø·Ø¨ÙŠØ¨',pres.doctor],
        ['Ø§Ù„ØªØ§Ø±ÙŠØ®',formatDate(pres.date)],
        ['Ù…Ø¯Ø© Ø§Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…',`${pres.duration} ÙŠÙˆÙ…`],
        ['Ø§Ù„ØªØ¹Ù„ÙŠÙ…Ø§Øª',pres.notes]
      ]});
      doc.save(`prescription-${pres.patient}-${pres.date}.pdf`);
    }

    async function deletePrescription(id){
      guardSensitive(async()=>{
        let prescriptions=await Storage.load('prescriptions');
        prescriptions=prescriptions.filter(p=>p.id!==id);
        await Storage.save('prescriptions',prescriptions);
        renderPrescriptionsTable();
      });
    }

    async function saveBankReconciliation(){
      const date=document.getElementById('reconDate')?.value;
      const bank=parseFloat(document.getElementById('reconBank')?.value||'0');
      const books=parseFloat(document.getElementById('reconBooks')?.value||'0');
      const notes=document.getElementById('reconNotes')?.value||'';
      if(!date){showToast('Ø£Ø¯Ø®Ù„ ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØ³ÙˆÙŠØ©','error');return;}
      const reconciliations=await Storage.load('bankReconciliations');
      reconciliations.push({id:Date.now(),date,bank,books,difference:bank-books,notes,reviewed:false,createdAt:new Date().toISOString()});
      await Storage.save('bankReconciliations',reconciliations);
      await logAudit('add',date,'ØªØ³ÙˆÙŠØ© Ø¨Ù†ÙƒÙŠØ©',{bank,books});
      showToast('ØªÙ… Ø­ÙØ¸ Ø§Ù„ØªØ³ÙˆÙŠØ©');
      renderBankReconciliations();
    }

    async function renderBankReconciliations(){
      const reconciliations=await Storage.load('bankReconciliations');
      const body=document.getElementById('bankReconciliationTable');
      if(!body) return;
      body.innerHTML=reconciliations.slice(-100).reverse().map(r=>`
        <tr>
          <td>${formatDate(r.date)}</td>
          <td>${formatCurrency(r.bank||0)}</td>
          <td>${formatCurrency(r.books||0)}</td>
          <td>${formatCurrency(r.difference||0)}</td>
          <td>${r.reviewed?'<span class="badge">Ù…Ø±Ø§Ø¬ÙØ¹</span>':'<span class="badge danger">Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©</span>'}</td>
          <td>${r.reviewed?'':`<button class="btn" onclick="markReconciliationReviewed(${r.id})">Ø§Ø¹ØªÙ…Ø§Ø¯</button>`}</td>
        </tr>`).join('');
    }

    async function markReconciliationReviewed(id){
      guardSensitive(async()=>{
        const reconciliations=await Storage.load('bankReconciliations');
        const item=reconciliations.find(r=>r.id===id);
        if(!item) return;
        item.reviewed=true;
        item.reviewedAt=new Date().toISOString();
        await Storage.save('bankReconciliations',reconciliations);
        await logAudit('update',id,'Ø§Ø¹ØªÙ…Ø§Ø¯ ØªØ³ÙˆÙŠØ© Ø¨Ù†ÙƒÙŠØ©');
        renderBankReconciliations();
      });
    }

    async function runInternalReview(){
      const results=[];
      const journals=await Storage.load('journals');
      const totals=computeLedgerTotals(journals);
      const balanced=Math.abs(totals.debit-totals.credit)<0.05;
      results.push({label:'Ø§ØªØ²Ø§Ù† Ø§Ù„Ù‚ÙŠÙˆØ¯',status:balanced?'ok':'fail',detail:`Ù…Ø¯ÙŠÙ† ${formatCurrency(totals.debit)} / Ø¯Ø§Ø¦Ù† ${formatCurrency(totals.credit)}`});
      const receivables=await Storage.load('patientReceivables');
      const overdue=receivables.filter(r=>r.balance>0&&new Date(r.due)<new Date());
      results.push({label:'Ø°Ù…Ù… Ù…ØªØ£Ø®Ø±Ø©',status:overdue.length?'fail':'ok',detail:overdue.length?`${overdue.length} Ø°Ù…Ø© Ù…ØªØ£Ø®Ø±Ø©`:'Ù„Ø§ ÙŠÙˆØ¬Ø¯'});
      const reconciliations=await Storage.load('bankReconciliations');
      const pending=reconciliations.filter(r=>!r.reviewed);
      results.push({label:'ØªØ³ÙˆÙŠØ§Øª Ø¨Ù†ÙƒÙŠØ© Ù…Ø¹Ù„Ù‚Ø©',status:pending.length?'warn':'ok',detail:pending.length?`${pending.length} ØªØ³ÙˆÙŠØ© ØªÙ†ØªØ¸Ø± Ø§Ù„Ø§Ø¹ØªÙ…Ø§Ø¯`:'Ø¬Ù…ÙŠØ¹ Ø§Ù„ØªØ³ÙˆÙŠØ§Øª Ù…Ø¹ØªÙ…Ø¯Ø©'});
      const expenses=await Storage.load('operatingExpenses');
      const dueExpenses=expenses.filter(item=>item.active&&item.nextDue&&new Date(item.nextDue)<=new Date());
      results.push({label:'Ù…ØµØ±ÙˆÙØ§Øª Ù…Ø³ØªØ­Ù‚Ø©',status:dueExpenses.length?'warn':'ok',detail:dueExpenses.length?`${dueExpenses.length} Ù…ØµØ±ÙˆÙ Ù…Ø³ØªØ­Ù‚ Ù„Ù„ØªØ±Ø­ÙŠÙ„`:'Ù„Ø§ ÙŠÙˆØ¬Ø¯'});
      const container=document.getElementById('internalReviewReport');
      if(container){
        container.innerHTML='<ul>'+results.map(r=>`<li>${r.status==='ok'?'âœ…':r.status==='warn'?'âš ï¸':'âŒ'} ${r.label} â€” ${r.detail}</li>`).join('')+'</ul>';
      }
      await logAudit('process','internal-review','ØªØ´ØºÙŠÙ„ Ù…Ø±Ø§Ø¬Ø¹Ø© Ø¯Ø§Ø®Ù„ÙŠØ©',results);
      showToast(results.every(r=>r.status==='ok')?'Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø© Ø³Ù„ÙŠÙ…Ø©':'Ø±Ø§Ø¬Ø¹ Ø§Ù„Ù†ØªØ§Ø¦Ø¬',results.every(r=>r.status==='ok')?'success':'error');
    }

    async function saveSettings(){
      App.settings.clinicName=document.getElementById('clinicName').value.trim();
      App.settings.clinicLogo=document.getElementById('clinicLogo').value.trim();
      App.settings.currency=document.getElementById('clinicCurrency').value.trim()||'YER';
      App.settings.overheadAllocation=document.getElementById('overheadAllocation').value;
      await Storage.save('settings',{...App.settings});
      showToast('ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª');
      renderDoctorsTable();
      refreshMiniTrial();
    }

    async function savePasswords(){
      const updates={};
      const settingsPwd=document.getElementById('pwdSettings').value.trim();
      const closePwd=document.getElementById('pwdClose').value.trim();
      const dangerPwd=document.getElementById('pwdDanger').value.trim();
      if(settingsPwd){App.passwords.settings=await hashText(settingsPwd);updates.settings=true;}
      if(closePwd){App.passwords.close=await hashText(closePwd);updates.close=true;}
      if(dangerPwd){App.passwords.danger=await hashText(dangerPwd);updates.danger=true;}
      if(Object.keys(updates).length===0){showToast('Ù„Ù… ÙŠØªÙ… Ø¥Ø¯Ø®Ø§Ù„ ÙƒÙ„Ù…Ø§Øª Ù…Ø±ÙˆØ± Ø¬Ø¯ÙŠØ¯Ø©','error');return;}
      await localforage.setItem('passwords',App.passwords);
      document.getElementById('pwdSettings').value='';
      document.getElementById('pwdClose').value='';
      document.getElementById('pwdDanger').value='';
      showToast('ØªÙ… ØªØ­Ø¯ÙŠØ« ÙƒÙ„Ù…Ø§Øª Ø§Ù„Ù…Ø±ÙˆØ±');
    }

    async function exportDataJSON(){
      const data={
        settings:App.settings,
        passwords:App.passwords,
        referenceCounters:App.counters,
        receipts:await Storage.load('receipts'),
        payments:await Storage.load('payments'),
        journals:await Storage.load('journals'),
        patients:await Storage.load('patients'),
        purchaseInvoices:await Storage.load('purchaseInvoices'),
        patientReceivables:await Storage.load('patientReceivables'),
        patientDepositsLedger:await Storage.load('patientDepositsLedger'),
        supplierReturns:await Storage.load('supplierReturns'),
        labs:await Storage.load('labs'),
        inventory:await Storage.load('inventory'),
        inventoryBatches:await Storage.load('inventoryBatches'),
        inventoryConsumption:await Storage.load('inventoryConsumption'),
        fixedAssets:await Storage.load('fixedAssets'),
        assetDisposals:await Storage.load('assetDisposals'),
        cashAccounts:await Storage.load('cashAccounts'),
        cashCounts:await Storage.load('cashCounts'),
        doctors:await Storage.load('doctors'),
        audit:await Storage.load('audit'),
        appointments:await Storage.load('appointments'),
        employees:await Storage.load('employees'),
        labPartners:await Storage.load('labPartners'),
        clinicServices:await Storage.load('clinicServices'),
        labCatalog:await Storage.load('labCatalog'),
        bankReconciliations:await Storage.load('bankReconciliations')
      };
      const blob=new Blob([JSON.stringify(data,null,2)],{type:'application/json'});
      const url=URL.createObjectURL(blob);
      const a=document.createElement('a');
      a.href=url;
      a.download=`MyClinicDB-backup-${new Date().toISOString()}.json`;
      a.click();
      URL.revokeObjectURL(url);
      showToast('ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù„Ù Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©');
    }

    function importDataJSON(){
      const input=document.createElement('input');
      input.type='file';
      input.accept='application/json';
      input.onchange=async()=>{
        const file=input.files[0];
        if(!file) return;
        try{
          const text=await file.text();
          const data=JSON.parse(text);
          await Storage.save('settings',{...App.settings,...data.settings});
          App.settings={...App.settings,...data.settings};
          if('passwords'in App.settings) delete App.settings.passwords;
          const importedPasswords=data.passwords||{};
          const prepared=await preparePasswords(importedPasswords);
          App.passwords=prepared.updated;
          await localforage.setItem('passwords',App.passwords);
          App.counters=data.referenceCounters||{};
          await Storage.save('referenceCounters',App.counters);
          App.cashAccounts=await Storage.load('cashAccounts');
          const keys=['receipts','payments','journals','patients','patientReceivables','patientDepositsLedger','purchaseInvoices','supplierReturns','labs','inventory','inventoryBatches','inventoryConsumption','fixedAssets','assetDisposals','cashAccounts','cashCounts','doctors','audit','appointments','employees','labPartners','clinicServices','labCatalog','bankReconciliations'];
          for(const key of keys){
            await Storage.save(key,data[key]||[]);
          }
          await ensureCashAccounts();
          await refreshInventoryAggregates();
          renderCashAccountSelectors();
          renderCashAccountsTable();
          showToast('ØªÙ… Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø¨Ù†Ø¬Ø§Ø­');
          switchView(App.view);
          refreshMiniTrial();
          await refreshCatalogLists();
          await refreshDoctorOptions();
        }catch(err){
          console.error(err);
          showToast('ÙØ´Ù„ Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯','error');
        }
      };
      input.click();
    }

    async function searchReference(){
      const ref=document.getElementById('referenceSearch').value.trim();
      const result=document.getElementById('referenceResult');
      if(!ref){result.textContent='';return;}
      const collections=['receipts','payments','journals','patientReceivables','supplierReturns','labs','purchaseInvoices'];
      for(const name of collections){
        const list=await Storage.load(name);
        const found=list.find(item=>(item.reference||item.id)===ref);
        if(found){
          result.innerHTML=`<div class="card"><strong>Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©:</strong> ${name}<br><pre>${JSON.stringify(found,null,2)}</pre></div>`;
          return;
        }
      }
      result.innerHTML='<div class="badge danger">Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø±Ø¬Ø¹</div>';
    }

    async function computeMiniTrialSummary(){
      const ledger=await aggregateLedger();
      const patients=await Storage.load('patients');
      const trial={Cashbox:0,Banks:0,AR:0,AP:0,Revenues:0,Expenses:0,Deposits:0,OnHold:0};
      let depositLedger=0;
      ledger.forEach(row=>{
        const code=row.code||'';
        const net=ledgerRowNet(row);
        if(code===AccountMap.cashbox.code){trial.Cashbox+=net;return;}
        if(AccountMap.bankAccounts && code===AccountMap.bankAccounts.code){trial.Banks+=net;return;}
        if(code===AccountMap.receivablesPatients.code){trial.AR+=net;return;}
        if([AccountMap.payablesSuppliers.code,AccountMap.accruedExpenses.code].includes(code)){trial.AP+=net;return;}
        if(row.category==='revenue'){trial.Revenues+=net;return;}
        if(row.category==='expense'){trial.Expenses+=net;return;}
        if(code===AccountMap.patientDeposits.code){depositLedger+=net;return;}
        if([AccountMap.supplierReturnPending.code,AccountMap.supplierAdvances.code].includes(code)){trial.OnHold+=net;return;}
      });
      trial.Deposits=depositLedger;
      const totals=ledger.reduce((acc,row)=>{
        acc.debit+=row.debit||0;
        acc.credit+=row.credit||0;
        return acc;
      },{debit:0,credit:0});
      const balanced=Math.abs(totals.debit-totals.credit)<0.05;
      return {trial,balanced};
    }

    async function refreshMiniTrial(){
      const {trial,balanced}=await computeMiniTrialSummary();
      const mini=document.getElementById('miniTrial');
      if(!mini) return;
      const rows=Object.entries(trial).map(([k,v])=>{
        const debit=v>0?formatCurrency(v):'';
        const credit=v<0?formatCurrency(Math.abs(v)):'';
        return `<tr><td>${k}</td><td>${debit}</td><td>${credit}</td><td>${formatCurrency(v)}</td></tr>`;
      }).join('');
      mini.innerHTML=`<table><thead><tr><th>Ø§Ù„Ø­Ø³Ø§Ø¨</th><th>Ù…Ø¯ÙŠÙ†</th><th>Ø¯Ø§Ø¦Ù†</th><th>ØµØ§ÙÙŠ</th></tr></thead><tbody>${rows}</tbody></table><div class="badge" style="margin-top:1rem;">Ø§ØªØ²Ø§Ù†: ${balanced?'âœ”ï¸':'âŒ'}</div>`;
    }

    async function renderDashboardWidgets(){
      await refreshMiniTrial();
      await renderInventoryAlerts();
      await renderAppointmentsTomorrow();
      await renderPeriodCard('morning');
      await renderPeriodCard('evening');
    }

    async function renderAppointmentsTomorrow(){
      const appointments=await Storage.load('appointments');
      const container=document.getElementById('appointmentsTomorrow');
      if(!container) return;
      const tomorrow=new Date();
      tomorrow.setDate(tomorrow.getDate()+1);
      const target=appointments.filter(a=>new Date(a.date).toDateString()===tomorrow.toDateString());
      if(!target.length){container.innerHTML='<span class="badge">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…ÙˆØ§Ø¹ÙŠØ¯</span>';return;}
      container.innerHTML='<table><thead><tr><th>Ø§Ù„Ù…Ø±ÙŠØ¶</th><th>Ø§Ù„Ø®Ø¯Ù…Ø©</th><th>Ø§Ù„Ø·Ø¨ÙŠØ¨</th><th>Ø§Ù„Ø­Ø§Ù„Ø©</th><th>Ø§Ù„Ù…Ø¯ÙÙˆØ¹/Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ</th></tr></thead><tbody>'+target.map(a=>`<tr><td>${a.patient}</td><td>${a.service}</td><td>${a.doctor}</td><td>${a.status}</td><td>${formatCurrency(a.paid||0)} / ${formatCurrency(a.due||0)}</td></tr>`).join('')+'</tbody></table>';
    }

    async function renderPeriodCard(period){
      const container=document.getElementById(period==='morning'?'periodMorning':'periodEvening');
      if(!container) return;
      const closures=await Storage.load('closures');
      const today=new Date().toISOString().slice(0,10);
      const record=closures.find(c=>c.date===today&&c.period===period);
      if(!record){
        container.innerHTML='<div class="badge">Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¥Ù‚ÙØ§Ù„ Ø¨Ø¹Ø¯</div>';
        return;
      }
      container.innerHTML=`<div class="badge ${record.locked?'':'danger'}">${record.locked?'Ù…Ù‚ÙÙˆÙ„':'Ù…ÙØªÙˆØ­'} â€” ${formatCurrency(record.total)}</div>`;
    }

    function closePeriod(period){
      promptPassword('close',async()=>{
        const closures=await Storage.load('closures');
        const receipts=await Storage.load('receipts');
        const payments=await Storage.load('payments');
        const now=new Date();
        const today=now.toISOString().slice(0,10);
        const totalIn=receipts.filter(r=>r.status==='posted'&&['service','settlement','deposit'].includes((r.receiptType||'service'))).reduce((s,r)=>s+r.amount,0);
        const totalOut=payments.filter(p=>p.status==='posted').reduce((s,p)=>s+p.amount,0);
        const total=totalIn-totalOut;
        const existing=closures.find(c=>c.date===today&&c.period===period);
        if(existing){existing.total=total;existing.locked=true;}else{closures.push({date:today,period,total,locked:true,createdAt:new Date().toISOString()});}
        await Storage.save('closures',closures);
        await logAudit('close',`${today}-${period}`,'Ø¥Ù‚ÙØ§Ù„ ÙØªØ±Ø©',{total});
        showToast('ØªÙ… Ø¥Ù‚ÙØ§Ù„ Ø§Ù„ÙØªØ±Ø©');
        renderPeriodCard(period);
        await exportPeriodPDF(period,true);
      });
    }

    async function exportPeriodPDF(period,silent){
      const doc=createArabicPDF();
      doc.setFontSize(14);
      pdfTextRight(doc,`${App.settings.clinicName}`,20);
      doc.setFontSize(12);
      pdfTextRight(doc,`ØªÙ‚Ø±ÙŠØ± ÙØªØ±Ø© ${period==='morning'?'ØµØ¨Ø§Ø­':'Ù…Ø³Ø§Ø¡'}`,30);
      const receipts=await Storage.load('receipts');
      const payments=await Storage.load('payments');
      const totalIn=receipts.filter(r=>r.status==='posted').reduce((s,r)=>s+r.amount,0);
      const totalOut=payments.filter(p=>p.status==='posted').reduce((s,p)=>s+p.amount,0);
      autoTableArabic(doc,{startY:40,head:[['Ø§Ù„Ø¨Ù†Ø¯','Ø§Ù„Ù‚ÙŠÙ…Ø©']],body:[['Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¯Ø®ÙˆÙ„',formatCurrency(totalIn)],['Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø®Ø±ÙˆØ¬',formatCurrency(totalOut)],['Ø§Ù„ØµØ§ÙÙŠ',formatCurrency(totalIn-totalOut)]]});
      doc.save(`period-${period}-${new Date().toISOString().slice(0,10)}.pdf`);
      if(!silent) showToast('ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù„Ù PDF');
    }

    async function miniTrialPDF(){
      const doc=createArabicPDF();
      doc.setFontSize(14);
      pdfTextRight(doc,'Ø§Ù„Ù…ÙŠØ²Ø§Ù† Ø§Ù„Ù…ØµØºØ±',20);
      const {trial,balanced}=await computeMiniTrialSummary();
      const data=Object.entries(trial).map(([k,v])=>[k,formatCurrency(v)]);
      autoTableArabic(doc,{startY:30,head:[['Ø§Ù„Ø­Ø³Ø§Ø¨','Ø§Ù„ØµØ§ÙÙŠ']],body:data});
      pdfTextRight(doc,`Ø§ØªØ²Ø§Ù† Ø§Ù„Ù‚ÙŠÙˆØ¯: ${balanced?'âœ”ï¸':'âŒ'}`,doc.lastAutoTable.finalY+12);
      doc.save('mini-trial.pdf');
    }

    async function appointmentsPDF(){
      const doc=createArabicPDF();
      doc.setFontSize(14);
      pdfTextRight(doc,'Ù…ÙˆØ§Ø¹ÙŠØ¯ Ø§Ù„ØºØ¯',20);
      const appointments=await Storage.load('appointments');
      const tomorrow=new Date();tomorrow.setDate(tomorrow.getDate()+1);
      const rows=appointments.filter(a=>new Date(a.date).toDateString()===tomorrow.toDateString()).map(a=>[a.patient,a.service,a.doctor,a.status,`${formatCurrency(a.paid||0)} / ${formatCurrency(a.due||0)}`]);
      autoTableArabic(doc,{startY:30,head:[['Ø§Ù„Ù…Ø±ÙŠØ¶','Ø§Ù„Ø®Ø¯Ù…Ø©','Ø§Ù„Ø·Ø¨ÙŠØ¨','Ø§Ù„Ø­Ø§Ù„Ø©','Ø§Ù„Ù…Ø¯ÙÙˆØ¹/Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ']],body:rows});
      doc.save('appointments-tomorrow.pdf');
    }

    async function inventoryAlertsPDF(){
      const doc=createArabicPDF();
      doc.setFontSize(14);
      pdfTextRight(doc,'ØªÙ†Ø¨ÙŠÙ‡Ø§Øª Ø§Ù„Ù…Ø®Ø²ÙˆÙ†',20);
      const {inventory}=await refreshInventoryAggregates();
      const rows=inventory.filter(i=>inventoryAlert(i)).map(i=>[i.name,inventoryAlert(i)]);
      autoTableArabic(doc,{startY:30,head:[['Ø§Ù„Ù…Ø§Ø¯Ø©','Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡']],body:rows});
      doc.save('inventory-alerts.pdf');
    }

    async function receiptPDF(reference){
      const receipts=await Storage.load('receipts');
      const receipt=receipts.find(r=>r.reference===reference);
      if(!receipt) return;
      const doc=createArabicPDF();
      doc.setFontSize(14);
      pdfTextRight(doc,App.settings.clinicName,20);
      pdfTextRight(doc,`Ø³Ù†Ø¯ Ù‚Ø¨Ø¶ ${reference}`,30);
      const receiptTypeMap={service:'ØªØ­ØµÙŠÙ„ Ø®Ø¯Ù…Ø© Ù†Ù‚Ø¯Ù‹Ø§',settlement:'ØªØ³Ø¯ÙŠØ¯ Ø°Ù…Ù…',deposit:'Ø§Ø³ØªÙ„Ø§Ù… Ø£Ù…Ø§Ù†Ø©','deposit-apply':'Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø£Ù…Ø§Ù†Ø©'};
      const typeKey=receipt.receiptType||'service';
      const typeLabel=receiptTypeMap[typeKey]||receiptTypeMap.service;
      autoTableArabic(doc,{startY:40,head:[['Ø§Ù„Ø­Ù‚Ù„','Ø§Ù„Ù‚ÙŠÙ…Ø©']],body:[
        ['Ø§Ù„Ù…Ø±ÙŠØ¶',receipt.patient],
        ['Ø§Ù„Ø®Ø¯Ù…Ø©',receipt.service||'-'],
        ['Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©',typeLabel],
        ['Ø§Ù„Ø·Ø¨ÙŠØ¨',receipt.doctor||'-'],
        ['Ø§Ù„Ù…Ø¨Ù„Øº',formatCurrency(receipt.amount)],
        ['Ø§Ù„Ø­Ø§Ù„Ø©',voucherStatusLabel(receipt.status)],
        ['Ø§Ù„ØªØ§Ø±ÙŠØ®',formatDate(receipt.createdAt)],
        ['Ù…Ù„Ø§Ø­Ø¸Ø§Øª',receipt.notes||'-']
      ]});
      if(receipt.attachment) pdfTextRight(doc,'Ù…Ø±ÙÙ‚ Ù…Ø¶Ù…Ù‘Ù†',doc.lastAutoTable.finalY+10);
      doc.save(`${reference}.pdf`);
    }

    async function paymentPDF(reference){
      const payments=await Storage.load('payments');
      const payment=payments.find(r=>r.reference===reference);
      if(!payment) return;
      const doc=createArabicPDF();
      doc.setFontSize(14);
      pdfTextRight(doc,App.settings.clinicName,20);
      pdfTextRight(doc,`Ø³Ù†Ø¯ ØµØ±Ù ${reference}`,30);
      const statusLabel=voucherStatusLabel(payment.status);
      const paymentTypeMap={invoice:'ØªØ³Ø¯ÙŠØ¯ ÙÙˆØ§ØªÙŠØ±',advance:'Ø³Ù„ÙØ©/Ø¯ÙØ¹Ø© Ù…Ù‚Ø¯Ù…Ø©'};
      const paymentKey=payment.paymentType|| (payment.paymentStatus==='pending'?'advance':'invoice');
      const settlementLabel=paymentTypeMap[paymentKey]||paymentTypeMap.invoice;
      autoTableArabic(doc,{startY:40,head:[['Ø§Ù„Ø­Ù‚Ù„','Ø§Ù„Ù‚ÙŠÙ…Ø©']],body:[
        ['Ø§Ù„Ù…ÙˆØ±Ø¯',payment.supplier],
        ['Ø§Ù„Ù…Ø¨Ù„Øº',formatCurrency(payment.amount)],
        ['Ø­Ø§Ù„Ø© Ø§Ù„Ø³Ù†Ø¯',statusLabel],
        ['Ø­Ø§Ù„Ø© Ø§Ù„Ø¯ÙØ¹',settlementLabel],
        ['Ø§Ù„ØªØ§Ø±ÙŠØ®',formatDate(payment.createdAt)],
        ['Ù…Ù„Ø§Ø­Ø¸Ø§Øª',payment.notes||'-']
      ]});
      doc.save(`${reference}.pdf`);
    }

    async function labOrderPDF(reference){
      const labs=await Storage.load('labs');
      const lab=labs.find(l=>l.reference===reference);
      if(!lab) return;
      const doc=createArabicPDF();
      doc.setFontSize(14);
      pdfTextRight(doc,'Ø·Ù„Ø¨ Ù…Ø¹Ù…Ù„',20);
      pdfTextRight(doc,reference,28);
      autoTableArabic(doc,{startY:34,head:[['Ø§Ù„Ø­Ù‚Ù„','Ø§Ù„Ù‚ÙŠÙ…Ø©']],body:[
        ['Ø§Ù„Ù…Ø±ÙŠØ¶',lab.patient],
        ['Ø§Ù„Ø·Ø¨ÙŠØ¨',lab.doctor||'-'],
        ['Ø§Ù„Ù…Ø¹Ù…Ù„',lab.partner||'-'],
        ['Ø§Ù„Ø®Ø¯Ù…Ø©',lab.service],
        ['Ø§Ù„Ø­Ø§Ù„Ø©',lab.status],
        ['Ø§Ù„ØªÙƒÙ„ÙØ©',formatCurrency(lab.cost||0)],
        ['Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª',lab.notes||'-'],
        ['Ø§Ù„Ù†ØªÙŠØ¬Ø©',lab.result||'-']
      ]});
      if(lab.resultAttachment) pdfTextRight(doc,'Ù…Ø±ÙÙ‚ Ù†ØªÙŠØ¬Ø© Ù…Ø¶Ù…Ù‘Ù†',doc.lastAutoTable.finalY+12);
      doc.save(`${reference}.pdf`);
    }

    async function labSummaryPDF(){
      const doc=createArabicPDF();
      doc.setFontSize(14);
      const labs=await Storage.load('labs');
      pdfTextRight(doc,'ÙƒØ´Ù Ø§Ù„Ù…Ø¹Ø§Ù…Ù„',20);
      autoTableArabic(doc,{startY:30,head:[['Ø§Ù„Ù…Ø±Ø¬Ø¹','Ø§Ù„Ù…Ø±ÙŠØ¶','Ø§Ù„Ø®Ø¯Ù…Ø©','Ø§Ù„Ù…Ø¹Ù…Ù„','Ø§Ù„Ø­Ø§Ù„Ø©','Ø§Ù„ØªÙƒÙ„ÙØ©','Ù†ØªÙŠØ¬Ø©']],body:labs.map(l=>[l.reference,l.patient,l.service,l.partner||'-',l.status,formatCurrency(l.cost||0),l.result?l.result.slice(0,30)+'...':'-'])});
      doc.save('labs-summary.pdf');
    }

    async function patientsAgingPDF(){
      const doc=createArabicPDF();
      doc.setFontSize(14);
      pdfTextRight(doc,'Ø£Ø¹Ù…Ø§Ø± Ø§Ù„Ø°Ù…Ù… Ù„Ù„Ù…Ø±Ø¶Ù‰',20);
      const receivables=await Storage.load('patientReceivables');
      const now=new Date();
      const summary={};
      receivables.filter(r=>r.balance>0).forEach(r=>{
        const diff=Math.floor((now-new Date(r.due))/(1000*60*60*24));
        const bucket=diff<=30?'0-30':diff<=60?'31-60':diff<=90?'61-90':'90+';
        if(!summary[r.patient]) summary[r.patient]={name:r.patient,'0-30':0,'31-60':0,'61-90':0,'90+':0,total:0};
        summary[r.patient][bucket]+=r.balance;
        summary[r.patient].total+=r.balance;
      });
      const body=Object.values(summary).map(row=>[
        row.name,
        formatCurrency(row['0-30']),
        formatCurrency(row['31-60']),
        formatCurrency(row['61-90']),
        formatCurrency(row['90+']),
        formatCurrency(row.total)
      ]);
      autoTableArabic(doc,{startY:30,head:[['Ø§Ù„Ù…Ø±ÙŠØ¶','0-30','31-60','61-90','90+','Ø¥Ø¬Ù…Ø§Ù„ÙŠ']],body:body});
      doc.save('patients-aging.pdf');
    }

    async function supplierAgingPDF(){
      const doc=createArabicPDF();
      doc.setFontSize(14);
      pdfTextRight(doc,'Ø£Ø¹Ù…Ø§Ø± Ø°Ù…Ù… Ø§Ù„Ù…ÙˆØ±Ø¯ÙŠÙ†',20);
      const invoices=await Storage.load('purchaseInvoices');
      const now=new Date();
      const summary={};
      invoices.filter(inv=>inv.balance>0).forEach(inv=>{
        const diff=Math.floor((now-new Date(inv.dueDate||inv.createdAt))/(1000*60*60*24));
        const bucket=diff<=30?'0-30':diff<=60?'31-60':diff<=90?'61-90':'90+';
        if(!summary[inv.supplier]) summary[inv.supplier]={name:inv.supplier,'0-30':0,'31-60':0,'61-90':0,'90+':0,total:0};
        summary[inv.supplier][bucket]+=inv.balance||0;
        summary[inv.supplier].total+=inv.balance||0;
      });
      const body=Object.values(summary).map(row=>[
        row.name,
        formatCurrency(row['0-30']),
        formatCurrency(row['31-60']),
        formatCurrency(row['61-90']),
        formatCurrency(row['90+']),
        formatCurrency(row.total)
      ]);
      autoTableArabic(doc,{startY:30,head:[['Ø§Ù„Ù…ÙˆØ±Ø¯','0-30','31-60','61-90','90+','Ø¥Ø¬Ù…Ø§Ù„ÙŠ']],body:body});
      doc.save('supplier-aging.pdf');
    }

    async function inventoryPDF(){
      const doc=createArabicPDF();
      doc.setFontSize(14);
      pdfTextRight(doc,'ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù…Ø®Ø²ÙˆÙ†',20);
      const {inventory}=await refreshInventoryAggregates();
      autoTableArabic(doc,{startY:30,head:[['Ø§Ù„Ù…Ø§Ø¯Ø©','Ø§Ù„ÙƒÙ…ÙŠØ©','Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¯Ù†Ù‰','Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ©']],body:inventory.map(i=>[i.name,i.qty,i.min,i.expiry?formatDate(i.expiry):'-'])});
      doc.save('inventory.pdf');
    }

    async function doctorProfitPDF(){
      const doc=createArabicPDF();
      doc.setFontSize(14);
      pdfTextRight(doc,'Ø±Ø¨Ø­ÙŠØ© Ø§Ù„Ø£Ø·Ø¨Ø§Ø¡',20);
      const doctors=await Storage.load('doctors');
      const receipts=await Storage.load('receipts');
      const labs=await Storage.load('labs');
      const overheads=await calculateOverheads();
      const rows=doctors.map(doc=>{
        const revenue=receipts.filter(r=>r.doctor===doc.name&&r.status==='posted').reduce((s,r)=>s+r.amount,0);
        const labCost=labs.filter(l=>l.doctor===doc.name).reduce((s,l)=>s+(l.cost||0),0);
        const net=revenue-labCost;
        const doctorShare=net*(doc.share/100);
        const contribution=net-doctorShare-(overheads[doc.name]||0);
        return [doc.name,formatCurrency(revenue),formatCurrency(labCost),doc.share+'%',formatCurrency(doctorShare),formatCurrency(contribution)];
      });
      autoTableArabic(doc,{startY:30,head:[['Ø§Ù„Ø·Ø¨ÙŠØ¨','Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯','ØªÙƒÙ„ÙØ© Ø§Ù„Ù…Ø¹Ù…Ù„','Ø§Ù„Ù†Ø³Ø¨Ø©','Ù†ØµÙŠØ¨ Ø§Ù„Ø·Ø¨ÙŠØ¨','Ù…Ø³Ø§Ù‡Ù…Ø© Ø§Ù„Ø¹ÙŠØ§Ø¯Ø©']],body:rows});
      doc.save('doctor-profit.pdf');
    }

    async function clinicProfitPDF(){
      const doc=createArabicPDF();
      doc.setFontSize(14);
      pdfTextRight(doc,'Ø±Ø¨Ø­ÙŠØ© Ø§Ù„Ø¹ÙŠØ§Ø¯Ø©',20);
      const receipts=await Storage.load('receipts');
      const payments=await Storage.load('payments');
      const labs=await Storage.load('labs');
      const doctors=await Storage.load('doctors');
      const revenue=receipts.filter(r=>r.status==='posted').reduce((s,r)=>s+r.amount,0);
      const labCost=labs.reduce((s,l)=>s+(l.cost||0),0);
      const expenses=payments.filter(p=>p.status==='posted').reduce((s,p)=>s+p.amount,0);
      const doctorShare=doctors.reduce((s,doc)=>{
        const docRevenue=receipts.filter(r=>r.doctor===doc.name&&r.status==='posted').reduce((t,r)=>t+r.amount,0);
        const docLab=labs.filter(l=>l.doctor===doc.name).reduce((t,l)=>t+(l.cost||0),0);
        return s+(docRevenue-docLab)*(doc.share/100);
      },0);
      const net=revenue-labCost-expenses-doctorShare;
      autoTableArabic(doc,{startY:30,head:[['Ø§Ù„Ø¨Ù†Ø¯','Ø§Ù„Ù‚ÙŠÙ…Ø©']],body:[['Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª',formatCurrency(revenue)],['ØªÙƒÙ„ÙØ© Ø§Ù„Ù…Ø¹Ù…Ù„',formatCurrency(labCost)],['Ù…ØµØ±ÙˆÙØ§Øª Ø£Ø®Ø±Ù‰',formatCurrency(expenses)],['Ù†ØµÙŠØ¨ Ø§Ù„Ø£Ø·Ø¨Ø§Ø¡',formatCurrency(doctorShare)],['ØµØ§ÙÙŠ Ø§Ù„Ø±Ø¨Ø­',formatCurrency(net)]]});
      doc.save('clinic-profit.pdf');
    }

    async function dailyReportPDF(){await genericReport('daily');}
    async function weeklyReportPDF(){await genericReport('weekly');}
    async function monthlyReportPDF(){await genericReport('monthly');}

    async function genericReport(type){
      const doc=createArabicPDF();
      doc.setFontSize(14);
      pdfTextRight(doc,`ØªÙ‚Ø±ÙŠØ± ${type==='daily'?'ÙŠÙˆÙ…ÙŠ':type==='weekly'?'Ø£Ø³Ø¨ÙˆØ¹ÙŠ':'Ø´Ù‡Ø±ÙŠ'}`,20);
      const receipts=await Storage.load('receipts');
      const payments=await Storage.load('payments');
      const now=new Date();
      let start;
      if(type==='daily') start=new Date(now.getFullYear(),now.getMonth(),now.getDate());
      if(type==='weekly'){start=new Date(now);start.setDate(now.getDate()-6);}
      if(type==='monthly'){start=new Date(now.getFullYear(),now.getMonth(),1);}
      const filteredReceipts=receipts.filter(r=>new Date(r.createdAt)>=start&&new Date(r.createdAt)<=now && r.status==='posted');
      const filteredPayments=payments.filter(r=>new Date(r.createdAt)>=start&&new Date(r.createdAt)<=now && r.status==='posted');
      const totalIn=filteredReceipts.reduce((s,r)=>s+r.amount,0);
      const totalOut=filteredPayments.reduce((s,r)=>s+r.amount,0);
      autoTableArabic(doc,{startY:30,head:[['Ø§Ù„Ø¨Ù†Ø¯','Ø§Ù„Ù‚ÙŠÙ…Ø©']],body:[['Ø§Ù„Ù…Ø¯Ø®ÙˆÙ„',formatCurrency(totalIn)],['Ø§Ù„Ù…Ø®Ø±ÙˆØ¬',formatCurrency(totalOut)],['Ø§Ù„ØµØ§ÙÙŠ',formatCurrency(totalIn-totalOut)]]});
      doc.save(`report-${type}.pdf`);
    }

    async function trialBalancePDF(){
      const doc=createArabicPDF('p','pt','a4');
      doc.setFontSize(14);
      pdfTextRight(doc,'Ù…ÙŠØ²Ø§Ù† Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©',40);
      const ledger=await aggregateLedger();
      const body=ledger.map(row=>[
        row.code||'-',
        row.name||row.account||'-',
        formatCurrency(row.debit||0),
        formatCurrency(row.credit||0),
        formatCurrency(ledgerRowNet(row))
      ]);
      const totalDebit=ledger.reduce((s,row)=>s+(row.debit||0),0);
      const totalCredit=ledger.reduce((s,row)=>s+(row.credit||0),0);
      body.push(['', 'Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ', formatCurrency(totalDebit), formatCurrency(totalCredit), formatCurrency(totalDebit-totalCredit)]);
      autoTableArabic(doc,{startY:55,head:[['Ø§Ù„ÙƒÙˆØ¯','Ø§Ù„Ø­Ø³Ø§Ø¨','Ù…Ø¯ÙŠÙ†','Ø¯Ø§Ø¦Ù†','Ø§Ù„Ø±ØµÙŠØ¯']],body});
      doc.save('trial-balance.pdf');
    }

    async function incomeStatementPDF(){
      const doc=createArabicPDF('p','pt','a4');
      doc.setFontSize(14);
      pdfTextRight(doc,'Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¯Ø®Ù„',40);
      const ledger=await aggregateLedger();
      const revenues=ledger.filter(row=>row.category==='revenue');
      const expenses=ledger.filter(row=>row.category==='expense');
      const revenueRows=revenues.map(row=>[row.code||'-',row.name||row.account||'-',formatCurrency(ledgerRowNet(row))]);
      const expenseRows=expenses.map(row=>[row.code||'-',row.name||row.account||'-',formatCurrency(ledgerRowNet(row))]);
      const totalRevenue=revenues.reduce((s,row)=>s+ledgerRowNet(row),0);
      const totalExpenses=expenses.reduce((s,row)=>s+ledgerRowNet(row),0);
      const net=totalRevenue-totalExpenses;
      let startY=55;
      autoTableArabic(doc,{startY,head:[['ÙƒÙˆØ¯','Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª','Ø§Ù„Ù‚ÙŠÙ…Ø©']],body:revenueRows.length?revenueRows:[['-','Ù„Ø§ ÙŠÙˆØ¬Ø¯',formatCurrency(0)]]});
      startY=doc.lastAutoTable.finalY+12;
      autoTableArabic(doc,{startY,head:[['ÙƒÙˆØ¯','Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª','Ø§Ù„Ù‚ÙŠÙ…Ø©']],body:expenseRows.length?expenseRows:[['-','Ù„Ø§ ÙŠÙˆØ¬Ø¯',formatCurrency(0)]]});
      pdfTextRight(doc,`Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª: ${formatCurrency(totalRevenue)}`,doc.lastAutoTable.finalY+14);
      pdfTextRight(doc,`Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª: ${formatCurrency(totalExpenses)}`,doc.lastAutoTable.finalY+22);
      pdfTextRight(doc,`ØµØ§ÙÙŠ Ø§Ù„Ø±Ø¨Ø­: ${formatCurrency(net)}`,doc.lastAutoTable.finalY+30);
      doc.save('income-statement.pdf');
    }

    async function balanceSheetPDF(){
      const doc=createArabicPDF('p','pt','a4');
      doc.setFontSize(14);
      pdfTextRight(doc,'Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø±ÙƒØ² Ø§Ù„Ù…Ø§Ù„ÙŠ',40);
      const ledger=await aggregateLedger();
      const assetRows=[];
      const liabilityRows=[];
      const equityRows=[];
      let totalAssets=0;
      let totalLiabilities=0;
      let totalEquity=0;
      ledger.forEach(row=>{
        const net=ledgerRowNet(row);
        const code=row.code||'-';
        const name=row.name||row.account||'-';
        if(row.category==='asset' || row.category==='contra-asset'){
          const adjusted=row.category==='contra-asset'?-net:net;
          if(Math.abs(adjusted)>0.005){
            assetRows.push([code,name,formatCurrency(adjusted)]);
            totalAssets+=adjusted;
          }
        }else if(row.category==='liability'){
          if(Math.abs(net)>0.005){
            liabilityRows.push([code,name,formatCurrency(net)]);
            totalLiabilities+=net;
          }
        }else if(row.category==='equity'){
          if(Math.abs(net)>0.005){
            equityRows.push([code,name,formatCurrency(net)]);
            totalEquity+=net;
          }
        }
      });
      let startY=55;
      if(assetRows.length){
        autoTableArabic(doc,{startY,head:[['ÙƒÙˆØ¯','Ø§Ù„Ø£ØµÙˆÙ„','Ø§Ù„Ù‚ÙŠÙ…Ø©']],body:assetRows});
        startY=doc.lastAutoTable.finalY+12;
      }
      if(liabilityRows.length){
        autoTableArabic(doc,{startY,head:[['ÙƒÙˆØ¯','Ø§Ù„Ø®ØµÙˆÙ…','Ø§Ù„Ù‚ÙŠÙ…Ø©']],body:liabilityRows});
        startY=doc.lastAutoTable.finalY+12;
      }
      if(equityRows.length){
        autoTableArabic(doc,{startY,head:[['ÙƒÙˆØ¯','Ø­Ù‚ÙˆÙ‚ Ø§Ù„Ù…Ù„ÙƒÙŠØ©','Ø§Ù„Ù‚ÙŠÙ…Ø©']],body:equityRows});
        startY=doc.lastAutoTable.finalY+12;
      }
      pdfTextRight(doc,`Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø£ØµÙˆÙ„: ${formatCurrency(totalAssets)}`,startY);
      pdfTextRight(doc,`Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø®ØµÙˆÙ…: ${formatCurrency(totalLiabilities)}`,startY+10);
      pdfTextRight(doc,`Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø­Ù‚ÙˆÙ‚ Ø§Ù„Ù…Ù„ÙƒÙŠØ©: ${formatCurrency(totalEquity)}`,startY+20);
      pdfTextRight(doc,`Ø§Ù„Ø®ØµÙˆÙ… + Ø­Ù‚ÙˆÙ‚ Ø§Ù„Ù…Ù„ÙƒÙŠØ©: ${formatCurrency(totalLiabilities+totalEquity)}`,startY+30);
      doc.save('balance-sheet.pdf');
    }

    async function journalPDF(){
      const doc=createArabicPDF('p','pt','a4');
      doc.setFontSize(14);
      pdfTextRight(doc,'Ø¯ÙØªØ± Ø§Ù„ÙŠÙˆÙ…ÙŠØ©',40);
      const journals=await Storage.load('journals');
      const body=journals.slice(-200).reverse().map(j=>[j.id,formatDate(j.createdAt),j.meta?.type||'',j.entries.map(e=>`${e.account}: ${e.debit?formatCurrency(e.debit):''} ${e.credit?formatCurrency(e.credit):''}`).join('\n')]);
      autoTableArabic(doc,{startY:60,head:[['Ø§Ù„Ù…Ø±Ø¬Ø¹','Ø§Ù„ØªØ§Ø±ÙŠØ®','Ø§Ù„ÙˆØµÙ','Ø§Ù„Ù‚ÙŠÙˆØ¯']],body});
      doc.save('journal.pdf');
    }

    async function auditLogPDF(){
      const doc=createArabicPDF('p','pt','a4');
      doc.setFontSize(14);
      pdfTextRight(doc,'Ø³Ø¬Ù„ Ø§Ù„ØªØ¯Ù‚ÙŠÙ‚',40);
      const log=await Storage.load('audit');
      autoTableArabic(doc,{startY:60,head:[['Ø§Ù„ÙˆÙ‚Øª','Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…','Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡','Ø§Ù„Ù…Ø±Ø¬Ø¹']],body:log.slice(-200).reverse().map(i=>[formatDate(i.timestamp),i.user,i.action,i.reference])});
      doc.save('audit-log.pdf');
    }

    async function downloadVoucherPDF(){
      const type=document.getElementById('voucherType')?.value||'receipt-service';
      if(type.startsWith('receipt')){
        await downloadReceiptPDF();
      }else{
        await downloadPaymentPDF();
      }
    }

    async function downloadReceiptPDF(){
      const receipts=await Storage.load('receipts');
      if(!receipts.length){showToast('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø³Ù†Ø¯Ø§Øª','error');return;}
      await receiptPDF(receipts[receipts.length-1].reference);
    }
    async function downloadPaymentPDF(){
      const payments=await Storage.load('payments');
      if(!payments.length){showToast('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø³Ù†Ø¯Ø§Øª','error');return;}
      await paymentPDF(payments[payments.length-1].reference);
    }

    async function runHealthCheck(){
      const results=[];
      try{
        if(!window.localforage) throw new Error('localForage ØºÙŠØ± Ù…ØªØ§Ø­');
        results.push({item:'localForage',status:'ok'});
      }catch(err){results.push({item:'localForage',status:'fail',message:err.message});}
      try{
        if(!window.jspdf) throw new Error('jsPDF ØºÙŠØ± Ù…ØªØ§Ø­');
        results.push({item:'jsPDF',status:'ok'});
      }catch(err){results.push({item:'jsPDF',status:'fail',message:err.message});}
      try{
        await localforage.setItem('test-key',{time:Date.now()});
        await localforage.getItem('test-key');
        results.push({item:'Ø§Ù„ÙƒØªØ§Ø¨Ø©/Ø§Ù„Ù‚Ø±Ø§Ø¡Ø©',status:'ok'});
      }catch(err){results.push({item:'Ø§Ù„ÙƒØªØ§Ø¨Ø©/Ø§Ù„Ù‚Ø±Ø§Ø¡Ø©',status:'fail',message:err.message});}
      try{
        const journals=await Storage.load('journals');
        const subset=journals.slice(-20);
        const valid=subset.every(j=>Math.abs(j.entries.reduce((s,e)=>s+(e.debit||0),0)-j.entries.reduce((s,e)=>s+(e.credit||0),0))<0.01);
        results.push({item:'Ø§ØªØ²Ø§Ù† Ø§Ù„Ù‚ÙŠÙˆØ¯',status:valid?'ok':'fail',message:valid?'':'ÙŠÙˆØ¬Ø¯ Ù‚ÙŠØ¯ ØºÙŠØ± Ù…ØªØ²Ù†'});
      }catch(err){results.push({item:'Ø§ØªØ²Ø§Ù† Ø§Ù„Ù‚ÙŠÙˆØ¯',status:'fail',message:err.message});}
      const health=document.getElementById('healthReport');
      const ok=results.every(r=>r.status==='ok');
      health.innerHTML='<ul>'+results.map(r=>`<li>${r.status==='ok'?'âœ…':'âŒ'} ${r.item}${r.message?` â€” ${r.message}`:''}</li>`).join('')+'</ul>';
      const doc=createArabicPDF();
      doc.setFontSize(14);
      pdfTextRight(doc,'ÙØ­Øµ Ø§Ù„Ù†Ø¸Ø§Ù…',20);
      autoTableArabic(doc,{startY:30,head:[['Ø§Ù„Ø¨Ù†Ø¯','Ø§Ù„Ù†ØªÙŠØ¬Ø©','Ù…Ù„Ø§Ø­Ø¸Ø§Øª']],body:results.map(r=>[r.item,r.status==='ok'?'âœ…':'âŒ',r.message||''])});
      doc.save('health-check.pdf');
      showToast(ok?'Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª Ù†Ø§Ø¬Ø­Ø©':'Ø¨Ø¹Ø¶ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª ÙØ´Ù„Øª',ok?'success':'error');
    }

    document.getElementById('btnSensitive').onclick=()=>{
      if(App.role!=='manager'){showToast('Ø§Ù„Ù…Ø¯ÙŠØ± ÙÙ‚Ø· ÙŠÙ…ÙƒÙ†Ù‡ ØªÙØ¹ÙŠÙ„ Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ø­Ø³Ø§Ø³','error');return;}
      if(App.sensitive){App.sensitive=false;updateStatus();return;}
      promptPassword('danger',()=>{App.sensitive=true;updateStatus();});
    };

    document.getElementById('btnSwitchRole').onclick=()=>{
      const overlay=document.getElementById('modalOverlay');
      overlay.innerHTML=`<div class="modal">
        <header><h3>ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</h3></header>
        <p>Ø§Ø®ØªØ± Ø§Ù„Ø¯ÙˆØ±:</p>
        <select id="roleSelect" style="width:100%;margin-bottom:1rem;">
          <option value="manager">Ù…Ø¯ÙŠØ±</option>
          <option value="secretary">Ø³ÙƒØ±ØªÙŠØ±Ø©</option>
        </select>
        <div class="flex" style="justify-content:flex-end;">
          <button class="btn" id="confirmRole">ØªØ£ÙƒÙŠØ¯</button>
        </div>
      </div>`;
      overlay.classList.add('active');
      document.getElementById('confirmRole').onclick=()=>{
        const role=document.getElementById('roleSelect').value;
        if(role==='manager'){
          promptPassword('settings',()=>{
            overlay.classList.remove('active');
            App.role='manager';
            updateStatus();
            renderNav();
            switchView('dashboard');
          });
        }else{
          overlay.classList.remove('active');
          App.role='secretary';
          App.sensitive=false;
          updateStatus();
          renderNav();
          switchView('dashboard');
        }
      };
      overlay.addEventListener('click',e=>{if(e.target.id==='modalOverlay')overlay.classList.remove('active');},{once:true});
    };

    function appointmentsSeed(){
      return [
        {id:1,patient:'Ø£Ø­Ù…Ø¯',service:'ØªÙ†Ø¸ÙŠÙ',doctor:'Ø¯. Ù„ÙŠÙ„Ù‰',paid:200,due:0,status:'scheduled',period:'morning',notes:'',date:new Date().toISOString()},
        {id:2,patient:'Ø³Ø§Ø±Ø©',service:'Ø­Ø´Ùˆ',doctor:'Ø¯. Ù…Ø­Ù…Ø¯',paid:0,due:300,status:'scheduled',period:'evening',notes:'',date:new Date(Date.now()+24*60*60*1000).toISOString()}
      ];
    }

    async function bootstrap(){
      await Storage.init();
      await ensureCashAccounts();
      const existingPatients=await Storage.load('patients');
      if(!existingPatients.length){
        await Storage.save('patients',[{name:'Ø£Ø­Ù…Ø¯ Ø¹Ù„ÙŠ',phone:'0500000000',balance:0,deposit:0,notes:'',createdAt:new Date().toISOString()}]);
      }
      const existingDoctors=await Storage.load('doctors');
      if(!existingDoctors.length){
        await Storage.save('doctors',[{name:'Ø¯. Ù„ÙŠÙ„Ù‰',share:40},{name:'Ø¯. Ù…Ø­Ù…Ø¯',share:45}]);
      }
      const appointments=await Storage.load('appointments');
      if(!appointments.length){
        await Storage.save('appointments',appointmentsSeed());
      }
      await updatePatientSelectors();
      updateStatus();
      renderNav();
      switchView('dashboard');
      renderVoucherTable();
      renderJournalTable();
      renderPatientsTable();
      renderPatientReceivables();
      renderMedicalAlerts();
      renderSupplierReturns();
      renderLabsTable();
      renderInventoryTable();
      renderOperatingExpenses();
      renderFixedAssets();
      renderAssetDisposals();
      renderDepreciationSchedule();
      renderPeriodClosings();
      renderDoctorsTable();
      renderAppointmentsTable();
      renderPrescriptionsTable();
      renderBankReconciliations();
      renderCashAccountsTable();
      renderCashCountTable();
      await renderEmployees();
      await renderLabPartners();
      await renderClinicCatalog();
      await renderLabCatalog();
      await refreshCatalogLists();
      await refreshDoctorOptions();
      renderCashAccountSelectors();
      await renderDashboardWidgets();
    }

    bootstrap();
  </script>
</body>
</html>
