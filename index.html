<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Ù†Ø¸Ø§Ù… Ø§Ù„Ø¹ÙŠØ§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§Ø³Ø¨ÙŠ</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700&display=swap" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/localforage/1.10.0/localforage.min.js" integrity="sha512-/g9hw3rroWAtxEvsC0BpvyOuk+qS0bkkCm1cW0XkyKADVY6jwxKF1u9IiMaTZGi99ZTSdKCbFf8gDuwZQ+U8wQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js" integrity="sha512-/Ija+6JGZveHFkNjEcNWef39/C4R2tQeM+c/fi91tIbp/BK+f5pFwchAuCdb9wirtmHg56k97X3CJidb/6G+AQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js" integrity="sha512-e/rMzFxLpy0X58F3RDeo63eNbUsVTNff7kwh28ykVfoCENKz7dxyzKDn5XxhxL7sRKqGZo4PMBVXgS5aXoaZQA==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  <style>
    :root {
      color-scheme: light;
      --bg: #f7f9fc;
      --surface: #ffffff;
      --primary: #0c8a8a;
      --danger: #c0392b;
      --accent: #f1c40f;
      --text: #2c3e50;
      --muted: #95a5a6;
      font-family: 'Cairo', sans-serif;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      background: var(--bg);
      color: var(--text);
      font-family: 'Cairo', sans-serif;
      display: flex;
      flex-direction: column;
      min-height: 100vh;
    }

    header {
      background: var(--surface);
      border-bottom: 1px solid #e6ecf1;
      padding: 1rem 1.5rem;
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 1rem;
      position: sticky;
      top: 0;
      z-index: 10;
    }

    header h1 {
      margin: 0;
      font-size: 1.35rem;
      font-weight: 700;
    }

    header nav {
      display: flex;
      gap: 0.5rem;
      flex: 1;
      justify-content: flex-end;
      flex-wrap: wrap;
    }

    header nav button {
      background: var(--primary);
      color: white;
      border: none;
      padding: 0.55rem 1.2rem;
      border-radius: 999px;
      font-size: 0.95rem;
      cursor: pointer;
      transition: transform 0.15s ease, box-shadow 0.15s ease;
    }

    header nav button.secondary {
      background: transparent;
      color: var(--primary);
      border: 1px solid var(--primary);
    }

    header nav button:active {
      transform: scale(0.97);
    }

    main {
      flex: 1;
      padding: 1.5rem;
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
      gap: 1rem;
    }

    .card {
      background: var(--surface);
      border-radius: 18px;
      padding: 1.25rem;
      box-shadow: 0 12px 24px rgba(15, 35, 95, 0.06);
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
    }

    .card h2 {
      margin: 0;
      font-size: 1.1rem;
      display: flex;
      align-items: center;
      gap: 0.4rem;
    }

    .tag {
      display: inline-flex;
      align-items: center;
      gap: 0.35rem;
      background: rgba(12, 138, 138, 0.1);
      color: var(--primary);
      border-radius: 999px;
      padding: 0.2rem 0.65rem;
      font-size: 0.8rem;
      font-weight: 600;
    }

    .danger-indicator {
      display: inline-flex;
      align-items: center;
      gap: 0.45rem;
      padding: 0.5rem 0.8rem;
      border-radius: 999px;
      font-weight: 700;
      font-size: 0.9rem;
      background: rgba(192, 57, 43, 0.1);
      color: var(--danger);
    }

    .danger-indicator.unlocked {
      background: rgba(46, 204, 113, 0.15);
      color: #27ae60;
    }

    .form-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 0.75rem;
    }

    label {
      font-size: 0.9rem;
      font-weight: 600;
      color: var(--text);
    }

    input, select, textarea {
      width: 100%;
      padding: 0.5rem 0.75rem;
      border-radius: 10px;
      border: 1px solid #d8e1e8;
      font-family: inherit;
      font-size: 0.95rem;
      background: white;
      transition: border 0.2s ease, box-shadow 0.2s ease;
    }

    input:focus, select:focus, textarea:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(12, 138, 138, 0.15);
    }

    .actions {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      margin-top: 0.75rem;
    }

    .btn {
      padding: 0.55rem 1.1rem;
      border-radius: 12px;
      border: none;
      cursor: pointer;
      font-size: 0.95rem;
      font-weight: 600;
      display: inline-flex;
      align-items: center;
      gap: 0.45rem;
    }

    .btn.primary {
      background: var(--primary);
      color: white;
    }

    .btn.secondary {
      background: rgba(12, 138, 138, 0.1);
      color: var(--primary);
    }

    .btn.danger {
      background: var(--danger);
      color: white;
    }

    .hidden {
      display: none !important;
    }

    .toast {
      position: fixed;
      inset-inline-start: 50%;
      bottom: 2rem;
      transform: translateX(-50%);
      background: var(--surface);
      border-radius: 14px;
      padding: 0.75rem 1.25rem;
      box-shadow: 0 12px 32px rgba(30, 60, 90, 0.18);
      display: flex;
      align-items: center;
      gap: 0.5rem;
      min-width: 280px;
      justify-content: space-between;
      transition: opacity 0.3s ease, transform 0.3s ease;
      opacity: 0;
      pointer-events: none;
    }

    .toast.visible {
      opacity: 1;
      pointer-events: auto;
      transform: translate(-50%, -16px);
    }

    dialog {
      border: none;
      border-radius: 20px;
      padding: 1.5rem;
      max-width: 420px;
      width: 90vw;
      box-shadow: 0 24px 60px rgba(15, 25, 55, 0.25);
    }

    dialog::backdrop {
      background: rgba(10, 20, 40, 0.45);
    }

    table {
      width: 100%;
      border-collapse: collapse;
    }

    th, td {
      padding: 0.55rem 0.35rem;
      text-align: start;
      font-size: 0.9rem;
      border-bottom: 1px solid #ecf1f6;
    }

    .badge {
      padding: 0.2rem 0.5rem;
      border-radius: 999px;
      font-size: 0.75rem;
      font-weight: 700;
    }

    .badge.success {
      background: rgba(39, 174, 96, 0.2);
      color: #1e8449;
    }

    .badge.error {
      background: rgba(192, 57, 43, 0.2);
      color: #943126;
    }

    .empty-state {
      text-align: center;
      padding: 2rem 1rem;
      color: var(--muted);
      font-size: 0.95rem;
    }

    @media (max-width: 768px) {
      header {
        flex-direction: column;
        align-items: flex-start;
      }

      header nav {
        justify-content: flex-start;
      }
    }
  </style>
</head>
<body>
  <header>
    <h1>Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… Ø§Ù„Ù…Ø­Ø§Ø³Ø¨ÙŠØ© Ù„Ù„Ø¹ÙŠØ§Ø¯Ø©</h1>
    <nav>
      <div id="currentUser" class="tag">ØºÙŠØ± Ù…Ø³Ø¬Ù„</div>
      <div id="dangerIndicator" class="danger-indicator" role="status" aria-live="polite">ğŸ”’ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø§Ù„Ø­Ø³Ø§Ø³Ø© Ù…Ù‚ÙÙ„Ø©</div>
      <button id="toggleDangerBtn" class="secondary">ØªÙØ¹ÙŠÙ„ Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ø­Ø³Ø§Ø³</button>
      <button id="openSettings" class="secondary">Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</button>
      <button id="exportData" class="secondary">ØªØµØ¯ÙŠØ± JSON</button>
      <label for="importFile" class="btn secondary" style="margin:0; cursor:pointer;">
        <span>Ø§Ø³ØªÙŠØ±Ø§Ø¯ JSON</span>
        <input type="file" id="importFile" accept="application/json" class="hidden">
      </label>
      <button id="logoutBtn" class="secondary">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</button>
    </nav>
  </header>
  <main>
    <section class="card" id="dashboardCard">
      <h2>Ø­Ø§Ù„Ø© Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ø¹Ø§Ù…Ø©</h2>
      <div class="form-grid">
        <div>
          <label>ÙˆØ¶Ø¹ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø§Ù„Ø­Ø³Ø§Ø³Ø©</label>
          <p id="dangerStateText">Ù…Ù‚ÙÙˆÙ„ Ø­ØªÙ‰ Ø¥Ø¯Ø®Ø§Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ø®Ø·Ø±</p>
        </div>
        <div>
          <label>Ø¢Ø®Ø± Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©</label>
          <p id="backupState">Ù„Ù… ÙŠØªÙ… Ø§Ù„ØªØµØ¯ÙŠØ± Ø¨Ø¹Ø¯</p>
        </div>
        <div>
          <label>Ù…Ø²ÙˆØ¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</label>
          <p id="storageProvider">Ø¬Ø§Ø±Ù Ø§Ù„ØªÙ‡ÙŠØ¦Ø©â€¦</p>
        </div>
        <div>
          <label>Ø­Ø§Ù„Ø© Ø§Ù„Ù…ÙƒØªØ¨Ø§Øª</label>
          <p id="librariesStatus" class="badge">Ø¬Ø§Ø±Ù Ø§Ù„ÙØ­Øµâ€¦</p>
        </div>
      </div>
    </section>

    <section class="card" id="sensitiveGuardCard">
      <h2>Ø­Ø§Ø±Ø³ Ø§Ù„Ø£Ø°ÙˆÙ†Ø§Øª Ø§Ù„Ù…Ø±ÙƒØ²ÙŠØ©</h2>
      <p>
        ÙŠÙ…Ù†Ø¹ Ø§Ù„Ù†Ø¸Ø§Ù… Ø£ÙŠ ØªØ¹Ø¯ÙŠÙ„ Ø£Ùˆ Ø­Ø°Ù Ø£Ùˆ Ø¥Ø¨Ø·Ø§Ù„ Ø£Ùˆ Ø¯Ø®ÙˆÙ„ Ø¥Ù„Ù‰ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø£Ùˆ Ø§Ù„Ø¥Ù‚ÙØ§Ù„Ø§Øª Ø¯ÙˆÙ† ØªÙØ¹ÙŠÙ„ Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ø­Ø³Ø§Ø³.
        ÙŠØªÙ… Ø§Ù„ØªÙØ¹ÙŠÙ„ Ø¨ÙˆØ§Ø³Ø·Ø© ÙƒÙ„Ù…Ø© Ø§Ù„Ø®Ø·Ø±ØŒ ÙˆÙŠØ³ØªÙ…Ø± Ù„Ù…Ø¯Ø© 15 Ø¯Ù‚ÙŠÙ‚Ø© Ø£Ùˆ Ø­ØªÙ‰ Ø§Ù„Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„ÙŠØ¯ÙˆÙŠ.
      </p>
      <div class="actions">
        <button id="lockDangerBtn" class="btn danger hidden">Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ø­Ø³Ø§Ø³</button>
        <button id="simulateSensitiveAction" class="btn secondary">Ù…Ø­Ø§ÙˆÙ„Ø© Ø­Ø°Ù ØªØ¬Ø±ÙŠØ¨ÙŠØ©</button>
      </div>
    </section>

    <section class="card" id="settingsCard" hidden>
      <h2>Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø©</h2>
      <p class="muted">Ø¥Ø¯Ø§Ø±Ø© ÙƒÙ„Ù…Ø§Øª Ø§Ù„Ø³Ø± ÙˆØ§Ù„Ø£Ù…Ø§Ù† Ù…ØªØ§Ø­Ø© Ù„Ù„Ù…Ø¯ÙŠØ± ÙÙ‚Ø·.</p>
      <form id="passwordForm" class="form-grid">
        <div>
          <label for="settingsPassword">ÙƒÙ„Ù…Ø© Ø³Ø± Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</label>
          <input id="settingsPassword" name="settingsPassword" type="password" required minlength="6" autocomplete="new-password" />
        </div>
        <div>
          <label for="closePassword">ÙƒÙ„Ù…Ø© Ø³Ø± Ø§Ù„Ø¥Ù‚ÙØ§Ù„</label>
          <input id="closePassword" name="closePassword" type="password" required minlength="6" autocomplete="new-password" />
        </div>
        <div>
          <label for="dangerPassword">ÙƒÙ„Ù…Ø© Ø§Ù„Ø®Ø·Ø±</label>
          <input id="dangerPassword" name="dangerPassword" type="password" required minlength="6" autocomplete="new-password" />
        </div>
        <div class="actions" style="grid-column: 1 / -1;">
          <button type="submit" class="btn primary">Ø­ÙØ¸ Ø§Ù„ÙƒÙ„Ù…Ø§Øª</button>
        </div>
      </form>
      <hr />
      <section>
        <h3>Ø¯Ù„ÙŠÙ„ Ù…Ø®ØªØµØ±</h3>
        <ul>
          <li>Ø¥Ù‚ÙØ§Ù„ Ø§Ù„ÙØªØ±Ø§Øª ÙŠØªØ·Ù„Ø¨ ÙƒÙ„Ù…Ø© Ø§Ù„Ø¥Ù‚ÙØ§Ù„ØŒ ÙˆÙŠÙˆÙ„Ù‘Ø¯ ØªÙ‚Ø§Ø±ÙŠØ± PDF ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§.</li>
          <li>Ù‚Ø¨Ù„ Ø£ÙŠ Ø­Ø°Ù Ø£Ùˆ ØªØ¹Ø¯ÙŠÙ„ Ø­Ø³Ø§Ø³ØŒ ÙØ¹Ù‘Ù„ Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ø­Ø³Ø§Ø³ ÙˆØ£Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ø®Ø·Ø±.</li>
          <li>Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„ØªØµØ¯ÙŠØ± Ø§Ù„Ø¯ÙˆØ±ÙŠ Ù„Ù…Ù„Ù JSON Ù„Ù„Ø§Ø­ØªÙØ§Ø¸ Ø¨Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©.</li>
        </ul>
      </section>
    </section>
  </main>

  <dialog id="loginDialog">
    <form method="dialog" id="loginForm">
      <h2>ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</h2>
      <p>Ø§Ø®ØªØ± Ø§Ù„Ø¯ÙˆØ± Ø§Ù„Ø­Ø§Ù„ÙŠ ÙˆØ£Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±.</p>
      <label for="roleSelect">Ø§Ù„Ø¯ÙˆØ±</label>
      <select id="roleSelect" required>
        <option value="manager">Ù…Ø¯ÙŠØ±</option>
        <option value="secretary">Ø³ÙƒØ±ØªÙŠØ±Ø©</option>
      </select>
      <label for="rolePassword">ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ø§Ù„Ø¯Ø®ÙˆÙ„</label>
      <input id="rolePassword" type="password" required autocomplete="current-password" />
      <div class="actions" style="margin-top: 1rem;">
        <button class="btn primary" type="submit">Ø¯Ø®ÙˆÙ„</button>
      </div>
    </form>
  </dialog>

  <dialog id="passwordPrompt">
    <form method="dialog" id="passwordPromptForm">
      <h2 id="promptTitle">ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ù…Ø·Ù„ÙˆØ¨Ø©</h2>
      <p id="promptMessage">ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ù…Ù†Ø§Ø³Ø¨Ø© Ù„Ù„Ù…ØªØ§Ø¨Ø¹Ø©.</p>
      <input id="promptInput" type="password" required autocomplete="off" />
      <div class="actions" style="margin-top: 1rem;">
        <button class="btn secondary" value="cancel" formmethod="dialog">Ø¥Ù„ØºØ§Ø¡</button>
        <button class="btn primary" type="submit">Ù…ØªØ§Ø¨Ø¹Ø©</button>
      </div>
    </form>
  </dialog>

  <div id="toast" class="toast" role="alert" aria-live="assertive"></div>

  <script>
    /* ===================== Ù‚Ø³Ù… Ø§Ù„Ø£Ø¯ÙˆØ§Øª Ø§Ù„Ø¹Ø§Ù…Ø© ===================== */
    const Toast = (() => {
      let timeout;
      const el = document.getElementById('toast');
      return {
        show(message, variant = 'info') {
          el.textContent = message;
          el.dataset.variant = variant;
          el.classList.add('visible');
          clearTimeout(timeout);
          timeout = setTimeout(() => el.classList.remove('visible'), 4000);
        }
      };
    })();

    const promptPassword = (title, message) => {
      return new Promise((resolve) => {
        const dialog = document.getElementById('passwordPrompt');
        const titleEl = document.getElementById('promptTitle');
        const msgEl = document.getElementById('promptMessage');
        const input = document.getElementById('promptInput');
        const form = document.getElementById('passwordPromptForm');
        titleEl.textContent = title;
        msgEl.textContent = message;
        input.value = '';
        const onSubmit = (event) => {
          event.preventDefault();
          dialog.close('confirm');
          form.removeEventListener('submit', onSubmit);
          resolve(input.value);
        };
        form.addEventListener('submit', onSubmit);
        dialog.addEventListener('close', () => {
          form.removeEventListener('submit', onSubmit);
          if (dialog.returnValue !== 'confirm') {
            resolve(null);
          }
        }, { once: true });
        dialog.showModal();
        requestAnimationFrame(() => input.focus());
      });
    };

    const arabicDigits = (value) => {
      const map = ['Ù ','Ù¡','Ù¢','Ù£','Ù¤','Ù¥','Ù¦','Ù§','Ù¨','Ù©'];
      return String(value).replace(/\d/g, (d) => map[d]);
    };

    const formatDateArabic = (isoDate) => {
      if (!isoDate) return 'â€”';
      const date = new Date(isoDate);
      return date.toLocaleDateString('ar-EG', {
        year: 'numeric', month: 'long', day: 'numeric',
        hour: '2-digit', minute: '2-digit'
      });
    };

    /* ===================== Ù‚Ø³Ù… Ø§Ù„ØªØ®Ø²ÙŠÙ† ÙˆØ§Ù„ØªÙ‡ÙŠØ¦Ø© ===================== */
    const STORAGE_KEY = 'myClinicDB_v1';

    const Storage = (() => {
      const lf = localforage.createInstance({ name: 'MyClinicDB' });

      const migrateFromLocalStorage = async () => {
        const legacy = localStorage.getItem(STORAGE_KEY);
        if (legacy) {
          try {
            const parsed = JSON.parse(legacy);
            await lf.setItem(STORAGE_KEY, parsed);
            localStorage.removeItem(STORAGE_KEY);
            Toast.show('ØªÙ…Øª ØªØ±Ù‚ÙŠØ© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© Ø¨Ù†Ø¬Ø§Ø­.', 'success');
          } catch (error) {
            console.error('Migration error', error);
            Toast.show('ØªØ¹Ø°Ù‘Ø± ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©.', 'error');
          }
        }
      };

      const defaultData = {
        settings: {
          settingsPassword: null,
          closePassword: null,
          dangerPassword: null,
          lastBackup: null,
          clinic: {
            name: 'Ø¹ÙŠØ§Ø¯Ø© Ø§Ù„Ø£Ø³Ù†Ø§Ù†',
            logo: ''
          }
        },
        users: {
          manager: {
            display: 'Ø§Ù„Ù…Ø¯ÙŠØ±',
            password: 'admin123'
          },
          secretary: {
            display: 'Ø§Ù„Ø³ÙƒØ±ØªÙŠØ±Ø©',
            password: 'sec1234'
          }
        },
        audit: []
      };

      const init = async () => {
        await migrateFromLocalStorage();
        const existing = await lf.getItem(STORAGE_KEY);
        if (!existing) {
          await lf.setItem(STORAGE_KEY, defaultData);
        }
        return lf.getItem(STORAGE_KEY);
      };

      const save = async (data) => {
        await lf.setItem(STORAGE_KEY, data);
        return data;
      };

      return { init, save, instance: lf };
    })();

    /* ===================== Ù‚Ø³Ù… Ø­Ø§Ù„Ø© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ ===================== */
    const AppState = {
      data: null,
      currentUser: null,
      dangerMode: false,
      dangerTimeout: null
    };

    const updateDangerIndicator = () => {
      const indicator = document.getElementById('dangerIndicator');
      indicator.classList.toggle('unlocked', AppState.dangerMode);
      indicator.textContent = AppState.dangerMode ? 'ğŸ”“ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø§Ù„Ø­Ø³Ø§Ø³Ø© Ù…ÙØ¹Ù„Ø©' : 'ğŸ”’ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø§Ù„Ø­Ø³Ø§Ø³Ø© Ù…Ù‚ÙÙ„Ø©';
      document.getElementById('dangerStateText').textContent = AppState.dangerMode ? 'Ù…ÙØªÙˆØ­ Ø­ØªÙ‰ Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„Ù…Ø¯Ø© Ø£Ùˆ Ø§Ù„Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„ÙŠØ¯ÙˆÙŠ' : 'Ù…Ù‚ÙÙˆÙ„ Ø­ØªÙ‰ Ø¥Ø¯Ø®Ø§Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ø®Ø·Ø±';
      document.getElementById('toggleDangerBtn').classList.toggle('hidden', AppState.dangerMode);
      document.getElementById('lockDangerBtn').classList.toggle('hidden', !AppState.dangerMode);
    };

    const setCurrentUser = (roleKey) => {
      const badge = document.getElementById('currentUser');
      if (!roleKey) {
        AppState.currentUser = null;
        badge.textContent = 'ØºÙŠØ± Ù…Ø³Ø¬Ù„';
        badge.classList.remove('badge', 'success');
        document.getElementById('settingsCard').hidden = true;
        return;
      }
      AppState.currentUser = roleKey;
      const display = AppState.data.users[roleKey]?.display || roleKey;
      badge.textContent = display;
      badge.classList.add('badge', 'success');
      document.getElementById('settingsCard').hidden = roleKey !== 'manager';
    };

    /* ===================== Ù‚Ø³Ù… Ø§Ù„Ø­Ù…Ø§ÙŠØ© ÙˆØ¥Ø¯Ø§Ø±Ø© ÙƒÙ„Ù…Ø§Øª Ø§Ù„Ø³Ø± ===================== */
    const Guards = (() => {
      const requireSettingsPassword = async () => {
        if (AppState.currentUser !== 'manager') {
          Toast.show('Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ù…ØªØ§Ø­Ø© Ù„Ù„Ù…Ø¯ÙŠØ± ÙÙ‚Ø·.', 'error');
          return false;
        }
        const stored = AppState.data.settings.settingsPassword;
        if (!stored) {
          Toast.show('Ù„Ù… ÙŠØªÙ… Ø¶Ø¨Ø· ÙƒÙ„Ù…Ø© Ø³Ø± Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø¨Ø¹Ø¯.', 'info');
          return true;
        }
        const input = await promptPassword('Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ù…Ø¤Ù…Ù†Ø©', 'Ø£Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø© Ø³Ø± Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ù„Ù„ÙˆØµÙˆÙ„.');
        if (input === stored) {
          Toast.show('ØªÙ… ÙØªØ­ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª.', 'success');
          return true;
        }
        Toast.show('ÙƒÙ„Ù…Ø© Ø³Ø± ØºÙŠØ± ØµØ­ÙŠØ­Ø©.', 'error');
        return false;
      };

      const requireDangerMode = async () => {
        if (AppState.dangerMode) {
          return true;
        }
        const stored = AppState.data.settings.dangerPassword;
        if (!stored) {
          Toast.show('Ù„Ù… ÙŠØªÙ… Ø¶Ø¨Ø· ÙƒÙ„Ù…Ø© Ø§Ù„Ø®Ø·Ø±. ÙŠÙØ±Ø¬Ù‰ Ø¶Ø¨Ø·Ù‡Ø§ Ø£ÙˆÙ„Ø§Ù‹.', 'error');
          return false;
        }
        const input = await promptPassword('Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ø­Ø³Ø§Ø³ Ù…Ù‚ÙÙ„', 'Ø£Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ø®Ø·Ø± Ù„ØªÙØ¹ÙŠÙ„ Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ø­Ø³Ø§Ø³.');
        if (input === stored) {
          enableDangerMode();
          return true;
        }
        Toast.show('ÙƒÙ„Ù…Ø© Ø§Ù„Ø®Ø·Ø± ØºÙŠØ± ØµØ­ÙŠØ­Ø©.', 'error');
        return false;
      };

      const requireClosePassword = async () => {
        const stored = AppState.data.settings.closePassword;
        if (!stored) {
          Toast.show('Ù„Ù… ÙŠØªÙ… Ø¶Ø¨Ø· ÙƒÙ„Ù…Ø© Ø³Ø± Ø§Ù„Ø¥Ù‚ÙØ§Ù„ Ø¨Ø¹Ø¯.', 'error');
          return false;
        }
        const input = await promptPassword('Ø¥Ù‚ÙØ§Ù„ Ø§Ù„ÙØªØ±Ø©', 'Ø£Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ø¥Ù‚ÙØ§Ù„ Ø§Ù„Ù…ØªÙÙ‚ Ø¹Ù„ÙŠÙ‡Ø§.');
        if (input === stored) {
          Toast.show('ØªÙ… Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙƒÙ„Ù…Ø© Ø§Ù„Ø¥Ù‚ÙØ§Ù„.', 'success');
          return true;
        }
        Toast.show('ÙƒÙ„Ù…Ø© Ø§Ù„Ø¥Ù‚ÙØ§Ù„ ØºÙŠØ± ØµØ­ÙŠØ­Ø©.', 'error');
        return false;
      };

      return { requireSettingsPassword, requireDangerMode, requireClosePassword };
    })();

    const enableDangerMode = () => {
      AppState.dangerMode = true;
      updateDangerIndicator();
      Toast.show('ØªÙ… ØªÙØ¹ÙŠÙ„ Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ø­Ø³Ø§Ø³ Ù„Ù…Ø¯Ø© Ù¡Ù¥ Ø¯Ù‚ÙŠÙ‚Ø©.', 'success');
      clearTimeout(AppState.dangerTimeout);
      AppState.dangerTimeout = setTimeout(() => {
        AppState.dangerMode = false;
        updateDangerIndicator();
        Toast.show('Ø§Ù†ØªÙ‡Øª ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ø­Ø³Ø§Ø³ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§.', 'info');
      }, 15 * 60 * 1000);
    };

    const disableDangerMode = () => {
      AppState.dangerMode = false;
      updateDangerIndicator();
      clearTimeout(AppState.dangerTimeout);
      Toast.show('ØªÙ… Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ø­Ø³Ø§Ø³.', 'info');
    };

    /* ===================== Ù‚Ø³Ù… Ø§Ù„ØªÙ‡ÙŠØ¦Ø© ===================== */
    const fillSettingsForm = () => {
      const form = document.getElementById('passwordForm');
      form.settingsPassword.value = AppState.data.settings.settingsPassword || '';
      form.closePassword.value = AppState.data.settings.closePassword || '';
      form.dangerPassword.value = AppState.data.settings.dangerPassword || '';
    };

    const updateLibraryStatus = () => {
      const badge = document.getElementById('librariesStatus');
      const hasLocalforage = typeof localforage !== 'undefined';
      const hasJsPDF = typeof window.jspdf !== 'undefined';
      const hasAutoTable = hasJsPDF && typeof window.jspdf.jsPDF === 'function' && typeof window.jspdf.jsPDF.prototype.autoTable === 'function';
      if (hasLocalforage && hasJsPDF && hasAutoTable) {
        badge.textContent = 'Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…ÙƒØªØ¨Ø§Øª Ù…ØªØ§Ø­Ø© âœ…';
        badge.className = 'badge success';
      } else {
        badge.textContent = 'Ù…Ø´ÙƒÙ„Ø© ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…ÙƒØªØ¨Ø§Øª';
        badge.className = 'badge error';
      }
    };

    const updateStorageProvider = () => {
      const provider = AppState.data?._provider || 'IndexedDB via localForage';
      document.getElementById('storageProvider').textContent = provider;
    };

    const updateBackupState = () => {
      const last = AppState.data?.settings?.lastBackup;
      document.getElementById('backupState').textContent = last ? formatDateArabic(last) : 'Ù„Ù… ÙŠØªÙ… Ø§Ù„ØªØµØ¯ÙŠØ± Ø¨Ø¹Ø¯';
    };

    const refreshUI = () => {
      updateDangerIndicator();
      updateLibraryStatus();
      updateStorageProvider();
      updateBackupState();
      fillSettingsForm();
    };

    /* ===================== Ù‚Ø³Ù… Ø§Ù„ØªØµØ¯ÙŠØ± ÙˆØ§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯ ===================== */
    const handleExport = async () => {
      const blob = new Blob([JSON.stringify(AppState.data, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      const date = new Date().toISOString().split('T')[0];
      a.download = `myclinicdb-backup-${date}.json`;
      a.click();
      URL.revokeObjectURL(url);
      AppState.data.settings.lastBackup = new Date().toISOString();
      await Storage.save(AppState.data);
      updateBackupState();
      Toast.show('ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© JSON Ø¨Ù†Ø¬Ø§Ø­.', 'success');
    };

    const handleImport = async (file) => {
      if (!file) return;
      try {
        const text = await file.text();
        const parsed = JSON.parse(text);
        if (!parsed || typeof parsed !== 'object') {
          throw new Error('ØµÙŠØºØ© ØºÙŠØ± ØµØ§Ù„Ø­Ø©');
        }
        AppState.data = await Storage.save(parsed);
        refreshUI();
        Toast.show('ØªÙ… Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø¨Ù†Ø¬Ø§Ø­.', 'success');
      } catch (error) {
        console.error(error);
        Toast.show('ØªØ¹Ø°Ù‘Ø± Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ù…Ù„Ù. ØªØ£ÙƒØ¯ Ù…Ù† ØµØ­Ø© JSON.', 'error');
      } finally {
        document.getElementById('importFile').value = '';
      }
    };

    /* ===================== Ù‚Ø³Ù… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ ===================== */
    const showLogin = () => {
      const dialog = document.getElementById('loginDialog');
      dialog.showModal();
    };

    const verifyLogin = (role, password) => {
      const record = AppState.data.users[role];
      if (!record) return false;
      return record.password === password;
    };

    /* ===================== Ù‚Ø³Ù… Ø§Ù„ØªØ¯Ù‚ÙŠÙ‚ ===================== */
    const auditLog = (action, details = {}) => {
      const entry = {
        id: crypto.randomUUID(),
        user: AppState.currentUser,
        action,
        details,
        timestamp: new Date().toISOString()
      };
      AppState.data.audit.unshift(entry);
      Storage.save(AppState.data).catch(console.error);
    };

    /* ===================== ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ù…Ø³ØªÙ…Ø¹ÙŠÙ† ===================== */
    const attachListeners = () => {
      document.getElementById('openSettings').addEventListener('click', async () => {
        if (await Guards.requireSettingsPassword()) {
          document.getElementById('settingsCard').hidden = false;
        }
      });

      document.getElementById('toggleDangerBtn').addEventListener('click', () => {
        Guards.requireDangerMode();
      });

      document.getElementById('lockDangerBtn').addEventListener('click', () => {
        disableDangerMode();
      });

      document.getElementById('simulateSensitiveAction').addEventListener('click', async () => {
        const allowed = await Guards.requireDangerMode();
        if (!allowed) {
          Toast.show('ØªÙ… Ù…Ù†Ø¹ Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ù„Ø¹Ø¯Ù… ØªÙØ¹ÙŠÙ„ Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ø­Ø³Ø§Ø³.', 'error');
          auditLog('sensitive_denied', { reason: 'danger-mode-disabled' });
          return;
        }
        Toast.show('ØªÙ…Øª Ù…Ø­Ø§ÙƒØ§Ø© Ø§Ù„Ø­Ø°Ù Ø¨Ù†Ø¬Ø§Ø­ (Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ø­Ù‚ÙŠÙ‚ÙŠØ©).', 'success');
        auditLog('sensitive_mock', { operation: 'delete-demo' });
      });

      document.getElementById('exportData').addEventListener('click', handleExport);
      document.getElementById('importFile').addEventListener('change', (event) => handleImport(event.target.files[0]));
      document.getElementById('logoutBtn').addEventListener('click', () => {
        setCurrentUser(null);
        showLogin();
      });

      document.getElementById('passwordForm').addEventListener('submit', async (event) => {
        event.preventDefault();
        const form = event.target;
        AppState.data.settings.settingsPassword = form.settingsPassword.value.trim() || null;
        AppState.data.settings.closePassword = form.closePassword.value.trim() || null;
        AppState.data.settings.dangerPassword = form.dangerPassword.value.trim() || null;
        await Storage.save(AppState.data);
        Toast.show('ØªÙ… Ø­ÙØ¸ ÙƒÙ„Ù…Ø§Øª Ø§Ù„Ø³Ø± Ø¨Ù†Ø¬Ø§Ø­.', 'success');
        auditLog('settings_updated', { fields: ['settingsPassword', 'closePassword', 'dangerPassword'] });
      });

      document.getElementById('loginForm').addEventListener('submit', (event) => {
        event.preventDefault();
        const role = document.getElementById('roleSelect').value;
        const password = document.getElementById('rolePassword').value;
        if (verifyLogin(role, password)) {
          setCurrentUser(role);
          document.getElementById('loginDialog').close();
          Toast.show('Ù…Ø±Ø­Ø¨Ù‹Ø§ Ø¨Ùƒ! ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„.', 'success');
          auditLog('login', { role });
        } else {
          Toast.show('Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¯Ø®ÙˆÙ„ ØºÙŠØ± ØµØ­ÙŠØ­Ø©.', 'error');
        }
      });
    };

    /* ===================== Ø¨Ø¯Ø¡ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ ===================== */
    (async () => {
      try {
        AppState.data = await Storage.init();
        AppState.data._provider = 'IndexedDB via localForage';
        refreshUI();
        attachListeners();
        showLogin();
      } catch (error) {
        console.error('Initialization error', error);
        Toast.show('ØªØ¹Ø°Ù‘Ø± ØªÙ‡ÙŠØ¦Ø© Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ©.', 'error');
      }
    })();
  </script>
</body>
</html>
