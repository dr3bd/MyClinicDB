<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>MyClinicDB</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/localforage/1.10.0/localforage.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
  <style>
    :root {
      --primary:#145C9E;
      --accent:#1ABC9C;
      --danger:#E74C3C;
      --bg:#F7F9FC;
      --text:#1B263B;
    }
    *{box-sizing:border-box;}
    body{
      margin:0;
      font-family:'Cairo',sans-serif;
      background:var(--bg);
      color:var(--text);
    }
    header{
      display:flex;
      justify-content:space-between;
      align-items:center;
      background:var(--primary);
      color:#fff;
      padding:1.25rem 1.5rem;
    }
    main{
      display:grid;
      grid-template-columns:260px 1fr;
      min-height:calc(100vh - 96px);
    }
    nav{
      background:#fff;
      border-left:1px solid #dce6f2;
      padding:1rem;
      display:flex;
      flex-direction:column;
      gap:.5rem;
    }
    nav button{
      border-radius:12px;
      border:1px solid transparent;
      padding:.75rem 1rem;
      background:transparent;
      text-align:right;
      font-weight:600;
      color:var(--text);
      cursor:pointer;
    }
    nav button.active,nav button:hover{
      border-color:var(--primary);
      color:var(--primary);
      background:rgba(20,92,158,0.08);
    }
    section{
      padding:1.5rem;
      overflow-y:auto;
    }
    .card{
      background:#fff;
      border-radius:16px;
      padding:1.25rem;
      box-shadow:0 12px 32px rgba(0,0,0,.06);
      margin-bottom:1.5rem;
    }
    .grid{display:grid;gap:1rem;}
    .grid-2{grid-template-columns:repeat(auto-fit,minmax(220px,1fr));}
    label{display:block;font-weight:600;margin-bottom:.3rem;}
    input,select,textarea{
      width:100%;
      padding:.6rem .8rem;
      border-radius:12px;
      border:1px solid #dbe5ef;
      font-family:inherit;
    }
    textarea{min-height:120px;}
    table{width:100%;border-collapse:collapse;direction:rtl;}
    th,td{padding:.6rem;border-bottom:1px solid #eef2f7;text-align:right;}
    th{background:#f0f5fb;}
    .btn{
      display:inline-flex;
      align-items:center;
      gap:.4rem;
      background:var(--primary);
      color:#fff;
      border:none;
      border-radius:12px;
      padding:.6rem 1rem;
      font-weight:600;
      cursor:pointer;
    }
    .btn.secondary{background:var(--accent);}
    .btn.danger{background:var(--danger);}
    .badge{
      display:inline-flex;
      gap:.3rem;
      align-items:center;
      padding:.35rem .75rem;
      background:rgba(20,92,158,.12);
      color:var(--primary);
      border-radius:999px;
      font-size:.75rem;
    }
    .badge.danger{background:rgba(231,76,60,.15);color:var(--danger);}
    .toast{
      position:fixed;top:1.5rem;left:50%;transform:translateX(-50%);
      background:#fff;padding:1rem 1.5rem;border-radius:16px;display:none;z-index:9999;
      box-shadow:0 12px 32px rgba(0,0,0,.15);
      min-width:260px;text-align:center;
    }
    .toast.show{display:block;}
    .toast.error{border-right:6px solid var(--danger);}
    .toast.success{border-right:6px solid var(--accent);}
    #modalOverlay{
      position:fixed;inset:0;background:rgba(0,0,0,.35);backdrop-filter:blur(4px);
      display:none;align-items:center;justify-content:center;z-index:9000;
    }
    #modalOverlay.active{display:flex;}
    .modal{background:#fff;padding:1.5rem;border-radius:18px;min-width:min(420px,94vw);}
    .modal header{margin-bottom:1rem;}
    .flex{display:flex;gap:1rem;align-items:center;flex-wrap:wrap;}
    .sensitive-active{border:2px dashed var(--danger);padding:.4rem .8rem;border-radius:10px;color:var(--danger);}
    @media(max-width:960px){
      main{grid-template-columns:1fr;}
      nav{flex-direction:row;flex-wrap:wrap;border-left:none;border-top:1px solid #dce6f2;}
      nav button{flex:1 1 calc(50% - .5rem);}
    }
  </style>
</head>
<body>
  <div class="toast" id="toast"></div>
  <div id="modalOverlay"></div>
  <header>
    <h1>MyClinicDB â€” Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø­Ø§Ø³Ø¨ÙŠ</h1>
    <div class="flex" id="statusBar">
      <span id="roleBadge" class="badge">Ø§Ù„ÙˆØ¶Ø¹: Ø³ÙƒØ±ØªØ§Ø±ÙŠØ©</span>
      <span id="sensitiveBadge" class="badge danger">Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø§Ù„Ø­Ø³Ø§Ø³Ø©: ğŸ”’</span>
      <button class="btn" id="btnSensitive">ØªÙØ¹ÙŠÙ„ Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ø­Ø³Ø§Ø³</button>
      <button class="btn secondary" id="btnSwitchRole">ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</button>
    </div>
  </header>
  <main>
    <nav id="mainNav"></nav>
    <section id="view"></section>
  </main>
  <script>
    const App = {
      role:'secretary',
      sensitive:false,
      passwords:{settings:'123456',close:'654321',danger:'246810'},
      settings:{
        clinicName:'Ø¹ÙŠØ§Ø¯Ø© Ø£Ø³Ù†Ø§Ù† Ù…ØªÙ‚Ø¯Ù…Ø©',
        clinicLogo:'',
        currency:'SAR',
        overheadAllocation:'revenue',
        numberFormat:'ar'
      },
      counters:{},
      view:'dashboard'
    };

    const Views = {};

    function showToast(msg,type='success'){
      const el=document.getElementById('toast');
      el.textContent=msg;
      el.className=`toast show ${type}`;
      setTimeout(()=>el.classList.remove('show'),3500);
    }

    function formatDate(date){
      if(!date) return '-';
      const d=new Date(date);
      return d.toLocaleDateString('ar-SA',{year:'numeric',month:'2-digit',day:'2-digit'});
    }
    function formatCurrency(val){
      return new Intl.NumberFormat('ar-EG',{style:'currency',currency:App.settings.currency||'SAR'}).format(val||0);
    }

    const Storage={
      async init(){
        localforage.config({name:'MyClinicDB',storeName:'clinic_store'});
        const settings=await localforage.getItem('settings');
        if(settings){
          App.settings={...App.settings,...settings};
          if(settings.passwords) App.passwords={...App.passwords,...settings.passwords};
        }
        App.counters=await localforage.getItem('referenceCounters')||{};
      },
      async load(key,fallback=[]){
        return await localforage.getItem(key)||fallback;
      },
      async save(key,val){
        await localforage.setItem(key,val);
      }
    };

    function generateReference(prefix){
      const now=new Date();
      const ym=`${now.getFullYear()}${String(now.getMonth()+1).padStart(2,'0')}`;
      const key=`${prefix}-${ym}`;
      const counter=(App.counters[key]||0)+1;
      App.counters[key]=counter;
      localforage.setItem('referenceCounters',App.counters);
      return `${prefix}-${ym}-${String(counter).padStart(4,'0')}`;
    }

    function updateStatus(){
      document.getElementById('roleBadge').textContent=`Ø§Ù„ÙˆØ¶Ø¹: ${App.role==='manager'?'Ù…Ø¯ÙŠØ±':'Ø³ÙƒØ±ØªØ§Ø±ÙŠØ©'}`;
      document.getElementById('btnSensitive').disabled=App.role!=='manager';
      document.getElementById('sensitiveBadge').textContent=`Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø§Ù„Ø­Ø³Ø§Ø³Ø©: ${App.sensitive?'ğŸ”“':'ğŸ”’'}`;
      document.getElementById('sensitiveBadge').className=`badge ${App.sensitive?'':'danger'}`;
    }

    function renderNav(){
      const nav=document.getElementById('mainNav');
      nav.innerHTML='';
      const items=[
        {id:'dashboard',label:'Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…'},
        {id:'receipts',label:'Ø³Ù†Ø¯Ø§Øª Ø§Ù„Ù‚Ø¨Ø¶'},
        {id:'payments',label:'Ø³Ù†Ø¯Ø§Øª Ø§Ù„ØµØ±Ù'},
        {id:'journal',label:'Ø¯ÙØªØ± Ø§Ù„ÙŠÙˆÙ…ÙŠØ©'},
        {id:'patients',label:'Ø§Ù„Ù…Ø±Ø¶Ù‰ ÙˆØ§Ù„Ø£Ù…Ø§Ù†Ø§Øª'},
        {id:'suppliers',label:'Ø§Ù„Ù…ÙˆØ±Ø¯ÙˆÙ† ÙˆØ§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª'},
        {id:'labs',label:'Ø§Ù„Ù…Ø¹Ø§Ù…Ù„'},
        {id:'inventory',label:'Ø§Ù„Ù…Ø®Ø²ÙˆÙ†'},
        {id:'doctors',label:'Ø§Ù„Ø£Ø·Ø¨Ø§Ø¡ ÙˆØ§Ù„Ø±Ø¨Ø­ÙŠØ©'},
        {id:'reports',label:'Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±'},
        {id:'settings',label:'Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª'}
      ];
      items.forEach(item=>{
        if(App.role!=='manager' && item.id==='settings') return;
        const btn=document.createElement('button');
        btn.textContent=item.label;
        if(App.view===item.id) btn.classList.add('active');
        btn.onclick=()=>switchView(item.id);
        nav.appendChild(btn);
      });
    }

    function switchView(id){
      App.view=id;
      renderNav();
      const container=document.getElementById('view');
      container.innerHTML=Views[id]?Views[id]():'';
    }

    function promptPassword(type,cb){
      const overlay=document.getElementById('modalOverlay');
      overlay.innerHTML=`<div class="modal">
        <header><h3>ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</h3></header>
        <p>Ø£Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± (${type==='settings'?'Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª':type==='close'?'Ø§Ù„Ø¥Ù‚ÙØ§Ù„':'Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø§Ù„Ø­Ø³Ø§Ø³Ø©'})</p>
        <input id="pwdField" type="password" style="width:100%;margin-bottom:1rem;" />
        <div class="flex" style="justify-content:flex-end;">
          <button class="btn" id="confirmPwd">ØªØ£ÙƒÙŠØ¯</button>
        </div>
      </div>`;
      overlay.classList.add('active');
      document.getElementById('confirmPwd').onclick=()=>{
        const value=document.getElementById('pwdField').value;
        if(value===App.passwords[type]){
          overlay.classList.remove('active');
          cb();
        }else{
          showToast('ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø©','error');
        }
      };
      overlay.addEventListener('click',e=>{if(e.target.id==='modalOverlay')overlay.classList.remove('active');},{once:true});
    }

    function guardSensitive(cb){
      if(!App.sensitive){
        showToast('ÙØ¹Ù‘Ù„ Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ø­Ø³Ø§Ø³ Ø£ÙˆÙ„Ø§Ù‹','error');
        return;
      }
      promptPassword('danger',cb);
    }

    async function logAudit(action,reference,description,payload={}){
      const log=await Storage.load('audit');
      log.push({id:Date.now(),action,reference,description,payload,user:App.role,timestamp:new Date().toISOString()});
      await Storage.save('audit',log);
    }

    async function recordJournal(entries,meta){
      const debit=entries.reduce((s,e)=>s+(e.debit||0),0);
      const credit=entries.reduce((s,e)=>s+(e.credit||0),0);
      if(Math.abs(debit-credit)>0.01){
        showToast('Ø§Ù„Ù‚ÙŠØ¯ ØºÙŠØ± Ù…ØªÙˆØ§Ø²Ù†','error');
        throw new Error('unbalanced');
      }
      const journals=await Storage.load('journals');
      const doc={id:generateReference('JV'),entries,meta,createdAt:new Date().toISOString()};
      journals.push(doc);
      await Storage.save('journals',journals);
      await logAudit('add',doc.id,'Ø¥Ø¶Ø§ÙØ© Ù‚ÙŠØ¯ ÙŠÙˆÙ…ÙŠØ©',meta);
      return doc;
    }

    function Views_dashboard(){
      return `
      <div class="grid grid-2">
        <div class="card">
          <h2>ÙØªØ±Ø© Ø§Ù„ÙŠÙˆÙ… â€” ØµØ¨Ø§Ø­</h2>
          <div id="periodMorning"></div>
          <div class="flex" style="margin-top:1rem;">
            <button class="btn secondary" onclick="exportPeriodPDF('morning')">PDF</button>
            <button class="btn" onclick="closePeriod('morning')">Ø¥Ù‚ÙØ§Ù„ Ø§Ù„ÙØªØ±Ø©</button>
          </div>
        </div>
        <div class="card">
          <h2>ÙØªØ±Ø© Ø§Ù„ÙŠÙˆÙ… â€” Ù…Ø³Ø§Ø¡</h2>
          <div id="periodEvening"></div>
          <div class="flex" style="margin-top:1rem;">
            <button class="btn secondary" onclick="exportPeriodPDF('evening')">PDF</button>
            <button class="btn" onclick="closePeriod('evening')">Ø¥Ù‚ÙØ§Ù„ Ø§Ù„ÙØªØ±Ø©</button>
          </div>
        </div>
        <div class="card">
          <h2>Ø§Ù„Ù…ÙŠØ²Ø§Ù† Ø§Ù„Ù…ØµØºÙ‘Ø±</h2>
          <div id="miniTrial"></div>
          <div class="flex" style="margin-top:1rem;">
            <button class="btn" onclick="refreshMiniTrial()">ØªØ­Ø¯ÙŠØ«</button>
            <button class="btn secondary" onclick="miniTrialPDF()">PDF</button>
          </div>
        </div>
        <div class="card">
          <h2>Ù…ÙˆØ§Ø¹ÙŠØ¯ Ø§Ù„ØºØ¯</h2>
          <div id="appointmentsTomorrow"></div>
          <button class="btn secondary" style="margin-top:1rem;" onclick="appointmentsPDF()">PDF</button>
        </div>
        <div class="card">
          <h2>Ø§Ù„Ù…Ø®Ø²ÙˆÙ†</h2>
          <div id="inventoryAlerts"></div>
          <button class="btn secondary" style="margin-top:1rem;" onclick="inventoryAlertsPDF()">PDF</button>
        </div>
      </div>`;
    }
    Views.dashboard=Views_dashboard;

    function Views_receipts(){
      return `
      <div class="card">
        <h2>Ø³Ù†Ø¯ Ù‚Ø¨Ø¶</h2>
        <div class="grid grid-2">
          <div><label>Ø§Ù„Ù…Ø±ÙŠØ¶/Ø§Ù„Ø·Ø±Ù</label><input id="receiptPatient" /></div>
          <div><label>Ø§Ù„Ø®Ø¯Ù…Ø©</label><input id="receiptService" /></div>
          <div><label>Ø§Ù„Ø·Ø¨ÙŠØ¨</label><input id="receiptDoctor" /></div>
          <div><label>Ø§Ù„Ù…Ø¨Ù„Øº</label><input id="receiptAmount" type="number" min="0" step="0.05" /></div>
          <div><label>Ù…Ù„Ø§Ø­Ø¸Ø§Øª</label><textarea id="receiptNotes"></textarea></div>
          <div><label>Ù…Ø±ÙÙ‚Ø§Øª</label><input type="file" id="receiptAttachment" accept="image/*,.pdf" /></div>
        </div>
        <div class="flex" style="margin-top:1rem;justify-content:flex-end;">
          <button class="btn" onclick="saveReceipt()">Ø­ÙØ¸</button>
          <button class="btn secondary" onclick="downloadReceiptPDF()">PDF</button>
        </div>
      </div>
      <div class="card">
        <div class="flex" style="justify-content:space-between;align-items:center;">
          <h2>Ø³Ù†Ø¯Ø§Øª Ù…Ø³Ø¬Ù„Ø©</h2>
          <input id="receiptSearch" placeholder="Ø¨Ø­Ø« Ø¨Ø§Ù„Ù…Ø±Ø¬Ø¹" oninput="debounced(()=>renderReceiptsTable())" />
        </div>
        <table>
          <thead><tr><th>Ø§Ù„Ù…Ø±Ø¬Ø¹</th><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>Ø§Ù„Ù…Ø±ÙŠØ¶</th><th>Ø§Ù„Ø®Ø¯Ù…Ø©</th><th>Ø§Ù„Ù…Ø¨Ù„Øº</th><th>Ø§Ù„Ø­Ø§Ù„Ø©</th><th>Ø®ÙŠØ§Ø±Ø§Øª</th></tr></thead>
          <tbody id="receiptTable"></tbody>
        </table>
      </div>`;
    }
    Views.receipts=Views_receipts;

    function Views_payments(){
      return `
      <div class="card">
        <h2>Ø³Ù†Ø¯ ØµØ±Ù</h2>
        <div class="grid grid-2">
          <div><label>Ø§Ù„Ù…ÙˆØ±Ø¯/Ø§Ù„Ù…Ø¹Ù…Ù„</label><input id="paymentSupplier" /></div>
          <div><label>Ø§Ù„Ø­Ø§Ù„Ø©</label><select id="paymentStatus"><option value="paid">Ù…Ø¯ÙÙˆØ¹</option><option value="pending">Ù…Ø¹Ù„Ù‘Ù‚</option></select></div>
          <div><label>Ø§Ù„Ù…Ø¨Ù„Øº</label><input id="paymentAmount" type="number" min="0" step="0.05" /></div>
          <div><label>Ù…Ù„Ø§Ø­Ø¸Ø§Øª</label><textarea id="paymentNotes"></textarea></div>
          <div><label>Ù…Ø±ÙÙ‚Ø§Øª</label><input type="file" id="paymentAttachment" accept="image/*,.pdf" /></div>
        </div>
        <div class="flex" style="margin-top:1rem;justify-content:flex-end;">
          <button class="btn" onclick="savePayment()">Ø­ÙØ¸</button>
          <button class="btn secondary" onclick="downloadPaymentPDF()">PDF</button>
        </div>
      </div>
      <div class="card">
        <div class="flex" style="justify-content:space-between;align-items:center;">
          <h2>Ø§Ù„Ø³Ù†Ø¯Ø§Øª</h2>
          <input id="paymentSearch" placeholder="Ø¨Ø­Ø« Ø¨Ø§Ù„Ù…Ø±Ø¬Ø¹" oninput="debounced(()=>renderPaymentsTable())" />
        </div>
        <table>
          <thead><tr><th>Ø§Ù„Ù…Ø±Ø¬Ø¹</th><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>Ø§Ù„Ù…ÙˆØ±Ø¯</th><th>Ø§Ù„Ù…Ø¨Ù„Øº</th><th>Ø§Ù„Ø­Ø§Ù„Ø©</th><th>Ø®ÙŠØ§Ø±Ø§Øª</th></tr></thead>
          <tbody id="paymentTable"></tbody>
        </table>
      </div>`;
    }
    Views.payments=Views_payments;

    function Views_journal(){
      return `
      <div class="card">
        <div class="flex" style="justify-content:space-between;align-items:center;">
          <h2>Ø¯ÙØªØ± Ø§Ù„ÙŠÙˆÙ…ÙŠØ©</h2>
          <div class="flex">
            <input id="journalFilter" placeholder="Ø¨Ø­Ø«" oninput="debounced(()=>renderJournalTable())" />
            <button class="btn secondary" onclick="journalPDF()">PDF</button>
          </div>
        </div>
        <table>
          <thead><tr><th>Ø§Ù„Ù…Ø±Ø¬Ø¹</th><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>Ø§Ù„ÙˆØµÙ</th><th>Ø§Ù„Ù‚ÙŠÙˆØ¯</th></tr></thead>
          <tbody id="journalTable"></tbody>
        </table>
      </div>`;
    }
    Views.journal=Views_journal;

    function Views_patients(){
      return `
      <div class="card">
        <h2>Ù…Ø±ÙŠØ¶ Ø¬Ø¯ÙŠØ¯</h2>
        <div class="grid grid-2">
          <div><label>Ø§Ù„Ø§Ø³Ù…</label><input id="patientName" /></div>
          <div><label>Ø§Ù„Ù‡Ø§ØªÙ</label><input id="patientPhone" /></div>
          <div><label>Ø£Ù…Ø§Ù†Ø§Øª</label><input id="patientDeposit" type="number" min="0" step="0.05" /></div>
          <div><label>Ù…Ù„Ø§Ø­Ø¸Ø§Øª</label><textarea id="patientNotes"></textarea></div>
        </div>
        <div class="flex" style="margin-top:1rem;justify-content:flex-end;">
          <button class="btn" onclick="savePatient()">Ø­ÙØ¸</button>
        </div>
      </div>
      <div class="card">
        <div class="flex" style="justify-content:space-between;align-items:center;">
          <h2>Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø±Ø¶Ù‰</h2>
          <button class="btn secondary" onclick="patientsAgingPDF()">PDF Ø£Ø¹Ù…Ø§Ø± Ø§Ù„Ø°Ù…Ù…</button>
        </div>
        <table>
          <thead><tr><th>Ø§Ù„Ø§Ø³Ù…</th><th>Ø§Ù„Ù‡Ø§ØªÙ</th><th>Ø§Ù„Ø±ØµÙŠØ¯</th><th>Ø§Ù„Ø£Ù…Ø§Ù†Ø§Øª</th><th>Ø®ÙŠØ§Ø±Ø§Øª</th></tr></thead>
          <tbody id="patientTable"></tbody>
        </table>
      </div>`;
    }
    Views.patients=Views_patients;

    function Views_suppliers(){
      return `
      <div class="card">
        <h2>ÙØ§ØªÙˆØ±Ø© Ù…Ø´ØªØ±ÙŠØ§Øª</h2>
        <div class="grid grid-2">
          <div><label>Ø§Ù„Ù…ÙˆØ±Ø¯</label><input id="invoiceSupplier" /></div>
          <div><label>Ø¥Ù„Ù‰ Ø§Ù„Ù…Ø®Ø²ÙˆÙ†ØŸ</label><select id="invoiceToStock"><option value="yes">Ù†Ø¹Ù…</option><option value="no">Ø§Ø³ØªÙ‡Ù„Ø§Ùƒ</option></select></div>
          <div><label>Ø§Ù„Ù‚ÙŠÙ…Ø©</label><input id="invoiceAmount" type="number" min="0" step="0.05" /></div>
          <div><label>Ù…Ù„Ø§Ø­Ø¸Ø§Øª</label><textarea id="invoiceNotes"></textarea></div>
        </div>
        <div class="flex" style="margin-top:1rem;justify-content:flex-end;">
          <button class="btn" onclick="savePurchaseInvoice()">Ø­ÙØ¸</button>
        </div>
      </div>
      <div class="card">
        <h2>Ù…Ø±ØªØ¬Ø¹Ø§Øª Ù…Ø¤Ø¬Ù„Ø©</h2>
        <div class="grid grid-2">
          <div><label>Ø§Ù„Ù…ÙˆØ±Ø¯</label><input id="returnSupplier" /></div>
          <div><label>Ø§Ù„Ù‚ÙŠÙ…Ø©</label><input id="returnAmount" type="number" min="0" step="0.05" /></div>
          <div><label>Ø§Ù„Ø­Ø§Ù„Ø©</label><select id="returnStatus"><option value="pending">Pending</option><option value="settled">Settled</option></select></div>
          <div><label>Ù…Ù„Ø§Ø­Ø¸Ø§Øª</label><textarea id="returnNotes"></textarea></div>
        </div>
        <div class="flex" style="margin-top:1rem;justify-content:flex-end;">
          <button class="btn" onclick="saveSupplierReturn()">Ø­ÙØ¸</button>
        </div>
        <table style="margin-top:1.5rem;">
          <thead><tr><th>Ø§Ù„Ù…Ø±Ø¬Ø¹</th><th>Ø§Ù„Ù…ÙˆØ±Ø¯</th><th>Ø§Ù„Ù‚ÙŠÙ…Ø©</th><th>Ø§Ù„Ø­Ø§Ù„Ø©</th><th>Ø®ÙŠØ§Ø±Ø§Øª</th></tr></thead>
          <tbody id="returnsTable"></tbody>
        </table>
      </div>`;
    }
    Views.suppliers=Views_suppliers;

    function Views_labs(){
      return `
      <div class="card">
        <h2>Ø·Ù„Ø¨ Ù…Ø¹Ù…Ù„</h2>
        <div class="grid grid-2">
          <div><label>Ø§Ù„Ù…Ø±ÙŠØ¶</label><input id="labPatient" /></div>
          <div><label>Ø§Ù„Ø·Ø¨ÙŠØ¨</label><input id="labDoctor" /></div>
          <div><label>Ø§Ù„Ø®Ø¯Ù…Ø©</label><input id="labService" /></div>
          <div><label>Ø¹Ø¯Ø¯ Ø§Ù„Ù‚Ø·Ø¹</label><input id="labUnits" type="number" min="1" value="1" /></div>
          <div><label>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥Ø±Ø³Ø§Ù„</label><input id="labSent" type="date" /></div>
          <div><label>ØªØ§Ø±ÙŠØ® Ù…ØªÙˆÙ‚Ø¹</label><input id="labExpected" type="date" /></div>
          <div><label>Ø§Ù„ØªÙƒÙ„ÙØ©</label><input id="labCost" type="number" min="0" step="0.05" /></div>
          <div><label>Ø§Ù„Ø­Ø§Ù„Ø©</label><select id="labStatus">
            <option value="requested">Ù…Ø·Ù„ÙˆØ¨</option>
            <option value="in-progress">Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°</option>
            <option value="delayed">Ù…ØªØ£Ø®Ø±</option>
            <option value="done">ØªÙ…</option>
            <option value="cancelled">Ù…Ù„ØºÙŠ</option>
            <option value="transferred">Ù…Ø­ÙˆÙ‘Ù„</option>
          </select></div>
          <div class="full"><label>Ù…Ù„Ø§Ø­Ø¸Ø§Øª</label><textarea id="labNotes"></textarea></div>
        </div>
        <div class="flex" style="margin-top:1rem;justify-content:flex-end;">
          <button class="btn" onclick="saveLabOrder()">Ø­ÙØ¸</button>
          <button class="btn secondary" onclick="labSummaryPDF()">PDF</button>
        </div>
      </div>
      <div class="card">
        <div class="flex" style="justify-content:space-between;align-items:center;">
          <h2>Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…Ø¹Ù…Ù„</h2>
          <div id="labStats" class="badge">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>
        </div>
        <table>
          <thead><tr><th>Ø§Ù„Ù…Ø±Ø¬Ø¹</th><th>Ø§Ù„Ù…Ø±ÙŠØ¶</th><th>Ø§Ù„Ø®Ø¯Ù…Ø©</th><th>Ø§Ù„Ø­Ø§Ù„Ø©</th><th>Ø§Ù„ØªÙƒÙ„ÙØ©</th><th>Ø®ÙŠØ§Ø±Ø§Øª</th></tr></thead>
          <tbody id="labsTable"></tbody>
        </table>
      </div>`;
    }
    Views.labs=Views_labs;

    function Views_inventory(){
      return `
      <div class="card">
        <h2>Ø¨Ø·Ø§Ù‚Ø© Ù…Ø§Ø¯Ø©</h2>
        <div class="grid grid-2">
          <div><label>Ø§Ù„Ø§Ø³Ù…</label><input id="itemName" /></div>
          <div><label>Ø§Ù„ÙƒÙ…ÙŠØ©</label><input id="itemQty" type="number" min="0" /></div>
          <div><label>Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¯Ù†Ù‰</label><input id="itemMin" type="number" min="0" /></div>
          <div><label>ØªØ§Ø±ÙŠØ® Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ©</label><input id="itemExpiry" type="date" /></div>
        </div>
        <div class="flex" style="margin-top:1rem;justify-content:flex-end;">
          <button class="btn" onclick="saveInventoryItem()">Ø­ÙØ¸</button>
        </div>
      </div>
      <div class="card">
        <div class="flex" style="justify-content:space-between;align-items:center;">
          <h2>Ø§Ù„Ù…ÙˆØ§Ø¯</h2>
          <button class="btn secondary" onclick="inventoryPDF()">PDF</button>
        </div>
        <table>
          <thead><tr><th>Ø§Ù„Ø§Ø³Ù…</th><th>Ø§Ù„ÙƒÙ…ÙŠØ©</th><th>Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¯Ù†Ù‰</th><th>Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ©</th><th>ØªÙ†Ø¨ÙŠÙ‡</th><th>Ø®ÙŠØ§Ø±Ø§Øª</th></tr></thead>
          <tbody id="inventoryTable"></tbody>
        </table>
      </div>`;
    }
    Views.inventory=Views_inventory;

    function Views_doctors(){
      return `
      <div class="card">
        <h2>Ø·Ø¨ÙŠØ¨</h2>
        <div class="grid grid-2">
          <div><label>Ø§Ù„Ø§Ø³Ù…</label><input id="doctorName" /></div>
          <div><label>Ø§Ù„Ù†Ø³Ø¨Ø© (%)</label><input id="doctorShare" type="number" min="30" max="50" /></div>
        </div>
        <div class="flex" style="margin-top:1rem;justify-content:flex-end;">
          <button class="btn" onclick="saveDoctor()">Ø­ÙØ¸</button>
        </div>
      </div>
      <div class="card">
        <div class="flex" style="justify-content:space-between;align-items:center;">
          <h2>Ø±Ø¨Ø­ÙŠØ© Ø§Ù„Ø£Ø·Ø¨Ø§Ø¡</h2>
          <button class="btn secondary" onclick="doctorProfitPDF()">PDF</button>
        </div>
        <table>
          <thead><tr><th>Ø§Ù„Ø·Ø¨ÙŠØ¨</th><th>Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª</th><th>ØªÙƒÙ„ÙØ© Ø§Ù„Ù…Ø¹Ù…Ù„</th><th>Ø§Ù„Ù†Ø³Ø¨Ø©</th><th>Ù†ØµÙŠØ¨ Ø§Ù„Ø·Ø¨ÙŠØ¨</th><th>Ù…Ø³Ø§Ù‡Ù…Ø© Ø§Ù„Ø¹ÙŠØ§Ø¯Ø©</th></tr></thead>
          <tbody id="doctorTable"></tbody>
        </table>
      </div>`;
    }
    Views.doctors=Views_doctors;

    function Views_reports(){
      return `
      <div class="card">
        <h2>Ù…Ø±ÙƒØ² Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±</h2>
        <div class="grid grid-2">
          <button class="btn" onclick="dailyReportPDF()">ØªÙ‚Ø±ÙŠØ± ÙŠÙˆÙ…ÙŠ</button>
          <button class="btn" onclick="weeklyReportPDF()">ØªÙ‚Ø±ÙŠØ± Ø£Ø³Ø¨ÙˆØ¹ÙŠ</button>
          <button class="btn" onclick="monthlyReportPDF()">ØªÙ‚Ø±ÙŠØ± Ø´Ù‡Ø±ÙŠ</button>
          <button class="btn" onclick="labSummaryPDF()">ÙƒØ´Ù Ø§Ù„Ù…Ø¹Ø§Ù…Ù„</button>
          <button class="btn" onclick="supplierAgingPDF()">ÙƒØ´Ù Ø§Ù„Ù…ÙˆØ±Ø¯ÙŠÙ†</button>
          <button class="btn" onclick="patientsAgingPDF()">Ø£Ø¹Ù…Ø§Ø± Ø§Ù„Ø°Ù…Ù…</button>
          <button class="btn" onclick="inventoryPDF()">Ø§Ù„Ù…Ø®Ø²ÙˆÙ†</button>
          <button class="btn" onclick="clinicProfitPDF()">Ø±Ø¨Ø­ÙŠØ© Ø§Ù„Ø¹ÙŠØ§Ø¯Ø©</button>
          <button class="btn" onclick="doctorProfitPDF()">Ø±Ø¨Ø­ÙŠØ© Ø§Ù„Ø£Ø·Ø¨Ø§Ø¡</button>
          <button class="btn" onclick="journalPDF()">Ø¯ÙØªØ± Ø§Ù„ÙŠÙˆÙ…ÙŠØ©</button>
          <button class="btn" onclick="auditLogPDF()">Ø³Ø¬Ù„ Ø§Ù„ØªØ¯Ù‚ÙŠÙ‚</button>
          <button class="btn" onclick="exportDataJSON()">ØªØµØ¯ÙŠØ± JSON</button>
          <button class="btn" onclick="importDataJSON()">Ø§Ø³ØªÙŠØ±Ø§Ø¯ JSON</button>
        </div>
      </div>
      <div class="card">
        <h2>Ø¨Ø­Ø« Ù…Ø±Ø¬Ø¹ÙŠ</h2>
        <input id="referenceSearch" placeholder="Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… Ø§Ù„Ù…Ø±Ø¬Ø¹" />
        <button class="btn" style="margin-top:1rem;" onclick="searchReference()">Ø¨Ø­Ø«</button>
        <div id="referenceResult" style="margin-top:1rem;"></div>
      </div>`;
    }
    Views.reports=Views_reports;

    function Views_settings(){
      return `
      <div class="card">
        <h2>Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø¹Ø§Ù…Ø©</h2>
        <div class="grid grid-2">
          <div><label>Ø§Ø³Ù… Ø§Ù„Ø¹ÙŠØ§Ø¯Ø©</label><input id="clinicName" value="${App.settings.clinicName}" /></div>
          <div><label>Ø§Ù„Ø´Ø¹Ø§Ø± (Base64)</label><textarea id="clinicLogo">${App.settings.clinicLogo}</textarea></div>
          <div><label>Ø§Ù„Ø¹Ù…Ù„Ø©</label><input id="clinicCurrency" value="${App.settings.currency}" /></div>
          <div><label>ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª</label><select id="overheadAllocation"><option value="revenue" ${App.settings.overheadAllocation==='revenue'?'selected':''}>Ø­Ø³Ø¨ Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª</option><option value="equal" ${App.settings.overheadAllocation==='equal'?'selected':''}>Ø¨Ø§Ù„ØªØ³Ø§ÙˆÙŠ</option></select></div>
        </div>
        <div class="flex" style="margin-top:1rem;justify-content:flex-end;">
          <button class="btn" onclick="saveSettings()">Ø­ÙØ¸</button>
        </div>
      </div>
      <div class="card">
        <h2>ÙƒÙ„Ù…Ø§Øª Ø§Ù„Ù…Ø±ÙˆØ±</h2>
        <div class="grid grid-2">
          <div><label>Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</label><input id="pwdSettings" type="password" value="${App.passwords.settings}" /></div>
          <div><label>Ø§Ù„Ø¥Ù‚ÙØ§Ù„</label><input id="pwdClose" type="password" value="${App.passwords.close}" /></div>
          <div><label>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø§Ù„Ø­Ø³Ø§Ø³Ø©</label><input id="pwdDanger" type="password" value="${App.passwords.danger}" /></div>
        </div>
        <div class="flex" style="margin-top:1rem;justify-content:flex-end;">
          <button class="btn" onclick="savePasswords()">ØªØ­Ø¯ÙŠØ«</button>
        </div>
      </div>
      <div class="card">
        <h2>Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ù†Ø¸Ø§Ù…</h2>
        <button class="btn" onclick="runHealthCheck()">ØªØ´ØºÙŠÙ„</button>
        <div id="healthReport" style="margin-top:1rem;"></div>
      </div>
      <div class="card">
        <h2>Ø¯Ù„ÙŠÙ„ Ù…Ø®ØªØµØ±</h2>
        <p>
          â€¢ Ø§Ø³ØªØ®Ø¯Ù… ÙƒÙ„Ù…Ø§Øª Ø§Ù„Ù…Ø±ÙˆØ± Ù„Ø­Ù…Ø§ÙŠØ© Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ÙˆØ§Ù„Ø¥Ù‚ÙØ§Ù„ ÙˆØ§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø§Ù„Ø­Ø³Ø§Ø³Ø©.<br>
          â€¢ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø³Ù†Ø¯Ø§Øª ØªÙˆÙ„Ø¯ Ù‚ÙŠÙˆØ¯Ù‹Ø§ Ù…Ø²Ø¯ÙˆØ¬Ø© ÙˆØªØ¸Ù‡Ø± ÙÙŠ Ø¯ÙØªØ± Ø§Ù„ÙŠÙˆÙ…ÙŠØ©.<br>
          â€¢ Ø²Ø± Ø§Ù„ØªØµØ¯ÙŠØ± ÙŠÙˆÙØ± Ù†Ø³Ø®Ø© JSON Ù„Ù„Ø­ÙØ¸ Ø§Ù„Ø®Ø§Ø±Ø¬ÙŠØŒ ÙˆØ²Ø± Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯ ÙŠØ¹ÙŠØ¯Ù‡Ø§.<br>
          â€¢ Ø§Ù„Ø¥Ù‚ÙØ§Ù„ ÙŠØªØ·Ù„Ø¨ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø®Ø§ØµØ© ÙˆÙŠÙ…Ù†Ø¹ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø­ØªÙ‰ Ø¥Ø¹Ø§Ø¯Ø© ÙØªØ­Ù‡ Ø¨ÙˆØ¶Ø¹ Ø­Ø³Ø§Ø³.<br>
        </p>
      </div>`;
    }
    Views.settings=Views_settings;

    let debounceTimer;
    function debounced(fn){
      clearTimeout(debounceTimer);
      debounceTimer=setTimeout(fn,250);
    }

    async function fileToBase64(file){
      return new Promise((resolve,reject)=>{
        const reader=new FileReader();
        reader.onload=()=>resolve(reader.result);
        reader.onerror=reject;
        reader.readAsDataURL(file);
      });
    }

    async function saveReceipt(){
      const patient=document.getElementById('receiptPatient').value.trim();
      const service=document.getElementById('receiptService').value.trim();
      const doctor=document.getElementById('receiptDoctor').value.trim();
      const amount=parseFloat(document.getElementById('receiptAmount').value);
      const notes=document.getElementById('receiptNotes').value.trim();
      if(!patient||!service||isNaN(amount)||amount<=0){showToast('Ø¨ÙŠØ§Ù†Ø§Øª ØºÙŠØ± ØµØ§Ù„Ø­Ø©','error');return;}
      let attachment=null;
      const file=document.getElementById('receiptAttachment').files[0];
      if(file){
        if(file.size>2*1024*1024){showToast('Ø­Ø¬Ù… Ø§Ù„Ù…Ø±ÙÙ‚ ÙƒØ¨ÙŠØ±','error');return;}
        attachment=await fileToBase64(file);
      }
      const receipts=await Storage.load('receipts');
      const reference=generateReference('RC');
      const record={reference,patient,service,doctor,amount,notes,attachment,status:'active',createdAt:new Date().toISOString()};
      receipts.push(record);
      await Storage.save('receipts',receipts);
      await recordJournal([
        {account:'ØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„Ù†Ù‚Ø¯ÙŠØ©',debit:amount},
        {account:`Ø¥ÙŠØ±Ø§Ø¯Ø§Øª - ${service}`,credit:amount}
      ],{type:'receipt',reference,patient,doctor});
      await logAudit('add',reference,'Ø³Ù†Ø¯ Ù‚Ø¨Ø¶',record);
      showToast('ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø³Ù†Ø¯');
      renderReceiptsTable();
      renderDoctorsTable();
      refreshMiniTrial();
    }

    async function renderReceiptsTable(){
      const list=await Storage.load('receipts');
      const search=(document.getElementById('receiptSearch')||{value:''}).value.trim();
      const body=document.getElementById('receiptTable');
      if(!body) return;
      body.innerHTML=list.filter(r=>!search||r.reference.includes(search)).slice(-200).reverse().map(r=>`
        <tr>
          <td>${r.reference}</td>
          <td>${formatDate(r.createdAt)}</td>
          <td>${r.patient}</td>
          <td>${r.service}</td>
          <td>${formatCurrency(r.amount)}</td>
          <td>${r.status==='active'?'<span class="badge">Ø³Ø§Ø±ÙŠ</span>':'<span class="badge danger">Ù…Ù„ØºÙŠ</span>'}</td>
          <td>
            <button class="btn secondary" onclick="receiptPDF('${r.reference}')">PDF</button>
            <button class="btn danger" onclick="cancelReceipt('${r.reference}')">Ø¥Ù„ØºØ§Ø¡</button>
          </td>
        </tr>`).join('');
    }

    async function cancelReceipt(reference){
      guardSensitive(async()=>{
        const list=await Storage.load('receipts');
        const item=list.find(r=>r.reference===reference);
        if(!item||item.status==='cancelled') return;
        item.status='cancelled';
        await Storage.save('receipts',list);
        await recordJournal([
          {account:`Ø¥ÙŠØ±Ø§Ø¯Ø§Øª - ${item.service}`,debit:item.amount},
          {account:'ØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„Ù†Ù‚Ø¯ÙŠØ©',credit:item.amount}
        ],{type:'reverse',reference});
        await logAudit('cancel',reference,'Ø¥Ù„ØºØ§Ø¡ Ø³Ù†Ø¯ Ù‚Ø¨Ø¶');
        showToast('ØªÙ… Ø§Ù„Ø¥Ù„ØºØ§Ø¡');
        renderReceiptsTable();
        refreshMiniTrial();
      });
    }

    async function savePayment(){
      const supplier=document.getElementById('paymentSupplier').value.trim();
      const status=document.getElementById('paymentStatus').value;
      const amount=parseFloat(document.getElementById('paymentAmount').value);
      const notes=document.getElementById('paymentNotes').value.trim();
      if(!supplier||isNaN(amount)||amount<=0){showToast('Ø¨ÙŠØ§Ù†Ø§Øª ØºÙŠØ± ØµØ§Ù„Ø­Ø©','error');return;}
      let attachment=null;
      const file=document.getElementById('paymentAttachment').files[0];
      if(file){
        if(file.size>2*1024*1024){showToast('Ø­Ø¬Ù… Ø§Ù„Ù…Ø±ÙÙ‚ ÙƒØ¨ÙŠØ±','error');return;}
        attachment=await fileToBase64(file);
      }
      const payments=await Storage.load('payments');
      const reference=generateReference('PM');
      const record={reference,supplier,status,amount,notes,attachment,state:'active',createdAt:new Date().toISOString()};
      payments.push(record);
      await Storage.save('payments',payments);
      await recordJournal([
        {account:`Ù…ØµØ±ÙˆÙØ§Øª - ${supplier}`,debit:amount},
        {account:'ØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„Ù†Ù‚Ø¯ÙŠØ©',credit:amount}
      ],{type:'payment',reference,supplier});
      await logAudit('add',reference,'Ø³Ù†Ø¯ ØµØ±Ù',record);
      showToast('ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø³Ù†Ø¯');
      renderPaymentsTable();
      refreshMiniTrial();
    }

    async function renderPaymentsTable(){
      const list=await Storage.load('payments');
      const search=(document.getElementById('paymentSearch')||{value:''}).value.trim();
      const body=document.getElementById('paymentTable');
      if(!body) return;
      body.innerHTML=list.filter(r=>!search||r.reference.includes(search)).slice(-200).reverse().map(r=>`
        <tr>
          <td>${r.reference}</td>
          <td>${formatDate(r.createdAt)}</td>
          <td>${r.supplier}</td>
          <td>${formatCurrency(r.amount)}</td>
          <td>${r.status==='paid'?'Ù…Ø¯ÙÙˆØ¹':'Ù…Ø¹Ù„Ù‘Ù‚'}</td>
          <td>
            <button class="btn secondary" onclick="paymentPDF('${r.reference}')">PDF</button>
            <button class="btn danger" onclick="cancelPayment('${r.reference}')">Ø¥Ù„ØºØ§Ø¡</button>
          </td>
        </tr>`).join('');
    }

    async function cancelPayment(reference){
      guardSensitive(async()=>{
        const list=await Storage.load('payments');
        const item=list.find(r=>r.reference===reference);
        if(!item||item.state==='cancelled') return;
        item.state='cancelled';
        await Storage.save('payments',list);
        await recordJournal([
          {account:'ØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„Ù†Ù‚Ø¯ÙŠØ©',debit:item.amount},
          {account:`Ù…ØµØ±ÙˆÙØ§Øª - ${item.supplier}`,credit:item.amount}
        ],{type:'reverse',reference});
        await logAudit('cancel',reference,'Ø¥Ù„ØºØ§Ø¡ Ø³Ù†Ø¯ ØµØ±Ù');
        showToast('ØªÙ… Ø§Ù„Ø¥Ù„ØºØ§Ø¡');
        renderPaymentsTable();
        refreshMiniTrial();
      });
    }

    async function renderJournalTable(){
      const list=await Storage.load('journals');
      const filter=(document.getElementById('journalFilter')||{value:''}).value.trim();
      const body=document.getElementById('journalTable');
      if(!body) return;
      body.innerHTML=list.filter(j=>!filter||j.id.includes(filter)||j.entries.some(e=>e.account.includes(filter))).slice(-200).reverse().map(j=>`
        <tr>
          <td>${j.id}</td>
          <td>${formatDate(j.createdAt)}</td>
          <td>${j.meta?.type||''}</td>
          <td>${j.entries.map(e=>`<div class="flex" style="justify-content:space-between;"><span>${e.account}</span><span>${e.debit?formatCurrency(e.debit):''}</span><span>${e.credit?formatCurrency(e.credit):''}</span></div>`).join('')}</td>
        </tr>`).join('');
    }

    async function savePatient(){
      const name=document.getElementById('patientName').value.trim();
      const phone=document.getElementById('patientPhone').value.trim();
      const deposit=parseFloat(document.getElementById('patientDeposit').value||'0');
      const notes=document.getElementById('patientNotes').value.trim();
      if(!name){showToast('Ø§Ø³Ù… Ø§Ù„Ù…Ø±ÙŠØ¶ Ù…Ø·Ù„ÙˆØ¨','error');return;}
      const patients=await Storage.load('patients');
      const existing=patients.find(p=>p.name===name);
      if(existing){
        existing.phone=phone;
        existing.deposit=deposit;
        existing.notes=notes;
      }else{
        patients.push({name,phone,balance:0,deposit,notes,createdAt:new Date().toISOString()});
      }
      await Storage.save('patients',patients);
      await logAudit('add',name,'ØªØ­Ø¯ÙŠØ« Ù…Ø±ÙŠØ¶');
      showToast('ØªÙ… Ø§Ù„Ø­ÙØ¸');
      renderPatientsTable();
    }

    async function renderPatientsTable(){
      const patients=await Storage.load('patients');
      const body=document.getElementById('patientTable');
      if(!body) return;
      body.innerHTML=patients.map(p=>`
        <tr>
          <td>${p.name}</td>
          <td>${p.phone}</td>
          <td>${formatCurrency(p.balance||0)}</td>
          <td>${formatCurrency(p.deposit||0)}</td>
          <td><button class="btn danger" onclick="deletePatient('${p.name}')">Ø­Ø°Ù</button></td>
        </tr>`).join('');
    }

    async function deletePatient(name){
      guardSensitive(async()=>{
        let patients=await Storage.load('patients');
        patients=patients.filter(p=>p.name!==name);
        await Storage.save('patients',patients);
        await logAudit('delete',name,'Ø­Ø°Ù Ù…Ø±ÙŠØ¶');
        renderPatientsTable();
      });
    }

    async function savePurchaseInvoice(){
      const supplier=document.getElementById('invoiceSupplier').value.trim();
      const toStock=document.getElementById('invoiceToStock').value;
      const amount=parseFloat(document.getElementById('invoiceAmount').value);
      const notes=document.getElementById('invoiceNotes').value.trim();
      if(!supplier||isNaN(amount)||amount<=0){showToast('Ø¨ÙŠØ§Ù†Ø§Øª ØºÙŠØ± ØµØ§Ù„Ø­Ø©','error');return;}
      const invoices=await Storage.load('purchaseInvoices');
      const reference=generateReference('PM');
      const invoice={reference,supplier,toStock,amount,notes,createdAt:new Date().toISOString()};
      invoices.push(invoice);
      await Storage.save('purchaseInvoices',invoices);
      if(toStock==='yes'){
        await recordJournal([
          {account:'Ø§Ù„Ù…Ø®Ø²ÙˆÙ†',debit:amount},
          {account:'ØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„Ù†Ù‚Ø¯ÙŠØ©',credit:amount}
        ],{type:'purchase-stock',reference,supplier});
      }else{
        await recordJournal([
          {account:`Ù…ØµØ±ÙˆÙØ§Øª - ${supplier}`,debit:amount},
          {account:'ØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„Ù†Ù‚Ø¯ÙŠØ©',credit:amount}
        ],{type:'purchase-expense',reference,supplier});
      }
      await logAudit('add',reference,'ÙØ§ØªÙˆØ±Ø© Ù…Ø´ØªØ±ÙŠØ§Øª',invoice);
      showToast('ØªÙ… Ø­ÙØ¸ Ø§Ù„ÙØ§ØªÙˆØ±Ø©');
      renderSupplierReturns();
      renderInventoryTable();
      refreshMiniTrial();
    }

    async function saveSupplierReturn(){
      const supplier=document.getElementById('returnSupplier').value.trim();
      const amount=parseFloat(document.getElementById('returnAmount').value);
      const status=document.getElementById('returnStatus').value;
      const notes=document.getElementById('returnNotes').value.trim();
      if(!supplier||isNaN(amount)||amount<=0){showToast('Ø¨ÙŠØ§Ù†Ø§Øª ØºÙŠØ± ØµØ§Ù„Ø­Ø©','error');return;}
      const returns=await Storage.load('supplierReturns');
      const reference=generateReference('PM');
      const record={reference,supplier,amount,status,notes,createdAt:new Date().toISOString()};
      returns.push(record);
      await Storage.save('supplierReturns',returns);
      if(status==='pending'){
        await recordJournal([
          {account:'Supplier Credit Pending',debit:amount},
          {account:'ØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„Ù†Ù‚Ø¯ÙŠØ©',credit:amount}
        ],{type:'supplier-return',reference,supplier});
      }else{
        await recordJournal([
          {account:'Ø°Ù…Ù… Ø§Ù„Ù…ÙˆØ±Ø¯ÙŠÙ†',debit:amount},
          {account:'Supplier Credit Pending',credit:amount}
        ],{type:'supplier-settlement',reference,supplier});
      }
      await logAudit('add',reference,'Ù…Ø±ØªØ¬Ø¹ Ù…ÙˆØ±Ø¯',record);
      showToast('ØªÙ… Ø§Ù„Ø­ÙØ¸');
      renderSupplierReturns();
      refreshMiniTrial();
    }

    async function renderSupplierReturns(){
      const returns=await Storage.load('supplierReturns');
      const body=document.getElementById('returnsTable');
      if(!body) return;
      body.innerHTML=returns.slice(-200).reverse().map(r=>`
        <tr>
          <td>${r.reference}</td>
          <td>${r.supplier}</td>
          <td>${formatCurrency(r.amount)}</td>
          <td>${r.status}</td>
          <td><button class="btn danger" onclick="deleteSupplierReturn('${r.reference}')">Ø­Ø°Ù</button></td>
        </tr>`).join('');
    }

    async function deleteSupplierReturn(reference){
      guardSensitive(async()=>{
        let returns=await Storage.load('supplierReturns');
        returns=returns.filter(r=>r.reference!==reference);
        await Storage.save('supplierReturns',returns);
        await logAudit('delete',reference,'Ø­Ø°Ù Ù…Ø±ØªØ¬Ø¹');
        renderSupplierReturns();
      });
    }

    async function saveLabOrder(){
      const patient=document.getElementById('labPatient').value.trim();
      const doctor=document.getElementById('labDoctor').value.trim();
      const service=document.getElementById('labService').value.trim();
      const units=parseInt(document.getElementById('labUnits').value||'1');
      const sent=document.getElementById('labSent').value;
      const expected=document.getElementById('labExpected').value;
      const cost=parseFloat(document.getElementById('labCost').value||'0');
      const status=document.getElementById('labStatus').value;
      const notes=document.getElementById('labNotes').value.trim();
      if(!patient||!service){showToast('Ø¨ÙŠØ§Ù†Ø§Øª ØºÙŠØ± ØµØ§Ù„Ø­Ø©','error');return;}
      const labs=await Storage.load('labs');
      const reference=generateReference('LB');
      const record={reference,patient,doctor,service,units,sent,expected,cost,status,notes,createdAt:new Date().toISOString()};
      labs.push(record);
      await Storage.save('labs',labs);
      await logAudit('add',reference,'Ø·Ù„Ø¨ Ù…Ø¹Ù…Ù„',record);
      showToast('ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø·Ù„Ø¨');
      renderLabsTable();
      renderDoctorsTable();
    }

    async function renderLabsTable(){
      const labs=await Storage.load('labs');
      const body=document.getElementById('labsTable');
      const stats=document.getElementById('labStats');
      const summary=labs.reduce((acc,cur)=>{acc[cur.status]=(acc[cur.status]||0)+1;return acc;},{})
      if(stats){
        stats.textContent=`Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ°: ${summary['in-progress']||0} | Ù…ØªØ£Ø®Ø±: ${summary['delayed']||0} | ØªÙ…: ${summary['done']||0}`;
      }
      if(!body) return;
      body.innerHTML=labs.slice(-200).reverse().map(l=>`
        <tr>
          <td>${l.reference}</td>
          <td>${l.patient}</td>
          <td>${l.service}</td>
          <td>${l.status}</td>
          <td>${formatCurrency(l.cost||0)}</td>
          <td><button class="btn secondary" onclick="labOrderPDF('${l.reference}')">PDF</button></td>
        </tr>`).join('');
    }

    function inventoryAlert(item){
      const low=item.qty<=item.min;
      let expiryAlert=false;
      if(item.expiry){
        const diff=(new Date(item.expiry)-new Date())/(1000*60*60*24*30);
        expiryAlert=diff<=6;
      }
      if(low&&expiryAlert) return 'ÙƒÙ…ÙŠØ© Ù…Ù†Ø®ÙØ¶Ø© ÙˆØµÙ„Ø§Ø­ÙŠØ© Ù‚Ø±ÙŠØ¨Ø©';
      if(low) return 'ÙƒÙ…ÙŠØ© Ù…Ù†Ø®ÙØ¶Ø©';
      if(expiryAlert) return 'Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ© Ù‚Ø±ÙŠØ¨Ø©';
      return '';
    }

    async function saveInventoryItem(){
      const name=document.getElementById('itemName').value.trim();
      const qty=parseFloat(document.getElementById('itemQty').value||'0');
      const min=parseFloat(document.getElementById('itemMin').value||'0');
      const expiry=document.getElementById('itemExpiry').value;
      if(!name){showToast('Ø§Ø³Ù… Ø§Ù„Ù…Ø§Ø¯Ø© Ù…Ø·Ù„ÙˆØ¨','error');return;}
      const inventory=await Storage.load('inventory');
      const existing=inventory.find(i=>i.name===name);
      if(existing){
        existing.qty=qty;existing.min=min;existing.expiry=expiry;
      }else{
        inventory.push({name,qty,min,expiry,createdAt:new Date().toISOString()});
      }
      await Storage.save('inventory',inventory);
      await logAudit('add',name,'ØªØ­Ø¯ÙŠØ« Ù…Ø§Ø¯Ø©');
      showToast('ØªÙ… Ø§Ù„Ø­ÙØ¸');
      renderInventoryTable();
    }

    async function renderInventoryTable(){
      const inventory=await Storage.load('inventory');
      const body=document.getElementById('inventoryTable');
      if(!body) return;
      body.innerHTML=inventory.map(item=>{
        const alert=inventoryAlert(item);
        return `<tr>
          <td>${item.name}</td>
          <td>${item.qty}</td>
          <td>${item.min}</td>
          <td>${item.expiry?formatDate(item.expiry):'-'}</td>
          <td>${alert?`<span class="badge danger">${alert}</span>`:'<span class="badge">Ø¬ÙŠØ¯</span>'}</td>
          <td><button class="btn danger" onclick="deleteInventoryItem('${item.name}')">Ø­Ø°Ù</button></td>
        </tr>`;
      }).join('');
      renderInventoryAlerts();
    }

    async function deleteInventoryItem(name){
      guardSensitive(async()=>{
        let inventory=await Storage.load('inventory');
        inventory=inventory.filter(i=>i.name!==name);
        await Storage.save('inventory',inventory);
        await logAudit('delete',name,'Ø­Ø°Ù Ù…Ø§Ø¯Ø©');
        renderInventoryTable();
      });
    }

    async function renderInventoryAlerts(){
      const inventory=await Storage.load('inventory');
      const container=document.getElementById('inventoryAlerts');
      if(!container) return;
      const alerts=inventory.filter(i=>inventoryAlert(i));
      if(!alerts.length){container.innerHTML='<span class="badge">Ù„Ø§ ØªÙ†Ø¨ÙŠÙ‡Ø§Øª</span>';return;}
      container.innerHTML=alerts.map(i=>`<div class="badge danger">${i.name}: ${inventoryAlert(i)}</div>`).join('');
    }

    async function saveDoctor(){
      const name=document.getElementById('doctorName').value.trim();
      const share=parseFloat(document.getElementById('doctorShare').value);
      if(!name||isNaN(share)||share<30||share>50){showToast('Ø§Ù„Ù†Ø³Ø¨Ø© Ø¨ÙŠÙ† 30-50','error');return;}
      const doctors=await Storage.load('doctors');
      const existing=doctors.find(d=>d.name===name);
      if(existing){existing.share=share;}else{doctors.push({name,share,createdAt:new Date().toISOString()});}
      await Storage.save('doctors',doctors);
      await logAudit('add',name,'ØªØ­Ø¯ÙŠØ« Ø·Ø¨ÙŠØ¨');
      showToast('ØªÙ… Ø§Ù„Ø­ÙØ¸');
      renderDoctorsTable();
    }

    async function calculateOverheads(){
      const doctors=await Storage.load('doctors');
      const receipts=await Storage.load('receipts');
      const totalOverhead=await estimateTotalOverheads();
      const revenueByDoctor={};
      doctors.forEach(doc=>{
        revenueByDoctor[doc.name]=receipts.filter(r=>r.doctor===doc.name&&r.status==='active').reduce((s,r)=>s+r.amount,0);
      });
      const totalRevenue=Object.values(revenueByDoctor).reduce((s,v)=>s+v,0);
      const allocation={};
      doctors.forEach(doc=>{
        if(App.settings.overheadAllocation==='equal'){
          allocation[doc.name]=doctors.length?totalOverhead/doctors.length:0;
        }else{
          allocation[doc.name]=totalRevenue?totalOverhead*(revenueByDoctor[doc.name]||0)/totalRevenue:0;
        }
      });
      return allocation;
    }

    async function estimateTotalOverheads(){
      const payments=await Storage.load('payments');
      return payments.reduce((s,p)=>s+(p.amount||0),0)*0.2;
    }

    async function renderDoctorsTable(){
      const doctors=await Storage.load('doctors');
      const receipts=await Storage.load('receipts');
      const labs=await Storage.load('labs');
      const overheads=await calculateOverheads();
      const body=document.getElementById('doctorTable');
      if(!body) return;
      body.innerHTML=doctors.map(doc=>{
        const revenue=receipts.filter(r=>r.doctor===doc.name&&r.status==='active').reduce((s,r)=>s+r.amount,0);
        const labCost=labs.filter(l=>l.doctor===doc.name).reduce((s,l)=>s+(l.cost||0),0);
        const net=revenue-labCost;
        const doctorShare=net*(doc.share/100);
        const clinicShare=net-doctorShare;
        const overheadShare=overheads[doc.name]||0;
        const contribution=clinicShare-overheadShare;
        const badgeClass=contribution>=0?'badge':'badge danger';
        return `<tr>
          <td>${doc.name}</td>
          <td>${formatCurrency(revenue)}</td>
          <td>${formatCurrency(labCost)}</td>
          <td>${doc.share}%</td>
          <td>${formatCurrency(doctorShare)}</td>
          <td><span class="${badgeClass}">${formatCurrency(contribution)}</span></td>
        </tr>`;
      }).join('');
    }

    async function saveSettings(){
      App.settings.clinicName=document.getElementById('clinicName').value.trim();
      App.settings.clinicLogo=document.getElementById('clinicLogo').value.trim();
      App.settings.currency=document.getElementById('clinicCurrency').value.trim()||'SAR';
      App.settings.overheadAllocation=document.getElementById('overheadAllocation').value;
      await Storage.save('settings',{...App.settings,passwords:App.passwords});
      showToast('ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª');
      renderDoctorsTable();
      refreshMiniTrial();
    }

    async function savePasswords(){
      App.passwords.settings=document.getElementById('pwdSettings').value;
      App.passwords.close=document.getElementById('pwdClose').value;
      App.passwords.danger=document.getElementById('pwdDanger').value;
      await Storage.save('settings',{...App.settings,passwords:App.passwords});
      showToast('ØªÙ… ØªØ­Ø¯ÙŠØ« ÙƒÙ„Ù…Ø§Øª Ø§Ù„Ù…Ø±ÙˆØ±');
    }

    async function exportDataJSON(){
      const data={
        settings:App.settings,
        passwords:App.passwords,
        referenceCounters:App.counters,
        receipts:await Storage.load('receipts'),
        payments:await Storage.load('payments'),
        journals:await Storage.load('journals'),
        patients:await Storage.load('patients'),
        purchaseInvoices:await Storage.load('purchaseInvoices'),
        supplierReturns:await Storage.load('supplierReturns'),
        labs:await Storage.load('labs'),
        inventory:await Storage.load('inventory'),
        doctors:await Storage.load('doctors'),
        audit:await Storage.load('audit'),
        appointments:await Storage.load('appointments')
      };
      const blob=new Blob([JSON.stringify(data,null,2)],{type:'application/json'});
      const url=URL.createObjectURL(blob);
      const a=document.createElement('a');
      a.href=url;
      a.download=`MyClinicDB-backup-${new Date().toISOString()}.json`;
      a.click();
      URL.revokeObjectURL(url);
      showToast('ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù„Ù Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©');
    }

    function importDataJSON(){
      const input=document.createElement('input');
      input.type='file';
      input.accept='application/json';
      input.onchange=async()=>{
        const file=input.files[0];
        if(!file) return;
        try{
          const text=await file.text();
          const data=JSON.parse(text);
          await Storage.save('settings',{...App.settings,...data.settings,passwords:data.passwords||App.passwords});
          App.settings={...App.settings,...data.settings};
          App.passwords={...App.passwords,...(data.passwords||{})};
          App.counters=data.referenceCounters||{};
          await Storage.save('referenceCounters',App.counters);
          const keys=['receipts','payments','journals','patients','purchaseInvoices','supplierReturns','labs','inventory','doctors','audit','appointments'];
          for(const key of keys){
            await Storage.save(key,data[key]||[]);
          }
          showToast('ØªÙ… Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø¨Ù†Ø¬Ø§Ø­');
          switchView(App.view);
          refreshMiniTrial();
        }catch(err){
          console.error(err);
          showToast('ÙØ´Ù„ Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯','error');
        }
      };
      input.click();
    }

    async function searchReference(){
      const ref=document.getElementById('referenceSearch').value.trim();
      const result=document.getElementById('referenceResult');
      if(!ref){result.textContent='';return;}
      const collections=['receipts','payments','journals','supplierReturns','labs','purchaseInvoices'];
      for(const name of collections){
        const list=await Storage.load(name);
        const found=list.find(item=>(item.reference||item.id)===ref);
        if(found){
          result.innerHTML=`<div class="card"><strong>Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©:</strong> ${name}<br><pre>${JSON.stringify(found,null,2)}</pre></div>`;
          return;
        }
      }
      result.innerHTML='<div class="badge danger">Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø±Ø¬Ø¹</div>';
    }

    async function refreshMiniTrial(){
      const receipts=await Storage.load('receipts');
      const payments=await Storage.load('payments');
      const returns=await Storage.load('supplierReturns');
      const deposits=await Storage.load('patients');
      const trial={
        Cashbox:0,
        AR:0,
        AP:0,
        Revenues:0,
        Expenses:0,
        Deposits:deposits.reduce((s,p)=>s+(p.deposit||0),0),
        OnHold:returns.filter(r=>r.status==='pending').reduce((s,r)=>s+r.amount,0)
      };
      receipts.filter(r=>r.status==='active').forEach(r=>{
        trial.Cashbox+=r.amount;
        trial.Revenues+=r.amount;
        trial.AR-=r.amount;
      });
      payments.filter(p=>p.state!=='cancelled').forEach(p=>{
        trial.Cashbox-=p.amount;
        trial.Expenses+=p.amount;
        trial.AP+=p.amount;
      });
      const mini=document.getElementById('miniTrial');
      if(!mini) return;
      const rows=Object.entries(trial).map(([k,v])=>`<tr><td>${k}</td><td>${v>0?formatCurrency(v):''}</td><td>${v<0?formatCurrency(Math.abs(v)):''}</td><td>${formatCurrency(v)}</td></tr>`).join('');
      const balanced=Math.abs((trial.Cashbox+trial.AR+trial.Deposits)-(trial.AP+trial.Revenues-trial.Expenses-trial.OnHold))<1;
      mini.innerHTML=`<table><thead><tr><th>Ø§Ù„Ø­Ø³Ø§Ø¨</th><th>Ù…Ø¯ÙŠÙ†</th><th>Ø¯Ø§Ø¦Ù†</th><th>ØµØ§ÙÙŠ</th></tr></thead><tbody>${rows}</tbody></table><div class="badge" style="margin-top:1rem;">Ø§ØªØ²Ø§Ù†: ${balanced?'âœ”ï¸':'âŒ'}</div>`;
    }

    async function renderDashboardWidgets(){
      refreshMiniTrial();
      renderInventoryAlerts();
      renderAppointmentsTomorrow();
      await renderPeriodCard('morning');
      await renderPeriodCard('evening');
    }

    async function renderAppointmentsTomorrow(){
      const appointments=await Storage.load('appointments');
      const container=document.getElementById('appointmentsTomorrow');
      if(!container) return;
      const tomorrow=new Date();
      tomorrow.setDate(tomorrow.getDate()+1);
      const target=appointments.filter(a=>new Date(a.date).toDateString()===tomorrow.toDateString());
      if(!target.length){container.innerHTML='<span class="badge">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…ÙˆØ§Ø¹ÙŠØ¯</span>';return;}
      container.innerHTML='<table><thead><tr><th>Ø§Ù„Ù…Ø±ÙŠØ¶</th><th>Ø§Ù„Ø®Ø¯Ù…Ø©</th><th>Ø§Ù„Ø·Ø¨ÙŠØ¨</th><th>Ø§Ù„Ù…Ø¯ÙÙˆØ¹</th></tr></thead><tbody>'+target.map(a=>`<tr><td>${a.patient}</td><td>${a.service}</td><td>${a.doctor}</td><td>${formatCurrency(a.paid||0)}</td></tr>`).join('')+'</tbody></table>';
    }

    async function renderPeriodCard(period){
      const container=document.getElementById(period==='morning'?'periodMorning':'periodEvening');
      if(!container) return;
      const closures=await Storage.load('closures');
      const today=new Date().toISOString().slice(0,10);
      const record=closures.find(c=>c.date===today&&c.period===period);
      if(!record){
        container.innerHTML='<div class="badge">Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¥Ù‚ÙØ§Ù„ Ø¨Ø¹Ø¯</div>';
        return;
      }
      container.innerHTML=`<div class="badge ${record.locked?'':'danger'}">${record.locked?'Ù…Ù‚ÙÙˆÙ„':'Ù…ÙØªÙˆØ­'} â€” ${formatCurrency(record.total)}</div>`;
    }

    function closePeriod(period){
      promptPassword('close',async()=>{
        const closures=await Storage.load('closures');
        const receipts=await Storage.load('receipts');
        const payments=await Storage.load('payments');
        const now=new Date();
        const today=now.toISOString().slice(0,10);
        const totalIn=receipts.filter(r=>r.status==='active').reduce((s,r)=>s+r.amount,0);
        const totalOut=payments.filter(p=>p.state!=='cancelled').reduce((s,p)=>s+p.amount,0);
        const total=totalIn-totalOut;
        const existing=closures.find(c=>c.date===today&&c.period===period);
        if(existing){existing.total=total;existing.locked=true;}else{closures.push({date:today,period,total,locked:true,createdAt:new Date().toISOString()});}
        await Storage.save('closures',closures);
        await logAudit('close',`${today}-${period}`,'Ø¥Ù‚ÙØ§Ù„ ÙØªØ±Ø©',{total});
        showToast('ØªÙ… Ø¥Ù‚ÙØ§Ù„ Ø§Ù„ÙØªØ±Ø©');
        renderPeriodCard(period);
        await exportPeriodPDF(period,true);
      });
    }

    async function exportPeriodPDF(period,silent){
      const {jsPDF}=window.jspdf;
      const doc=new jsPDF();
      doc.setFont('helvetica','bold');
      doc.text(`${App.settings.clinicName}`,14,20);
      doc.setFontSize(12);
      doc.text(`ØªÙ‚Ø±ÙŠØ± ÙØªØ±Ø© ${period==='morning'?'ØµØ¨Ø§Ø­':'Ù…Ø³Ø§Ø¡'}`,14,30);
      const receipts=await Storage.load('receipts');
      const payments=await Storage.load('payments');
      const totalIn=receipts.filter(r=>r.status==='active').reduce((s,r)=>s+r.amount,0);
      const totalOut=payments.filter(p=>p.state!=='cancelled').reduce((s,p)=>s+p.amount,0);
      doc.autoTable({startY:40,head:[['Ø§Ù„Ø¨Ù†Ø¯','Ø§Ù„Ù‚ÙŠÙ…Ø©']],body:[['Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¯Ø®ÙˆÙ„',formatCurrency(totalIn)],['Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø®Ø±ÙˆØ¬',formatCurrency(totalOut)],['Ø§Ù„ØµØ§ÙÙŠ',formatCurrency(totalIn-totalOut)]]});
      doc.save(`period-${period}-${new Date().toISOString().slice(0,10)}.pdf`);
      if(!silent) showToast('ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù„Ù PDF');
    }

    async function miniTrialPDF(){
      const {jsPDF}=window.jspdf;
      const doc=new jsPDF();
      doc.text('Ø§Ù„Ù…ÙŠØ²Ø§Ù† Ø§Ù„Ù…ØµØºØ±',14,20);
      const receipts=await Storage.load('receipts');
      const payments=await Storage.load('payments');
      const data=[['Cashbox',formatCurrency(receipts.reduce((s,r)=>s+r.amount,0)-payments.reduce((s,p)=>s+p.amount,0))]];
      doc.autoTable({startY:30,head:[['Ø§Ù„Ø­Ø³Ø§Ø¨','Ø§Ù„ØµØ§ÙÙŠ']],body:data});
      doc.save('mini-trial.pdf');
    }

    async function appointmentsPDF(){
      const {jsPDF}=window.jspdf;
      const doc=new jsPDF();
      doc.text('Ù…ÙˆØ§Ø¹ÙŠØ¯ Ø§Ù„ØºØ¯',14,20);
      const appointments=await Storage.load('appointments');
      const tomorrow=new Date();tomorrow.setDate(tomorrow.getDate()+1);
      const rows=appointments.filter(a=>new Date(a.date).toDateString()===tomorrow.toDateString()).map(a=>[a.patient,a.service,a.doctor,formatCurrency(a.paid||0)]);
      doc.autoTable({startY:30,head:[['Ø§Ù„Ù…Ø±ÙŠØ¶','Ø§Ù„Ø®Ø¯Ù…Ø©','Ø§Ù„Ø·Ø¨ÙŠØ¨','Ø§Ù„Ù…Ø¯ÙÙˆØ¹']],body:rows});
      doc.save('appointments-tomorrow.pdf');
    }

    async function inventoryAlertsPDF(){
      const {jsPDF}=window.jspdf;
      const doc=new jsPDF();
      doc.text('ØªÙ†Ø¨ÙŠÙ‡Ø§Øª Ø§Ù„Ù…Ø®Ø²ÙˆÙ†',14,20);
      const inventory=await Storage.load('inventory');
      const rows=inventory.filter(i=>inventoryAlert(i)).map(i=>[i.name,inventoryAlert(i)]);
      doc.autoTable({startY:30,head:[['Ø§Ù„Ù…Ø§Ø¯Ø©','Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡']],body:rows});
      doc.save('inventory-alerts.pdf');
    }

    async function receiptPDF(reference){
      const receipts=await Storage.load('receipts');
      const receipt=receipts.find(r=>r.reference===reference);
      if(!receipt) return;
      const {jsPDF}=window.jspdf;
      const doc=new jsPDF();
      doc.text(App.settings.clinicName,14,20);
      doc.text(`Ø³Ù†Ø¯ Ù‚Ø¨Ø¶ ${reference}`,14,30);
      doc.autoTable({startY:40,head:[['Ø§Ù„Ø­Ù‚Ù„','Ø§Ù„Ù‚ÙŠÙ…Ø©']],body:[['Ø§Ù„Ù…Ø±ÙŠØ¶',receipt.patient],['Ø§Ù„Ø®Ø¯Ù…Ø©',receipt.service],['Ø§Ù„Ø·Ø¨ÙŠØ¨',receipt.doctor],['Ø§Ù„Ù…Ø¨Ù„Øº',formatCurrency(receipt.amount)],['Ø§Ù„ØªØ§Ø±ÙŠØ®',formatDate(receipt.createdAt)],['Ù…Ù„Ø§Ø­Ø¸Ø§Øª',receipt.notes||'-']]});
      if(receipt.attachment) doc.text('Ù…Ø±ÙÙ‚ Ù…Ø¶Ù…Ù‘Ù†',14,doc.lastAutoTable.finalY+10);
      doc.save(`${reference}.pdf`);
    }

    async function paymentPDF(reference){
      const payments=await Storage.load('payments');
      const payment=payments.find(r=>r.reference===reference);
      if(!payment) return;
      const {jsPDF}=window.jspdf;
      const doc=new jsPDF();
      doc.text(App.settings.clinicName,14,20);
      doc.text(`Ø³Ù†Ø¯ ØµØ±Ù ${reference}`,14,30);
      doc.autoTable({startY:40,head:[['Ø§Ù„Ø­Ù‚Ù„','Ø§Ù„Ù‚ÙŠÙ…Ø©']],body:[['Ø§Ù„Ù…ÙˆØ±Ø¯',payment.supplier],['Ø§Ù„Ù…Ø¨Ù„Øº',formatCurrency(payment.amount)],['Ø§Ù„Ø­Ø§Ù„Ø©',payment.status],['Ø§Ù„ØªØ§Ø±ÙŠØ®',formatDate(payment.createdAt)],['Ù…Ù„Ø§Ø­Ø¸Ø§Øª',payment.notes||'-']]});
      doc.save(`${reference}.pdf`);
    }

    async function labOrderPDF(reference){
      const labs=await Storage.load('labs');
      const lab=labs.find(l=>l.reference===reference);
      if(!lab) return;
      const {jsPDF}=window.jspdf;
      const doc=new jsPDF();
      doc.text('Ø·Ù„Ø¨ Ù…Ø¹Ù…Ù„',14,20);
      doc.text(reference,14,28);
      doc.autoTable({startY:34,head:[['Ø§Ù„Ø­Ù‚Ù„','Ø§Ù„Ù‚ÙŠÙ…Ø©']],body:[['Ø§Ù„Ù…Ø±ÙŠØ¶',lab.patient],['Ø§Ù„Ø·Ø¨ÙŠØ¨',lab.doctor||'-'],['Ø§Ù„Ø®Ø¯Ù…Ø©',lab.service],['Ø§Ù„Ø­Ø§Ù„Ø©',lab.status],['Ø§Ù„ØªÙƒÙ„ÙØ©',formatCurrency(lab.cost||0)],['Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª',lab.notes||'-']]});
      doc.save(`${reference}.pdf`);
    }

    async function labSummaryPDF(){
      const {jsPDF}=window.jspdf;
      const doc=new jsPDF();
      const labs=await Storage.load('labs');
      doc.text('ÙƒØ´Ù Ø§Ù„Ù…Ø¹Ø§Ù…Ù„',14,20);
      doc.autoTable({startY:30,head:[['Ø§Ù„Ù…Ø±Ø¬Ø¹','Ø§Ù„Ù…Ø±ÙŠØ¶','Ø§Ù„Ø®Ø¯Ù…Ø©','Ø§Ù„Ø­Ø§Ù„Ø©','Ø§Ù„ØªÙƒÙ„ÙØ©']],body:labs.map(l=>[l.reference,l.patient,l.service,l.status,formatCurrency(l.cost||0)])});
      doc.save('labs-summary.pdf');
    }

    async function patientsAgingPDF(){
      const {jsPDF}=window.jspdf;
      const doc=new jsPDF();
      doc.text('Ø£Ø¹Ù…Ø§Ø± Ø§Ù„Ø°Ù…Ù… Ù„Ù„Ù…Ø±Ø¶Ù‰',14,20);
      const patients=await Storage.load('patients');
      doc.autoTable({startY:30,head:[['Ø§Ù„Ø§Ø³Ù…','Ø§Ù„Ø±ØµÙŠØ¯','Ø§Ù„Ø£Ù…Ø§Ù†Ø§Øª']],body:patients.map(p=>[p.name,formatCurrency(p.balance||0),formatCurrency(p.deposit||0)])});
      doc.save('patients-aging.pdf');
    }

    async function supplierAgingPDF(){
      const {jsPDF}=window.jspdf;
      const doc=new jsPDF();
      doc.text('ÙƒØ´Ù Ø§Ù„Ù…ÙˆØ±Ø¯ÙŠÙ†',14,20);
      const returns=await Storage.load('supplierReturns');
      doc.autoTable({startY:30,head:[['Ø§Ù„Ù…Ø±Ø¬Ø¹','Ø§Ù„Ù…ÙˆØ±Ø¯','Ø§Ù„Ù‚ÙŠÙ…Ø©','Ø§Ù„Ø­Ø§Ù„Ø©']],body:returns.map(r=>[r.reference,r.supplier,formatCurrency(r.amount),r.status])});
      doc.save('supplier-aging.pdf');
    }

    async function inventoryPDF(){
      const {jsPDF}=window.jspdf;
      const doc=new jsPDF();
      doc.text('ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù…Ø®Ø²ÙˆÙ†',14,20);
      const inventory=await Storage.load('inventory');
      doc.autoTable({startY:30,head:[['Ø§Ù„Ù…Ø§Ø¯Ø©','Ø§Ù„ÙƒÙ…ÙŠØ©','Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¯Ù†Ù‰','Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ©']],body:inventory.map(i=>[i.name,i.qty,i.min,i.expiry?formatDate(i.expiry):'-'])});
      doc.save('inventory.pdf');
    }

    async function doctorProfitPDF(){
      const {jsPDF}=window.jspdf;
      const doc=new jsPDF();
      doc.text('Ø±Ø¨Ø­ÙŠØ© Ø§Ù„Ø£Ø·Ø¨Ø§Ø¡',14,20);
      const doctors=await Storage.load('doctors');
      const receipts=await Storage.load('receipts');
      const labs=await Storage.load('labs');
      const overheads=await calculateOverheads();
      const rows=doctors.map(doc=>{
        const revenue=receipts.filter(r=>r.doctor===doc.name&&r.status==='active').reduce((s,r)=>s+r.amount,0);
        const labCost=labs.filter(l=>l.doctor===doc.name).reduce((s,l)=>s+(l.cost||0),0);
        const net=revenue-labCost;
        const doctorShare=net*(doc.share/100);
        const contribution=net-doctorShare-(overheads[doc.name]||0);
        return [doc.name,formatCurrency(revenue),formatCurrency(labCost),doc.share+'%',formatCurrency(doctorShare),formatCurrency(contribution)];
      });
      doc.autoTable({startY:30,head:[['Ø§Ù„Ø·Ø¨ÙŠØ¨','Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯','ØªÙƒÙ„ÙØ© Ø§Ù„Ù…Ø¹Ù…Ù„','Ø§Ù„Ù†Ø³Ø¨Ø©','Ù†ØµÙŠØ¨ Ø§Ù„Ø·Ø¨ÙŠØ¨','Ù…Ø³Ø§Ù‡Ù…Ø© Ø§Ù„Ø¹ÙŠØ§Ø¯Ø©']],body:rows});
      doc.save('doctor-profit.pdf');
    }

    async function clinicProfitPDF(){
      const {jsPDF}=window.jspdf;
      const doc=new jsPDF();
      doc.text('Ø±Ø¨Ø­ÙŠØ© Ø§Ù„Ø¹ÙŠØ§Ø¯Ø©',14,20);
      const receipts=await Storage.load('receipts');
      const payments=await Storage.load('payments');
      const labs=await Storage.load('labs');
      const doctors=await Storage.load('doctors');
      const revenue=receipts.filter(r=>r.status==='active').reduce((s,r)=>s+r.amount,0);
      const labCost=labs.reduce((s,l)=>s+(l.cost||0),0);
      const expenses=payments.filter(p=>p.state!=='cancelled').reduce((s,p)=>s+p.amount,0);
      const doctorShare=doctors.reduce((s,doc)=>{
        const docRevenue=receipts.filter(r=>r.doctor===doc.name&&r.status==='active').reduce((t,r)=>t+r.amount,0);
        const docLab=labs.filter(l=>l.doctor===doc.name).reduce((t,l)=>t+(l.cost||0),0);
        return s+(docRevenue-docLab)*(doc.share/100);
      },0);
      const net=revenue-labCost-expenses-doctorShare;
      doc.autoTable({startY:30,head:[['Ø§Ù„Ø¨Ù†Ø¯','Ø§Ù„Ù‚ÙŠÙ…Ø©']],body:[['Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª',formatCurrency(revenue)],['ØªÙƒÙ„ÙØ© Ø§Ù„Ù…Ø¹Ù…Ù„',formatCurrency(labCost)],['Ù…ØµØ±ÙˆÙØ§Øª Ø£Ø®Ø±Ù‰',formatCurrency(expenses)],['Ù†ØµÙŠØ¨ Ø§Ù„Ø£Ø·Ø¨Ø§Ø¡',formatCurrency(doctorShare)],['ØµØ§ÙÙŠ Ø§Ù„Ø±Ø¨Ø­',formatCurrency(net)]]});
      doc.save('clinic-profit.pdf');
    }

    async function dailyReportPDF(){await genericReport('daily');}
    async function weeklyReportPDF(){await genericReport('weekly');}
    async function monthlyReportPDF(){await genericReport('monthly');}

    async function genericReport(type){
      const {jsPDF}=window.jspdf;
      const doc=new jsPDF();
      doc.text(`ØªÙ‚Ø±ÙŠØ± ${type==='daily'?'ÙŠÙˆÙ…ÙŠ':type==='weekly'?'Ø£Ø³Ø¨ÙˆØ¹ÙŠ':'Ø´Ù‡Ø±ÙŠ'}`,14,20);
      const receipts=await Storage.load('receipts');
      const payments=await Storage.load('payments');
      const now=new Date();
      let start;
      if(type==='daily') start=new Date(now.getFullYear(),now.getMonth(),now.getDate());
      if(type==='weekly'){start=new Date(now);start.setDate(now.getDate()-6);}
      if(type==='monthly'){start=new Date(now.getFullYear(),now.getMonth(),1);}
      const filteredReceipts=receipts.filter(r=>new Date(r.createdAt)>=start&&new Date(r.createdAt)<=now && r.status==='active');
      const filteredPayments=payments.filter(r=>new Date(r.createdAt)>=start&&new Date(r.createdAt)<=now && r.state!=='cancelled');
      const totalIn=filteredReceipts.reduce((s,r)=>s+r.amount,0);
      const totalOut=filteredPayments.reduce((s,r)=>s+r.amount,0);
      doc.autoTable({startY:30,head:[['Ø§Ù„Ø¨Ù†Ø¯','Ø§Ù„Ù‚ÙŠÙ…Ø©']],body:[['Ø§Ù„Ù…Ø¯Ø®ÙˆÙ„',formatCurrency(totalIn)],['Ø§Ù„Ù…Ø®Ø±ÙˆØ¬',formatCurrency(totalOut)],['Ø§Ù„ØµØ§ÙÙŠ',formatCurrency(totalIn-totalOut)]]});
      doc.save(`report-${type}.pdf`);
    }

    async function journalPDF(){
      const {jsPDF}=window.jspdf;
      const doc=new jsPDF('p','pt','a4');
      doc.text('Ø¯ÙØªØ± Ø§Ù„ÙŠÙˆÙ…ÙŠØ©',40,40);
      const journals=await Storage.load('journals');
      const body=journals.slice(-200).reverse().map(j=>[j.id,formatDate(j.createdAt),j.meta?.type||'',j.entries.map(e=>`${e.account}: ${e.debit?formatCurrency(e.debit):''} ${e.credit?formatCurrency(e.credit):''}`).join('\n')]);
      doc.autoTable({startY:60,head:[['Ø§Ù„Ù…Ø±Ø¬Ø¹','Ø§Ù„ØªØ§Ø±ÙŠØ®','Ø§Ù„ÙˆØµÙ','Ø§Ù„Ù‚ÙŠÙˆØ¯']],body});
      doc.save('journal.pdf');
    }

    async function auditLogPDF(){
      const {jsPDF}=window.jspdf;
      const doc=new jsPDF('p','pt','a4');
      doc.text('Ø³Ø¬Ù„ Ø§Ù„ØªØ¯Ù‚ÙŠÙ‚',40,40);
      const log=await Storage.load('audit');
      doc.autoTable({startY:60,head:[['Ø§Ù„ÙˆÙ‚Øª','Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…','Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡','Ø§Ù„Ù…Ø±Ø¬Ø¹']],body:log.slice(-200).reverse().map(i=>[formatDate(i.timestamp),i.user,i.action,i.reference])});
      doc.save('audit-log.pdf');
    }

    async function downloadReceiptPDF(){
      const receipts=await Storage.load('receipts');
      if(!receipts.length){showToast('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø³Ù†Ø¯Ø§Øª','error');return;}
      await receiptPDF(receipts[receipts.length-1].reference);
    }
    async function downloadPaymentPDF(){
      const payments=await Storage.load('payments');
      if(!payments.length){showToast('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø³Ù†Ø¯Ø§Øª','error');return;}
      await paymentPDF(payments[payments.length-1].reference);
    }

    async function runHealthCheck(){
      const results=[];
      try{
        if(!window.localforage) throw new Error('localForage ØºÙŠØ± Ù…ØªØ§Ø­');
        results.push({item:'localForage',status:'ok'});
      }catch(err){results.push({item:'localForage',status:'fail',message:err.message});}
      try{
        if(!window.jspdf) throw new Error('jsPDF ØºÙŠØ± Ù…ØªØ§Ø­');
        results.push({item:'jsPDF',status:'ok'});
      }catch(err){results.push({item:'jsPDF',status:'fail',message:err.message});}
      try{
        await localforage.setItem('test-key',{time:Date.now()});
        await localforage.getItem('test-key');
        results.push({item:'Ø§Ù„ÙƒØªØ§Ø¨Ø©/Ø§Ù„Ù‚Ø±Ø§Ø¡Ø©',status:'ok'});
      }catch(err){results.push({item:'Ø§Ù„ÙƒØªØ§Ø¨Ø©/Ø§Ù„Ù‚Ø±Ø§Ø¡Ø©',status:'fail',message:err.message});}
      try{
        const journals=await Storage.load('journals');
        const subset=journals.slice(-20);
        const valid=subset.every(j=>Math.abs(j.entries.reduce((s,e)=>s+(e.debit||0),0)-j.entries.reduce((s,e)=>s+(e.credit||0),0))<0.01);
        results.push({item:'Ø§ØªØ²Ø§Ù† Ø§Ù„Ù‚ÙŠÙˆØ¯',status:valid?'ok':'fail',message:valid?'':'ÙŠÙˆØ¬Ø¯ Ù‚ÙŠØ¯ ØºÙŠØ± Ù…ØªØ²Ù†'});
      }catch(err){results.push({item:'Ø§ØªØ²Ø§Ù† Ø§Ù„Ù‚ÙŠÙˆØ¯',status:'fail',message:err.message});}
      const health=document.getElementById('healthReport');
      const ok=results.every(r=>r.status==='ok');
      health.innerHTML='<ul>'+results.map(r=>`<li>${r.status==='ok'?'âœ…':'âŒ'} ${r.item}${r.message?` â€” ${r.message}`:''}</li>`).join('')+'</ul>';
      const {jsPDF}=window.jspdf;
      const doc=new jsPDF();
      doc.text('Health Check',14,20);
      doc.autoTable({startY:30,head:[['Ø§Ù„Ø¨Ù†Ø¯','Ø§Ù„Ù†ØªÙŠØ¬Ø©','Ù…Ù„Ø§Ø­Ø¸Ø§Øª']],body:results.map(r=>[r.item,r.status==='ok'?'âœ…':'âŒ',r.message||''])});
      doc.save('health-check.pdf');
      showToast(ok?'Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª Ù†Ø§Ø¬Ø­Ø©':'Ø¨Ø¹Ø¶ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª ÙØ´Ù„Øª',ok?'success':'error');
    }

    document.getElementById('btnSensitive').onclick=()=>{
      if(App.role!=='manager'){showToast('Ø§Ù„Ù…Ø¯ÙŠØ± ÙÙ‚Ø· ÙŠÙ…ÙƒÙ†Ù‡ ØªÙØ¹ÙŠÙ„ Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ø­Ø³Ø§Ø³','error');return;}
      if(App.sensitive){App.sensitive=false;updateStatus();return;}
      promptPassword('danger',()=>{App.sensitive=true;updateStatus();});
    };

    document.getElementById('btnSwitchRole').onclick=()=>{
      const overlay=document.getElementById('modalOverlay');
      overlay.innerHTML=`<div class="modal">
        <header><h3>ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</h3></header>
        <p>Ø§Ø®ØªØ± Ø§Ù„Ø¯ÙˆØ±:</p>
        <select id="roleSelect" style="width:100%;margin-bottom:1rem;">
          <option value="manager">Ù…Ø¯ÙŠØ±</option>
          <option value="secretary">Ø³ÙƒØ±ØªÙŠØ±Ø©</option>
        </select>
        <div class="flex" style="justify-content:flex-end;">
          <button class="btn" id="confirmRole">ØªØ£ÙƒÙŠØ¯</button>
        </div>
      </div>`;
      overlay.classList.add('active');
      document.getElementById('confirmRole').onclick=()=>{
        const role=document.getElementById('roleSelect').value;
        if(role==='manager'){
          promptPassword('settings',()=>{
            overlay.classList.remove('active');
            App.role='manager';
            updateStatus();
            renderNav();
            switchView('dashboard');
          });
        }else{
          overlay.classList.remove('active');
          App.role='secretary';
          App.sensitive=false;
          updateStatus();
          renderNav();
          switchView('dashboard');
        }
      };
      overlay.addEventListener('click',e=>{if(e.target.id==='modalOverlay')overlay.classList.remove('active');},{once:true});
    };

    function appointmentsSeed(){
      return [
        {id:1,patient:'Ø£Ø­Ù…Ø¯',service:'ØªÙ†Ø¸ÙŠÙ',doctor:'Ø¯. Ù„ÙŠÙ„Ù‰',paid:200,date:new Date().toISOString()},
        {id:2,patient:'Ø³Ø§Ø±Ø©',service:'Ø­Ø´Ùˆ',doctor:'Ø¯. Ù…Ø­Ù…Ø¯',paid:0,date:new Date(Date.now()+24*60*60*1000).toISOString()}
      ];
    }

    async function bootstrap(){
      await Storage.init();
      const existingPatients=await Storage.load('patients');
      if(!existingPatients.length){
        await Storage.save('patients',[{name:'Ø£Ø­Ù…Ø¯ Ø¹Ù„ÙŠ',phone:'0500000000',balance:0,deposit:0,notes:'',createdAt:new Date().toISOString()}]);
      }
      const existingDoctors=await Storage.load('doctors');
      if(!existingDoctors.length){
        await Storage.save('doctors',[{name:'Ø¯. Ù„ÙŠÙ„Ù‰',share:40},{name:'Ø¯. Ù…Ø­Ù…Ø¯',share:45}]);
      }
      const appointments=await Storage.load('appointments');
      if(!appointments.length){
        await Storage.save('appointments',appointmentsSeed());
      }
      updateStatus();
      renderNav();
      switchView('dashboard');
      renderReceiptsTable();
      renderPaymentsTable();
      renderJournalTable();
      renderPatientsTable();
      renderSupplierReturns();
      renderLabsTable();
      renderInventoryTable();
      renderDoctorsTable();
      renderDashboardWidgets();
    }

    bootstrap();
  </script>
</body>
</html>
