<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>MyClinicDB</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/localforage/1.10.0/localforage.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
  <style>
    :root {
      --primary:#145C9E;
      --accent:#1ABC9C;
      --danger:#E74C3C;
      --bg:#F7F9FC;
      --text:#1B263B;
    }
    *{box-sizing:border-box;}
    body{
      margin:0;
      font-family:'Cairo',sans-serif;
      background:var(--bg);
      color:var(--text);
    }
    header{
      display:flex;
      justify-content:space-between;
      align-items:center;
      background:var(--primary);
      color:#fff;
      padding:1.25rem 1.5rem;
    }
    main{
      display:grid;
      grid-template-columns:260px 1fr;
      min-height:calc(100vh - 96px);
    }
    nav{
      background:#fff;
      border-left:1px solid #dce6f2;
      padding:1rem;
      display:flex;
      flex-direction:column;
      gap:.5rem;
    }
    nav button{
      border-radius:12px;
      border:1px solid transparent;
      padding:.75rem 1rem;
      background:transparent;
      text-align:right;
      font-weight:600;
      color:var(--text);
      cursor:pointer;
    }
    nav button.active,nav button:hover{
      border-color:var(--primary);
      color:var(--primary);
      background:rgba(20,92,158,0.08);
    }
    section{
      padding:1.5rem;
      overflow-y:auto;
    }
    .card{
      background:#fff;
      border-radius:16px;
      padding:1.25rem;
      box-shadow:0 12px 32px rgba(0,0,0,.06);
      margin-bottom:1.5rem;
    }
    .grid{display:grid;gap:1rem;}
    .grid-2{grid-template-columns:repeat(auto-fit,minmax(220px,1fr));}
    label{display:block;font-weight:600;margin-bottom:.3rem;}
    input,select,textarea{
      width:100%;
      padding:.6rem .8rem;
      border-radius:12px;
      border:1px solid #dbe5ef;
      font-family:inherit;
    }
    textarea{min-height:120px;}
    table{width:100%;border-collapse:collapse;direction:rtl;}
    th,td{padding:.6rem;border-bottom:1px solid #eef2f7;text-align:right;}
    th{background:#f0f5fb;}
    .btn{
      display:inline-flex;
      align-items:center;
      gap:.4rem;
      background:var(--primary);
      color:#fff;
      border:none;
      border-radius:12px;
      padding:.6rem 1rem;
      font-weight:600;
      cursor:pointer;
    }
    .btn.secondary{background:var(--accent);}
    .btn.danger{background:var(--danger);}
    .badge{
      display:inline-flex;
      gap:.3rem;
      align-items:center;
      padding:.35rem .75rem;
      background:rgba(20,92,158,.12);
      color:var(--primary);
      border-radius:999px;
      font-size:.75rem;
    }
    .badge.danger{background:rgba(231,76,60,.15);color:var(--danger);}
    .toast{
      position:fixed;top:1.5rem;left:50%;transform:translateX(-50%);
      background:#fff;padding:1rem 1.5rem;border-radius:16px;display:none;z-index:9999;
      box-shadow:0 12px 32px rgba(0,0,0,.15);
      min-width:260px;text-align:center;
    }
    .toast.show{display:block;}
    .toast.error{border-right:6px solid var(--danger);}
    .toast.success{border-right:6px solid var(--accent);}
    #modalOverlay{
      position:fixed;inset:0;background:rgba(0,0,0,.35);backdrop-filter:blur(4px);
      display:none;align-items:center;justify-content:center;z-index:9000;
    }
    #modalOverlay.active{display:flex;}
    .modal{background:#fff;padding:1.5rem;border-radius:18px;min-width:min(420px,94vw);}
    .modal header{margin-bottom:1rem;}
    .flex{display:flex;gap:1rem;align-items:center;flex-wrap:wrap;}
    .sensitive-active{border:2px dashed var(--danger);padding:.4rem .8rem;border-radius:10px;color:var(--danger);}
    @media(max-width:960px){
      main{grid-template-columns:1fr;}
      nav{flex-direction:row;flex-wrap:wrap;border-left:none;border-top:1px solid #dce6f2;}
      nav button{flex:1 1 calc(50% - .5rem);}
    }
  </style>
</head>
<body>
  <div class="toast" id="toast"></div>
  <div id="modalOverlay"></div>
  <header>
    <h1>MyClinicDB โ ุงููุธุงู ุงููุญุงุณุจู</h1>
    <div class="flex" id="statusBar">
      <span id="roleBadge" class="badge">ุงููุถุน: ุณูุฑุชุงุฑูุฉ</span>
      <span id="sensitiveBadge" class="badge danger">ุงูุฅุฌุฑุงุกุงุช ุงูุญุณุงุณุฉ: ๐</span>
      <button class="btn" id="btnSensitive">ุชูุนูู ุงููุถุน ุงูุญุณุงุณ</button>
      <button class="btn secondary" id="btnSwitchRole">ุชุจุฏูู ุงููุณุชุฎุฏู</button>
    </div>
  </header>
  <main>
    <nav id="mainNav"></nav>
    <section id="view"></section>
  </main>
  <script>
    const App = {
      role:'secretary',
      sensitive:false,
      passwords:{
        settings:'sha256$jZae727K08KaOmKSgOaGzww/XVqGr/PKEgIMkjrcbJI=',
        close:'sha256$SB9swFERQ8zdfi0bG5T68KcAqLSc0Tkipwta4orKqMU=',
        danger:'sha256$fCUjyYWIH7LCtM++kX6xLExLYeiYrU5xYM/KSHyjxPM='
      },
      settings:{
        clinicName:'ุนูุงุฏุฉ ุฃุณูุงู ูุชูุฏูุฉ',
        clinicLogo:'',
        currency:'YER',
        overheadAllocation:'revenue',
        numberFormat:'ar'
      },
      counters:{},
      view:'dashboard'
    };

    const DEFAULT_PASSWORDS={settings:'123456',close:'654321',danger:'246810'};
    const PasswordGuard={
      failed:{settings:0,close:0,danger:0},
      lockedUntil:{settings:0,close:0,danger:0}
    };
    const MAX_FAILED_ATTEMPTS=3;
    const LOCK_DURATION_MS=5*60*1000;

    const Views = {};
    const DENTAL_TEETH=[
      '18','17','16','15','14','13','12','11',
      '21','22','23','24','25','26','27','28',
      '38','37','36','35','34','33','32','31',
      '41','42','43','44','45','46','47','48'
    ];
    const DENTAL_STATUSES=['ุณููู','ูุญุดู','ููููุฏ','ุชุญุช ุงูุนูุงุฌ','ุฒุฑุนุฉ'];

    function showToast(msg,type='success'){
      const el=document.getElementById('toast');
      el.textContent=msg;
      el.className=`toast show ${type}`;
      setTimeout(()=>el.classList.remove('show'),3500);
    }

    function formatDate(date){
      if(!date) return '-';
      const d=new Date(date);
      return d.toLocaleDateString('ar-SA',{year:'numeric',month:'2-digit',day:'2-digit'});
    }
    function formatCurrency(val){
      return new Intl.NumberFormat('ar-EG',{style:'currency',currency:App.settings.currency||'YER'}).format(val||0);
    }

    async function hashText(text){
      try{
        if(!(window.crypto&&window.crypto.subtle)) throw new Error('subtle-crypto-unavailable');
        const data=new TextEncoder().encode(text);
        const digest=await crypto.subtle.digest('SHA-256',data);
        const bytes=Array.from(new Uint8Array(digest));
        const binary=String.fromCharCode(...bytes);
        return `sha256$${btoa(binary)}`;
      }catch(err){
        const encoded=unescape(encodeURIComponent(text));
        return `sha256$${btoa(encoded)}`;
      }
    }

    async function preparePasswords(existing={}){
      const updated={...existing};
      let changed=false;
      for(const key of Object.keys(DEFAULT_PASSWORDS)){
        let current=updated[key];
        if(!current){
          current=DEFAULT_PASSWORDS[key];
          changed=true;
        }
        if(!String(current).startsWith('sha256$')){
          current=await hashText(current);
          changed=true;
        }
        updated[key]=current;
      }
      return {updated,changed};
    }

    async function verifyPassword(type,value){
      if(!value) return false;
      const hashed=await hashText(value);
      return hashed===App.passwords[type];
    }

    const Storage={
      async init(){
        localforage.config({name:'MyClinicDB',storeName:'clinic_store'});
        const settings=await localforage.getItem('settings');
        if(settings){
          App.settings={...App.settings,...settings};
          if('passwords'in App.settings) delete App.settings.passwords;
        }
        const storedPasswords=await localforage.getItem('passwords');
        const {updated,changed}=await preparePasswords(storedPasswords||App.passwords);
        App.passwords=updated;
        if(changed||!storedPasswords){
          await localforage.setItem('passwords',App.passwords);
        }
        App.counters=await localforage.getItem('referenceCounters')||{};
      },
      async load(key,fallback=[]){
        return await localforage.getItem(key)||fallback;
      },
      async save(key,val){
        await localforage.setItem(key,val);
      }
    };

    function generateReference(prefix){
      const now=new Date();
      const ym=`${now.getFullYear()}${String(now.getMonth()+1).padStart(2,'0')}`;
      const key=`${prefix}-${ym}`;
      const counter=(App.counters[key]||0)+1;
      App.counters[key]=counter;
      localforage.setItem('referenceCounters',App.counters);
      return `${prefix}-${ym}-${String(counter).padStart(4,'0')}`;
    }

    function updateStatus(){
      document.getElementById('roleBadge').textContent=`ุงููุถุน: ${App.role==='manager'?'ูุฏูุฑ':'ุณูุฑุชุงุฑูุฉ'}`;
      document.getElementById('btnSensitive').disabled=App.role!=='manager';
      document.getElementById('sensitiveBadge').textContent=`ุงูุฅุฌุฑุงุกุงุช ุงูุญุณุงุณุฉ: ${App.sensitive?'๐':'๐'}`;
      document.getElementById('sensitiveBadge').className=`badge ${App.sensitive?'':'danger'}`;
    }

    function renderNav(){
      const nav=document.getElementById('mainNav');
      nav.innerHTML='';
      const items=[
        {id:'dashboard',label:'ููุญุฉ ุงูุชุญูู'},
        {id:'receipts',label:'ุณูุฏุงุช ุงููุจุถ'},
        {id:'payments',label:'ุณูุฏุงุช ุงูุตุฑู'},
        {id:'journal',label:'ุฏูุชุฑ ุงูููููุฉ'},
        {id:'patients',label:'ุงููุฑุถู ูุงูุฃูุงูุงุช'},
        {id:'appointments',label:'ุงูููุงุนูุฏ'},
        {id:'suppliers',label:'ุงูููุฑุฏูู ูุงููุดุชุฑูุงุช'},
        {id:'labs',label:'ุงููุนุงูู'},
        {id:'inventory',label:'ุงููุฎุฒูู'},
        {id:'finance',label:'ุงููุตุฑููุงุช ูุงูุฅููุงู'},
        {id:'doctors',label:'ุงูุฃุทุจุงุก ูุงูุฑุจุญูุฉ'},
        {id:'prescriptions',label:'ุงููุตูุงุช ุงูุทุจูุฉ'},
        {id:'controls',label:'ุงูุชุณููุงุช ูุงููุฑุงุฌุนุฉ'},
        {id:'reports',label:'ุงูุชูุงุฑูุฑ'},
        {id:'settings',label:'ุงูุฅุนุฏุงุฏุงุช'}
      ];
      items.forEach(item=>{
        if(App.role!=='manager' && item.id==='settings') return;
        const btn=document.createElement('button');
        btn.textContent=item.label;
        if(App.view===item.id) btn.classList.add('active');
        btn.onclick=()=>switchView(item.id);
        nav.appendChild(btn);
      });
    }

    function switchView(id){
      App.view=id;
      renderNav();
      const container=document.getElementById('view');
      container.innerHTML=Views[id]?Views[id]():'';
      const hooks={
        dashboard:()=>renderDashboardWidgets(),
        receipts:()=>{updatePatientSelectors();renderReceiptsTable();},
        payments:()=>renderPaymentsTable(),
        journal:()=>renderJournalTable(),
        patients:()=>{renderPatientsTable();renderPatientReceivables();renderMedicalAlerts();renderDentalChartControls();},
        appointments:()=>renderAppointmentsTable(),
        suppliers:()=>{renderSupplierReturns();},
        labs:()=>renderLabsTable(),
        inventory:()=>renderInventoryTable(),
        finance:()=>{renderOperatingExpenses();renderFixedAssets();renderPeriodClosings();},
        doctors:()=>renderDoctorsTable(),
        prescriptions:()=>renderPrescriptionsTable(),
        controls:()=>{renderBankReconciliations();},
        reports:()=>{},
        settings:()=>{}
      };
      if(hooks[id]) hooks[id]();
    }

    async function promptPassword(type,cb){
      const overlay=document.getElementById('modalOverlay');
      const now=Date.now();
      if(PasswordGuard.lockedUntil[type]&&now<PasswordGuard.lockedUntil[type]){
        showToast('ูุญุงููุงุช ูุซูุฑุฉุ ุงูุฑุฌุงุก ุงูุงูุชุธุงุฑ ูุจู ุงููุญุงููุฉ ูุฌุฏุฏูุง','error');
        await logAudit('security-deny',`PWD-${type}`,'ุฑูุถ ุฅุฏุฎุงู ูููุฉ ุงููุฑูุฑ ุจุณุจุจ ุงูููู',{lockedUntil:new Date(PasswordGuard.lockedUntil[type]).toISOString()});
        return;
      }
      overlay.innerHTML=`<div class="modal">
        <header><h3>ูููุฉ ุงููุฑูุฑ</h3></header>
        <p>ุฃุฏุฎู ูููุฉ ุงููุฑูุฑ (${type==='settings'?'ุงูุฅุนุฏุงุฏุงุช':type==='close'?'ุงูุฅููุงู':'ุงูุฅุฌุฑุงุกุงุช ุงูุญุณุงุณุฉ'})</p>
        <input id="pwdField" type="password" style="width:100%;margin-bottom:1rem;" />
        <div class="flex" style="justify-content:flex-end;">
          <button class="btn secondary" id="cancelPwd">ุฅูุบุงุก</button>
          <button class="btn" id="confirmPwd">ุชุฃููุฏ</button>
        </div>
      </div>`;
      overlay.classList.add('active');
      const closeModal=()=>overlay.classList.remove('active');
      document.getElementById('cancelPwd').onclick=()=>{
        closeModal();
      };
      document.getElementById('confirmPwd').onclick=async()=>{
        const value=document.getElementById('pwdField').value;
        if(await verifyPassword(type,value)){
          PasswordGuard.failed[type]=0;
          closeModal();
          await logAudit('security-pass',`PWD-${type}`,'ุชู ุงูุชุญูู ูู ูููุฉ ุงููุฑูุฑ');
          cb();
        }else{
          PasswordGuard.failed[type]=(PasswordGuard.failed[type]||0)+1;
          await logAudit('security-fail',`PWD-${type}`,'ูุญุงููุฉ ูููุฉ ูุฑูุฑ ูุงุดูุฉ',{attempts:PasswordGuard.failed[type]});
          showToast('ูููุฉ ุงููุฑูุฑ ุบูุฑ ุตุญูุญุฉ','error');
          if(PasswordGuard.failed[type]>=MAX_FAILED_ATTEMPTS){
            PasswordGuard.lockedUntil[type]=Date.now()+LOCK_DURATION_MS;
            PasswordGuard.failed[type]=0;
            await logAudit('security-lock',`PWD-${type}`,'ุชู ููู ุงููุญุงููุฉ ูุคูุชูุง',{lockedUntil:new Date(PasswordGuard.lockedUntil[type]).toISOString()});
            showToast('ุชู ููู ุงููุญุงููุฉ ูุคูุชูุง ุจุนุฏ ูุญุงููุงุช ูุชูุฑุฑุฉ','error');
            closeModal();
          }
        }
      };
      overlay.addEventListener('click',e=>{if(e.target.id==='modalOverlay')overlay.classList.remove('active');},{once:true});
    }

    function guardSensitive(cb){
      if(!App.sensitive){
        showToast('ูุนูู ุงููุถุน ุงูุญุณุงุณ ุฃููุงู','error');
        return;
      }
      promptPassword('danger',cb);
    }

    async function logAudit(action,reference,description,payload={}){
      const log=await Storage.load('audit');
      log.push({id:Date.now(),action,reference,description,payload,user:App.role,timestamp:new Date().toISOString()});
      await Storage.save('audit',log);
    }

    function computeLedgerTotals(journals){
      return journals.reduce((acc,j)=>{
        j.entries.forEach(e=>{
          acc.debit+=e.debit||0;
          acc.credit+=e.credit||0;
        });
        return acc;
      },{debit:0,credit:0});
    }

    async function recordJournal(entries,meta){
      const debit=entries.reduce((s,e)=>s+(e.debit||0),0);
      const credit=entries.reduce((s,e)=>s+(e.credit||0),0);
      if(Math.abs(debit-credit)>0.01){
        showToast('ุงูููุฏ ุบูุฑ ูุชูุงุฒู','error');
        throw new Error('unbalanced');
      }
      const journals=await Storage.load('journals');
      const doc={id:generateReference('JV'),entries,meta,createdAt:new Date().toISOString()};
      const prospective=[...journals,doc];
      const totals=computeLedgerTotals(prospective);
      const imbalance=Math.abs(totals.debit-totals.credit);
      if(imbalance>0.05){
        showToast('ุชุญุฐูุฑ: ุฏูุชุฑ ุงูููููุฉ ุบูุฑ ูุชุฒู ุจุนุฏ ูุฐุง ุงูููุฏ','error');
        await logAudit('alert','TRIAL-IMBALANCE','ูุญุงููุฉ ุฅุฏุฎุงู ุชุณุจุจุช ูู ุนุฏู ุงุชุฒุงู',{meta,debit:totals.debit,credit:totals.credit});
        throw new Error('ledger-imbalance');
      }
      journals.push(doc);
      await Storage.save('journals',journals);
      await logAudit('add',doc.id,'ุฅุถุงูุฉ ููุฏ ููููุฉ',meta);
      return doc;
    }

    function Views_dashboard(){
      return `
      <div class="grid grid-2">
        <div class="card">
          <h2>ูุชุฑุฉ ุงูููู โ ุตุจุงุญ</h2>
          <div id="periodMorning"></div>
          <div class="flex" style="margin-top:1rem;">
            <button class="btn secondary" onclick="exportPeriodPDF('morning')">PDF</button>
            <button class="btn" onclick="closePeriod('morning')">ุฅููุงู ุงููุชุฑุฉ</button>
          </div>
        </div>
        <div class="card">
          <h2>ูุชุฑุฉ ุงูููู โ ูุณุงุก</h2>
          <div id="periodEvening"></div>
          <div class="flex" style="margin-top:1rem;">
            <button class="btn secondary" onclick="exportPeriodPDF('evening')">PDF</button>
            <button class="btn" onclick="closePeriod('evening')">ุฅููุงู ุงููุชุฑุฉ</button>
          </div>
        </div>
        <div class="card">
          <h2>ุงูููุฒุงู ุงููุตุบูุฑ</h2>
          <div id="miniTrial"></div>
          <div class="flex" style="margin-top:1rem;">
            <button class="btn" onclick="refreshMiniTrial()">ุชุญุฏูุซ</button>
            <button class="btn secondary" onclick="miniTrialPDF()">PDF</button>
          </div>
        </div>
        <div class="card">
          <h2>ููุงุนูุฏ ุงูุบุฏ</h2>
          <div id="appointmentsTomorrow"></div>
          <button class="btn secondary" style="margin-top:1rem;" onclick="appointmentsPDF()">PDF</button>
        </div>
        <div class="card">
          <h2>ุงููุฎุฒูู</h2>
          <div id="inventoryAlerts"></div>
          <button class="btn secondary" style="margin-top:1rem;" onclick="inventoryAlertsPDF()">PDF</button>
        </div>
      </div>`;
    }
    Views.dashboard=Views_dashboard;

    function Views_receipts(){
      return `
      <div class="card">
        <h2>ุณูุฏ ูุจุถ</h2>
        <div class="grid grid-2">
          <div><label>ุงููุฑูุถ</label><select id="receiptPatient"></select></div>
          <div><label>ููุน ุงูุนูููุฉ</label><select id="receiptType"><option value="service">ุฅูุฑุงุฏ ุฎุฏูุฉ ููุฑูุฉ</option><option value="settlement">ุชุณุฏูุฏ ุฐูุฉ ูุงุฆูุฉ</option></select></div>
          <div><label>ุงูุฎุฏูุฉ</label><input id="receiptService" /></div>
          <div><label>ุงูุทุจูุจ</label><input id="receiptDoctor" /></div>
          <div><label>ุงููุจูุบ</label><input id="receiptAmount" type="number" min="0" step="0.05" /></div>
          <div><label>ููุงุญุธุงุช</label><textarea id="receiptNotes"></textarea></div>
          <div><label>ูุฑููุงุช</label><input type="file" id="receiptAttachment" accept="image/*,.pdf" /></div>
        </div>
        <div class="flex" style="margin-top:1rem;justify-content:flex-end;">
          <button class="btn" onclick="saveReceipt()">ุญูุธ</button>
          <button class="btn secondary" onclick="downloadReceiptPDF()">PDF</button>
        </div>
      </div>
      <div class="card">
        <div class="flex" style="justify-content:space-between;align-items:center;">
          <h2>ุณูุฏุงุช ูุณุฌูุฉ</h2>
          <input id="receiptSearch" placeholder="ุจุญุซ ุจุงููุฑุฌุน" oninput="debounced(()=>renderReceiptsTable())" />
        </div>
        <table>
          <thead><tr><th>ุงููุฑุฌุน</th><th>ุงูุชุงุฑูุฎ</th><th>ุงููุฑูุถ</th><th>ุงูุฎุฏูุฉ</th><th>ุงูููุน</th><th>ุงููุจูุบ</th><th>ุงูุญุงูุฉ</th><th>ุฎูุงุฑุงุช</th></tr></thead>
          <tbody id="receiptTable"></tbody>
        </table>
      </div>`;
    }
    Views.receipts=Views_receipts;

    function Views_payments(){
      return `
      <div class="card">
        <h2>ุณูุฏ ุตุฑู</h2>
        <div class="grid grid-2">
          <div><label>ุงูููุฑุฏ/ุงููุนูู</label><input id="paymentSupplier" /></div>
          <div><label>ุงูุญุงูุฉ</label><select id="paymentStatus"><option value="paid">ูุฏููุน</option><option value="pending">ูุนููู</option></select></div>
          <div><label>ุงููุจูุบ</label><input id="paymentAmount" type="number" min="0" step="0.05" /></div>
          <div><label>ููุงุญุธุงุช</label><textarea id="paymentNotes"></textarea></div>
          <div><label>ูุฑููุงุช</label><input type="file" id="paymentAttachment" accept="image/*,.pdf" /></div>
        </div>
        <div class="flex" style="margin-top:1rem;justify-content:flex-end;">
          <button class="btn" onclick="savePayment()">ุญูุธ</button>
          <button class="btn secondary" onclick="downloadPaymentPDF()">PDF</button>
        </div>
      </div>
      <div class="card">
        <div class="flex" style="justify-content:space-between;align-items:center;">
          <h2>ุงูุณูุฏุงุช</h2>
          <input id="paymentSearch" placeholder="ุจุญุซ ุจุงููุฑุฌุน" oninput="debounced(()=>renderPaymentsTable())" />
        </div>
        <table>
          <thead><tr><th>ุงููุฑุฌุน</th><th>ุงูุชุงุฑูุฎ</th><th>ุงูููุฑุฏ</th><th>ุงููุจูุบ</th><th>ุงูุญุงูุฉ</th><th>ุฎูุงุฑุงุช</th></tr></thead>
          <tbody id="paymentTable"></tbody>
        </table>
      </div>`;
    }
    Views.payments=Views_payments;

    function Views_journal(){
      return `
      <div class="card">
        <div class="flex" style="justify-content:space-between;align-items:center;">
          <h2>ุฏูุชุฑ ุงูููููุฉ</h2>
          <div class="flex">
            <input id="journalFilter" placeholder="ุจุญุซ" oninput="debounced(()=>renderJournalTable())" />
            <button class="btn secondary" onclick="journalPDF()">PDF</button>
          </div>
        </div>
        <table>
          <thead><tr><th>ุงููุฑุฌุน</th><th>ุงูุชุงุฑูุฎ</th><th>ุงููุตู</th><th>ุงููููุฏ</th></tr></thead>
          <tbody id="journalTable"></tbody>
        </table>
      </div>`;
    }
    Views.journal=Views_journal;

    function Views_patients(){
      return `
      <div class="card">
        <h2>ูุฑูุถ ุฌุฏูุฏ</h2>
        <div class="grid grid-2">
          <div><label>ุงูุงุณู</label><input id="patientName" /></div>
          <div><label>ุงููุงุชู</label><input id="patientPhone" /></div>
          <div><label>ุฃูุงูุงุช</label><input id="patientDeposit" type="number" min="0" step="0.05" /></div>
          <div><label>ููุงุญุธุงุช</label><textarea id="patientNotes"></textarea></div>
        </div>
        <div class="flex" style="margin-top:1rem;justify-content:flex-end;">
          <button class="btn" onclick="savePatient()">ุญูุธ</button>
        </div>
      </div>
      <div class="card">
        <div class="flex" style="justify-content:space-between;align-items:center;">
          <h2>ูุงุฆูุฉ ุงููุฑุถู</h2>
          <button class="btn secondary" onclick="patientsAgingPDF()">PDF ุฃุนูุงุฑ ุงูุฐูู</button>
        </div>
        <table>
          <thead><tr><th>ุงูุงุณู</th><th>ุงููุงุชู</th><th>ุงูุฑุตูุฏ</th><th>ุงูุฃูุงูุงุช</th><th>ุชูุจููุงุช</th><th>ุฎูุงุฑุงุช</th></tr></thead>
          <tbody id="patientTable"></tbody>
        </table>
      </div>
      <div class="card">
        <h2>ุงูุณุฌู ุงูุณูู ูููุฑูุถ</h2>
        <div class="grid grid-2">
          <div><label>ุงููุฑูุถ</label><select id="dentalPatient"></select></div>
          <div><label>ููุงุญุธุงุช ุงูุณุฌู</label><textarea id="dentalNotes"></textarea></div>
        </div>
        <div id="dentalChart" style="margin-top:1rem;"></div>
        <div class="flex" style="margin-top:1rem;justify-content:flex-end;">
          <button class="btn" onclick="saveDentalChart()">ุญูุธ ุงูุณุฌู ุงูุณูู</button>
        </div>
      </div>
      <div class="card">
        <h2>ุฐูู ุงููุฑุถู</h2>
        <div class="grid grid-2">
          <div><label>ุงููุฑูุถ</label><select id="receivablePatient"></select></div>
          <div><label>ุงููุจูุบ</label><input id="receivableAmount" type="number" min="0" step="0.05" /></div>
          <div><label>ุชุงุฑูุฎ ุงูุงุณุชุญูุงู</label><input id="receivableDue" type="date" /></div>
          <div><label>ููุงุญุธุงุช</label><textarea id="receivableNotes"></textarea></div>
        </div>
        <div class="flex" style="margin-top:1rem;justify-content:flex-end;">
          <button class="btn" onclick="savePatientReceivable()">ุชุณุฌูู ุฐูุฉ</button>
        </div>
        <table style="margin-top:1.5rem;">
          <thead><tr><th>ุงููุฑูุถ</th><th>ุงููุจูุบ</th><th>ุงููุชุจูู</th><th>ุชุงุฑูุฎ ุงูุงุณุชุญูุงู</th><th>ุงูุญุงูุฉ</th></tr></thead>
          <tbody id="patientReceivableTable"></tbody>
        </table>
      </div>
      <div class="card">
        <h2>ุงูุชูุจููุงุช ุงูุทุจูุฉ</h2>
        <div class="grid grid-2">
          <div><label>ุงููุฑูุถ</label><select id="alertPatient"></select></div>
          <div><label>ููุน ุงูุชูุจูู</label><input id="alertType" placeholder="ุญุณุงุณูุฉุ ูุฑุถ ูุฒูู..." /></div>
          <div><label>ุงูุฎุทูุฑุฉ</label><select id="alertSeverity"><option value="low">ููุฎูุถ</option><option value="medium">ูุชูุณุท</option><option value="high">ูุฑุชูุน</option></select></div>
          <div><label>ููุงุญุธุงุช</label><textarea id="alertNotes"></textarea></div>
        </div>
        <div class="flex" style="margin-top:1rem;justify-content:flex-end;">
          <button class="btn" onclick="saveMedicalAlert()">ุฅุถุงูุฉ ุชูุจูู</button>
        </div>
        <div id="medicalAlertsList" style="margin-top:1rem;"></div>
      </div>`;
    }
    Views.patients=Views_patients;

    function Views_appointments(){
      return `
      <div class="card">
        <h2>ุญุฌุฒ ููุนุฏ</h2>
        <div class="grid grid-2">
          <div><label>ุงููุฑูุถ</label><select id="appointmentPatient"></select></div>
          <div><label>ุงูุฎุฏูุฉ</label><input id="appointmentService" /></div>
          <div><label>ุงูุทุจูุจ</label><input id="appointmentDoctor" /></div>
          <div><label>ุงูุชุงุฑูุฎ</label><input id="appointmentDate" type="datetime-local" /></div>
          <div><label>ุงููุชุฑุฉ</label><select id="appointmentPeriod"><option value="morning">ุตุจุงุญ</option><option value="evening">ูุณุงุก</option></select></div>
          <div><label>ุงูุญุงูุฉ</label><select id="appointmentStatus"><option value="scheduled">ูุฌุฏูู</option><option value="in-progress">ููุฏ ุงูุชูููุฐ</option><option value="completed">ุชู</option><option value="cancelled">ููุบู</option></select></div>
          <div><label>ุงููุฏููุน</label><input id="appointmentPaid" type="number" min="0" step="0.05" /></div>
          <div><label>ุงููุชุจูู</label><input id="appointmentDue" type="number" min="0" step="0.05" /></div>
          <div class="full"><label>ููุงุญุธุงุช</label><textarea id="appointmentNotes"></textarea></div>
        </div>
        <div class="flex" style="margin-top:1rem;justify-content:flex-end;">
          <button class="btn" onclick="saveAppointment()">ุญูุธ ุงูููุนุฏ</button>
        </div>
      </div>
      <div class="card">
        <div class="flex" style="justify-content:space-between;align-items:center;">
          <h2>ุฌุฏูู ุงูููุงุนูุฏ</h2>
          <div class="flex">
            <select id="appointmentFilterDoctor" onchange="renderAppointmentsTable()"><option value="">ูู ุงูุฃุทุจุงุก</option></select>
            <select id="appointmentFilterStatus" onchange="renderAppointmentsTable()"><option value="">ูู ุงูุญุงูุงุช</option><option value="scheduled">ูุฌุฏูู</option><option value="in-progress">ููุฏ ุงูุชูููุฐ</option><option value="completed">ุชู</option><option value="cancelled">ููุบู</option></select>
          </div>
        </div>
        <table>
          <thead><tr><th>ุงููุฑูุถ</th><th>ุงูุฎุฏูุฉ</th><th>ุงูุทุจูุจ</th><th>ุงูุชุงุฑูุฎ</th><th>ุงูุญุงูุฉ</th><th>ุงููุจุงูุบ</th><th>ุฎูุงุฑุงุช</th></tr></thead>
          <tbody id="appointmentsTable"></tbody>
        </table>
      </div>`;
    }
    Views.appointments=Views_appointments;

    function Views_suppliers(){
      return `
      <div class="card">
        <h2>ูุงุชูุฑุฉ ูุดุชุฑูุงุช</h2>
        <div class="grid grid-2">
          <div><label>ุงูููุฑุฏ</label><input id="invoiceSupplier" /></div>
          <div><label>ุฅูู ุงููุฎุฒููุ</label><select id="invoiceToStock"><option value="yes">ูุนู</option><option value="no">ุงุณุชููุงู</option></select></div>
          <div><label>ุงููููุฉ</label><input id="invoiceAmount" type="number" min="0" step="0.05" /></div>
          <div><label>ููุงุญุธุงุช</label><textarea id="invoiceNotes"></textarea></div>
        </div>
        <div class="flex" style="margin-top:1rem;justify-content:flex-end;">
          <button class="btn" onclick="savePurchaseInvoice()">ุญูุธ</button>
        </div>
      </div>
      <div class="card">
        <h2>ูุฑุชุฌุนุงุช ูุคุฌูุฉ</h2>
        <div class="grid grid-2">
          <div><label>ุงูููุฑุฏ</label><input id="returnSupplier" /></div>
          <div><label>ุงููููุฉ</label><input id="returnAmount" type="number" min="0" step="0.05" /></div>
          <div><label>ุงูุญุงูุฉ</label><select id="returnStatus"><option value="pending">Pending</option><option value="settled">Settled</option></select></div>
          <div><label>ููุงุญุธุงุช</label><textarea id="returnNotes"></textarea></div>
        </div>
        <div class="flex" style="margin-top:1rem;justify-content:flex-end;">
          <button class="btn" onclick="saveSupplierReturn()">ุญูุธ</button>
        </div>
        <table style="margin-top:1.5rem;">
          <thead><tr><th>ุงููุฑุฌุน</th><th>ุงูููุฑุฏ</th><th>ุงููููุฉ</th><th>ุงูุญุงูุฉ</th><th>ุฎูุงุฑุงุช</th></tr></thead>
          <tbody id="returnsTable"></tbody>
        </table>
      </div>`;
    }
    Views.suppliers=Views_suppliers;

    function Views_labs(){
      return `
      <div class="card">
        <h2>ุทูุจ ูุนูู</h2>
        <div class="grid grid-2">
          <div><label>ุงููุฑูุถ</label><input id="labPatient" /></div>
          <div><label>ุงูุทุจูุจ</label><input id="labDoctor" /></div>
          <div><label>ุงูุฎุฏูุฉ</label><input id="labService" /></div>
          <div><label>ุนุฏุฏ ุงููุทุน</label><input id="labUnits" type="number" min="1" value="1" /></div>
          <div><label>ุชุงุฑูุฎ ุงูุฅุฑุณุงู</label><input id="labSent" type="date" /></div>
          <div><label>ุชุงุฑูุฎ ูุชููุน</label><input id="labExpected" type="date" /></div>
          <div><label>ุงูุชูููุฉ</label><input id="labCost" type="number" min="0" step="0.05" /></div>
          <div><label>ุงูุญุงูุฉ</label><select id="labStatus">
            <option value="requested">ูุทููุจ</option>
            <option value="in-progress">ููุฏ ุงูุชูููุฐ</option>
            <option value="delayed">ูุชุฃุฎุฑ</option>
            <option value="done">ุชู</option>
            <option value="cancelled">ููุบู</option>
            <option value="transferred">ูุญููู</option>
          </select></div>
          <div><label>ููู ุงููุชูุฌุฉ</label><input type="file" id="labResultFile" accept="image/*,.pdf" /></div>
          <div class="full"><label>ููุงุญุธุงุช</label><textarea id="labNotes"></textarea></div>
          <div class="full"><label>ูุชูุฌุฉ/ุชูุฑูุฑ ุงููุนูู</label><textarea id="labResult"></textarea></div>
        </div>
        <div class="flex" style="margin-top:1rem;justify-content:flex-end;">
          <button class="btn" onclick="saveLabOrder()">ุญูุธ</button>
          <button class="btn secondary" onclick="labSummaryPDF()">PDF</button>
        </div>
      </div>
      <div class="card">
        <div class="flex" style="justify-content:space-between;align-items:center;">
          <h2>ุทูุจุงุช ุงููุนูู</h2>
          <div id="labStats" class="badge">ุฌุงุฑู ุงูุชุญููู...</div>
        </div>
        <table>
          <thead><tr><th>ุงููุฑุฌุน</th><th>ุงููุฑูุถ</th><th>ุงูุฎุฏูุฉ</th><th>ุงูุญุงูุฉ</th><th>ุงูุชูููุฉ</th><th>ุงููุชูุฌุฉ</th><th>ุฎูุงุฑุงุช</th></tr></thead>
          <tbody id="labsTable"></tbody>
        </table>
      </div>`;
    }
    Views.labs=Views_labs;

    function Views_inventory(){
      return `
      <div class="card">
        <h2>ุจุทุงูุฉ ูุงุฏุฉ</h2>
        <div class="grid grid-2">
          <div><label>ุงูุงุณู</label><input id="itemName" /></div>
          <div><label>ุงููููุฉ</label><input id="itemQty" type="number" min="0" /></div>
          <div><label>ุงูุญุฏ ุงูุฃุฏูู</label><input id="itemMin" type="number" min="0" /></div>
          <div><label>ุชุงุฑูุฎ ุงูุตูุงุญูุฉ</label><input id="itemExpiry" type="date" /></div>
        </div>
        <div class="flex" style="margin-top:1rem;justify-content:flex-end;">
          <button class="btn" onclick="saveInventoryItem()">ุญูุธ</button>
        </div>
      </div>
      <div class="card">
        <div class="flex" style="justify-content:space-between;align-items:center;">
          <h2>ุงูููุงุฏ</h2>
          <button class="btn secondary" onclick="inventoryPDF()">PDF</button>
        </div>
        <table>
          <thead><tr><th>ุงูุงุณู</th><th>ุงููููุฉ</th><th>ุงูุญุฏ ุงูุฃุฏูู</th><th>ุงูุตูุงุญูุฉ</th><th>ุชูุจูู</th><th>ุฎูุงุฑุงุช</th></tr></thead>
          <tbody id="inventoryTable"></tbody>
        </table>
      </div>`;
    }
    Views.inventory=Views_inventory;

    function Views_finance(){
      return `
      <div class="card">
        <h2>ูุตุฑููุงุช ุชุดุบูููุฉ ุฏูุฑูุฉ</h2>
        <div class="grid grid-2">
          <div><label>ุงุณู ุงููุตุฑูู</label><input id="expenseName" /></div>
          <div><label>ุงููููุฉ</label><input id="expenseAmount" type="number" min="0" step="0.05" /></div>
          <div><label>ุงูุชูุฑุงุฑ</label><select id="expenseFrequency"><option value="monthly">ุดูุฑู</option><option value="quarterly">ุฑุจุน ุณููู</option><option value="yearly">ุณููู</option></select></div>
          <div><label>ุชุงุฑูุฎ ุงูุงุณุชุญูุงู ุงููุงุฏู</label><input id="expenseNextDue" type="date" /></div>
          <div><label>ูุฑูุฒ ุงูุชูููุฉ</label><input id="expenseCostCenter" placeholder="ุนูุงุฏุฉ 1ุ ุงุณุชูุจุงู..." /></div>
        </div>
        <div class="flex" style="margin-top:1rem;justify-content:flex-end;">
          <button class="btn" onclick="saveRecurringExpense()">ุญูุธ ุงููุตุฑูู</button>
          <button class="btn secondary" onclick="postRecurringExpenses()">ุชุฑุญูู ูุตุฑููุงุช ูุณุชุญูุฉ</button>
        </div>
        <table style="margin-top:1.5rem;">
          <thead><tr><th>ุงููุตุฑูู</th><th>ุงููููุฉ</th><th>ุงูุชูุฑุงุฑ</th><th>ุงูุงุณุชุญูุงู ุงูุชุงูู</th><th>ูุฑูุฒ ุงูุชูููุฉ</th><th>ุญุงูุฉ</th></tr></thead>
          <tbody id="operatingExpensesTable"></tbody>
        </table>
      </div>
      <div class="card">
        <h2>ุงูุฃุตูู ุงูุซุงุจุชุฉ ูุงูุฅููุงู</h2>
        <div class="grid grid-2">
          <div><label>ุงุณู ุงูุฃุตู</label><input id="assetName" /></div>
          <div><label>ุชุงุฑูุฎ ุงูุดุฑุงุก</label><input id="assetPurchase" type="date" /></div>
          <div><label>ุงูุชูููุฉ</label><input id="assetCost" type="number" min="0" step="0.05" /></div>
          <div><label>ุงูุนูุฑ ุงูุฅูุชุงุฌู (ุฃุดูุฑ)</label><input id="assetLife" type="number" min="1" /></div>
          <div><label>ูุฑูุฒ ุงูุชูููุฉ</label><input id="assetCenter" /></div>
        </div>
        <div class="flex" style="margin-top:1rem;justify-content:flex-end;">
          <button class="btn" onclick="saveFixedAsset()">ุญูุธ ุงูุฃุตู</button>
          <button class="btn secondary" onclick="postMonthlyDepreciation()">ุฅููุงู ุงูุดูุฑ ุงูุญุงูู</button>
        </div>
        <table style="margin-top:1.5rem;">
          <thead><tr><th>ุงูุฃุตู</th><th>ุงูุชูููุฉ</th><th>ุงูุฅููุงู ุงูุดูุฑู</th><th>ุงููุฌูุน</th><th>ุขุฎุฑ ุดูุฑ</th></tr></thead>
          <tbody id="fixedAssetsTable"></tbody>
        </table>
      </div>
      <div class="card">
        <h2>ุฅููุงู ุงููุชุฑุงุช</h2>
        <div class="flex" style="gap:1rem;flex-wrap:wrap;">
          <button class="btn" onclick="closeMonth()">ุฅููุงู ุงูุดูุฑ</button>
          <button class="btn" onclick="closeYear()">ุฅููุงู ุงูุณูุฉ</button>
        </div>
        <table style="margin-top:1.5rem;">
          <thead><tr><th>ุงููุชุฑุฉ</th><th>ุงูููุน</th><th>ุงูุฅูุฑุงุฏุงุช</th><th>ุงููุตุฑููุงุช</th><th>ุตุงูู ุงูุฑุจุญ</th></tr></thead>
          <tbody id="periodClosingsTable"></tbody>
        </table>
      </div>`;
    }
    Views.finance=Views_finance;

    function Views_doctors(){
      return `
      <div class="card">
        <h2>ุทุจูุจ</h2>
        <div class="grid grid-2">
          <div><label>ุงูุงุณู</label><input id="doctorName" /></div>
          <div><label>ุงููุณุจุฉ (%)</label><input id="doctorShare" type="number" min="30" max="50" /></div>
        </div>
        <div class="flex" style="margin-top:1rem;justify-content:flex-end;">
          <button class="btn" onclick="saveDoctor()">ุญูุธ</button>
        </div>
      </div>
      <div class="card">
        <div class="flex" style="justify-content:space-between;align-items:center;">
          <h2>ุฑุจุญูุฉ ุงูุฃุทุจุงุก</h2>
          <button class="btn secondary" onclick="doctorProfitPDF()">PDF</button>
        </div>
        <table>
          <thead><tr><th>ุงูุทุจูุจ</th><th>ุงูุฅูุฑุงุฏุงุช</th><th>ุชูููุฉ ุงููุนูู</th><th>ุงููุณุจุฉ</th><th>ูุตูุจ ุงูุทุจูุจ</th><th>ูุณุงููุฉ ุงูุนูุงุฏุฉ</th></tr></thead>
          <tbody id="doctorTable"></tbody>
        </table>
      </div>`;
    }
    Views.doctors=Views_doctors;

    function Views_prescriptions(){
      return `
      <div class="card">
        <h2>ูุตูุฉ ุทุจูุฉ ุฌุฏูุฏุฉ</h2>
        <div class="grid grid-2">
          <div><label>ุงููุฑูุถ</label><select id="prescriptionPatient"></select></div>
          <div><label>ุงูุทุจูุจ</label><input id="prescriptionDoctor" /></div>
          <div><label>ุชุงุฑูุฎ ุงููุตูุฉ</label><input id="prescriptionDate" type="date" /></div>
          <div><label>ูุฏุฉ ุงูุงุณุชุฎุฏุงู (ุฃูุงู)</label><input id="prescriptionDuration" type="number" min="1" /></div>
          <div class="full"><label>ุงูุฃุฏููุฉ ูุงูุชุนูููุงุช</label><textarea id="prescriptionNotes"></textarea></div>
        </div>
        <div class="flex" style="margin-top:1rem;justify-content:flex-end;">
          <button class="btn" onclick="savePrescription()">ุญูุธ ุงููุตูุฉ</button>
        </div>
      </div>
      <div class="card">
        <h2>ุงููุตูุงุช</h2>
        <table>
          <thead><tr><th>ุงููุฑูุถ</th><th>ุงูุทุจูุจ</th><th>ุงูุชุงุฑูุฎ</th><th>ุงููุฏุฉ</th><th>ุฎูุงุฑุงุช</th></tr></thead>
          <tbody id="prescriptionsTable"></tbody>
        </table>
      </div>`;
    }
    Views.prescriptions=Views_prescriptions;

    function Views_controls(){
      return `
      <div class="card">
        <h2>ุชุณููุฉ ุจูููุฉ</h2>
        <div class="grid grid-2">
          <div><label>ุงูุชุงุฑูุฎ</label><input id="reconDate" type="date" /></div>
          <div><label>ุฑุตูุฏ ุงูุจูู</label><input id="reconBank" type="number" step="0.05" /></div>
          <div><label>ุฑุตูุฏ ุงูุฏูุงุชุฑ</label><input id="reconBooks" type="number" step="0.05" /></div>
          <div><label>ูุฑูู ูุณุฌูุฉ</label><textarea id="reconNotes"></textarea></div>
        </div>
        <div class="flex" style="margin-top:1rem;justify-content:flex-end;">
          <button class="btn" onclick="saveBankReconciliation()">ุชุณุฌูู ุชุณููุฉ</button>
        </div>
        <table style="margin-top:1.5rem;">
          <thead><tr><th>ุงูุชุงุฑูุฎ</th><th>ุฑุตูุฏ ุงูุจูู</th><th>ุฑุตูุฏ ุงูุฏูุงุชุฑ</th><th>ุงููุฑู</th><th>ุญุงูุฉ ุงููุฑุงุฌุนุฉ</th><th>ุฎูุงุฑุงุช</th></tr></thead>
          <tbody id="bankReconciliationTable"></tbody>
        </table>
      </div>
      <div class="card">
        <h2>ูุฑุงุฌุนุฉ ุฏุงุฎููุฉ</h2>
        <button class="btn" onclick="runInternalReview()">ุชุดุบูู ูุฑุงุฌุนุฉ</button>
        <div id="internalReviewReport" style="margin-top:1rem;"></div>
      </div>`;
    }
    Views.controls=Views_controls;

    function Views_reports(){
      return `
      <div class="card">
        <h2>ูุฑูุฒ ุงูุชูุงุฑูุฑ</h2>
        <div class="grid grid-2">
          <button class="btn" onclick="dailyReportPDF()">ุชูุฑูุฑ ูููู</button>
          <button class="btn" onclick="weeklyReportPDF()">ุชูุฑูุฑ ุฃุณุจูุนู</button>
          <button class="btn" onclick="monthlyReportPDF()">ุชูุฑูุฑ ุดูุฑู</button>
          <button class="btn" onclick="labSummaryPDF()">ูุดู ุงููุนุงูู</button>
          <button class="btn" onclick="supplierAgingPDF()">ูุดู ุงูููุฑุฏูู</button>
          <button class="btn" onclick="patientsAgingPDF()">ุฃุนูุงุฑ ุงูุฐูู</button>
          <button class="btn" onclick="inventoryPDF()">ุงููุฎุฒูู</button>
          <button class="btn" onclick="clinicProfitPDF()">ุฑุจุญูุฉ ุงูุนูุงุฏุฉ</button>
          <button class="btn" onclick="doctorProfitPDF()">ุฑุจุญูุฉ ุงูุฃุทุจุงุก</button>
          <button class="btn" onclick="journalPDF()">ุฏูุชุฑ ุงูููููุฉ</button>
          <button class="btn" onclick="auditLogPDF()">ุณุฌู ุงูุชุฏููู</button>
          <button class="btn" onclick="exportDataJSON()">ุชุตุฏูุฑ JSON</button>
          <button class="btn" onclick="importDataJSON()">ุงุณุชูุฑุงุฏ JSON</button>
        </div>
      </div>
      <div class="card">
        <h2>ุจุญุซ ูุฑุฌุนู</h2>
        <input id="referenceSearch" placeholder="ุฃุฏุฎู ุฑูู ุงููุฑุฌุน" />
        <button class="btn" style="margin-top:1rem;" onclick="searchReference()">ุจุญุซ</button>
        <div id="referenceResult" style="margin-top:1rem;"></div>
      </div>`;
    }
    Views.reports=Views_reports;

    function Views_settings(){
      return `
      <div class="card">
        <h2>ุฅุนุฏุงุฏุงุช ุนุงูุฉ</h2>
        <div class="grid grid-2">
          <div><label>ุงุณู ุงูุนูุงุฏุฉ</label><input id="clinicName" value="${App.settings.clinicName}" /></div>
          <div><label>ุงูุดุนุงุฑ (Base64)</label><textarea id="clinicLogo">${App.settings.clinicLogo}</textarea></div>
          <div><label>ุงูุนููุฉ</label><input id="clinicCurrency" value="${App.settings.currency}" /></div>
          <div><label>ุชูุฒูุน ุงููุตุฑููุงุช</label><select id="overheadAllocation"><option value="revenue" ${App.settings.overheadAllocation==='revenue'?'selected':''}>ุญุณุจ ุงูุฅูุฑุงุฏุงุช</option><option value="equal" ${App.settings.overheadAllocation==='equal'?'selected':''}>ุจุงูุชุณุงูู</option></select></div>
        </div>
        <div class="flex" style="margin-top:1rem;justify-content:flex-end;">
          <button class="btn" onclick="saveSettings()">ุญูุธ</button>
        </div>
      </div>
      <div class="card">
        <h2>ูููุงุช ุงููุฑูุฑ</h2>
        <div class="grid grid-2">
          <div><label>ุงูุฅุนุฏุงุฏุงุช</label><input id="pwdSettings" type="password" placeholder="ุงูุชุจ ูููุฉ ูุฑูุฑ ุฌุฏูุฏุฉ" /></div>
          <div><label>ุงูุฅููุงู</label><input id="pwdClose" type="password" placeholder="ุงูุชุจ ูููุฉ ูุฑูุฑ ุฌุฏูุฏุฉ" /></div>
          <div><label>ุงูุฅุฌุฑุงุกุงุช ุงูุญุณุงุณุฉ</label><input id="pwdDanger" type="password" placeholder="ุงูุชุจ ูููุฉ ูุฑูุฑ ุฌุฏูุฏุฉ" /></div>
        </div>
        <div class="flex" style="margin-top:1rem;justify-content:flex-end;">
          <button class="btn" onclick="savePasswords()">ุชุญุฏูุซ</button>
        </div>
      </div>
      <div class="card">
        <h2>ุงุฎุชุจุงุฑ ุงููุธุงู</h2>
        <button class="btn" onclick="runHealthCheck()">ุชุดุบูู</button>
        <div id="healthReport" style="margin-top:1rem;"></div>
      </div>
      <div class="card">
        <h2>ุฏููู ูุฎุชุตุฑ</h2>
        <p>
          โข ุงุณุชุฎุฏู ูููุงุช ุงููุฑูุฑ ูุญูุงูุฉ ุงูุฅุนุฏุงุฏุงุช ูุงูุฅููุงู ูุงูุฅุฌุฑุงุกุงุช ุงูุญุณุงุณุฉ.<br>
          โข ุฌููุน ุงูุณูุฏุงุช ุชููุฏ ูููุฏูุง ูุฒุฏูุฌุฉ ูุชุธูุฑ ูู ุฏูุชุฑ ุงูููููุฉ.<br>
          โข ุฒุฑ ุงูุชุตุฏูุฑ ูููุฑ ูุณุฎุฉ JSON ููุญูุธ ุงูุฎุงุฑุฌูุ ูุฒุฑ ุงูุงุณุชูุฑุงุฏ ูุนูุฏูุง.<br>
          โข ุงูุฅููุงู ูุชุทูุจ ูููุฉ ุงููุฑูุฑ ุงูุฎุงุตุฉ ููููุน ุงูุชุนุฏูู ุญุชู ุฅุนุงุฏุฉ ูุชุญู ุจูุถุน ุญุณุงุณ.<br>
        </p>
      </div>`;
    }
    Views.settings=Views_settings;

    let debounceTimer;
    function debounced(fn){
      clearTimeout(debounceTimer);
      debounceTimer=setTimeout(fn,250);
    }

    async function fileToBase64(file){
      return new Promise((resolve,reject)=>{
        const reader=new FileReader();
        reader.onload=()=>resolve(reader.result);
        reader.onerror=reject;
        reader.readAsDataURL(file);
      });
    }

    async function saveReceipt(){
      const patient=document.getElementById('receiptPatient')?.value||'';
      const operation=document.getElementById('receiptType')?.value||'service';
      const service=document.getElementById('receiptService').value.trim();
      const doctor=document.getElementById('receiptDoctor').value.trim();
      const amount=parseFloat(document.getElementById('receiptAmount').value);
      const notes=document.getElementById('receiptNotes').value.trim();
      if(!patient){showToast('ุงุฎุชุฑ ุงููุฑูุถ ูู ุงููุงุฆูุฉ','error');return;}
      const patients=await Storage.load('patients');
      if(!patients.some(p=>p.name===patient)){showToast('ุงููุฑูุถ ุบูุฑ ูุณุฌู ูู ุงููุธุงู','error');return;}
      if(operation==='service'&&!service){showToast('ุงูุฎุฏูุฉ ูุทููุจุฉ','error');return;}
      if(isNaN(amount)||amount<=0){showToast('ุงููุจูุบ ุบูุฑ ุตุงูุญ','error');return;}
      let attachment=null;
      const file=document.getElementById('receiptAttachment').files[0];
      if(file){
        if(file.size>10*1024*1024){showToast('ุญุฌู ุงููุฑูู ูุชุฌุงูุฒ ุงูุญุฏ (10MB)','error');return;}
        attachment=await fileToBase64(file);
      }
      const receipts=await Storage.load('receipts');
      const reference=generateReference('RC');
      const record={reference,patient,service,doctor,amount,notes,attachment,status:'active',receiptType:operation,createdAt:new Date().toISOString()};
      try{
        const entries=operation==='settlement'
          ?[
            {account:'ุตูุฏูู ุงูููุฏูุฉ',debit:amount},
            {account:'ุฐูู ุงููุฑุถู',credit:amount}
          ]
          :[
            {account:'ุตูุฏูู ุงูููุฏูุฉ',debit:amount},
            {account:`ุฅูุฑุงุฏุงุช - ${service}`,credit:amount}
          ];
        await recordJournal(entries,{type:'receipt',reference,patient,doctor,receiptType:operation});
      }catch(err){
        showToast('ุชุนุฐุฑ ุญูุธ ุงูุณูุฏ ุจุณุจุจ ุฎูู ูู ุงูููุฏ','error');
        throw err;
      }
      receipts.push(record);
      await Storage.save('receipts',receipts);
      if(operation==='settlement'){
        await applyReceiptToReceivables(patient,amount);
      }
      await logAudit('add',reference,'ุณูุฏ ูุจุถ',record);
      showToast('ุชู ุญูุธ ุงูุณูุฏ');
      renderReceiptsTable();
      renderDoctorsTable();
      renderPatientReceivables();
      renderPatientsTable();
      refreshMiniTrial();
    }

    async function renderReceiptsTable(){
      const list=await Storage.load('receipts');
      const search=(document.getElementById('receiptSearch')||{value:''}).value.trim();
      const body=document.getElementById('receiptTable');
      if(!body) return;
      let mutated=false;
      list.forEach(r=>{
        if(r.state&& !r.status){r.status=r.state;delete r.state;mutated=true;}
        if(!r.status){r.status='active';mutated=true;}
        if(!r.receiptType){r.receiptType='service';mutated=true;}
      });
      if(mutated){await Storage.save('receipts',list);}
      body.innerHTML=list.filter(r=>!search||r.reference.includes(search)).slice(-200).reverse().map(r=>{
        const typeLabel=r.receiptType==='settlement'?'ุชุณุฏูุฏ ุฐูุฉ':'ุฅูุฑุงุฏ ุฎุฏูุฉ';
        const statusLabel=r.status==='active'?'<span class="badge">ุณุงุฑู</span>':'<span class="badge danger">ููุบู</span>';
        return `
        <tr>
          <td>${r.reference}</td>
          <td>${formatDate(r.createdAt)}</td>
          <td>${r.patient}</td>
          <td>${r.service||'-'}</td>
          <td>${typeLabel}</td>
          <td>${formatCurrency(r.amount)}</td>
          <td>${statusLabel}</td>
          <td>
            <button class="btn secondary" onclick="receiptPDF('${r.reference}')">PDF</button>
            <button class="btn danger" onclick="cancelReceipt('${r.reference}')">ุฅูุบุงุก</button>
          </td>
        </tr>`;
      }).join('');
    }

    async function cancelReceipt(reference){
      guardSensitive(async()=>{
        const list=await Storage.load('receipts');
        const item=list.find(r=>r.reference===reference);
        if(!item||item.status==='cancelled') return;
        item.status='cancelled';
        const receiptType=item.receiptType==='settlement'?'settlement':'service';
        const entries=receiptType==='settlement'
          ?[
            {account:'ุฐูู ุงููุฑุถู',debit:item.amount},
            {account:'ุตูุฏูู ุงูููุฏูุฉ',credit:item.amount}
          ]
          :[
            {account:`ุฅูุฑุงุฏุงุช - ${item.service}`,debit:item.amount},
            {account:'ุตูุฏูู ุงูููุฏูุฉ',credit:item.amount}
          ];
        await recordJournal(entries,{type:'reverse',reference,receiptType});
        await Storage.save('receipts',list);
        if(receiptType==='settlement'){
          await reverseReceiptFromReceivables(item.patient,item.amount);
        }
        await logAudit('cancel',reference,'ุฅูุบุงุก ุณูุฏ ูุจุถ');
        showToast('ุชู ุงูุฅูุบุงุก');
        renderReceiptsTable();
        renderPatientReceivables();
        renderPatientsTable();
        refreshMiniTrial();
      });
    }

    async function savePayment(){
      const supplier=document.getElementById('paymentSupplier').value.trim();
      const status=document.getElementById('paymentStatus').value;
      const amount=parseFloat(document.getElementById('paymentAmount').value);
      const notes=document.getElementById('paymentNotes').value.trim();
      if(!supplier||isNaN(amount)||amount<=0){showToast('ุจูุงูุงุช ุบูุฑ ุตุงูุญุฉ','error');return;}
      let attachment=null;
      const file=document.getElementById('paymentAttachment').files[0];
      if(file){
        if(file.size>10*1024*1024){showToast('ุญุฌู ุงููุฑูู ูุชุฌุงูุฒ ุงูุญุฏ (10MB)','error');return;}
        attachment=await fileToBase64(file);
      }
      const payments=await Storage.load('payments');
      const reference=generateReference('PMT');
      const record={reference,supplier,status,amount,notes,attachment,createdAt:new Date().toISOString()};
      payments.push(record);
      await Storage.save('payments',payments);
      await recordJournal([
        {account:`ูุตุฑููุงุช - ${supplier}`,debit:amount},
        {account:'ุตูุฏูู ุงูููุฏูุฉ',credit:amount}
      ],{type:'payment',reference,supplier});
      await logAudit('add',reference,'ุณูุฏ ุตุฑู',record);
      showToast('ุชู ุญูุธ ุงูุณูุฏ');
      renderPaymentsTable();
      refreshMiniTrial();
    }

    async function renderPaymentsTable(){
      const list=await Storage.load('payments');
      const search=(document.getElementById('paymentSearch')||{value:''}).value.trim();
      const body=document.getElementById('paymentTable');
      if(!body) return;
      let mutated=false;
      list.forEach(p=>{
        if(p.state&& !p.status){p.status=p.state;delete p.state;mutated=true;}
        if(!p.status){p.status='pending';mutated=true;}
      });
      if(mutated){await Storage.save('payments',list);}
      body.innerHTML=list.filter(r=>!search||r.reference.includes(search)).slice(-200).reverse().map(r=>{
        let statusLabel='ูุนููู';
        if(r.status==='paid') statusLabel='ูุฏููุน';
        if(r.status==='cancelled') statusLabel='ููุบู';
        return `
        <tr>
          <td>${r.reference}</td>
          <td>${formatDate(r.createdAt)}</td>
          <td>${r.supplier}</td>
          <td>${formatCurrency(r.amount)}</td>
          <td>${statusLabel}</td>
          <td>
            <button class="btn secondary" onclick="paymentPDF('${r.reference}')">PDF</button>
            <button class="btn danger" onclick="cancelPayment('${r.reference}')">ุฅูุบุงุก</button>
          </td>
        </tr>`;
      }).join('');
    }

    async function cancelPayment(reference){
      guardSensitive(async()=>{
        const list=await Storage.load('payments');
        const item=list.find(r=>r.reference===reference);
        if(!item||item.status==='cancelled') return;
        const previousStatus=item.status;
        item.status='cancelled';
        await Storage.save('payments',list);
        await recordJournal([
          {account:'ุตูุฏูู ุงูููุฏูุฉ',debit:item.amount},
          {account:`ูุตุฑููุงุช - ${item.supplier}`,credit:item.amount}
        ],{type:'reverse-payment',reference,previousStatus});
        await logAudit('cancel',reference,'ุฅูุบุงุก ุณูุฏ ุตุฑู');
        showToast('ุชู ุงูุฅูุบุงุก');
        renderPaymentsTable();
        refreshMiniTrial();
      });
    }

    async function renderJournalTable(){
      const list=await Storage.load('journals');
      const filter=(document.getElementById('journalFilter')||{value:''}).value.trim();
      const body=document.getElementById('journalTable');
      if(!body) return;
      body.innerHTML=list.filter(j=>!filter||j.id.includes(filter)||j.entries.some(e=>e.account.includes(filter))).slice(-200).reverse().map(j=>`
        <tr>
          <td>${j.id}</td>
          <td>${formatDate(j.createdAt)}</td>
          <td>${j.meta?.type||''}</td>
          <td>${j.entries.map(e=>`<div class="flex" style="justify-content:space-between;"><span>${e.account}</span><span>${e.debit?formatCurrency(e.debit):''}</span><span>${e.credit?formatCurrency(e.credit):''}</span></div>`).join('')}</td>
        </tr>`).join('');
    }

    async function savePatient(){
      const name=document.getElementById('patientName').value.trim();
      const phone=document.getElementById('patientPhone').value.trim();
      const deposit=parseFloat(document.getElementById('patientDeposit').value||'0');
      const notes=document.getElementById('patientNotes').value.trim();
      if(!name){showToast('ุงุณู ุงููุฑูุถ ูุทููุจ','error');return;}
      const patients=await Storage.load('patients');
      const existing=patients.find(p=>p.name===name);
      if(existing){
        existing.phone=phone;
        existing.deposit=deposit;
        existing.notes=notes;
      }else{
        patients.push({name,phone,balance:0,deposit,notes,createdAt:new Date().toISOString()});
      }
      await Storage.save('patients',patients);
      await logAudit('add',name,'ุชุญุฏูุซ ูุฑูุถ');
      showToast('ุชู ุงูุญูุธ');
      renderPatientsTable();
      await updatePatientSelectors();
    }

    async function renderPatientsTable(){
      const patients=await Storage.load('patients');
      const receivables=await Storage.load('patientReceivables');
      const alerts=await Storage.load('medicalAlerts');
      const body=document.getElementById('patientTable');
      if(!body) return;
      body.innerHTML=patients.map(p=>{
        const outstanding=receivables.filter(r=>r.patient===p.name&&r.balance>0).reduce((s,r)=>s+r.balance,0);
        const patientAlerts=alerts.filter(a=>a.patient===p.name);
        return `<tr>
          <td>${p.name}</td>
          <td>${p.phone}</td>
          <td>${formatCurrency(outstanding)}</td>
          <td>${formatCurrency(p.deposit||0)}</td>
          <td>${patientAlerts.length?`<span class="badge danger">${patientAlerts.length} ุชูุจูู</span>`:'<span class="badge">ูุง ุชูุฌุฏ</span>'}</td>
          <td><button class="btn danger" onclick="deletePatient('${p.name}')">ุญุฐู</button></td>
        </tr>`;
      }).join('');
    }

    async function updatePatientSelectors(){
      const patients=await Storage.load('patients');
      const options=patients.map(p=>`<option value="${p.name}">${p.name}</option>`).join('');
      const withPlaceholder=`<option value="" disabled selected>ุงุฎุชุฑ ุงููุฑูุถ</option>${options}`;
      ['dentalPatient','receivablePatient','alertPatient','appointmentPatient','prescriptionPatient','receiptPatient'].forEach(id=>{
        const el=document.getElementById(id);
        if(el){
          const previous=el.value;
          if(id==='dentalPatient'){
            el.innerHTML=options;
            if(previous&&patients.some(p=>p.name===previous)){
              el.value=previous;
            }else if(patients.length){
              el.value=patients[0].name;
            }
          }else{
            el.innerHTML=withPlaceholder;
            if(previous&&patients.some(p=>p.name===previous)){
              el.value=previous;
            }
          }
        }
      });
    }

    function buildDentalChartGrid(teeth){
      return `<div class="grid" style="grid-template-columns:repeat(auto-fit,minmax(120px,1fr));">${DENTAL_TEETH.map(tooth=>{
        const status=teeth[tooth]||'ุณููู';
        return `<div><label>ุณู ${tooth}</label><select data-tooth="${tooth}" class="tooth-select">${DENTAL_STATUSES.map(s=>`<option value="${s}" ${s===status?'selected':''}>${s}</option>`).join('')}</select></div>`;
      }).join('')}</div>`;
    }

    async function loadDentalChart(){
      const select=document.getElementById('dentalPatient');
      if(!select) return;
      const patient=select.value;
      const charts=await Storage.load('dentalCharts');
      const record=charts.find(c=>c.patient===patient)||{teeth:{}};
      const notes=document.getElementById('dentalNotes');
      if(notes) notes.value=record.notes||'';
      const container=document.getElementById('dentalChart');
      if(container){
        container.innerHTML=buildDentalChartGrid(record.teeth||{});
      }
    }

    async function renderDentalChartControls(){
      await updatePatientSelectors();
      const select=document.getElementById('dentalPatient');
      if(select){
        if(!select.value&&select.options.length){select.value=select.options[0].value;}
        select.onchange=loadDentalChart;
      }
      await loadDentalChart();
    }

    async function saveDentalChart(){
      const select=document.getElementById('dentalPatient');
      if(!select||!select.value){showToast('ุงุฎุชุฑ ุงููุฑูุถ','error');return;}
      const patient=select.value;
      const notes=document.getElementById('dentalNotes')?.value||'';
      const inputs=document.querySelectorAll('#dentalChart .tooth-select');
      const teeth={};
      inputs.forEach(sel=>{teeth[sel.dataset.tooth]=sel.value;});
      const charts=await Storage.load('dentalCharts');
      const existing=charts.find(c=>c.patient===patient);
      if(existing){existing.teeth=teeth;existing.notes=notes;existing.updatedAt=new Date().toISOString();}
      else{charts.push({patient,teeth,notes,updatedAt:new Date().toISOString()});}
      await Storage.save('dentalCharts',charts);
      await logAudit('update',patient,'ุชุญุฏูุซ ุณุฌู ุณูู',{teeth});
      showToast('ุชู ุญูุธ ุงูุณุฌู ุงูุณูู');
    }

    async function savePatientReceivable(){
      const patient=document.getElementById('receivablePatient')?.value;
      const amount=parseFloat(document.getElementById('receivableAmount')?.value||'0');
      const due=document.getElementById('receivableDue')?.value;
      const notes=document.getElementById('receivableNotes')?.value||'';
      if(!patient||isNaN(amount)||amount<=0||!due){showToast('ุจูุงูุงุช ุงูุฐูุฉ ุบูุฑ ููุชููุฉ','error');return;}
      const receivables=await Storage.load('patientReceivables');
      receivables.push({id:Date.now(),patient,amount,balance:amount,due,notes,status:'open',createdAt:new Date().toISOString()});
      await Storage.save('patientReceivables',receivables);
      await logAudit('add',patient,'ุฅุถุงูุฉ ุฐูุฉ ูุฑูุถ',{amount,due});
      showToast('ุชู ุชุณุฌูู ุงูุฐูุฉ');
      renderPatientReceivables();
      renderPatientsTable();
    }

    async function applyReceiptToReceivables(patient,amount){
      if(!patient||amount<=0) return;
      const receivables=await Storage.load('patientReceivables');
      let remaining=amount;
      for(const rec of receivables.filter(r=>r.patient===patient&&r.balance>0).sort((a,b)=>new Date(a.due)-new Date(b.due))){
        if(remaining<=0) break;
        const take=Math.min(rec.balance,remaining);
        rec.balance-=take;
        if(rec.balance<=0){rec.status='settled';}
        remaining-=take;
      }
      await Storage.save('patientReceivables',receivables);
    }

    async function reverseReceiptFromReceivables(patient,amount){
      if(!patient||amount<=0) return;
      const receivables=await Storage.load('patientReceivables');
      let remaining=amount;
      for(const rec of receivables.filter(r=>r.patient===patient).sort((a,b)=>new Date(b.due)-new Date(a.due))){
        if(remaining<=0) break;
        const add=Math.min(rec.amount-rec.balance,remaining);
        rec.balance+=add;
        if(rec.balance>0){rec.status='open';}
        remaining-=add;
      }
      await Storage.save('patientReceivables',receivables);
    }

    function receivableStatus(rec){
      if(rec.balance<=0) return 'ูุณุฏุฏ';
      const diff=(new Date(rec.due)-new Date())/(1000*60*60*24);
      if(diff<0) return 'ูุชุฃุฎุฑ';
      if(diff<=7) return 'ูุณุชุญู ูุฑูุจุงู';
      return 'ูุดุท';
    }

    async function renderPatientReceivables(){
      const receivables=await Storage.load('patientReceivables');
      const body=document.getElementById('patientReceivableTable');
      if(!body) return;
      body.innerHTML=receivables.slice(-200).reverse().map(rec=>`
        <tr>
          <td>${rec.patient}</td>
          <td>${formatCurrency(rec.amount)}</td>
          <td>${formatCurrency(rec.balance)}</td>
          <td>${formatDate(rec.due)}</td>
          <td>${receivableStatus(rec)}</td>
        </tr>`).join('');
    }

    async function saveMedicalAlert(){
      const patient=document.getElementById('alertPatient')?.value;
      const type=document.getElementById('alertType')?.value.trim();
      const severity=document.getElementById('alertSeverity')?.value;
      const notes=document.getElementById('alertNotes')?.value||'';
      if(!patient||!type){showToast('ุฃุฏุฎู ุชูุงุตูู ุงูุชูุจูู','error');return;}
      const alerts=await Storage.load('medicalAlerts');
      alerts.push({id:Date.now(),patient,type,severity,notes,createdAt:new Date().toISOString()});
      await Storage.save('medicalAlerts',alerts);
      await logAudit('add',patient,'ุชูุจูู ุทุจู',{type,severity});
      showToast('ุชู ุฅุถุงูุฉ ุงูุชูุจูู');
      renderMedicalAlerts();
      renderPatientsTable();
    }

    async function renderMedicalAlerts(){
      const container=document.getElementById('medicalAlertsList');
      if(!container) return;
      const alerts=await Storage.load('medicalAlerts');
      if(!alerts.length){container.innerHTML='<span class="badge">ูุง ุชูุฌุฏ ุชูุจููุงุช</span>';return;}
      container.innerHTML='<ul>'+alerts.slice(-200).reverse().map(alert=>`<li>${formatDate(alert.createdAt)} โ <strong>${alert.patient}</strong> (${alert.severity}) : ${alert.type} <button class="btn danger" style="padding:.2rem .6rem;" onclick="deleteMedicalAlert(${alert.id})">ุญุฐู</button></li>`).join('')+'</ul>';
    }

    async function deleteMedicalAlert(id){
      guardSensitive(async()=>{
        let alerts=await Storage.load('medicalAlerts');
        alerts=alerts.filter(a=>a.id!==id);
        await Storage.save('medicalAlerts',alerts);
        renderMedicalAlerts();
        renderPatientsTable();
      });
    }

    async function saveAppointment(){
      await updatePatientSelectors();
      const patient=document.getElementById('appointmentPatient')?.value;
      const service=document.getElementById('appointmentService')?.value.trim();
      const doctor=document.getElementById('appointmentDoctor')?.value.trim();
      const when=document.getElementById('appointmentDate')?.value;
      const period=document.getElementById('appointmentPeriod')?.value;
      const status=document.getElementById('appointmentStatus')?.value;
      const paid=parseFloat(document.getElementById('appointmentPaid')?.value||'0');
      const due=parseFloat(document.getElementById('appointmentDue')?.value||'0');
      const notes=document.getElementById('appointmentNotes')?.value||'';
      if(!patient||!service||!doctor||!when){showToast('ุจูุงูุงุช ุงูููุนุฏ ุบูุฑ ููุชููุฉ','error');return;}
      const appointments=await Storage.load('appointments');
      const record={id:Date.now(),patient,service,doctor,date:when,period,status,paid,due,notes,createdAt:new Date().toISOString()};
      appointments.push(record);
      await Storage.save('appointments',appointments);
      if(due>0){
        const receivables=await Storage.load('patientReceivables');
        receivables.push({id:Date.now()+1,patient,amount:due,balance:due,due:when.slice(0,10),notes:`${service} โ ููุนุฏ`,status:'open',createdAt:new Date().toISOString()});
        await Storage.save('patientReceivables',receivables);
      }
      await logAudit('add',record.id,'ููุนุฏ ุฌุฏูุฏ',record);
      showToast('ุชู ุญูุธ ุงูููุนุฏ');
      renderAppointmentsTable();
      renderAppointmentsTomorrow();
      renderPatientReceivables();
      renderPatientsTable();
    }

    async function populateAppointmentFilters(){
      const doctorSelect=document.getElementById('appointmentFilterDoctor');
      if(doctorSelect){
        const doctors=await Storage.load('doctors');
        const current=doctorSelect.value;
        doctorSelect.innerHTML='<option value="">ูู ุงูุฃุทุจุงุก</option>'+doctors.map(d=>`<option value="${d.name}">${d.name}</option>`).join('');
        if(current) doctorSelect.value=current;
      }
    }

    async function renderAppointmentsTable(){
      await updatePatientSelectors();
      await populateAppointmentFilters();
      const appointments=await Storage.load('appointments');
      const doctorFilter=document.getElementById('appointmentFilterDoctor')?.value||'';
      const statusFilter=document.getElementById('appointmentFilterStatus')?.value||'';
      const body=document.getElementById('appointmentsTable');
      if(!body) return;
      body.innerHTML=appointments.slice(-500).reverse().filter(app=>{
        return (!doctorFilter||app.doctor===doctorFilter)&&(!statusFilter||app.status===statusFilter);
      }).map(app=>`<tr>
        <td>${app.patient}</td>
        <td>${app.service}</td>
        <td>${app.doctor}</td>
        <td>${new Date(app.date).toLocaleString('ar-SA')}</td>
        <td>${app.status}</td>
        <td>${formatCurrency(app.paid||0)} / ${formatCurrency(app.due||0)}</td>
        <td>
          <button class="btn" onclick="markAppointment(${app.id},'completed')">ุชู</button>
          <button class="btn secondary" onclick="markAppointment(${app.id},'in-progress')">ููุฏ ุงูุชูููุฐ</button>
          <button class="btn danger" onclick="markAppointment(${app.id},'cancelled')">ุฅูุบุงุก</button>
        </td>
      </tr>`).join('');
    }

    async function markAppointment(id,status){
      const appointments=await Storage.load('appointments');
      const appointment=appointments.find(a=>a.id===id);
      if(!appointment) return;
      appointment.status=status;
      appointment.updatedAt=new Date().toISOString();
      await Storage.save('appointments',appointments);
      await logAudit('update',id,'ุชุญุฏูุซ ุญุงูุฉ ููุนุฏ',{status});
      showToast('ุชู ุชุญุฏูุซ ุงูููุนุฏ');
      renderAppointmentsTable();
      renderAppointmentsTomorrow();
    }

    async function deletePatient(name){
      guardSensitive(async()=>{
        let patients=await Storage.load('patients');
        patients=patients.filter(p=>p.name!==name);
        await Storage.save('patients',patients);
        await logAudit('delete',name,'ุญุฐู ูุฑูุถ');
        renderPatientsTable();
        await updatePatientSelectors();
      });
    }

    async function savePurchaseInvoice(){
      const supplier=document.getElementById('invoiceSupplier').value.trim();
      const toStock=document.getElementById('invoiceToStock').value;
      const amount=parseFloat(document.getElementById('invoiceAmount').value);
      const notes=document.getElementById('invoiceNotes').value.trim();
      if(!supplier||isNaN(amount)||amount<=0){showToast('ุจูุงูุงุช ุบูุฑ ุตุงูุญุฉ','error');return;}
      const invoices=await Storage.load('purchaseInvoices');
      const reference=generateReference('PI');
      const invoice={reference,supplier,toStock,amount,notes,createdAt:new Date().toISOString()};
      invoices.push(invoice);
      await Storage.save('purchaseInvoices',invoices);
      if(toStock==='yes'){
        await recordJournal([
          {account:'ุงููุฎุฒูู',debit:amount},
          {account:'ุตูุฏูู ุงูููุฏูุฉ',credit:amount}
        ],{type:'purchase-stock',reference,supplier});
      }else{
        await recordJournal([
          {account:`ูุตุฑููุงุช - ${supplier}`,debit:amount},
          {account:'ุตูุฏูู ุงูููุฏูุฉ',credit:amount}
        ],{type:'purchase-expense',reference,supplier});
      }
      await logAudit('add',reference,'ูุงุชูุฑุฉ ูุดุชุฑูุงุช',invoice);
      showToast('ุชู ุญูุธ ุงููุงุชูุฑุฉ');
      renderSupplierReturns();
      renderInventoryTable();
      refreshMiniTrial();
    }

    async function saveSupplierReturn(){
      const supplier=document.getElementById('returnSupplier').value.trim();
      const amount=parseFloat(document.getElementById('returnAmount').value);
      const status=document.getElementById('returnStatus').value;
      const notes=document.getElementById('returnNotes').value.trim();
      if(!supplier||isNaN(amount)||amount<=0){showToast('ุจูุงูุงุช ุบูุฑ ุตุงูุญุฉ','error');return;}
      const returns=await Storage.load('supplierReturns');
      const reference=generateReference('SR');
      const record={reference,supplier,amount,status,notes,createdAt:new Date().toISOString()};
      returns.push(record);
      await Storage.save('supplierReturns',returns);
      if(status==='pending'){
        await recordJournal([
          {account:'ุฑุตูุฏ ูุฑุชุฌุน ููุฑุฏ ูุนูู',debit:amount},
          {account:'ุตูุฏูู ุงูููุฏูุฉ',credit:amount}
        ],{type:'supplier-return',reference,supplier});
      }else{
        await recordJournal([
          {account:'ุฐูู ุงูููุฑุฏูู',debit:amount},
          {account:'ุฑุตูุฏ ูุฑุชุฌุน ููุฑุฏ ูุนูู',credit:amount}
        ],{type:'supplier-settlement',reference,supplier});
      }
      await logAudit('add',reference,'ูุฑุชุฌุน ููุฑุฏ',record);
      showToast('ุชู ุงูุญูุธ');
      renderSupplierReturns();
      refreshMiniTrial();
    }

    async function renderSupplierReturns(){
      const returns=await Storage.load('supplierReturns');
      const body=document.getElementById('returnsTable');
      if(!body) return;
      body.innerHTML=returns.slice(-200).reverse().map(r=>{
        const statusLabel=r.status==='pending'?'ููุฏ ุงูุชุณููุฉ':r.status==='settled'?'ูุณูู':r.status;
        return `
        <tr>
          <td>${r.reference}</td>
          <td>${r.supplier}</td>
          <td>${formatCurrency(r.amount)}</td>
          <td>${statusLabel}</td>
          <td><button class="btn danger" onclick="deleteSupplierReturn('${r.reference}')">ุญุฐู</button></td>
        </tr>`;
      }).join('');
    }

    async function deleteSupplierReturn(reference){
      guardSensitive(async()=>{
        let returns=await Storage.load('supplierReturns');
        returns=returns.filter(r=>r.reference!==reference);
        await Storage.save('supplierReturns',returns);
        await logAudit('delete',reference,'ุญุฐู ูุฑุชุฌุน');
        renderSupplierReturns();
      });
    }

    async function saveLabOrder(){
      const patient=document.getElementById('labPatient').value.trim();
      const doctor=document.getElementById('labDoctor').value.trim();
      const service=document.getElementById('labService').value.trim();
      const units=parseInt(document.getElementById('labUnits').value||'1');
      const sent=document.getElementById('labSent').value;
      const expected=document.getElementById('labExpected').value;
      const cost=parseFloat(document.getElementById('labCost').value||'0');
      const status=document.getElementById('labStatus').value;
      const notes=document.getElementById('labNotes').value.trim();
      const result=document.getElementById('labResult').value.trim();
      let resultAttachment=null;
      const file=document.getElementById('labResultFile').files[0];
      if(file){
        if(file.size>20*1024*1024){showToast('ุญุฌู ูุฑูู ุงููุชูุฌุฉ ูุชุฌุงูุฒ ุงูุญุฏ (20MB)','error');return;}
        resultAttachment=await fileToBase64(file);
      }
      if(!patient||!service){showToast('ุจูุงูุงุช ุบูุฑ ุตุงูุญุฉ','error');return;}
      const labs=await Storage.load('labs');
      const reference=generateReference('LB');
      const record={reference,patient,doctor,service,units,sent,expected,cost,status,notes,result,resultAttachment,createdAt:new Date().toISOString()};
      labs.push(record);
      await Storage.save('labs',labs);
      await logAudit('add',reference,'ุทูุจ ูุนูู',record);
      showToast('ุชู ุญูุธ ุงูุทูุจ');
      renderLabsTable();
      renderDoctorsTable();
    }

    async function renderLabsTable(){
      const labs=await Storage.load('labs');
      const body=document.getElementById('labsTable');
      const stats=document.getElementById('labStats');
      const summary=labs.reduce((acc,cur)=>{acc[cur.status]=(acc[cur.status]||0)+1;return acc;},{})
      if(stats){
        stats.textContent=`ููุฏ ุงูุชูููุฐ: ${summary['in-progress']||0} | ูุชุฃุฎุฑ: ${summary['delayed']||0} | ุชู: ${summary['done']||0}`;
      }
      if(!body) return;
      body.innerHTML=labs.slice(-200).reverse().map(l=>`
        <tr>
          <td>${l.reference}</td>
          <td>${l.patient}</td>
          <td>${l.service}</td>
          <td>${l.status}</td>
          <td>${formatCurrency(l.cost||0)}</td>
          <td>${l.result?'<span class="badge">ูุชููุฑ</span>':'-'}</td>
          <td><button class="btn secondary" onclick="labOrderPDF('${l.reference}')">PDF</button></td>
        </tr>`).join('');
    }

    function inventoryAlert(item){
      const low=item.qty<=item.min;
      let expiryAlert=false;
      if(item.expiry){
        const diff=(new Date(item.expiry)-new Date())/(1000*60*60*24*30);
        expiryAlert=diff<=6;
      }
      if(low&&expiryAlert) return 'ูููุฉ ููุฎูุถุฉ ูุตูุงุญูุฉ ูุฑูุจุฉ';
      if(low) return 'ูููุฉ ููุฎูุถุฉ';
      if(expiryAlert) return 'ุงูุตูุงุญูุฉ ูุฑูุจุฉ';
      return '';
    }

    async function saveInventoryItem(){
      const name=document.getElementById('itemName').value.trim();
      const qty=parseFloat(document.getElementById('itemQty').value||'0');
      const min=parseFloat(document.getElementById('itemMin').value||'0');
      const expiry=document.getElementById('itemExpiry').value;
      if(!name){showToast('ุงุณู ุงููุงุฏุฉ ูุทููุจ','error');return;}
      const inventory=await Storage.load('inventory');
      const existing=inventory.find(i=>i.name===name);
      if(existing){
        existing.qty=qty;existing.min=min;existing.expiry=expiry;
      }else{
        inventory.push({name,qty,min,expiry,createdAt:new Date().toISOString()});
      }
      await Storage.save('inventory',inventory);
      await logAudit('add',name,'ุชุญุฏูุซ ูุงุฏุฉ');
      showToast('ุชู ุงูุญูุธ');
      renderInventoryTable();
    }

    async function renderInventoryTable(){
      const inventory=await Storage.load('inventory');
      const body=document.getElementById('inventoryTable');
      if(!body) return;
      body.innerHTML=inventory.map(item=>{
        const alert=inventoryAlert(item);
        return `<tr>
          <td>${item.name}</td>
          <td>${item.qty}</td>
          <td>${item.min}</td>
          <td>${item.expiry?formatDate(item.expiry):'-'}</td>
          <td>${alert?`<span class="badge danger">${alert}</span>`:'<span class="badge">ุฌูุฏ</span>'}</td>
          <td><button class="btn danger" onclick="deleteInventoryItem('${item.name}')">ุญุฐู</button></td>
        </tr>`;
      }).join('');
      renderInventoryAlerts();
    }

    async function deleteInventoryItem(name){
      guardSensitive(async()=>{
        let inventory=await Storage.load('inventory');
        inventory=inventory.filter(i=>i.name!==name);
        await Storage.save('inventory',inventory);
        await logAudit('delete',name,'ุญุฐู ูุงุฏุฉ');
        renderInventoryTable();
      });
    }

    async function renderInventoryAlerts(){
      const inventory=await Storage.load('inventory');
      const container=document.getElementById('inventoryAlerts');
      if(!container) return;
      const alerts=inventory.filter(i=>inventoryAlert(i));
      if(!alerts.length){container.innerHTML='<span class="badge">ูุง ุชูุฌุฏ ุชูุจููุงุช</span>';return;}
      container.innerHTML='<ul>'+alerts.map(a=>`<li>${a.name} โ ${inventoryAlert(a)}</li>`).join('')+'</ul>';
    }

    function advanceExpenseDue(item){
      if(!item.nextDue) return;
      const due=new Date(item.nextDue);
      if(item.frequency==='monthly') due.setMonth(due.getMonth()+1);
      if(item.frequency==='quarterly') due.setMonth(due.getMonth()+3);
      if(item.frequency==='yearly') due.setFullYear(due.getFullYear()+1);
      item.nextDue=due.toISOString().slice(0,10);
    }

    function expenseStatus(item){
      if(!item.nextDue) return 'ุบูุฑ ูุญุฏุฏ';
      const diff=(new Date(item.nextDue)-new Date())/(1000*60*60*24);
      if(diff<0) return 'ูุณุชุญู';
      if(diff<=7) return 'ูุฑูุจ';
      return 'ูุณุชูุจูู';
    }

    async function saveRecurringExpense(){
      const name=document.getElementById('expenseName')?.value.trim();
      const amount=parseFloat(document.getElementById('expenseAmount')?.value||'0');
      const frequency=document.getElementById('expenseFrequency')?.value;
      const nextDue=document.getElementById('expenseNextDue')?.value;
      const costCenter=document.getElementById('expenseCostCenter')?.value||'';
      if(!name||isNaN(amount)||amount<=0||!nextDue){showToast('ุจูุงูุงุช ุงููุตุฑูู ุบูุฑ ููุชููุฉ','error');return;}
      const expenses=await Storage.load('operatingExpenses');
      const existing=expenses.find(e=>e.name===name&&e.costCenter===costCenter);
      if(existing){existing.amount=amount;existing.frequency=frequency;existing.nextDue=nextDue;existing.costCenter=costCenter;}
      else{expenses.push({id:Date.now(),name,amount,frequency,nextDue,costCenter,active:true});}
      await Storage.save('operatingExpenses',expenses);
      await logAudit('add',name,'ูุตุฑูู ุชุดุบููู',{amount,frequency});
      showToast('ุชู ุญูุธ ุงููุตุฑูู');
      renderOperatingExpenses();
    }

    async function renderOperatingExpenses(){
      const expenses=await Storage.load('operatingExpenses');
      const body=document.getElementById('operatingExpensesTable');
      if(!body) return;
      body.innerHTML=expenses.map(item=>`
        <tr>
          <td>${item.name}</td>
          <td>${formatCurrency(item.amount)}</td>
          <td>${item.frequency}</td>
          <td>${item.nextDue?formatDate(item.nextDue):'-'}</td>
          <td>${item.costCenter||'-'}</td>
          <td>${expenseStatus(item)}</td>
        </tr>`).join('');
    }

    async function postRecurringExpenses(){
      const expenses=await Storage.load('operatingExpenses');
      const dueExpenses=expenses.filter(item=>item.active&&item.nextDue&&new Date(item.nextDue)<=new Date());
      if(!dueExpenses.length){showToast('ูุง ุชูุฌุฏ ูุตุฑููุงุช ูุณุชุญูุฉ ููุชุฑุญูู','error');return;}
      for(const item of dueExpenses){
        try{
          await recordJournal([
            {account:`ูุตุฑููุงุช ุชุดุบูููุฉ - ${item.name}`,debit:item.amount},
            {account:'ูุตุฑููุงุช ูุณุชุญูุฉ',credit:item.amount}
          ],{type:'operating-expense',item:item.name,costCenter:item.costCenter});
          advanceExpenseDue(item);
        }catch(err){
          showToast(`ุชุนุฐุฑ ุชุฑุญูู ${item.name}`,'error');
        }
      }
      await Storage.save('operatingExpenses',expenses);
      await logAudit('process','expenses','ุชุฑุญูู ูุตุฑููุงุช',{count:dueExpenses.length});
      renderOperatingExpenses();
      refreshMiniTrial();
      showToast('ุชู ุชุฑุญูู ุงููุตุฑููุงุช ุงููุณุชุญูุฉ');
    }

    async function saveFixedAsset(){
      const name=document.getElementById('assetName')?.value.trim();
      const purchase=document.getElementById('assetPurchase')?.value;
      const cost=parseFloat(document.getElementById('assetCost')?.value||'0');
      const lifeMonths=parseInt(document.getElementById('assetLife')?.value||'0',10);
      const center=document.getElementById('assetCenter')?.value||'';
      if(!name||!purchase||isNaN(cost)||cost<=0||!lifeMonths){showToast('ุจูุงูุงุช ุงูุฃุตู ุบูุฑ ููุชููุฉ','error');return;}
      const assets=await Storage.load('fixedAssets');
      const existing=assets.find(a=>a.name===name);
      if(existing){existing.purchase=purchase;existing.cost=cost;existing.lifeMonths=lifeMonths;existing.center=center;}
      else{assets.push({id:Date.now(),name,purchase,cost,lifeMonths,center,accumulated:0,lastDepreciation:null});}
      await Storage.save('fixedAssets',assets);
      await logAudit('add',name,'ุชุณุฌูู ุฃุตู ุซุงุจุช',{cost,lifeMonths});
      showToast('ุชู ุญูุธ ุงูุฃุตู');
      renderFixedAssets();
    }

    async function renderFixedAssets(){
      const assets=await Storage.load('fixedAssets');
      const body=document.getElementById('fixedAssetsTable');
      if(!body) return;
      body.innerHTML=assets.map(asset=>{
        const monthly=asset.lifeMonths?asset.cost/asset.lifeMonths:0;
        return `<tr>
          <td>${asset.name}</td>
          <td>${formatCurrency(asset.cost)}</td>
          <td>${formatCurrency(monthly)}</td>
          <td>${formatCurrency(asset.accumulated||0)}</td>
          <td>${asset.lastDepreciation||'-'}</td>
        </tr>`;
      }).join('');
    }

    async function postMonthlyDepreciation(){
      const assets=await Storage.load('fixedAssets');
      if(!assets.length){showToast('ูุง ุชูุฌุฏ ุฃุตูู','error');return;}
      const now=new Date();
      const period=`${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}`;
      let processed=0;
      for(const asset of assets){
        if(asset.lastDepreciation===period) continue;
        if(new Date(asset.purchase)>now) continue;
        const monthly=asset.lifeMonths?asset.cost/asset.lifeMonths:0;
        if(monthly<=0) continue;
        const remaining=asset.cost-(asset.accumulated||0);
        if(remaining<=0) continue;
        const amount=Math.min(monthly,remaining);
        try{
          await recordJournal([
            {account:'ูุตุฑูู ุฅููุงู',debit:amount},
            {account:`ูุฌูุน ุงูุฅููุงู - ${asset.name}`,credit:amount}
          ],{type:'depreciation',asset:asset.name,period});
          asset.accumulated=(asset.accumulated||0)+amount;
          asset.lastDepreciation=period;
          processed++;
        }catch(err){
          showToast(`ูุดู ุฅููุงู ุงูุฃุตู ${asset.name}`,'error');
        }
      }
      await Storage.save('fixedAssets',assets);
      if(processed){
        await logAudit('process','depreciation','ุฅููุงู ุดูุฑู',{count:processed,period});
        showToast('ุชู ุชุณุฌูู ุฅููุงู ุงูุดูุฑ');
        renderFixedAssets();
        refreshMiniTrial();
      }else{
        showToast('ูุง ุชูุฌุฏ ุฃุตูู ูุณุชุญูุฉ ููุฅููุงู','error');
      }
    }

    async function summarizePeriod(start,end){
      const journals=await Storage.load('journals');
      const summary={revenue:0,expenses:0};
      journals.filter(j=>{
        const time=new Date(j.createdAt);
        return time>=start&&time<=end;
      }).forEach(j=>{
        j.entries.forEach(e=>{
          const account=e.account||'';
          const debit=e.debit||0;
          const credit=e.credit||0;
          if(account.includes('ุฅูุฑุงุฏุงุช')||account.toLowerCase().includes('revenue')){
            summary.revenue+=credit-debit;
          }
          if(account.includes('ูุตุฑูู')||account.toLowerCase().includes('expense')){
            summary.expenses+=debit-credit;
          }
        });
      });
      return summary;
    }

    async function renderPeriodClosings(){
      const closings=await Storage.load('periodClosings');
      const body=document.getElementById('periodClosingsTable');
      if(!body) return;
      body.innerHTML=closings.slice(-50).reverse().map(row=>`
        <tr>
          <td>${row.period}</td>
          <td>${row.type==='month'?'ุดูุฑู':'ุณููู'}</td>
          <td>${formatCurrency(row.revenue)}</td>
          <td>${formatCurrency(row.expenses)}</td>
          <td>${formatCurrency(row.net)}</td>
        </tr>`).join('');
    }

    async function closeMonth(){
      promptPassword('close',async()=>{
        const now=new Date();
        const start=new Date(now.getFullYear(),now.getMonth(),1);
        const end=new Date(now.getFullYear(),now.getMonth()+1,0,23,59,59);
        const period=`${start.getFullYear()}-${String(start.getMonth()+1).padStart(2,'0')}`;
        const closings=await Storage.load('periodClosings');
        if(closings.find(c=>c.period===period&&c.type==='month')){showToast('ูุฐุง ุงูุดูุฑ ูุบูู ุจุงููุนู','error');return;}
        const summary=await summarizePeriod(start,end);
        const net=summary.revenue-summary.expenses;
        if(Math.abs(net)>0.01){
          const entry=net>=0?
            [
              {account:'ููุฎุต ุงูุฏุฎู',debit:net},
              {account:'ุฃุฑุจุงุญ ูุญุชุฌุฒุฉ',credit:net}
            ]:
            [
              {account:'ุฃุฑุจุงุญ ูุญุชุฌุฒุฉ',debit:Math.abs(net)},
              {account:'ููุฎุต ุงูุฏุฎู',credit:Math.abs(net)}
            ];
          await recordJournal(entry,{type:'monthly-close',period});
        }
        closings.push({id:Date.now(),period,type:'month',revenue:summary.revenue,expenses:summary.expenses,net,createdAt:new Date().toISOString()});
        await Storage.save('periodClosings',closings);
        await logAudit('close',`month-${period}`,'ุฅููุงู ุดูุฑ',{net});
        showToast('ุชู ุฅููุงู ุงูุดูุฑ');
        renderPeriodClosings();
        refreshMiniTrial();
      });
    }

    async function closeYear(){
      promptPassword('close',async()=>{
        const now=new Date();
        const start=new Date(now.getFullYear(),0,1);
        const end=new Date(now.getFullYear(),11,31,23,59,59);
        const period=`${start.getFullYear()}`;
        const closings=await Storage.load('periodClosings');
        if(closings.find(c=>c.period===period&&c.type==='year')){showToast('ูุฐู ุงูุณูุฉ ูุบููุฉ','error');return;}
        const summary=await summarizePeriod(start,end);
        const net=summary.revenue-summary.expenses;
        if(Math.abs(net)>0.01){
          const entry=net>=0?
            [
              {account:'ููุฎุต ุงูุฏุฎู ุงูุณููู',debit:net},
              {account:'ุฃุฑุจุงุญ ูุญุชุฌุฒุฉ',credit:net}
            ]:
            [
              {account:'ุฃุฑุจุงุญ ูุญุชุฌุฒุฉ',debit:Math.abs(net)},
              {account:'ููุฎุต ุงูุฏุฎู ุงูุณููู',credit:Math.abs(net)}
            ];
          await recordJournal(entry,{type:'yearly-close',period});
        }
        closings.push({id:Date.now(),period,type:'year',revenue:summary.revenue,expenses:summary.expenses,net,createdAt:new Date().toISOString()});
        await Storage.save('periodClosings',closings);
        await logAudit('close',`year-${period}`,'ุฅููุงู ุณูุฉ',{net});
        showToast('ุชู ุฅููุงู ุงูุณูุฉ');
        renderPeriodClosings();
        refreshMiniTrial();
      });
    }

    async function saveDoctor(){
      const name=document.getElementById('doctorName').value.trim();
      const share=parseFloat(document.getElementById('doctorShare').value);
      if(!name||isNaN(share)||share<30||share>50){showToast('ุงููุณุจุฉ ุจูู 30-50','error');return;}
      const doctors=await Storage.load('doctors');
      const existing=doctors.find(d=>d.name===name);
      if(existing){existing.share=share;}else{doctors.push({name,share,createdAt:new Date().toISOString()});}
      await Storage.save('doctors',doctors);
      await logAudit('add',name,'ุชุญุฏูุซ ุทุจูุจ');
      showToast('ุชู ุงูุญูุธ');
      renderDoctorsTable();
    }

    async function calculateOverheads(){
      const doctors=await Storage.load('doctors');
      const receipts=await Storage.load('receipts');
      const totalOverhead=await estimateTotalOverheads();
      const revenueByDoctor={};
      doctors.forEach(doc=>{
        revenueByDoctor[doc.name]=receipts.filter(r=>r.doctor===doc.name&&r.status==='active').reduce((s,r)=>s+r.amount,0);
      });
      const totalRevenue=Object.values(revenueByDoctor).reduce((s,v)=>s+v,0);
      const allocation={};
      doctors.forEach(doc=>{
        if(App.settings.overheadAllocation==='equal'){
          allocation[doc.name]=doctors.length?totalOverhead/doctors.length:0;
        }else{
          allocation[doc.name]=totalRevenue?totalOverhead*(revenueByDoctor[doc.name]||0)/totalRevenue:0;
        }
      });
      return allocation;
    }

    async function estimateTotalOverheads(){
      const payments=await Storage.load('payments');
      return payments.reduce((s,p)=>s+(p.amount||0),0)*0.2;
    }

    async function renderDoctorsTable(){
      const doctors=await Storage.load('doctors');
      const receipts=await Storage.load('receipts');
      const labs=await Storage.load('labs');
      const overheads=await calculateOverheads();
      const body=document.getElementById('doctorTable');
      if(!body) return;
      body.innerHTML=doctors.map(doc=>{
        const revenue=receipts.filter(r=>r.doctor===doc.name&&r.status==='active').reduce((s,r)=>s+r.amount,0);
        const labCost=labs.filter(l=>l.doctor===doc.name).reduce((s,l)=>s+(l.cost||0),0);
        const net=revenue-labCost;
        const doctorShare=net*(doc.share/100);
        const clinicShare=net-doctorShare;
        const overheadShare=overheads[doc.name]||0;
        const contribution=clinicShare-overheadShare;
        const badgeClass=contribution>=0?'badge':'badge danger';
        return `<tr>
          <td>${doc.name}</td>
          <td>${formatCurrency(revenue)}</td>
          <td>${formatCurrency(labCost)}</td>
          <td>${doc.share}%</td>
          <td>${formatCurrency(doctorShare)}</td>
          <td><span class="${badgeClass}">${formatCurrency(contribution)}</span></td>
        </tr>`;
      }).join('');
    }

    async function savePrescription(){
      await updatePatientSelectors();
      const patient=document.getElementById('prescriptionPatient')?.value;
      const doctor=document.getElementById('prescriptionDoctor')?.value.trim();
      const date=document.getElementById('prescriptionDate')?.value;
      const duration=parseInt(document.getElementById('prescriptionDuration')?.value||'0',10);
      const notes=document.getElementById('prescriptionNotes')?.value||'';
      if(!patient||!doctor||!date||!duration||duration<=0||!notes.trim()){showToast('ุฃููู ุจูุงูุงุช ุงููุตูุฉ','error');return;}
      const prescriptions=await Storage.load('prescriptions');
      const record={id:Date.now(),patient,doctor,date,duration,notes,createdAt:new Date().toISOString()};
      prescriptions.push(record);
      await Storage.save('prescriptions',prescriptions);
      await logAudit('add',record.id,'ูุตูุฉ ุทุจูุฉ',record);
      showToast('ุชู ุญูุธ ุงููุตูุฉ');
      renderPrescriptionsTable();
    }

    async function renderPrescriptionsTable(){
      const prescriptions=await Storage.load('prescriptions');
      const body=document.getElementById('prescriptionsTable');
      if(!body) return;
      body.innerHTML=prescriptions.slice(-200).reverse().map(p=>`
        <tr>
          <td>${p.patient}</td>
          <td>${p.doctor}</td>
          <td>${formatDate(p.date)}</td>
          <td>${p.duration} ููู</td>
          <td>
            <button class="btn secondary" onclick="prescriptionPDF(${p.id})">PDF</button>
            <button class="btn danger" onclick="deletePrescription(${p.id})">ุญุฐู</button>
          </td>
        </tr>`).join('');
    }

    async function prescriptionPDF(id){
      const prescriptions=await Storage.load('prescriptions');
      const pres=prescriptions.find(p=>p.id===id);
      if(!pres) return;
      const {jsPDF}=window.jspdf;
      const doc=new jsPDF();
      doc.text(App.settings.clinicName,14,20);
      doc.text('ูุตูุฉ ุทุจูุฉ',14,30);
      doc.autoTable({startY:40,head:[['ุงูุญูู','ุงููููุฉ']],body:[
        ['ุงููุฑูุถ',pres.patient],
        ['ุงูุทุจูุจ',pres.doctor],
        ['ุงูุชุงุฑูุฎ',formatDate(pres.date)],
        ['ูุฏุฉ ุงูุงุณุชุฎุฏุงู',`${pres.duration} ููู`],
        ['ุงูุชุนูููุงุช',pres.notes]
      ]});
      doc.save(`prescription-${pres.patient}-${pres.date}.pdf`);
    }

    async function deletePrescription(id){
      guardSensitive(async()=>{
        let prescriptions=await Storage.load('prescriptions');
        prescriptions=prescriptions.filter(p=>p.id!==id);
        await Storage.save('prescriptions',prescriptions);
        renderPrescriptionsTable();
      });
    }

    async function saveBankReconciliation(){
      const date=document.getElementById('reconDate')?.value;
      const bank=parseFloat(document.getElementById('reconBank')?.value||'0');
      const books=parseFloat(document.getElementById('reconBooks')?.value||'0');
      const notes=document.getElementById('reconNotes')?.value||'';
      if(!date){showToast('ุฃุฏุฎู ุชุงุฑูุฎ ุงูุชุณููุฉ','error');return;}
      const reconciliations=await Storage.load('bankReconciliations');
      reconciliations.push({id:Date.now(),date,bank,books,difference:bank-books,notes,reviewed:false,createdAt:new Date().toISOString()});
      await Storage.save('bankReconciliations',reconciliations);
      await logAudit('add',date,'ุชุณููุฉ ุจูููุฉ',{bank,books});
      showToast('ุชู ุญูุธ ุงูุชุณููุฉ');
      renderBankReconciliations();
    }

    async function renderBankReconciliations(){
      const reconciliations=await Storage.load('bankReconciliations');
      const body=document.getElementById('bankReconciliationTable');
      if(!body) return;
      body.innerHTML=reconciliations.slice(-100).reverse().map(r=>`
        <tr>
          <td>${formatDate(r.date)}</td>
          <td>${formatCurrency(r.bank||0)}</td>
          <td>${formatCurrency(r.books||0)}</td>
          <td>${formatCurrency(r.difference||0)}</td>
          <td>${r.reviewed?'<span class="badge">ูุฑุงุฌูุน</span>':'<span class="badge danger">ุจุงูุชุธุงุฑ ุงููุฑุงุฌุนุฉ</span>'}</td>
          <td>${r.reviewed?'':`<button class="btn" onclick="markReconciliationReviewed(${r.id})">ุงุนุชูุงุฏ</button>`}</td>
        </tr>`).join('');
    }

    async function markReconciliationReviewed(id){
      guardSensitive(async()=>{
        const reconciliations=await Storage.load('bankReconciliations');
        const item=reconciliations.find(r=>r.id===id);
        if(!item) return;
        item.reviewed=true;
        item.reviewedAt=new Date().toISOString();
        await Storage.save('bankReconciliations',reconciliations);
        await logAudit('update',id,'ุงุนุชูุงุฏ ุชุณููุฉ ุจูููุฉ');
        renderBankReconciliations();
      });
    }

    async function runInternalReview(){
      const results=[];
      const journals=await Storage.load('journals');
      const totals=computeLedgerTotals(journals);
      const balanced=Math.abs(totals.debit-totals.credit)<0.05;
      results.push({label:'ุงุชุฒุงู ุงููููุฏ',status:balanced?'ok':'fail',detail:`ูุฏูู ${formatCurrency(totals.debit)} / ุฏุงุฆู ${formatCurrency(totals.credit)}`});
      const receivables=await Storage.load('patientReceivables');
      const overdue=receivables.filter(r=>r.balance>0&&new Date(r.due)<new Date());
      results.push({label:'ุฐูู ูุชุฃุฎุฑุฉ',status:overdue.length?'fail':'ok',detail:overdue.length?`${overdue.length} ุฐูุฉ ูุชุฃุฎุฑุฉ`:'ูุง ููุฌุฏ'});
      const reconciliations=await Storage.load('bankReconciliations');
      const pending=reconciliations.filter(r=>!r.reviewed);
      results.push({label:'ุชุณููุงุช ุจูููุฉ ูุนููุฉ',status:pending.length?'warn':'ok',detail:pending.length?`${pending.length} ุชุณููุฉ ุชูุชุธุฑ ุงูุงุนุชูุงุฏ`:'ุฌููุน ุงูุชุณููุงุช ูุนุชูุฏุฉ'});
      const expenses=await Storage.load('operatingExpenses');
      const dueExpenses=expenses.filter(item=>item.active&&item.nextDue&&new Date(item.nextDue)<=new Date());
      results.push({label:'ูุตุฑููุงุช ูุณุชุญูุฉ',status:dueExpenses.length?'warn':'ok',detail:dueExpenses.length?`${dueExpenses.length} ูุตุฑูู ูุณุชุญู ููุชุฑุญูู`:'ูุง ููุฌุฏ'});
      const container=document.getElementById('internalReviewReport');
      if(container){
        container.innerHTML='<ul>'+results.map(r=>`<li>${r.status==='ok'?'โ':r.status==='warn'?'โ๏ธ':'โ'} ${r.label} โ ${r.detail}</li>`).join('')+'</ul>';
      }
      await logAudit('process','internal-review','ุชุดุบูู ูุฑุงุฌุนุฉ ุฏุงุฎููุฉ',results);
      showToast(results.every(r=>r.status==='ok')?'ุงููุฑุงุฌุนุฉ ุณูููุฉ':'ุฑุงุฌุน ุงููุชุงุฆุฌ',results.every(r=>r.status==='ok')?'success':'error');
    }

    async function saveSettings(){
      App.settings.clinicName=document.getElementById('clinicName').value.trim();
      App.settings.clinicLogo=document.getElementById('clinicLogo').value.trim();
      App.settings.currency=document.getElementById('clinicCurrency').value.trim()||'YER';
      App.settings.overheadAllocation=document.getElementById('overheadAllocation').value;
      await Storage.save('settings',{...App.settings});
      showToast('ุชู ุญูุธ ุงูุฅุนุฏุงุฏุงุช');
      renderDoctorsTable();
      refreshMiniTrial();
    }

    async function savePasswords(){
      const updates={};
      const settingsPwd=document.getElementById('pwdSettings').value.trim();
      const closePwd=document.getElementById('pwdClose').value.trim();
      const dangerPwd=document.getElementById('pwdDanger').value.trim();
      if(settingsPwd){App.passwords.settings=await hashText(settingsPwd);updates.settings=true;}
      if(closePwd){App.passwords.close=await hashText(closePwd);updates.close=true;}
      if(dangerPwd){App.passwords.danger=await hashText(dangerPwd);updates.danger=true;}
      if(Object.keys(updates).length===0){showToast('ูู ูุชู ุฅุฏุฎุงู ูููุงุช ูุฑูุฑ ุฌุฏูุฏุฉ','error');return;}
      await localforage.setItem('passwords',App.passwords);
      document.getElementById('pwdSettings').value='';
      document.getElementById('pwdClose').value='';
      document.getElementById('pwdDanger').value='';
      showToast('ุชู ุชุญุฏูุซ ูููุงุช ุงููุฑูุฑ');
    }

    async function exportDataJSON(){
      const data={
        settings:App.settings,
        passwords:App.passwords,
        referenceCounters:App.counters,
        receipts:await Storage.load('receipts'),
        payments:await Storage.load('payments'),
        journals:await Storage.load('journals'),
        patients:await Storage.load('patients'),
        purchaseInvoices:await Storage.load('purchaseInvoices'),
        supplierReturns:await Storage.load('supplierReturns'),
        labs:await Storage.load('labs'),
        inventory:await Storage.load('inventory'),
        doctors:await Storage.load('doctors'),
        audit:await Storage.load('audit'),
        appointments:await Storage.load('appointments')
      };
      const blob=new Blob([JSON.stringify(data,null,2)],{type:'application/json'});
      const url=URL.createObjectURL(blob);
      const a=document.createElement('a');
      a.href=url;
      a.download=`MyClinicDB-backup-${new Date().toISOString()}.json`;
      a.click();
      URL.revokeObjectURL(url);
      showToast('ุชู ุฅูุดุงุก ููู ุงููุณุฎุฉ ุงูุงุญุชูุงุทูุฉ');
    }

    function importDataJSON(){
      const input=document.createElement('input');
      input.type='file';
      input.accept='application/json';
      input.onchange=async()=>{
        const file=input.files[0];
        if(!file) return;
        try{
          const text=await file.text();
          const data=JSON.parse(text);
          await Storage.save('settings',{...App.settings,...data.settings});
          App.settings={...App.settings,...data.settings};
          if('passwords'in App.settings) delete App.settings.passwords;
          const importedPasswords=data.passwords||{};
          const prepared=await preparePasswords(importedPasswords);
          App.passwords=prepared.updated;
          await localforage.setItem('passwords',App.passwords);
          App.counters=data.referenceCounters||{};
          await Storage.save('referenceCounters',App.counters);
          const keys=['receipts','payments','journals','patients','purchaseInvoices','supplierReturns','labs','inventory','doctors','audit','appointments'];
          for(const key of keys){
            await Storage.save(key,data[key]||[]);
          }
          showToast('ุชู ุงูุงุณุชูุฑุงุฏ ุจูุฌุงุญ');
          switchView(App.view);
          refreshMiniTrial();
        }catch(err){
          console.error(err);
          showToast('ูุดู ุงูุงุณุชูุฑุงุฏ','error');
        }
      };
      input.click();
    }

    async function searchReference(){
      const ref=document.getElementById('referenceSearch').value.trim();
      const result=document.getElementById('referenceResult');
      if(!ref){result.textContent='';return;}
      const collections=['receipts','payments','journals','supplierReturns','labs','purchaseInvoices'];
      for(const name of collections){
        const list=await Storage.load(name);
        const found=list.find(item=>(item.reference||item.id)===ref);
        if(found){
          result.innerHTML=`<div class="card"><strong>ุงููุฌููุนุฉ:</strong> ${name}<br><pre>${JSON.stringify(found,null,2)}</pre></div>`;
          return;
        }
      }
      result.innerHTML='<div class="badge danger">ูู ูุชู ุงูุนุซูุฑ ุนูู ุงููุฑุฌุน</div>';
    }

    async function refreshMiniTrial(){
      const journals=await Storage.load('journals');
      const patients=await Storage.load('patients');
      const trial={Cashbox:0,AR:0,AP:0,Revenues:0,Expenses:0,Deposits:patients.reduce((s,p)=>s+(p.deposit||0),0),OnHold:0};
      journals.forEach(j=>{
        j.entries.forEach(e=>{
          const account=e.account||'';
          const debit=e.debit||0;
          const credit=e.credit||0;
          const delta=debit-credit;
          if(account.includes('ุตูุฏูู')||account.toLowerCase().includes('cash')) trial.Cashbox+=delta;
          else if(account.includes('ุฐูู ุงููุฑุถู')||account.includes('AR')) trial.AR+=delta;
          else if(account.includes('ุฐูู ุงูููุฑุฏูู')||account.includes('AP')) trial.AP+=credit-debit;
          else if(account.includes('ุฅูุฑุงุฏุงุช')||account.toLowerCase().includes('revenue')) trial.Revenues+=credit-debit;
          else if(account.includes('ูุตุฑูู')||account.toLowerCase().includes('expense')||account.includes('ุฅููุงู')) trial.Expenses+=debit-credit;
          else if(account.includes('ุฃูุงูุงุช')||account.toLowerCase().includes('deposit')) trial.Deposits+=delta;
          else if(account.toLowerCase().includes('pending')||account.includes('ูุนูู')) trial.OnHold+=credit-debit;
        });
      });
      const totals=computeLedgerTotals(journals);
      const balanced=Math.abs(totals.debit-totals.credit)<0.05;
      const mini=document.getElementById('miniTrial');
      if(!mini) return;
      const rows=Object.entries(trial).map(([k,v])=>{
        const debit=v>0?formatCurrency(v):'';
        const credit=v<0?formatCurrency(Math.abs(v)):'';
        return `<tr><td>${k}</td><td>${debit}</td><td>${credit}</td><td>${formatCurrency(v)}</td></tr>`;
      }).join('');
      mini.innerHTML=`<table><thead><tr><th>ุงูุญุณุงุจ</th><th>ูุฏูู</th><th>ุฏุงุฆู</th><th>ุตุงูู</th></tr></thead><tbody>${rows}</tbody></table><div class="badge" style="margin-top:1rem;">ุงุชุฒุงู: ${balanced?'โ๏ธ':'โ'}</div>`;
    }

    async function renderDashboardWidgets(){
      refreshMiniTrial();
      renderInventoryAlerts();
      renderAppointmentsTomorrow();
      await renderPeriodCard('morning');
      await renderPeriodCard('evening');
    }

    async function renderAppointmentsTomorrow(){
      const appointments=await Storage.load('appointments');
      const container=document.getElementById('appointmentsTomorrow');
      if(!container) return;
      const tomorrow=new Date();
      tomorrow.setDate(tomorrow.getDate()+1);
      const target=appointments.filter(a=>new Date(a.date).toDateString()===tomorrow.toDateString());
      if(!target.length){container.innerHTML='<span class="badge">ูุง ุชูุฌุฏ ููุงุนูุฏ</span>';return;}
      container.innerHTML='<table><thead><tr><th>ุงููุฑูุถ</th><th>ุงูุฎุฏูุฉ</th><th>ุงูุทุจูุจ</th><th>ุงูุญุงูุฉ</th><th>ุงููุฏููุน/ุงููุชุจูู</th></tr></thead><tbody>'+target.map(a=>`<tr><td>${a.patient}</td><td>${a.service}</td><td>${a.doctor}</td><td>${a.status}</td><td>${formatCurrency(a.paid||0)} / ${formatCurrency(a.due||0)}</td></tr>`).join('')+'</tbody></table>';
    }

    async function renderPeriodCard(period){
      const container=document.getElementById(period==='morning'?'periodMorning':'periodEvening');
      if(!container) return;
      const closures=await Storage.load('closures');
      const today=new Date().toISOString().slice(0,10);
      const record=closures.find(c=>c.date===today&&c.period===period);
      if(!record){
        container.innerHTML='<div class="badge">ูู ูุชู ุงูุฅููุงู ุจุนุฏ</div>';
        return;
      }
      container.innerHTML=`<div class="badge ${record.locked?'':'danger'}">${record.locked?'ููููู':'ููุชูุญ'} โ ${formatCurrency(record.total)}</div>`;
    }

    function closePeriod(period){
      promptPassword('close',async()=>{
        const closures=await Storage.load('closures');
        const receipts=await Storage.load('receipts');
        const payments=await Storage.load('payments');
        const now=new Date();
        const today=now.toISOString().slice(0,10);
        const totalIn=receipts.filter(r=>r.status!=='cancelled').reduce((s,r)=>s+r.amount,0);
        const totalOut=payments.filter(p=>p.status!=='cancelled').reduce((s,p)=>s+p.amount,0);
        const total=totalIn-totalOut;
        const existing=closures.find(c=>c.date===today&&c.period===period);
        if(existing){existing.total=total;existing.locked=true;}else{closures.push({date:today,period,total,locked:true,createdAt:new Date().toISOString()});}
        await Storage.save('closures',closures);
        await logAudit('close',`${today}-${period}`,'ุฅููุงู ูุชุฑุฉ',{total});
        showToast('ุชู ุฅููุงู ุงููุชุฑุฉ');
        renderPeriodCard(period);
        await exportPeriodPDF(period,true);
      });
    }

    async function exportPeriodPDF(period,silent){
      const {jsPDF}=window.jspdf;
      const doc=new jsPDF();
      doc.setFont('helvetica','bold');
      doc.text(`${App.settings.clinicName}`,14,20);
      doc.setFontSize(12);
      doc.text(`ุชูุฑูุฑ ูุชุฑุฉ ${period==='morning'?'ุตุจุงุญ':'ูุณุงุก'}`,14,30);
      const receipts=await Storage.load('receipts');
      const payments=await Storage.load('payments');
      const totalIn=receipts.filter(r=>r.status!=='cancelled').reduce((s,r)=>s+r.amount,0);
      const totalOut=payments.filter(p=>p.status!=='cancelled').reduce((s,p)=>s+p.amount,0);
      doc.autoTable({startY:40,head:[['ุงูุจูุฏ','ุงููููุฉ']],body:[['ุฅุฌูุงูู ุงููุฏุฎูู',formatCurrency(totalIn)],['ุฅุฌูุงูู ุงููุฎุฑูุฌ',formatCurrency(totalOut)],['ุงูุตุงูู',formatCurrency(totalIn-totalOut)]]});
      doc.save(`period-${period}-${new Date().toISOString().slice(0,10)}.pdf`);
      if(!silent) showToast('ุชู ุฅูุดุงุก ููู PDF');
    }

    async function miniTrialPDF(){
      const {jsPDF}=window.jspdf;
      const doc=new jsPDF();
      doc.text('ุงูููุฒุงู ุงููุตุบุฑ',14,20);
      const receipts=await Storage.load('receipts');
      const payments=await Storage.load('payments');
      const activeReceipts=receipts.filter(r=>r.status!=='cancelled');
      const activePayments=payments.filter(p=>p.status!=='cancelled');
      const data=[['Cashbox',formatCurrency(activeReceipts.reduce((s,r)=>s+r.amount,0)-activePayments.reduce((s,p)=>s+p.amount,0))]];
      doc.autoTable({startY:30,head:[['ุงูุญุณุงุจ','ุงูุตุงูู']],body:data});
      doc.save('mini-trial.pdf');
    }

    async function appointmentsPDF(){
      const {jsPDF}=window.jspdf;
      const doc=new jsPDF();
      doc.text('ููุงุนูุฏ ุงูุบุฏ',14,20);
      const appointments=await Storage.load('appointments');
      const tomorrow=new Date();tomorrow.setDate(tomorrow.getDate()+1);
      const rows=appointments.filter(a=>new Date(a.date).toDateString()===tomorrow.toDateString()).map(a=>[a.patient,a.service,a.doctor,a.status,`${formatCurrency(a.paid||0)} / ${formatCurrency(a.due||0)}`]);
      doc.autoTable({startY:30,head:[['ุงููุฑูุถ','ุงูุฎุฏูุฉ','ุงูุทุจูุจ','ุงูุญุงูุฉ','ุงููุฏููุน/ุงููุชุจูู']],body:rows});
      doc.save('appointments-tomorrow.pdf');
    }

    async function inventoryAlertsPDF(){
      const {jsPDF}=window.jspdf;
      const doc=new jsPDF();
      doc.text('ุชูุจููุงุช ุงููุฎุฒูู',14,20);
      const inventory=await Storage.load('inventory');
      const rows=inventory.filter(i=>inventoryAlert(i)).map(i=>[i.name,inventoryAlert(i)]);
      doc.autoTable({startY:30,head:[['ุงููุงุฏุฉ','ุงูุชูุจูู']],body:rows});
      doc.save('inventory-alerts.pdf');
    }

    async function receiptPDF(reference){
      const receipts=await Storage.load('receipts');
      const receipt=receipts.find(r=>r.reference===reference);
      if(!receipt) return;
      const {jsPDF}=window.jspdf;
      const doc=new jsPDF();
      doc.text(App.settings.clinicName,14,20);
      doc.text(`ุณูุฏ ูุจุถ ${reference}`,14,30);
      const typeLabel=receipt.receiptType==='settlement'?'ุชุณุฏูุฏ ุฐูุฉ':'ุฅูุฑุงุฏ ุฎุฏูุฉ ููุฑูุฉ';
      doc.autoTable({startY:40,head:[['ุงูุญูู','ุงููููุฉ']],body:[['ุงููุฑูุถ',receipt.patient],['ุงูุฎุฏูุฉ',receipt.service||'-'],['ููุน ุงูุนูููุฉ',typeLabel],['ุงูุทุจูุจ',receipt.doctor||'-'],['ุงููุจูุบ',formatCurrency(receipt.amount)],['ุงูุชุงุฑูุฎ',formatDate(receipt.createdAt)],['ููุงุญุธุงุช',receipt.notes||'-']]});
      if(receipt.attachment) doc.text('ูุฑูู ูุถููู',14,doc.lastAutoTable.finalY+10);
      doc.save(`${reference}.pdf`);
    }

    async function paymentPDF(reference){
      const payments=await Storage.load('payments');
      const payment=payments.find(r=>r.reference===reference);
      if(!payment) return;
      const {jsPDF}=window.jspdf;
      const doc=new jsPDF();
      doc.text(App.settings.clinicName,14,20);
      doc.text(`ุณูุฏ ุตุฑู ${reference}`,14,30);
      let statusLabel='ูุนููู';
      if(payment.status==='paid') statusLabel='ูุฏููุน';
      if(payment.status==='cancelled') statusLabel='ููุบู';
      doc.autoTable({startY:40,head:[['ุงูุญูู','ุงููููุฉ']],body:[['ุงูููุฑุฏ',payment.supplier],['ุงููุจูุบ',formatCurrency(payment.amount)],['ุงูุญุงูุฉ',statusLabel],['ุงูุชุงุฑูุฎ',formatDate(payment.createdAt)],['ููุงุญุธุงุช',payment.notes||'-']]});
      doc.save(`${reference}.pdf`);
    }

    async function labOrderPDF(reference){
      const labs=await Storage.load('labs');
      const lab=labs.find(l=>l.reference===reference);
      if(!lab) return;
      const {jsPDF}=window.jspdf;
      const doc=new jsPDF();
      doc.text('ุทูุจ ูุนูู',14,20);
      doc.text(reference,14,28);
      doc.autoTable({startY:34,head:[['ุงูุญูู','ุงููููุฉ']],body:[
        ['ุงููุฑูุถ',lab.patient],
        ['ุงูุทุจูุจ',lab.doctor||'-'],
        ['ุงูุฎุฏูุฉ',lab.service],
        ['ุงูุญุงูุฉ',lab.status],
        ['ุงูุชูููุฉ',formatCurrency(lab.cost||0)],
        ['ุงูููุงุญุธุงุช',lab.notes||'-'],
        ['ุงููุชูุฌุฉ',lab.result||'-']
      ]});
      if(lab.resultAttachment) doc.text('ูุฑูู ูุชูุฌุฉ ูุถููู',14,doc.lastAutoTable.finalY+12);
      doc.save(`${reference}.pdf`);
    }

    async function labSummaryPDF(){
      const {jsPDF}=window.jspdf;
      const doc=new jsPDF();
      const labs=await Storage.load('labs');
      doc.text('ูุดู ุงููุนุงูู',14,20);
      doc.autoTable({startY:30,head:[['ุงููุฑุฌุน','ุงููุฑูุถ','ุงูุฎุฏูุฉ','ุงูุญุงูุฉ','ุงูุชูููุฉ','ูุชูุฌุฉ']],body:labs.map(l=>[l.reference,l.patient,l.service,l.status,formatCurrency(l.cost||0),l.result?l.result.slice(0,30)+'...':'-'])});
      doc.save('labs-summary.pdf');
    }

    async function patientsAgingPDF(){
      const {jsPDF}=window.jspdf;
      const doc=new jsPDF();
      doc.text('ุฃุนูุงุฑ ุงูุฐูู ูููุฑุถู',14,20);
      const receivables=await Storage.load('patientReceivables');
      const now=new Date();
      const summary={};
      receivables.filter(r=>r.balance>0).forEach(r=>{
        const diff=Math.floor((now-new Date(r.due))/(1000*60*60*24));
        const bucket=diff<=30?'0-30':diff<=60?'31-60':diff<=90?'61-90':'90+';
        if(!summary[r.patient]) summary[r.patient]={name:r.patient,'0-30':0,'31-60':0,'61-90':0,'90+':0,total:0};
        summary[r.patient][bucket]+=r.balance;
        summary[r.patient].total+=r.balance;
      });
      const body=Object.values(summary).map(row=>[
        row.name,
        formatCurrency(row['0-30']),
        formatCurrency(row['31-60']),
        formatCurrency(row['61-90']),
        formatCurrency(row['90+']),
        formatCurrency(row.total)
      ]);
      doc.autoTable({startY:30,head:[['ุงููุฑูุถ','0-30','31-60','61-90','90+','ุฅุฌูุงูู']],body:body});
      doc.save('patients-aging.pdf');
    }

    async function supplierAgingPDF(){
      const {jsPDF}=window.jspdf;
      const doc=new jsPDF();
      doc.text('ูุดู ุงูููุฑุฏูู',14,20);
      const returns=await Storage.load('supplierReturns');
      doc.autoTable({startY:30,head:[['ุงููุฑุฌุน','ุงูููุฑุฏ','ุงููููุฉ','ุงูุญุงูุฉ']],body:returns.map(r=>[r.reference,r.supplier,formatCurrency(r.amount),r.status])});
      doc.save('supplier-aging.pdf');
    }

    async function inventoryPDF(){
      const {jsPDF}=window.jspdf;
      const doc=new jsPDF();
      doc.text('ุชูุฑูุฑ ุงููุฎุฒูู',14,20);
      const inventory=await Storage.load('inventory');
      doc.autoTable({startY:30,head:[['ุงููุงุฏุฉ','ุงููููุฉ','ุงูุญุฏ ุงูุฃุฏูู','ุงูุตูุงุญูุฉ']],body:inventory.map(i=>[i.name,i.qty,i.min,i.expiry?formatDate(i.expiry):'-'])});
      doc.save('inventory.pdf');
    }

    async function doctorProfitPDF(){
      const {jsPDF}=window.jspdf;
      const doc=new jsPDF();
      doc.text('ุฑุจุญูุฉ ุงูุฃุทุจุงุก',14,20);
      const doctors=await Storage.load('doctors');
      const receipts=await Storage.load('receipts');
      const labs=await Storage.load('labs');
      const overheads=await calculateOverheads();
      const rows=doctors.map(doc=>{
        const revenue=receipts.filter(r=>r.doctor===doc.name&&r.status==='active').reduce((s,r)=>s+r.amount,0);
        const labCost=labs.filter(l=>l.doctor===doc.name).reduce((s,l)=>s+(l.cost||0),0);
        const net=revenue-labCost;
        const doctorShare=net*(doc.share/100);
        const contribution=net-doctorShare-(overheads[doc.name]||0);
        return [doc.name,formatCurrency(revenue),formatCurrency(labCost),doc.share+'%',formatCurrency(doctorShare),formatCurrency(contribution)];
      });
      doc.autoTable({startY:30,head:[['ุงูุทุจูุจ','ุงูุฅูุฑุงุฏ','ุชูููุฉ ุงููุนูู','ุงููุณุจุฉ','ูุตูุจ ุงูุทุจูุจ','ูุณุงููุฉ ุงูุนูุงุฏุฉ']],body:rows});
      doc.save('doctor-profit.pdf');
    }

    async function clinicProfitPDF(){
      const {jsPDF}=window.jspdf;
      const doc=new jsPDF();
      doc.text('ุฑุจุญูุฉ ุงูุนูุงุฏุฉ',14,20);
      const receipts=await Storage.load('receipts');
      const payments=await Storage.load('payments');
      const labs=await Storage.load('labs');
      const doctors=await Storage.load('doctors');
      const revenue=receipts.filter(r=>r.status==='active').reduce((s,r)=>s+r.amount,0);
      const labCost=labs.reduce((s,l)=>s+(l.cost||0),0);
      const expenses=payments.filter(p=>p.status!=='cancelled').reduce((s,p)=>s+p.amount,0);
      const doctorShare=doctors.reduce((s,doc)=>{
        const docRevenue=receipts.filter(r=>r.doctor===doc.name&&r.status==='active').reduce((t,r)=>t+r.amount,0);
        const docLab=labs.filter(l=>l.doctor===doc.name).reduce((t,l)=>t+(l.cost||0),0);
        return s+(docRevenue-docLab)*(doc.share/100);
      },0);
      const net=revenue-labCost-expenses-doctorShare;
      doc.autoTable({startY:30,head:[['ุงูุจูุฏ','ุงููููุฉ']],body:[['ุงูุฅูุฑุงุฏุงุช',formatCurrency(revenue)],['ุชูููุฉ ุงููุนูู',formatCurrency(labCost)],['ูุตุฑููุงุช ุฃุฎุฑู',formatCurrency(expenses)],['ูุตูุจ ุงูุฃุทุจุงุก',formatCurrency(doctorShare)],['ุตุงูู ุงูุฑุจุญ',formatCurrency(net)]]});
      doc.save('clinic-profit.pdf');
    }

    async function dailyReportPDF(){await genericReport('daily');}
    async function weeklyReportPDF(){await genericReport('weekly');}
    async function monthlyReportPDF(){await genericReport('monthly');}

    async function genericReport(type){
      const {jsPDF}=window.jspdf;
      const doc=new jsPDF();
      doc.text(`ุชูุฑูุฑ ${type==='daily'?'ูููู':type==='weekly'?'ุฃุณุจูุนู':'ุดูุฑู'}`,14,20);
      const receipts=await Storage.load('receipts');
      const payments=await Storage.load('payments');
      const now=new Date();
      let start;
      if(type==='daily') start=new Date(now.getFullYear(),now.getMonth(),now.getDate());
      if(type==='weekly'){start=new Date(now);start.setDate(now.getDate()-6);}
      if(type==='monthly'){start=new Date(now.getFullYear(),now.getMonth(),1);}
      const filteredReceipts=receipts.filter(r=>new Date(r.createdAt)>=start&&new Date(r.createdAt)<=now && r.status==='active');
      const filteredPayments=payments.filter(r=>new Date(r.createdAt)>=start&&new Date(r.createdAt)<=now && r.status!=='cancelled');
      const totalIn=filteredReceipts.reduce((s,r)=>s+r.amount,0);
      const totalOut=filteredPayments.reduce((s,r)=>s+r.amount,0);
      doc.autoTable({startY:30,head:[['ุงูุจูุฏ','ุงููููุฉ']],body:[['ุงููุฏุฎูู',formatCurrency(totalIn)],['ุงููุฎุฑูุฌ',formatCurrency(totalOut)],['ุงูุตุงูู',formatCurrency(totalIn-totalOut)]]});
      doc.save(`report-${type}.pdf`);
    }

    async function journalPDF(){
      const {jsPDF}=window.jspdf;
      const doc=new jsPDF('p','pt','a4');
      doc.text('ุฏูุชุฑ ุงูููููุฉ',40,40);
      const journals=await Storage.load('journals');
      const body=journals.slice(-200).reverse().map(j=>[j.id,formatDate(j.createdAt),j.meta?.type||'',j.entries.map(e=>`${e.account}: ${e.debit?formatCurrency(e.debit):''} ${e.credit?formatCurrency(e.credit):''}`).join('\n')]);
      doc.autoTable({startY:60,head:[['ุงููุฑุฌุน','ุงูุชุงุฑูุฎ','ุงููุตู','ุงููููุฏ']],body});
      doc.save('journal.pdf');
    }

    async function auditLogPDF(){
      const {jsPDF}=window.jspdf;
      const doc=new jsPDF('p','pt','a4');
      doc.text('ุณุฌู ุงูุชุฏููู',40,40);
      const log=await Storage.load('audit');
      doc.autoTable({startY:60,head:[['ุงูููุช','ุงููุณุชุฎุฏู','ุงูุฅุฌุฑุงุก','ุงููุฑุฌุน']],body:log.slice(-200).reverse().map(i=>[formatDate(i.timestamp),i.user,i.action,i.reference])});
      doc.save('audit-log.pdf');
    }

    async function downloadReceiptPDF(){
      const receipts=await Storage.load('receipts');
      if(!receipts.length){showToast('ูุง ุชูุฌุฏ ุณูุฏุงุช','error');return;}
      await receiptPDF(receipts[receipts.length-1].reference);
    }
    async function downloadPaymentPDF(){
      const payments=await Storage.load('payments');
      if(!payments.length){showToast('ูุง ุชูุฌุฏ ุณูุฏุงุช','error');return;}
      await paymentPDF(payments[payments.length-1].reference);
    }

    async function runHealthCheck(){
      const results=[];
      try{
        if(!window.localforage) throw new Error('localForage ุบูุฑ ูุชุงุญ');
        results.push({item:'localForage',status:'ok'});
      }catch(err){results.push({item:'localForage',status:'fail',message:err.message});}
      try{
        if(!window.jspdf) throw new Error('jsPDF ุบูุฑ ูุชุงุญ');
        results.push({item:'jsPDF',status:'ok'});
      }catch(err){results.push({item:'jsPDF',status:'fail',message:err.message});}
      try{
        await localforage.setItem('test-key',{time:Date.now()});
        await localforage.getItem('test-key');
        results.push({item:'ุงููุชุงุจุฉ/ุงููุฑุงุกุฉ',status:'ok'});
      }catch(err){results.push({item:'ุงููุชุงุจุฉ/ุงููุฑุงุกุฉ',status:'fail',message:err.message});}
      try{
        const journals=await Storage.load('journals');
        const subset=journals.slice(-20);
        const valid=subset.every(j=>Math.abs(j.entries.reduce((s,e)=>s+(e.debit||0),0)-j.entries.reduce((s,e)=>s+(e.credit||0),0))<0.01);
        results.push({item:'ุงุชุฒุงู ุงููููุฏ',status:valid?'ok':'fail',message:valid?'':'ููุฌุฏ ููุฏ ุบูุฑ ูุชุฒู'});
      }catch(err){results.push({item:'ุงุชุฒุงู ุงููููุฏ',status:'fail',message:err.message});}
      const health=document.getElementById('healthReport');
      const ok=results.every(r=>r.status==='ok');
      health.innerHTML='<ul>'+results.map(r=>`<li>${r.status==='ok'?'โ':'โ'} ${r.item}${r.message?` โ ${r.message}`:''}</li>`).join('')+'</ul>';
      const {jsPDF}=window.jspdf;
      const doc=new jsPDF();
      doc.text('Health Check',14,20);
      doc.autoTable({startY:30,head:[['ุงูุจูุฏ','ุงููุชูุฌุฉ','ููุงุญุธุงุช']],body:results.map(r=>[r.item,r.status==='ok'?'โ':'โ',r.message||''])});
      doc.save('health-check.pdf');
      showToast(ok?'ุฌููุน ุงูุงุฎุชุจุงุฑุงุช ูุงุฌุญุฉ':'ุจุนุถ ุงูุงุฎุชุจุงุฑุงุช ูุดูุช',ok?'success':'error');
    }

    document.getElementById('btnSensitive').onclick=()=>{
      if(App.role!=='manager'){showToast('ุงููุฏูุฑ ููุท ููููู ุชูุนูู ุงููุถุน ุงูุญุณุงุณ','error');return;}
      if(App.sensitive){App.sensitive=false;updateStatus();return;}
      promptPassword('danger',()=>{App.sensitive=true;updateStatus();});
    };

    document.getElementById('btnSwitchRole').onclick=()=>{
      const overlay=document.getElementById('modalOverlay');
      overlay.innerHTML=`<div class="modal">
        <header><h3>ุชุจุฏูู ุงููุณุชุฎุฏู</h3></header>
        <p>ุงุฎุชุฑ ุงูุฏูุฑ:</p>
        <select id="roleSelect" style="width:100%;margin-bottom:1rem;">
          <option value="manager">ูุฏูุฑ</option>
          <option value="secretary">ุณูุฑุชูุฑุฉ</option>
        </select>
        <div class="flex" style="justify-content:flex-end;">
          <button class="btn" id="confirmRole">ุชุฃููุฏ</button>
        </div>
      </div>`;
      overlay.classList.add('active');
      document.getElementById('confirmRole').onclick=()=>{
        const role=document.getElementById('roleSelect').value;
        if(role==='manager'){
          promptPassword('settings',()=>{
            overlay.classList.remove('active');
            App.role='manager';
            updateStatus();
            renderNav();
            switchView('dashboard');
          });
        }else{
          overlay.classList.remove('active');
          App.role='secretary';
          App.sensitive=false;
          updateStatus();
          renderNav();
          switchView('dashboard');
        }
      };
      overlay.addEventListener('click',e=>{if(e.target.id==='modalOverlay')overlay.classList.remove('active');},{once:true});
    };

    function appointmentsSeed(){
      return [
        {id:1,patient:'ุฃุญูุฏ',service:'ุชูุธูู',doctor:'ุฏ. ูููู',paid:200,due:0,status:'scheduled',period:'morning',notes:'',date:new Date().toISOString()},
        {id:2,patient:'ุณุงุฑุฉ',service:'ุญุดู',doctor:'ุฏ. ูุญูุฏ',paid:0,due:300,status:'scheduled',period:'evening',notes:'',date:new Date(Date.now()+24*60*60*1000).toISOString()}
      ];
    }

    async function bootstrap(){
      await Storage.init();
      const existingPatients=await Storage.load('patients');
      if(!existingPatients.length){
        await Storage.save('patients',[{name:'ุฃุญูุฏ ุนูู',phone:'0500000000',balance:0,deposit:0,notes:'',createdAt:new Date().toISOString()}]);
      }
      const existingDoctors=await Storage.load('doctors');
      if(!existingDoctors.length){
        await Storage.save('doctors',[{name:'ุฏ. ูููู',share:40},{name:'ุฏ. ูุญูุฏ',share:45}]);
      }
      const appointments=await Storage.load('appointments');
      if(!appointments.length){
        await Storage.save('appointments',appointmentsSeed());
      }
      await updatePatientSelectors();
      updateStatus();
      renderNav();
      switchView('dashboard');
      renderReceiptsTable();
      renderPaymentsTable();
      renderJournalTable();
      renderPatientsTable();
      renderPatientReceivables();
      renderMedicalAlerts();
      renderSupplierReturns();
      renderLabsTable();
      renderInventoryTable();
      renderOperatingExpenses();
      renderFixedAssets();
      renderPeriodClosings();
      renderDoctorsTable();
      renderAppointmentsTable();
      renderPrescriptionsTable();
      renderBankReconciliations();
      renderDashboardWidgets();
    }

    bootstrap();
  </script>
</body>
</html>
